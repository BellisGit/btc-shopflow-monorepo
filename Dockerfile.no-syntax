# ä¸ä¾èµ– Docker Hub syntax è§£æå™¨çš„ç‰ˆæœ¬
# æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬ä¸ä½¿ç”¨æ„å»ºç¼“å­˜æŒ‚è½½ï¼Œæ„å»ºé€Ÿåº¦ä¼šè¾ƒæ…¢
# é€šç”¨å¤šé˜¶æ®µæ„å»ºï¼šä½¿ç”¨ --build-arg APP_DIR=apps/admin-app æŒ‡å®šå­åº”ç”¨ç›®å½•
ARG NODE_VERSION=20-alpine
ARG PNPM_VERSION=9
ARG APP_DIR=apps/admin-app

FROM node:${NODE_VERSION} AS base
WORKDIR /repo
ENV CI=true
ENV PNPM_HOME=/root/.local/share/pnpm
ENV PATH="${PNPM_HOME}:${PATH}"
RUN corepack enable && corepack prepare pnpm@${PNPM_VERSION} --activate

# ä»…æ‹·è´ workspace å…ƒæ•°æ®ä¸é”æ–‡ä»¶ï¼ŒåŠ å¿«å®‰è£…ç¼“å­˜å‘½ä¸­
COPY pnpm-workspace.yaml ./
COPY package.json ./
COPY turbo.json ./
COPY packages/shared-core/package.json packages/shared-core/package.json
COPY packages/shared-components/package.json packages/shared-components/package.json
COPY packages/shared-utils/package.json packages/shared-utils/package.json
COPY packages/vite-plugin/package.json packages/vite-plugin/package.json
COPY packages/subapp-manifests/package.json packages/subapp-manifests/package.json
COPY apps/admin-app/package.json apps/admin-app/package.json
COPY apps/docs-site-app/package.json apps/docs-site-app/package.json
COPY apps/engineering-app/package.json apps/engineering-app/package.json
COPY apps/finance-app/package.json apps/finance-app/package.json
COPY apps/logistics-app/package.json apps/logistics-app/package.json
COPY apps/production-app/package.json apps/production-app/package.json
COPY apps/quality-app/package.json apps/quality-app/package.json
COPY apps/system-app/package.json apps/system-app/package.json
COPY apps/mobile-app/package.json apps/mobile-app/package.json

FROM base AS deps
# å®‰è£…ä¾èµ–ï¼ˆå¿½ç•¥ prepare è„šæœ¬ï¼Œå› ä¸ºæ­¤æ—¶è¿˜æ²¡æœ‰æºä»£ç ï¼‰
# æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬ä¸ä½¿ç”¨ç¼“å­˜æŒ‚è½½ï¼Œæ„å»ºä¼šè¾ƒæ…¢
COPY pnpm-lock.yaml* ./
RUN pnpm install --no-frozen-lockfile --ignore-scripts

FROM base AS build
ARG APP_DIR
# å…ˆå¤åˆ¶ä¾èµ–ï¼ˆä» deps é˜¶æ®µï¼Œåˆ©ç”¨ç¼“å­˜åŠ é€Ÿï¼‰
COPY --from=deps /repo/node_modules /repo/node_modules
COPY --from=deps /repo/pnpm-lock.yaml /repo/pnpm-lock.yaml

# âš ï¸ å…³é”®ä¼˜åŒ–ï¼šåªå¤åˆ¶å¿…è¦çš„æºä»£ç ï¼Œé¿å…è§¦å‘å…¶ä»–åº”ç”¨çš„æ„å»º
# åªå¤åˆ¶å…±äº«åŒ…å’ŒæŒ‡å®šåº”ç”¨çš„æºä»£ç ï¼ˆä¸å¤åˆ¶å…¶ä»–åº”ç”¨ï¼‰
COPY packages/ packages/
COPY ${APP_DIR}/ ${APP_DIR}/
# å¤åˆ¶ scripts ç›®å½•ï¼ˆæŸäº›åŒ…çš„ prepare è„šæœ¬éœ€è¦ï¼‰
COPY scripts/ scripts/
# å¤åˆ¶ configs ç›®å½•ï¼ˆæŸäº›åº”ç”¨çš„ vite.config.ts éœ€è¦ï¼‰
COPY configs/ configs/
# å¤åˆ¶ auth ç›®å½•ï¼ˆsystem-app ä¾èµ–ï¼ŒåŒ…å«ç™»å½•ã€æ³¨å†Œç­‰é¡µé¢ï¼‰
COPY auth/ auth/
# å¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶
COPY turbo.json ./
COPY .npmrc* ./
COPY .env* ./
# å¤åˆ¶ uno.config.tsï¼ˆæŸäº›åº”ç”¨éœ€è¦ï¼‰
COPY uno.config.ts* ./

# âš ï¸ ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ„å»ºçš„åº”ç”¨ä¾èµ–å…¶ä»–åº”ç”¨çš„é…ç½®ï¼Œéœ€è¦å¤åˆ¶ç›¸å…³æ–‡ä»¶
# system-app ä¾èµ– admin-app çš„ proxy é…ç½®ï¼Œéœ€è¦å¤åˆ¶ admin-app/src/config ç›®å½•
# æ³¨æ„ï¼šåªå¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶ï¼Œä¸å¤åˆ¶æ•´ä¸ª admin-appï¼Œé¿å…è§¦å‘ admin-app çš„æ„å»º
RUN mkdir -p apps/admin-app/src/config || true
COPY apps/admin-app/src/config/ apps/admin-app/src/config/

# é‡æ–°å®‰è£…ä¾èµ–ä»¥ç¡®ä¿ prepare è„šæœ¬æ­£ç¡®æ‰§è¡Œï¼ˆæºä»£ç ç°åœ¨å·²å­˜åœ¨ï¼‰
# æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬ä¸ä½¿ç”¨ç¼“å­˜æŒ‚è½½ï¼Œæ„å»ºä¼šè¾ƒæ…¢
WORKDIR /repo
RUN pnpm install --frozen-lockfile --prefer-offline

# âš ï¸ åªæ„å»ºæŒ‡å®šåº”ç”¨åŠå…¶ä¾èµ–åŒ…ï¼ˆä¸ä¼šæ„å»ºå…¶ä»–åº”ç”¨ï¼‰
# ä½¿ç”¨ --filter ç²¾ç¡®æŒ‡å®šè¦æ„å»ºçš„åŒ…ï¼Œé¿å…è§¦å‘å…¶ä»–åº”ç”¨çš„æ„å»º
# æ³¨æ„ï¼šç”±äºåªå¤åˆ¶äº†æŒ‡å®šåº”ç”¨çš„æºä»£ç ï¼Œå…¶ä»–åº”ç”¨ä¸ä¼šè¢«è§¦å‘æ„å»º
RUN APP_NAME=$(basename ${APP_DIR}) && \
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" && \
    echo "ğŸ”¨ Building ${APP_NAME} and dependencies ONLY..." && \
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" && \
    pnpm --filter @btc/vite-plugin build && \
    pnpm --filter @btc/shared-utils build && \
    pnpm --filter @btc/shared-core build && \
    pnpm --filter @btc/shared-components build && \
    pnpm --filter @btc/subapp-manifests build && \
    echo "" && \
    echo "ğŸ”¨ Building ${APP_NAME}..." && \
    pnpm --filter ${APP_NAME} build && \
    echo "" && \
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" && \
    echo "âœ… Build completed for ${APP_NAME} only (no other apps were built)" && \
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# è¿è¡Œæ—¶é•œåƒï¼šä½¿ç”¨ Node.js æä¾›é™æ€èµ„æºæœåŠ¡
ARG NODE_VERSION=20-alpine
FROM node:${NODE_VERSION} AS runner
ARG APP_DIR=apps/admin-app
ENV APP_DIR=${APP_DIR}
WORKDIR /app

# å®‰è£… serve ç”¨äºæä¾›é™æ€æ–‡ä»¶æœåŠ¡
RUN npm install -g serve

# æ‹·è´æ„å»ºäº§ç‰©
COPY --from=build /repo/${APP_DIR}/dist ./dist

# éªŒè¯ dist ç›®å½•æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
RUN if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then \
      echo "ERROR: dist directory is empty or does not exist!" && \
      echo "APP_DIR=${APP_DIR}" && \
      ls -la /app || true && \
      exit 1; \
    else \
      echo "âœ… dist directory is valid" && \
      ls -la dist | head -10; \
    fi

EXPOSE 80
# ä½¿ç”¨ -s å‚æ•°æ”¯æŒ SPA è·¯ç”±ï¼Œ-n å‚æ•°ç¦ç”¨ç¼“å­˜
CMD ["serve", "-s", "dist", "-l", "80", "-n"]


