name: Deploy System App

# ⚠️ 此工作流仅用于部署 system-app
# - 触发条件：
#   1. 推送到 .deploy/system-app/** 路径的文件
#   2. repository_dispatch 事件（通过 API 触发）
#   3. workflow_dispatch（手动触发）
# - 不会触发任何构建过程（构建在本地完成）
# - 不会影响其他应用的部署
on:
  push:
    branches: [ master ]
    paths:
      - '.deploy/system-app/**'
  repository_dispatch:
    types: [deploy-system-app]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  packages: read

jobs:
  validate:
    name: Validate Deployment
    uses: ./.github/workflows/validate-deployment.yml
    secrets: inherit

  detect-image-tag:
    name: Detect Image Tag
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
    steps:
      - name: Detect image tag
        id: detect
        run: |
          # 优先级：client_payload.image_tag > client_payload.github_sha > github.sha > latest
          if [ -n "${{ github.event.client_payload.image_tag }}" ]; then
            # 从完整镜像标签中提取标签部分（去掉 registry 前缀）
            FULL_TAG="${{ github.event.client_payload.image_tag }}"
            IMAGE_TAG=$(echo "$FULL_TAG" | sed 's|.*:||' || echo "")
          elif [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            IMAGE_TAG="${{ github.event.client_payload.github_sha }}"
          else
            GITHUB_SHA="${{ github.sha }}"
            IMAGE_TAG="${GITHUB_SHA:0:7}"
          fi
          
          # 如果标签为空或太短，使用 latest
          if [ -z "$IMAGE_TAG" ] || [ ${#IMAGE_TAG} -lt 7 ]; then
            IMAGE_TAG="latest"
          fi
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "✅ 检测到镜像标签: $IMAGE_TAG"

  deploy:
    name: Deploy System App
    needs: [validate, detect-image-tag]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: system-app
      app_port: "30080"
      container_name: btc-system-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  cleanup:
    name: Clean up deployment marker
    needs: [deploy]
    if: always() && needs.deploy.result == 'success' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Clean up
        run: |
          rm -rf ".deploy/system-app" || true
