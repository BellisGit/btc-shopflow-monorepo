name: Deploy Static Files

on:
  # è‡ªåŠ¨è§¦å‘ï¼šæŽ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²æ‰€æœ‰åº”ç”¨
  push:
    branches:
      - master
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - '.github/**'
      - 'docs/**'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      app:
        description: 'åº”ç”¨åç§° (å•ä¸ªåº”ç”¨åç§°æˆ– "all" éƒ¨ç½²æ‰€æœ‰åº”ç”¨)'
        required: true
        type: choice
        options:
          - all
          - system-app
          - admin-app
          - logistics-app
          - quality-app
          - production-app
          - engineering-app
          - finance-app
          - mobile-app
      skip_build:
        description: 'è·³è¿‡æž„å»ºæ­¥éª¤ï¼ˆä»…éƒ¨ç½²ï¼‰'
        required: false
        type: boolean
        default: false
  # API è§¦å‘
  repository_dispatch:
    types: [deploy-static]
  # æž„å»ºå®ŒæˆåŽè‡ªåŠ¨è§¦å‘ï¼ˆä»…å½“æž„å»ºæˆåŠŸæ—¶ï¼‰
  workflow_run:
    workflows: ["Build-Deploy All Apps"]
    types:
      - completed

permissions:
  contents: read

jobs:
  determine-apps:
    name: Determine Apps
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.apps.outputs.apps }}
      apps_json: ${{ steps.apps.outputs.apps_json }}
      build_all: ${{ steps.apps.outputs.build_all }}
      skip_build: ${{ steps.apps.outputs.skip_build }}
    steps:
      - name: Determine apps to build and deploy
        id: apps
        run: |
          # æ ¹æ®è§¦å‘æ–¹å¼ç¡®å®šè¦éƒ¨ç½²çš„åº”ç”¨
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨è¾“å…¥å‚æ•°
            APP_INPUT="${{ inputs.app }}"
            SKIP_BUILD="${{ inputs.skip_build }}"
          elif [ "${{ github.event_name }}" == "workflow_run" ]; then
            # æž„å»ºå®ŒæˆåŽè‡ªåŠ¨è§¦å‘ï¼šéƒ¨ç½²æ‰€æœ‰åº”ç”¨ï¼Œè·³è¿‡æž„å»º
            APP_INPUT="all"
            SKIP_BUILD="true"
          elif [ "${{ github.event_name }}" == "push" ]; then
            # æŽ¨é€è§¦å‘ï¼šéƒ¨ç½²æ‰€æœ‰åº”ç”¨ï¼Œéœ€è¦æž„å»º
            APP_INPUT="all"
            SKIP_BUILD="false"
          else
            # repository_dispatch æˆ–å…¶ä»–ï¼šä½¿ç”¨ payload æˆ–é»˜è®¤ all
            APP_INPUT="${{ github.event.client_payload.app || 'all' }}"
            SKIP_BUILD="${{ github.event.client_payload.skip_build || 'false' }}"
          fi
          
          if [ "$APP_INPUT" = "all" ]; then
            APPS="system-app admin-app logistics-app quality-app production-app engineering-app finance-app mobile-app"
            BUILD_ALL=true
          else
            APPS="$APP_INPUT"
            BUILD_ALL=false
          fi
          
          # å°†åº”ç”¨åˆ—è¡¨è½¬æ¢ä¸º JSON æ•°ç»„ï¼ˆç”¨äºŽ matrixï¼‰
          APPS_JSON="["
          FIRST=true
          for app in $APPS; do
            if [ "$FIRST" = true ]; then
              APPS_JSON="$APPS_JSON\"$app\""
              FIRST=false
            else
              APPS_JSON="$APPS_JSON,\"$app\""
            fi
          done
          APPS_JSON="$APPS_JSON]"
          
          echo "apps=$APPS" >> $GITHUB_OUTPUT
          echo "apps_json=$APPS_JSON" >> $GITHUB_OUTPUT
          echo "build_all=$BUILD_ALL" >> $GITHUB_OUTPUT
          echo "skip_build=$SKIP_BUILD" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "ðŸ“‹ å°†éƒ¨ç½²çš„åº”ç”¨: $APPS"
          echo "ðŸ“‹ è·³è¿‡æž„å»º: $SKIP_BUILD"
          echo "ðŸ“‹ Matrix JSON: $APPS_JSON"

  build-shared-deps:
    name: Build Shared Dependencies
    needs: determine-apps
    if: needs.determine-apps.outputs.skip_build != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile --prefer-offline
      
      - name: Restore built packages cache
        uses: actions/cache@v3
        with:
          path: |
            packages/*/dist
            packages/*/build
          key: packages-build-${{ github.sha }}
          restore-keys: |
            packages-build-
      
      - name: Build shared dependencies
        continue-on-error: true
        run: |
          echo "ðŸ”¨ æž„å»ºå…±äº«ä¾èµ–åŒ…..."
          pnpm --filter @btc/vite-plugin run build --force || pnpm --filter @btc/vite-plugin run build || true
          pnpm --filter @btc/shared-utils run build --force || pnpm --filter @btc/shared-utils run build || true
          pnpm --filter @btc/shared-core run build --force || pnpm --filter @btc/shared-core run build || true
          pnpm --filter @btc/shared-components run build --force || pnpm --filter @btc/shared-components run build || true
          pnpm --filter @btc/subapp-manifests run build --force || pnpm --filter @btc/subapp-manifests run build || true

  build-apps:
    name: Build Applications (Parallel)
    needs: [determine-apps, build-shared-deps]
    if: always()
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.determine-apps.outputs.apps_json) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile --prefer-offline
      
      - name: Restore built packages cache
        uses: actions/cache@v3
        with:
          path: |
            packages/*/dist
            packages/*/build
          key: packages-build-${{ github.sha }}
          restore-keys: |
            packages-build-
      
      - name: Check if build is needed
        id: check_build
        run: |
          SKIP_BUILD="${{ needs.determine-apps.outputs.skip_build }}"
          echo "skip_build=$SKIP_BUILD" >> $GITHUB_OUTPUT
          if [ "$SKIP_BUILD" = "true" ]; then
            echo "â­ï¸ è·³è¿‡æž„å»ºï¼ˆä½¿ç”¨å·²æœ‰æž„å»ºäº§ç‰©ï¼‰"
            echo "skipped=true" >> $GITHUB_OUTPUT
          else
            echo "skipped=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Build application
        if: steps.check_build.outputs.skipped != 'true'
        run: |
          set -e
          APP_NAME="${{ matrix.app }}"
          echo "ðŸ”¨ æž„å»º $APP_NAME..."
          
          cd apps/$APP_NAME
          if [ ! -f "package.json" ]; then
            echo "âŒ é”™è¯¯: $APP_NAME/package.json ä¸å­˜åœ¨"
            exit 1
          fi
          
          pnpm run build
          cd ../..
          
          # éªŒè¯æž„å»ºäº§ç‰©
          if [ ! -d "apps/$APP_NAME/dist" ] || [ -z "$(ls -A apps/$APP_NAME/dist 2>/dev/null)" ]; then
            echo "âŒ é”™è¯¯: $APP_NAME/dist ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… $APP_NAME æž„å»ºå®Œæˆ"
          echo "ðŸ“¦ æž„å»ºäº§ç‰©ç»Ÿè®¡:"
          find apps/$APP_NAME/dist -type f | wc -l | xargs echo "  æ€»æ–‡ä»¶æ•°:"
          du -sh apps/$APP_NAME/dist | awk '{print "  æ€»å¤§å°: " $1}'

  deploy:
    name: Deploy Static Files
    # æ€»æ˜¯ç­‰å¾… determine-apps å’Œ build-appsï¼ˆå¦‚æžœè·³è¿‡æž„å»ºï¼Œbuild-apps ä¼šç«‹å³å®Œæˆï¼‰
    needs: [determine-apps, build-apps]
    # å¦‚æžœæ˜¯ workflow_run è§¦å‘ï¼Œä»…åœ¨åŽŸå·¥ä½œæµæˆåŠŸæ—¶æ‰§è¡Œ
    # å¦‚æžœè·³è¿‡æž„å»ºï¼Œbuild-apps ä¼šæˆåŠŸå®Œæˆï¼ˆè·³è¿‡æž„å»ºæ­¥éª¤ï¼‰
    if: |
      (github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success') &&
      (needs.determine-apps.outputs.skip_build == 'true' || needs.build-apps.result == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
      SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
      SSH_KEY: ${{ secrets.SERVER_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # å¤„ç† SSH å¯†é’¥
          if [ -n "${{ secrets.SERVER_KEY }}" ]; then
            SERVER_KEY="${{ secrets.SERVER_KEY }}"
            # æ£€æŸ¥æ˜¯å¦æ˜¯ base64 ç¼–ç 
            if echo "$SERVER_KEY" | grep -q "^[A-Za-z0-9+/]*={0,2}$" && [ ${#SERVER_KEY} -gt 100 ]; then
              echo "$SERVER_KEY" | base64 -d > ~/.ssh/id_rsa
            else
              echo "$SERVER_KEY" > ~/.ssh/id_rsa
            fi
            chmod 600 ~/.ssh/id_rsa
          else
            echo "âŒ SERVER_KEY æœªè®¾ç½®"
            exit 1
          fi
          
          # æ·»åŠ æœåŠ¡å™¨åˆ° known_hosts
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # æµ‹è¯• SSH è¿žæŽ¥
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || '22' }} \
            -o ConnectTimeout=5 -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} \
            "echo 'SSH connection successful'" || {
            echo "âŒ SSH è¿žæŽ¥å¤±è´¥"
            exit 1
          }
      
      - name: Deploy static files
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
          SSH_KEY: ~/.ssh/id_rsa
        run: |
          set -e
          chmod +x scripts/deploy-static.sh
          
          APPS="${{ needs.determine-apps.outputs.apps }}"
          
          if [ "${{ needs.determine-apps.outputs.build_all }}" = "true" ]; then
            # æ‰¹é‡éƒ¨ç½²
            ./scripts/deploy-static.sh --all
          else
            # å•ä¸ªåº”ç”¨éƒ¨ç½²
            for app in $APPS; do
              ./scripts/deploy-static.sh --app "$app"
            done
          fi
      
      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸ“Š éƒ¨ç½²ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²æ¨¡å¼**: ${{ needs.determine-apps.outputs.build_all == 'true' && 'æ‰¹é‡éƒ¨ç½²' || 'å•åº”ç”¨éƒ¨ç½²' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²åº”ç”¨**: ${{ needs.determine-apps.outputs.apps }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æœåŠ¡å™¨**: ${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          SKIP_BUILD_VAL="${{ needs.determine-apps.outputs.skip_build }}"
          if [ "$SKIP_BUILD_VAL" = "true" ]; then
            echo "- **æž„å»º**: å·²è·³è¿‡ï¼ˆä½¿ç”¨å·²æœ‰æž„å»ºäº§ç‰©ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **æž„å»º**: å·²å®Œæˆï¼ˆå¹¶è¡Œæž„å»ºï¼‰" >> $GITHUB_STEP_SUMMARY
          fi

