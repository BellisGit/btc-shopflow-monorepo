name: Build Engineering App

on:
  workflow_call:
    inputs:
      registry:
        description: 'Container registry'
        required: true
        type: string
      github_repository:
        description: 'GitHub repository'
        required: true
        type: string
      github_sha:
        description: 'GitHub SHA'
        required: true
        type: string
    secrets:
      GH_TOKEN:
        required: true

jobs:
  build-engineering-app:
    name: Build Engineering App Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Job Info - Engineering App (6/8)
      run: |
        echo "Starting build for: engineering-app"
        echo "Job Index: 6/8"
        echo "Build Group: docker-builds"
        echo "Start Time: $(date)"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ github.actor }}
        password: ${{ secrets.GH_TOKEN }}

    - name: Build Engineering App Docker Image
      run: |
        echo "Building engineering-app..."
        
        cat > "apps/engineering-app/Dockerfile" << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        
        # 复制配置文件
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY .npmrc* ./
        COPY turbo.json ./
        COPY tsconfig.json ./
        
        # 复制源代码
        COPY apps/ ./apps/
        COPY packages/ ./packages/
        COPY auth/ ./auth/
        COPY scripts/ ./scripts/
        COPY configs/ ./configs/
        
        # 安装pnpm
        RUN npm install -g pnpm@8.15.0
        RUN pnpm config set store-dir /root/.local/share/pnpm/store
        
        # 安装依赖
        RUN pnpm install --no-frozen-lockfile
        
        # 先构建必需的共享包
        RUN pnpm --filter @btc/vite-plugin run build
        RUN pnpm --filter @btc/shared-utils run build
        RUN pnpm --filter @btc/shared-core run build
        RUN pnpm --filter @btc/shared-components run build
        
        # 构建应用
        RUN cd apps/engineering-app && pnpm run build
        
        FROM nginx:alpine
        COPY --from=builder /app/apps/engineering-app/dist /usr/share/nginx/html
        RUN echo 'server { listen 80; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
        
        docker build -t btc-shopflow/engineering-app:latest -f apps/engineering-app/Dockerfile .
        docker tag btc-shopflow/engineering-app:latest ${{ inputs.registry }}/$(echo "${{ inputs.github_repository }}" | tr '[:upper:]' '[:lower:]')/engineering-app:latest
        docker push ${{ inputs.registry }}/$(echo "${{ inputs.github_repository }}" | tr '[:upper:]' '[:lower:]')/engineering-app:latest

    - name: Build Complete
      run: |
        echo "Engineering App build completed successfully"
        echo "Image: ${{ inputs.registry }}/$(echo "${{ inputs.github_repository }}" | tr '[:upper:]' '[:lower:]')/engineering-app:latest"
