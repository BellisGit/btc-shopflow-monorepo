name: Build and Deploy App to K8s (Reusable)

# ‚ö†Ô∏è Ê≠§Â∑•‰ΩúÊµÅÊòØÂèØÂ§çÁî®ÁöÑÔºå‰∏ç‰ºöËá™Âä®Ëß¶Âèë
# - Âè™ËÉΩÈÄöËøáÂÖ∂‰ªñÂ∑•‰ΩúÊµÅË∞ÉÁî®Ôºàworkflow_callÔºâ
# - Áî®‰∫éÊûÑÂª∫Â∫îÁî®Âπ∂Á´ãÂç≥ÈÉ®ÁΩ≤Âà∞ Kubernetes ÈõÜÁæ§
# - ÊØè‰∏™Â∫îÁî®Áã¨Á´ãÂÆåÊàêÊûÑÂª∫‚ÜíÈÉ®ÁΩ≤ÊµÅÁ®ãÔºå‰∏çÁ≠âÂæÖÂÖ∂‰ªñÂ∫îÁî®

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application name (e.g., system-app, admin-app)'
        required: true
        type: string
      registry:
        description: 'Container registry URL'
        required: true
        type: string
      github_repository:
        description: 'GitHub repository name'
        required: true
        type: string
      github_sha:
        description: 'GitHub commit SHA'
        required: true
        type: string
      github_repository_owner:
        description: 'GitHub repository owner (lowercase)'
        required: true
        type: string
      image_tag:
        description: 'Docker image tag (e.g., commit SHA short)'
        required: true
        type: string
      k8s_namespace:
        description: 'K8s namespace (default: btc-shopflow)'
        required: false
        type: string
        default: 'btc-shopflow'
      skip_build:
        description: 'Skip build step'
        required: false
        type: boolean
        default: false
      skip_deploy:
        description: 'Skip deploy step'
        required: false
        type: boolean
        default: false
    secrets:
      gh_token:
        description: 'GitHub token for registry access'
        required: true
      K8S_SERVER:
        required: false
      K8S_CA_CERT:
        required: false
      K8S_TOKEN:
        required: false
      SERVER_HOST:
        required: false
      SERVER_USER:
        required: false
      SERVER_KEY:
        required: false
      SERVER_PORT:
        required: false
      SERVER_PAT:
        required: false

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  build-and-deploy:
    name: Build and Deploy ${{ inputs.app_name }}
    runs-on: ubuntu-latest
    outputs:
      has_k8s_config: ${{ steps.configure-k8s.outputs.has_k8s_config }}
      image_tag: ${{ inputs.image_tag }}
    
    steps:
      # ========== ÊûÑÂª∫Èò∂ÊÆµ ==========
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ========== ÊûÑÂª∫Èò∂ÊÆµÔºà‰ªÖÂú®Êú™Ë∑≥ËøáÊó∂ÊâßË°åÔºâ==========
      - name: Setup Node.js
        if: inputs.skip_build != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        if: inputs.skip_build != 'true'
        uses: pnpm/action-setup@v4
      
      - name: Get pnpm store directory
        if: inputs.skip_build != 'true'
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm store
        if: inputs.skip_build != 'true'
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        if: inputs.skip_build != 'true'
        run: |
          pnpm install --frozen-lockfile --prefer-offline
      
      - name: Restore built packages cache
        if: inputs.skip_build != 'true'
        uses: actions/cache@v3
        with:
          path: |
            packages/*/dist
            packages/*/build
          key: packages-build-${{ inputs.github_sha }}
          restore-keys: |
            packages-build-
      
      - name: Build dependencies if needed
        if: inputs.skip_build != 'true'
        run: |
          if [ ! -d "packages/vite-plugin/dist" ] || [ ! -f "packages/vite-plugin/dist/index.js" ]; then
            echo "Building dependencies for ${{ inputs.app_name }}..."
            pnpm --filter @btc/vite-plugin run build
            pnpm --filter @btc/shared-utils run build
            pnpm --filter @btc/shared-core run build
            pnpm --filter @btc/shared-components run build
            pnpm --filter @btc/subapp-manifests run build
          else
            echo "Using cached built packages"
          fi
      
      - name: Build application
        if: inputs.skip_build != 'true'
        run: cd apps/${{ inputs.app_name }} && pnpm run build
      
      - name: Skip build (placeholder)
        if: inputs.skip_build == 'true'
        run: echo "‚è≠Ô∏è  Ë∑≥ËøáÊûÑÂª∫Ê≠•È™§Ôºà‰ΩøÁî®Â∑≤ÊúâÈïúÂÉèÔºâ"
      
      # ========== Docker ÊûÑÂª∫ÂíåÊé®ÈÄÅÔºà‰ªÖÂú®Êú™Ë∑≥ËøáÊûÑÂª∫Êó∂ÊâßË°åÔºâ==========
      - name: Validate GitHub Token
        if: inputs.skip_build != 'true'
        run: |
          echo "Validating GitHub token for registry access..."
          # ‰ºòÂÖà‰ΩøÁî®‰º†ÂÖ•ÁöÑ gh_tokenÔºåÂ¶ÇÊûú‰∏∫Á©∫ÊàñÊú™ÂÆö‰πâÂàô‰ΩøÁî® github.token
          GH_TOKEN="${{ secrets.gh_token }}"
          if [ -n "$GH_TOKEN" ] && [ "$GH_TOKEN" != "" ]; then
            TOKEN="$GH_TOKEN"
            echo "[INFO] Using provided gh_token"
          else
            TOKEN="${{ github.token }}"
            echo "[INFO] Using github.token as fallback"
          fi
          # ÊúÄÁªàÊ£ÄÊü•ÔºöÂ¶ÇÊûú TOKEN ‰ªçÁÑ∂‰∏∫Á©∫ÔºåÂ∞ùËØï‰ΩøÁî® github.token
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "" ]; then
            TOKEN="${{ github.token }}"
            echo "[INFO] Fallback to github.token"
          fi
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "" ]; then
            echo "[ERROR] No token available"
            echo "[DEBUG] GH_TOKEN value: '${GH_TOKEN:-empty}'"
            echo "[DEBUG] github.token value: '${GITHUB_TOKEN:-empty}'"
            exit 1
          fi
          echo "[SUCCESS] Token is available"
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
      
      - name: Prepare Docker tags
        if: inputs.skip_build != 'true'
        id: tags
        run: |
          REPO_LOWER=$(echo "${{ inputs.github_repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repository_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
      
      - name: Login to Container Registry
        if: inputs.skip_build != 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ github.actor }}
          password: ${{ env.TOKEN }}
      
      - name: Set up Docker Buildx
        if: inputs.skip_build != 'true'
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push Docker image
        if: inputs.skip_build != 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            APP_DIR=apps/${{ inputs.app_name }}
          push: true
          tags: |
            ${{ inputs.registry }}/${{ steps.tags.outputs.repository_lower }}/${{ inputs.app_name }}:latest
            ${{ inputs.registry }}/${{ steps.tags.outputs.repository_lower }}/${{ inputs.app_name }}:${{ inputs.github_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        env:
          DOCKER_BUILDKIT: 1
      
      # ========== ÈÉ®ÁΩ≤Èò∂ÊÆµ ==========
      - name: Setup kubectl
        if: inputs.skip_deploy != 'true'
        uses: azure/setup-kubectl@v3
      
      - name: Skip deploy (placeholder)
        if: inputs.skip_deploy == 'true'
        run: |
          echo "‚è≠Ô∏è  Ë∑≥ËøáÈÉ®ÁΩ≤Ê≠•È™§Ôºàskip_deploy=trueÔºâ"
      
      - name: Configure K8s
        if: inputs.skip_deploy != 'true'
        id: configure-k8s
        run: |
          # ÈÖçÁΩÆ kubectlÔºà‰ΩøÁî® secrets ‰∏≠ÁöÑÈÖçÁΩÆÔºâ
          if [ -z "${{ secrets.K8S_SERVER }}" ]; then
            echo "‚ö†Ô∏è  Êú™ÈÖçÁΩÆ K8s ÈõÜÁæ§‰ø°ÊÅØÔºàK8S_SERVER secret ‰∏çÂ≠òÂú®Ôºâ"
            echo "Ë∑≥Ëøá K8s ÈÉ®ÁΩ≤Ê≠•È™§"
            echo ""
            echo "Â¶ÇÈúÄÈÉ®ÁΩ≤Âà∞ K8sÔºåËØ∑Âú® GitHub Secrets ‰∏≠ÈÖçÁΩÆÔºö"
            echo "  - K8S_SERVER: K8s API ÊúçÂä°Âô®Âú∞ÂùÄ"
            echo "  - K8S_CA_CERT: CA ËØÅ‰π¶Ôºàbase64 ÁºñÁ†ÅÔºâ"
            echo "  - K8S_TOKEN: ËÆøÈóÆ‰ª§Áâå"
            echo "has_k8s_config=false" >> $GITHUB_OUTPUT
            echo "has_k8s_config=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "has_k8s_config=true" >> $GITHUB_OUTPUT
          echo "has_k8s_config=true" >> $GITHUB_ENV
          
          echo "ÈÖçÁΩÆ kubectl..."
          mkdir -p ~/.kube
          cat > ~/.kube/config <<EOF
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              server: ${{ secrets.K8S_SERVER }}
              certificate-authority-data: ${{ secrets.K8S_CA_CERT }}
            name: k8s-cluster
          contexts:
          - context:
              cluster: k8s-cluster
              user: k8s-user
            name: k8s-context
          current-context: k8s-context
          users:
          - name: k8s-user
            user:
              token: ${{ secrets.K8S_TOKEN }}
          EOF
          
          # ÊòæÂºèËÆæÁΩÆ KUBECONFIG ÁéØÂ¢ÉÂèòÈáè
          export KUBECONFIG=~/.kube/config
          echo "KUBECONFIG=~/.kube/config" >> $GITHUB_ENV
          echo "has_k8s_config=true" >> $GITHUB_ENV
          
          # È™åËØÅÈÖçÁΩÆÊñá‰ª∂Â∑≤ÂàõÂª∫
          if [ ! -f ~/.kube/config ]; then
            echo "‚ùå kubectl ÈÖçÁΩÆÊñá‰ª∂ÂàõÂª∫Â§±Ë¥•"
            exit 1
          fi
          
          kubectl config use-context k8s-context
          echo "‚úÖ K8s ÈÖçÁΩÆÂÆåÊàê"
          
          # È™åËØÅ kubectl ËøûÊé•Ôºà‰∏çÂº∫Âà∂Ë¶ÅÊ±ÇÊàêÂäüÔºåÂõ†‰∏∫ÂèØËÉΩÊòØÁΩëÁªúÈóÆÈ¢òÔºâ
          echo "È™åËØÅ kubectl ËøûÊé•..."
          if kubectl cluster-info >/dev/null 2>&1; then
            echo "‚úÖ kubectl ËøûÊé•Ê≠£Â∏∏"
          else
            echo "‚ö†Ô∏è  Êó†Ê≥ïËøûÊé•Âà∞ÈõÜÁæ§Ôºå‰ΩÜÈÖçÁΩÆÂ∑≤ÂàõÂª∫ÔºàÂèØËÉΩÊòØÁΩëÁªúÈóÆÈ¢òÊàñÈõÜÁæ§ÊöÇÊó∂‰∏çÂèØÁî®Ôºâ"
          fi
      
      - name: Deploy application
        if: inputs.skip_deploy != 'true' && steps.configure-k8s.outputs.has_k8s_config == 'true'
        run: |
          # Á°Æ‰øù kubectl ÈÖçÁΩÆÂ∑≤Âä†ËΩΩÔºàÈÖçÁΩÆÂ∫îËØ•Âú® Configure K8s step ‰∏≠Â∑≤ÂàõÂª∫Ôºâ
          # ‰ΩøÁî® GITHUB_ENV ‰∏≠ÁöÑ KUBECONFIGÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®Âàô‰ΩøÁî®ÈªòËÆ§Ë∑ØÂæÑ
          if [ -n "$KUBECONFIG" ]; then
            export KUBECONFIG="$KUBECONFIG"
          else
            export KUBECONFIG=~/.kube/config
          fi
          
          # È™åËØÅ kubectl ÈÖçÁΩÆ
          if [ ! -f "$KUBECONFIG" ]; then
            echo "‚ùå kubectl ÈÖçÁΩÆ‰∏çÂ≠òÂú®: $KUBECONFIG"
            echo "ËØ∑Á°Æ‰øù Configure K8s step Â∑≤ÊàêÂäüÊâßË°å"
            echo "Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®:"
            ls -la ~/.kube/ || echo "~/.kube ÁõÆÂΩï‰∏çÂ≠òÂú®"
            exit 1
          fi
          
          echo "‚úÖ ‰ΩøÁî® kubectl ÈÖçÁΩÆ: $KUBECONFIG"
          
          # È™åËØÅ kubectl ÂèØ‰ª•ËøûÊé•Âà∞ÈõÜÁæ§Ôºà‰∏çÂº∫Âà∂Ë¶ÅÊ±ÇÊàêÂäüÔºâ
          echo "È™åËØÅ kubectl ËøûÊé•..."
          if kubectl cluster-info >/dev/null 2>&1; then
            echo "‚úÖ kubectl ËøûÊé•Ê≠£Â∏∏"
          else
            echo "‚ö†Ô∏è  kubectl Êó†Ê≥ïËøûÊé•Âà∞ÈõÜÁæ§Ôºå‰ΩÜÁªßÁª≠Â∞ùËØïÈÉ®ÁΩ≤ÔºàÂèØËÉΩÊòØÁΩëÁªúÈóÆÈ¢òÔºâ"
          fi
          
          APP_NAME="${{ inputs.app_name }}"
          IMAGE_TAG="${{ inputs.image_tag }}"
          REGISTRY="${{ inputs.registry }}"
          REPO_OWNER="${{ inputs.github_repository_owner }}"
          K8S_NAMESPACE="${{ inputs.k8s_namespace }}"
          
          # Â∫îÁî®ÂêçÁß∞Âà∞ Deployment ÂêçÁß∞ÁöÑÊò†Â∞Ñ
          declare -A DEPLOYMENT_NAMES=(
            ["system-app"]="btc-system-app"
            ["admin-app"]="btc-admin-app"
            ["logistics-app"]="btc-logistics-app"
            ["quality-app"]="btc-quality-app"
            ["production-app"]="btc-production-app"
            ["engineering-app"]="btc-engineering-app"
            ["finance-app"]="btc-finance-app"
            ["mobile-app"]="btc-mobile-app"
          )
          
          DEPLOYMENT_NAME="${DEPLOYMENT_NAMES[$APP_NAME]}"
          FULL_IMAGE_TAG="$REGISTRY/$REPO_OWNER/$APP_NAME:$IMAGE_TAG"
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üöÄ ÈÉ®ÁΩ≤Â∫îÁî®: $APP_NAME"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Deployment: $DEPLOYMENT_NAME"
          echo "ÈïúÂÉè: $FULL_IMAGE_TAG"
          echo "ÂëΩÂêçÁ©∫Èó¥: $K8S_NAMESPACE"
          
          # Ê£ÄÊü• Deployment ÊòØÂê¶Â≠òÂú®
          if kubectl get deployment "$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" >/dev/null 2>&1; then
            echo "‚úÖ Êõ¥Êñ∞Áé∞Êúâ Deployment..."
            kubectl set image deployment/"$DEPLOYMENT_NAME" "$APP_NAME=$FULL_IMAGE_TAG" -n "$K8S_NAMESPACE"
            kubectl rollout status deployment/"$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" --timeout=5m
            echo "‚úÖ $APP_NAME ÈÉ®ÁΩ≤ÂÆåÊàê"
          else
            echo "‚ö†Ô∏è  Deployment ‰∏çÂ≠òÂú®: $DEPLOYMENT_NAME"
            echo "Â∞ùËØï‰ªé YAML Êñá‰ª∂ÂàõÂª∫ Deployment..."
            
            # Êü•ÊâæÂØπÂ∫îÁöÑ YAML Êñá‰ª∂
            YAML_FILE=""
            # Ê£ÄÊü•Âçï‰∏™Â∫îÁî®ÁöÑ YAML Êñá‰ª∂
            if [ -f "k8s/deployments/$APP_NAME.yaml" ]; then
              YAML_FILE="k8s/deployments/$APP_NAME.yaml"
              echo "ÊâæÂà∞Âçï‰∏™Â∫îÁî® YAML Êñá‰ª∂: $YAML_FILE"
            # Ê£ÄÊü• all-apps.yamlÔºàÂåÖÂê´Â§ö‰∏™Â∫îÁî®Ôºâ
            elif [ -f "k8s/deployments/all-apps.yaml" ]; then
              YAML_FILE="k8s/deployments/all-apps.yaml"
              echo "ÊâæÂà∞Â§öÂ∫îÁî® YAML Êñá‰ª∂: $YAML_FILE"
            fi
            
            if [ -n "$YAML_FILE" ] && [ -f "$YAML_FILE" ]; then
              echo "ÂàõÂª∫ Deployment Âπ∂ËÆæÁΩÆÈïúÂÉè: $FULL_IMAGE_TAG"
              
              # ÂàõÂª∫‰∏¥Êó∂ YAML Êñá‰ª∂ÔºåÊõøÊç¢ÈïúÂÉèÊ†áÁ≠æÂíåÂëΩÂêçÁ©∫Èó¥
              TEMP_YAML=$(mktemp)
              cp "$YAML_FILE" "$TEMP_YAML"
              
              # ÊõøÊç¢ÈïúÂÉèÊ†áÁ≠æÔºàÂåπÈÖçÂåÖÂê´Â∫îÁî®ÂêçÁß∞ÁöÑÈïúÂÉèË°åÔºâ
              sed -i "s|image:.*$APP_NAME.*|image: $FULL_IMAGE_TAG|g" "$TEMP_YAML"
              # Á°Æ‰øùÂëΩÂêçÁ©∫Èó¥Ê≠£Á°ÆÔºàÊõøÊç¢ÊâÄÊúâ namespace Â≠óÊÆµÔºâ
              sed -i "s|namespace:.*|namespace: $K8S_NAMESPACE|g" "$TEMP_YAML"
              
              # Â∫îÁî® YAML Êñá‰ª∂Ôºàkubectl apply ‰ºöËá™Âä®Âè™Â∫îÁî®Áõ∏ÂÖ≥ÁöÑËµÑÊ∫êÔºâ
              # ‰ΩøÁî® --validate=false Ë∑≥ËøáÂÆ¢Êà∑Á´ØÈ™åËØÅÔºåÈÅøÂÖç OpenAPI schema ‰∏ãËΩΩÂ§±Ë¥•
              # ‰ΩøÁî® --server-side Âú®ÊúçÂä°Âô®Á´ØÂ∫îÁî®ÔºåÈÅøÂÖçÂÆ¢Êà∑Á´ØÈ™åËØÅÈóÆÈ¢ò
              echo "Â∫îÁî® YAML Êñá‰ª∂..."
              kubectl apply -f "$TEMP_YAML" -n "$K8S_NAMESPACE" --validate=false --server-side || \
              kubectl apply -f "$TEMP_YAML" -n "$K8S_NAMESPACE" --validate=false
              
              # Á≠âÂæÖ Deployment Â∞±Áª™
              echo "Á≠âÂæÖ Deployment Â∞±Áª™..."
              if kubectl wait --for=condition=available --timeout=5m deployment/"$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" 2>/dev/null; then
                echo "‚úÖ Deployment Â∑≤Â∞±Áª™"
              else
                echo "‚ö†Ô∏è  Deployment ÂàõÂª∫ÊàêÂäüÔºå‰ΩÜÂèØËÉΩÂ∞öÊú™ÂÆåÂÖ®Â∞±Áª™"
              fi
              
              # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
              rm -f "$TEMP_YAML"
              
              echo "‚úÖ $APP_NAME ÈÉ®ÁΩ≤ÂÆåÊàêÔºà‰ªé YAML ÂàõÂª∫Ôºâ"
            else
              echo "‚ùå Êú™ÊâæÂà∞ YAML Êñá‰ª∂: k8s/deployments/$APP_NAME.yaml Êàñ k8s/deployments/all-apps.yaml"
              echo "ËØ∑ÂÖàÂàõÂª∫ Deployment ÊàñÁ°Æ‰øù YAML Êñá‰ª∂Â≠òÂú®"
              exit 1
            fi
          fi
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ $APP_NAME ÊûÑÂª∫ÂíåÈÉ®ÁΩ≤ÊàêÂäü"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

  determine-server-port:
    name: Determine Server Port
    needs: build-and-deploy
    if: inputs.skip_deploy != 'true' && needs.build-and-deploy.outputs.has_k8s_config == 'false'
    runs-on: ubuntu-latest
    outputs:
      app_port: ${{ steps.port.outputs.app_port }}
    steps:
      - name: Determine app port
        id: port
        run: |
          APP_NAME="${{ inputs.app_name }}"
          case "$APP_NAME" in
            system-app)
              APP_PORT="30080"
              ;;
            admin-app)
              APP_PORT="30081"
              ;;
            logistics-app)
              APP_PORT="30082"
              ;;
            quality-app)
              APP_PORT="30083"
              ;;
            production-app)
              APP_PORT="30084"
              ;;
            engineering-app)
              APP_PORT="30085"
              ;;
            finance-app)
              APP_PORT="30086"
              ;;
            mobile-app)
              APP_PORT="30091"
              ;;
            *)
              APP_PORT="8080"
              ;;
          esac
          echo "app_port=$APP_PORT" >> $GITHUB_OUTPUT
          echo "‚úÖ Â∫îÁî®Á´ØÂè£: $APP_PORT"

  deploy-to-server:
    name: Deploy ${{ inputs.app_name }} to Server
    needs: [build-and-deploy, determine-server-port]
    if: inputs.skip_deploy != 'true' && needs.build-and-deploy.outputs.has_k8s_config == 'false'
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: ${{ inputs.app_name }}
      app_port: ${{ needs.determine-server-port.outputs.app_port }}
      container_name: btc-${{ inputs.app_name }}
      image_tag: ${{ needs.build-and-deploy.outputs.image_tag }}
    secrets:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_KEY: ${{ secrets.SERVER_KEY }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SERVER_PAT: ${{ secrets.SERVER_PAT }}
      GITHUB_TOKEN: ${{ github.token }}

