name: Build and Deploy App to K8s (Reusable)

# âš ï¸ æ­¤å·¥ä½œæµæ˜¯å¯å¤ç”¨çš„ï¼Œä¸ä¼šè‡ªåŠ¨è§¦å‘
# - åªèƒ½é€šè¿‡å…¶ä»–å·¥ä½œæµè°ƒç”¨ï¼ˆworkflow_callï¼‰
# - ç”¨äºæ„å»ºåº”ç”¨å¹¶ç«‹å³éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤
# - æ¯ä¸ªåº”ç”¨ç‹¬ç«‹å®Œæˆæ„å»ºâ†’éƒ¨ç½²æµç¨‹ï¼Œä¸ç­‰å¾…å…¶ä»–åº”ç”¨

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application name (e.g., system-app, admin-app)'
        required: true
        type: string
      registry:
        description: 'Container registry URL'
        required: true
        type: string
      github_repository:
        description: 'GitHub repository name'
        required: true
        type: string
      github_sha:
        description: 'GitHub commit SHA'
        required: true
        type: string
      github_repository_owner:
        description: 'GitHub repository owner (lowercase)'
        required: true
        type: string
      image_tag:
        description: 'Docker image tag (e.g., commit SHA short)'
        required: true
        type: string
      k8s_namespace:
        description: 'K8s namespace (default: btc-shopflow)'
        required: false
        type: string
        default: 'btc-shopflow'
      skip_build:
        description: 'Skip build step'
        required: false
        type: boolean
        default: false
      skip_deploy:
        description: 'Skip deploy step'
        required: false
        type: boolean
        default: false
    secrets:
      gh_token:
        description: 'GitHub token for registry access'
        required: true
      K8S_SERVER:
        required: false
      K8S_CA_CERT:
        required: false
      K8S_TOKEN:
        required: false

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  build-and-deploy:
    name: Build and Deploy ${{ inputs.app_name }}
    runs-on: ubuntu-latest
    outputs:
      has_k8s_config: ${{ steps.configure-k8s.outputs.has_k8s_config }}
      image_tag: ${{ inputs.image_tag }}
    
    steps:
      # ========== æ„å»ºé˜¶æ®µ ==========
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ========== æ„å»ºé˜¶æ®µï¼ˆä»…åœ¨æœªè·³è¿‡æ—¶æ‰§è¡Œï¼‰==========
      - name: Setup Node.js
        if: inputs.skip_build != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        if: inputs.skip_build != 'true'
        uses: pnpm/action-setup@v4
      
      - name: Get pnpm store directory
        if: inputs.skip_build != 'true'
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm store
        if: inputs.skip_build != 'true'
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        if: inputs.skip_build != 'true'
        run: |
          pnpm install --frozen-lockfile --prefer-offline
      
      - name: Restore built packages cache
        if: inputs.skip_build != 'true'
        uses: actions/cache@v3
        with:
          path: |
            packages/*/dist
            packages/*/build
          key: packages-build-${{ inputs.github_sha }}
          restore-keys: |
            packages-build-
      
      - name: Build dependencies if needed
        if: inputs.skip_build != 'true'
        run: |
          if [ ! -d "packages/vite-plugin/dist" ] || [ ! -f "packages/vite-plugin/dist/index.js" ]; then
            echo "Building dependencies for ${{ inputs.app_name }}..."
            pnpm --filter @btc/vite-plugin run build
            pnpm --filter @btc/shared-utils run build
            pnpm --filter @btc/shared-core run build
            pnpm --filter @btc/shared-components run build
            pnpm --filter @btc/subapp-manifests run build
          else
            echo "Using cached built packages"
          fi
      
      - name: Build application
        if: inputs.skip_build != 'true'
        run: cd apps/${{ inputs.app_name }} && pnpm run build
      
      - name: Skip build (placeholder)
        if: inputs.skip_build == 'true'
        run: echo "â­ï¸  è·³è¿‡æ„å»ºæ­¥éª¤ï¼ˆä½¿ç”¨å·²æœ‰é•œåƒï¼‰"
      
      # ========== Docker æ„å»ºå’Œæ¨é€ï¼ˆä»…åœ¨æœªè·³è¿‡æ„å»ºæ—¶æ‰§è¡Œï¼‰==========
      - name: Validate GitHub Token
        if: inputs.skip_build != 'true'
        run: |
          echo "Validating GitHub token for registry access..."
          # ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ gh_tokenï¼Œå¦‚æœä¸ºç©ºæˆ–æœªå®šä¹‰åˆ™ä½¿ç”¨ github.token
          GH_TOKEN="${{ secrets.gh_token }}"
          if [ -n "$GH_TOKEN" ] && [ "$GH_TOKEN" != "" ]; then
            TOKEN="$GH_TOKEN"
            echo "[INFO] Using provided gh_token"
          else
            TOKEN="${{ github.token }}"
            echo "[INFO] Using github.token as fallback"
          fi
          # æœ€ç»ˆæ£€æŸ¥ï¼šå¦‚æœ TOKEN ä»ç„¶ä¸ºç©ºï¼Œå°è¯•ä½¿ç”¨ github.token
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "" ]; then
            TOKEN="${{ github.token }}"
            echo "[INFO] Fallback to github.token"
          fi
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "" ]; then
            echo "[ERROR] No token available"
            echo "[DEBUG] GH_TOKEN value: '${GH_TOKEN:-empty}'"
            echo "[DEBUG] github.token value: '${GITHUB_TOKEN:-empty}'"
            exit 1
          fi
          echo "[SUCCESS] Token is available"
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
      
      - name: Prepare Docker tags
        if: inputs.skip_build != 'true'
        id: tags
        run: |
          REPO_LOWER=$(echo "${{ inputs.github_repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repository_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
      
      - name: Login to Container Registry
        if: inputs.skip_build != 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ github.actor }}
          password: ${{ env.TOKEN }}
      
      - name: Set up Docker Buildx
        if: inputs.skip_build != 'true'
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push Docker image
        if: inputs.skip_build != 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            APP_DIR=apps/${{ inputs.app_name }}
          push: true
          tags: |
            ${{ inputs.registry }}/${{ steps.tags.outputs.repository_lower }}/${{ inputs.app_name }}:latest
            ${{ inputs.registry }}/${{ steps.tags.outputs.repository_lower }}/${{ inputs.app_name }}:${{ inputs.github_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        env:
          DOCKER_BUILDKIT: 1
      
      # ========== éƒ¨ç½²é˜¶æ®µ ==========
      - name: Setup kubectl
        if: inputs.skip_deploy != 'true'
        uses: azure/setup-kubectl@v3
      
      - name: Skip deploy (placeholder)
        if: inputs.skip_deploy == 'true'
        run: |
          echo "â­ï¸  è·³è¿‡éƒ¨ç½²æ­¥éª¤ï¼ˆskip_deploy=trueï¼‰"
      
      - name: Configure K8s
        if: inputs.skip_deploy != 'true'
        id: configure-k8s
        run: |
          # é…ç½® kubectlï¼ˆä½¿ç”¨ secrets ä¸­çš„é…ç½®ï¼‰
          if [ -z "${{ secrets.K8S_SERVER }}" ]; then
            echo "âš ï¸  æœªé…ç½® K8s é›†ç¾¤ä¿¡æ¯ï¼ˆK8S_SERVER secret ä¸å­˜åœ¨ï¼‰"
            echo "è·³è¿‡ K8s éƒ¨ç½²æ­¥éª¤"
            echo ""
            echo "å¦‚éœ€éƒ¨ç½²åˆ° K8sï¼Œè¯·åœ¨ GitHub Secrets ä¸­é…ç½®ï¼š"
            echo "  - K8S_SERVER: K8s API æœåŠ¡å™¨åœ°å€"
            echo "  - K8S_CA_CERT: CA è¯ä¹¦ï¼ˆbase64 ç¼–ç ï¼‰"
            echo "  - K8S_TOKEN: è®¿é—®ä»¤ç‰Œ"
            echo "has_k8s_config=false" >> $GITHUB_OUTPUT
            echo "has_k8s_config=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "has_k8s_config=true" >> $GITHUB_OUTPUT
          echo "has_k8s_config=true" >> $GITHUB_ENV
          
          echo "é…ç½® kubectl..."
          mkdir -p ~/.kube
          cat > ~/.kube/config <<EOF
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              server: ${{ secrets.K8S_SERVER }}
              certificate-authority-data: ${{ secrets.K8S_CA_CERT }}
            name: k8s-cluster
          contexts:
          - context:
              cluster: k8s-cluster
              user: k8s-user
            name: k8s-context
          current-context: k8s-context
          users:
          - name: k8s-user
            user:
              token: ${{ secrets.K8S_TOKEN }}
          EOF
          
          # æ˜¾å¼è®¾ç½® KUBECONFIG ç¯å¢ƒå˜é‡
          export KUBECONFIG=~/.kube/config
          echo "KUBECONFIG=~/.kube/config" >> $GITHUB_ENV
          echo "has_k8s_config=true" >> $GITHUB_ENV
          
          # éªŒè¯é…ç½®æ–‡ä»¶å·²åˆ›å»º
          if [ ! -f ~/.kube/config ]; then
            echo "âŒ kubectl é…ç½®æ–‡ä»¶åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          kubectl config use-context k8s-context
          echo "âœ… K8s é…ç½®å®Œæˆ"
          
          # éªŒè¯ kubectl è¿æ¥ï¼ˆä¸å¼ºåˆ¶è¦æ±‚æˆåŠŸï¼Œå› ä¸ºå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰
          echo "éªŒè¯ kubectl è¿æ¥..."
          if kubectl cluster-info >/dev/null 2>&1; then
            echo "âœ… kubectl è¿æ¥æ­£å¸¸"
          else
            echo "âš ï¸  æ— æ³•è¿æ¥åˆ°é›†ç¾¤ï¼Œä½†é…ç½®å·²åˆ›å»ºï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–é›†ç¾¤æš‚æ—¶ä¸å¯ç”¨ï¼‰"
          fi
      
      - name: Deploy application
        if: inputs.skip_deploy != 'true' && steps.configure-k8s.outputs.has_k8s_config == 'true'
        run: |
          # ç¡®ä¿ kubectl é…ç½®å·²åŠ è½½ï¼ˆé…ç½®åº”è¯¥åœ¨ Configure K8s step ä¸­å·²åˆ›å»ºï¼‰
          # ä½¿ç”¨ GITHUB_ENV ä¸­çš„ KUBECONFIGï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„
          if [ -n "$KUBECONFIG" ]; then
            export KUBECONFIG="$KUBECONFIG"
          else
            export KUBECONFIG=~/.kube/config
          fi
          
          # éªŒè¯ kubectl é…ç½®
          if [ ! -f "$KUBECONFIG" ]; then
            echo "âŒ kubectl é…ç½®ä¸å­˜åœ¨: $KUBECONFIG"
            echo "è¯·ç¡®ä¿ Configure K8s step å·²æˆåŠŸæ‰§è¡Œ"
            echo "æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
            ls -la ~/.kube/ || echo "~/.kube ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… ä½¿ç”¨ kubectl é…ç½®: $KUBECONFIG"
          
          # éªŒè¯ kubectl å¯ä»¥è¿æ¥åˆ°é›†ç¾¤ï¼ˆä¸å¼ºåˆ¶è¦æ±‚æˆåŠŸï¼‰
          echo "éªŒè¯ kubectl è¿æ¥..."
          if kubectl cluster-info >/dev/null 2>&1; then
            echo "âœ… kubectl è¿æ¥æ­£å¸¸"
          else
            echo "âš ï¸  kubectl æ— æ³•è¿æ¥åˆ°é›†ç¾¤ï¼Œä½†ç»§ç»­å°è¯•éƒ¨ç½²ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰"
          fi
          
          APP_NAME="${{ inputs.app_name }}"
          IMAGE_TAG="${{ inputs.image_tag }}"
          REGISTRY="${{ inputs.registry }}"
          REPO_OWNER="${{ inputs.github_repository_owner }}"
          K8S_NAMESPACE="${{ inputs.k8s_namespace }}"
          
          # åº”ç”¨åç§°åˆ° Deployment åç§°çš„æ˜ å°„
          declare -A DEPLOYMENT_NAMES=(
            ["system-app"]="btc-system-app"
            ["admin-app"]="btc-admin-app"
            ["logistics-app"]="btc-logistics-app"
            ["quality-app"]="btc-quality-app"
            ["production-app"]="btc-production-app"
            ["engineering-app"]="btc-engineering-app"
            ["finance-app"]="btc-finance-app"
            ["mobile-app"]="btc-mobile-app"
          )
          
          DEPLOYMENT_NAME="${DEPLOYMENT_NAMES[$APP_NAME]}"
          FULL_IMAGE_TAG="$REGISTRY/$REPO_OWNER/$APP_NAME:$IMAGE_TAG"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ éƒ¨ç½²åº”ç”¨: $APP_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Deployment: $DEPLOYMENT_NAME"
          echo "é•œåƒ: $FULL_IMAGE_TAG"
          echo "å‘½åç©ºé—´: $K8S_NAMESPACE"
          
          # æ£€æŸ¥ Deployment æ˜¯å¦å­˜åœ¨
          if kubectl get deployment "$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" >/dev/null 2>&1; then
            echo "âœ… æ›´æ–°ç°æœ‰ Deployment..."
            kubectl set image deployment/"$DEPLOYMENT_NAME" "$APP_NAME=$FULL_IMAGE_TAG" -n "$K8S_NAMESPACE"
            kubectl rollout status deployment/"$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" --timeout=5m
            echo "âœ… $APP_NAME éƒ¨ç½²å®Œæˆ"
          else
            echo "âš ï¸  Deployment ä¸å­˜åœ¨: $DEPLOYMENT_NAME"
            echo "å°è¯•ä» YAML æ–‡ä»¶åˆ›å»º Deployment..."
            
            # æŸ¥æ‰¾å¯¹åº”çš„ YAML æ–‡ä»¶
            YAML_FILE=""
            # æ£€æŸ¥å•ä¸ªåº”ç”¨çš„ YAML æ–‡ä»¶
            if [ -f "k8s/deployments/$APP_NAME.yaml" ]; then
              YAML_FILE="k8s/deployments/$APP_NAME.yaml"
              echo "æ‰¾åˆ°å•ä¸ªåº”ç”¨ YAML æ–‡ä»¶: $YAML_FILE"
            # æ£€æŸ¥ all-apps.yamlï¼ˆåŒ…å«å¤šä¸ªåº”ç”¨ï¼‰
            elif [ -f "k8s/deployments/all-apps.yaml" ]; then
              YAML_FILE="k8s/deployments/all-apps.yaml"
              echo "æ‰¾åˆ°å¤šåº”ç”¨ YAML æ–‡ä»¶: $YAML_FILE"
            fi
            
            if [ -n "$YAML_FILE" ] && [ -f "$YAML_FILE" ]; then
              echo "åˆ›å»º Deployment å¹¶è®¾ç½®é•œåƒ: $FULL_IMAGE_TAG"
              
              # åˆ›å»ºä¸´æ—¶ YAML æ–‡ä»¶ï¼Œæ›¿æ¢é•œåƒæ ‡ç­¾å’Œå‘½åç©ºé—´
              TEMP_YAML=$(mktemp)
              cp "$YAML_FILE" "$TEMP_YAML"
              
              # æ›¿æ¢é•œåƒæ ‡ç­¾ï¼ˆåŒ¹é…åŒ…å«åº”ç”¨åç§°çš„é•œåƒè¡Œï¼‰
              sed -i "s|image:.*$APP_NAME.*|image: $FULL_IMAGE_TAG|g" "$TEMP_YAML"
              # ç¡®ä¿å‘½åç©ºé—´æ­£ç¡®ï¼ˆæ›¿æ¢æ‰€æœ‰ namespace å­—æ®µï¼‰
              sed -i "s|namespace:.*|namespace: $K8S_NAMESPACE|g" "$TEMP_YAML"
              
              # åº”ç”¨ YAML æ–‡ä»¶ï¼ˆkubectl apply ä¼šè‡ªåŠ¨åªåº”ç”¨ç›¸å…³çš„èµ„æºï¼‰
              # ä½¿ç”¨ --validate=false è·³è¿‡å®¢æˆ·ç«¯éªŒè¯ï¼Œé¿å… OpenAPI schema ä¸‹è½½å¤±è´¥
              # ä½¿ç”¨ --server-side åœ¨æœåŠ¡å™¨ç«¯åº”ç”¨ï¼Œé¿å…å®¢æˆ·ç«¯éªŒè¯é—®é¢˜
              echo "åº”ç”¨ YAML æ–‡ä»¶..."
              kubectl apply -f "$TEMP_YAML" -n "$K8S_NAMESPACE" --validate=false --server-side || \
              kubectl apply -f "$TEMP_YAML" -n "$K8S_NAMESPACE" --validate=false
              
              # ç­‰å¾… Deployment å°±ç»ª
              echo "ç­‰å¾… Deployment å°±ç»ª..."
              if kubectl wait --for=condition=available --timeout=5m deployment/"$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" 2>/dev/null; then
                echo "âœ… Deployment å·²å°±ç»ª"
              else
                echo "âš ï¸  Deployment åˆ›å»ºæˆåŠŸï¼Œä½†å¯èƒ½å°šæœªå®Œå…¨å°±ç»ª"
              fi
              
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -f "$TEMP_YAML"
              
              echo "âœ… $APP_NAME éƒ¨ç½²å®Œæˆï¼ˆä» YAML åˆ›å»ºï¼‰"
            else
              echo "âŒ æœªæ‰¾åˆ° YAML æ–‡ä»¶: k8s/deployments/$APP_NAME.yaml æˆ– k8s/deployments/all-apps.yaml"
              echo "è¯·å…ˆåˆ›å»º Deployment æˆ–ç¡®ä¿ YAML æ–‡ä»¶å­˜åœ¨"
              exit 1
            fi
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… $APP_NAME æ„å»ºå’Œéƒ¨ç½²æˆåŠŸ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  deploy-to-server:
    name: Deploy ${{ inputs.app_name }} to Server
    needs: build-and-deploy
    if: inputs.skip_deploy != 'true' && needs.build-and-deploy.outputs.has_k8s_config == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Determine app port
        id: app-port
        run: |
          APP_NAME="${{ inputs.app_name }}"
          case "$APP_NAME" in
            system-app)
              APP_PORT="30080"
              ;;
            admin-app)
              APP_PORT="30081"
              ;;
            logistics-app)
              APP_PORT="30082"
              ;;
            quality-app)
              APP_PORT="30083"
              ;;
            production-app)
              APP_PORT="30084"
              ;;
            engineering-app)
              APP_PORT="30085"
              ;;
            finance-app)
              APP_PORT="30086"
              ;;
            mobile-app)
              APP_PORT="30091"
              ;;
            *)
              APP_PORT="8080"
              ;;
          esac
          echo "app_port=$APP_PORT" >> $GITHUB_OUTPUT
          echo "âœ… åº”ç”¨ç«¯å£: $APP_PORT"
      
      - name: Deploy to server
        uses: ./.github/workflows/deploy-app-reusable.yml
        with:
          app_name: ${{ inputs.app_name }}
          app_port: ${{ steps.app-port.outputs.app_port }}
          container_name: btc-${{ inputs.app_name }}
          image_tag: ${{ needs.build-and-deploy.outputs.image_tag }}
        secrets: inherit

