name: Deploy App (Reusable)

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
      app_port:
        required: true
        type: string
      container_name:
        required: true
        type: string
      image_tag:
        required: false
        type: string
        description: "Docker image tag (defaults to SHA or latest)"
    secrets:
      SERVER_HOST:
        required: false
      SERVER_USER:
        required: false
      SERVER_KEY:
        required: false
      SERVER_PORT:
        required: false
      SERVER_PAT:
        required: false
      GITHUB_TOKEN:
        required: false

permissions:
  contents: read
  packages: read

jobs:
  deploy-app:
    name: Deploy ${{ inputs.app_name }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Detect deployment info
        id: detect-deploy
        run: |
          APP_NAME="${{ inputs.app_name }}"
          ENVIRONMENT="production"
          
          # è·å–é•œåƒæ ‡ç­¾ï¼ˆä¼˜å…ˆçº§ï¼šè¾“å…¥ > client_payload > SHA > latestï¼‰
          if [ -n "${{ inputs.image_tag }}" ]; then
            # ä½¿ç”¨ä¼ å…¥çš„é•œåƒæ ‡ç­¾
            IMAGE_TAG="${{ inputs.image_tag }}"
          elif [ -n "${{ github.event.client_payload.image_tag }}" ]; then
            # ä» client_payload æå–æ ‡ç­¾ï¼ˆå»æ‰ registry å‰ç¼€ï¼‰
            FULL_TAG="${{ github.event.client_payload.image_tag }}"
            IMAGE_TAG=$(echo "$FULL_TAG" | sed 's|.*:||' || echo "")
          elif [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            # ä½¿ç”¨ client_payload ä¸­çš„ github_sha
            IMAGE_TAG="${{ github.event.client_payload.github_sha }}"
          else
            # ä½¿ç”¨å½“å‰ commit SHA çš„å‰7ä½
            GITHUB_SHA="${{ github.sha }}"
            IMAGE_TAG="${GITHUB_SHA:0:7}"
          fi
          
          # å¦‚æœæ ‡ç­¾ä¸ºç©ºæˆ–å¤ªçŸ­ï¼Œä½¿ç”¨ latest
          if [ -z "$IMAGE_TAG" ] || [ ${#IMAGE_TAG} -lt 7 ]; then
            IMAGE_TAG="latest"
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          echo "âœ… æ£€æµ‹åˆ°éƒ¨ç½²è¯·æ±‚:"
          echo "   App: $APP_NAME"
          echo "   Image Tag: $IMAGE_TAG"
          echo "   Environment: $ENVIRONMENT"
        
      - name: Deploy application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          timeout: 900s
          command_timeout: 10m
          script: |
            set -e
            
            APP_NAME="${{ inputs.app_name }}"
            IMAGE_TAG="${{ steps.detect-deploy.outputs.image_tag }}"
            PORT="${{ inputs.app_port }}"
            CONTAINER_NAME="${{ inputs.container_name }}"
            
            REPO_LOWER="bellisgit/btc-shopflow-monorepo"
            REGISTRY="ghcr.io"
            IMAGE_NAME="$REGISTRY/$REPO_LOWER/$APP_NAME"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Starting BTC ShopFlow Deployment"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "App: $APP_NAME"
            echo "Image: $IMAGE_NAME:$IMAGE_TAG"
            echo "Port: $PORT"
            echo ""
            
            # ç™»å½•åˆ° GHCRï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ï¼‰
            echo "ğŸ” Logging into container registry..."
            mkdir -p /tmp/.docker
            export DOCKER_CONFIG=/tmp/.docker
            
            # ä½¿ç”¨ GitHub Token ç™»å½•ï¼ˆä»ç¯å¢ƒå˜é‡æˆ– secretsï¼‰
            if [ -n "${{ secrets.SERVER_PAT }}" ]; then
              TOKEN="${{ secrets.SERVER_PAT }}"
            elif [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
              TOKEN="${{ secrets.GITHUB_TOKEN }}"
            else
              echo "[ERROR] No token available for registry"
              exit 1
            fi
            
            # Docker ç™»å½•å‡½æ•°ï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•ï¼‰
            docker_login_with_timeout() {
              local registry=$1
              local username=$2
              local token=$3
              local timeout_seconds=${4:-30}  # é»˜è®¤30ç§’è¶…æ—¶
              local max_retries=${5:-3}  # é»˜è®¤é‡è¯•3æ¬¡
              local retry_count=0
              
              while [ $retry_count -lt $max_retries ]; do
                retry_count=$((retry_count + 1))
                echo "ğŸ”„ å°è¯•ç™»å½•åˆ° $registry (ç¬¬ $retry_count/$max_retries æ¬¡)..."
                
                START_TIME=$(date +%s)
                
                # ä½¿ç”¨ timeout å‘½ä»¤é™åˆ¶ç™»å½•æ—¶é—´
                if echo "$token" | timeout $timeout_seconds docker login "$registry" -u "$username" --password-stdin 2>&1; then
                  ELAPSED=$(($(date +%s) - START_TIME))
                  echo "âœ… ç™»å½•æˆåŠŸ (è€—æ—¶: ${ELAPSED} ç§’)"
                  return 0
                else
                  EXIT_CODE=$?
                  ELAPSED=$(($(date +%s) - START_TIME))
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "â±ï¸  ç™»å½•è¶…æ—¶ (${timeout_seconds} ç§’)"
                  else
                    echo "âŒ ç™»å½•å¤±è´¥ (é€€å‡ºç : $EXIT_CODE, è€—æ—¶: ${ELAPSED} ç§’)"
                  fi
                  
                  if [ $retry_count -lt $max_retries ]; then
                    echo "â³ ç­‰å¾… 3 ç§’åé‡è¯•..."
                    sleep 3
                  fi
                fi
              done
              
              return 1
            }
            
            # æ‰§è¡Œç™»å½•ï¼ˆ30ç§’è¶…æ—¶ï¼Œé‡è¯•3æ¬¡ï¼‰
            if ! docker_login_with_timeout "$REGISTRY" "${{ github.actor }}" "$TOKEN" 30 3; then
              echo "[ERROR] æ— æ³•ç™»å½•åˆ° $REGISTRY"
              echo "[ERROR] è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ Token æƒé™"
              exit 1
            fi
            
            # ä» GHCR æ‹‰å–é•œåƒï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ï¼‰
            echo "ğŸ“¥ Pulling Docker image from $REGISTRY..."
            
            # æ‹‰å–é•œåƒçš„å‡½æ•°ï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•ï¼‰
            pull_image_with_timeout() {
              local image=$1
              local timeout_seconds=${2:-600}  # é»˜è®¤10åˆ†é’Ÿè¶…æ—¶
              local max_retries=${3:-2}  # é»˜è®¤é‡è¯•2æ¬¡
              local retry_count=0
              
              while [ $retry_count -lt $max_retries ]; do
                retry_count=$((retry_count + 1))
                echo "ğŸ”„ å°è¯•æ‹‰å–é•œåƒ (ç¬¬ $retry_count/$max_retries æ¬¡): $image"
                echo "â±ï¸  è¶…æ—¶è®¾ç½®: ${timeout_seconds} ç§’"
                
                START_TIME=$(date +%s)
                
                # ä½¿ç”¨ timeout å‘½ä»¤é™åˆ¶æ‹‰å–æ—¶é—´
                if timeout $timeout_seconds docker pull "$image" 2>&1; then
                  ELAPSED=$(($(date +%s) - START_TIME))
                  echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ (è€—æ—¶: ${ELAPSED} ç§’)"
                  return 0
                else
                  EXIT_CODE=$?
                  ELAPSED=$(($(date +%s) - START_TIME))
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "â±ï¸  æ‹‰å–è¶…æ—¶ (${timeout_seconds} ç§’)"
                  else
                    echo "âŒ æ‹‰å–å¤±è´¥ (é€€å‡ºç : $EXIT_CODE, è€—æ—¶: ${ELAPSED} ç§’)"
                  fi
                  
                  if [ $retry_count -lt $max_retries ]; then
                    echo "â³ ç­‰å¾… 5 ç§’åé‡è¯•..."
                    sleep 5
                  fi
                fi
              done
              
              return 1
            }
            
            # å°è¯•æ‹‰å–æŒ‡å®šæ ‡ç­¾çš„é•œåƒ
            if ! pull_image_with_timeout "$IMAGE_NAME:$IMAGE_TAG" 600 2; then
              echo "âš ï¸  æ— æ³•æ‹‰å– $IMAGE_NAME:$IMAGE_TAGï¼Œå°è¯• latest æ ‡ç­¾..."
              if ! pull_image_with_timeout "$IMAGE_NAME:latest" 600 2; then
                echo "[ERROR] æ— æ³•ä» $REGISTRY æ‹‰å–é•œåƒ"
                echo "[ERROR] å·²å°è¯•çš„æ ‡ç­¾: $IMAGE_TAG, latest"
                exit 1
              fi
              IMAGE_TAG="latest"
            fi
            
            # æ ‡è®°ä¸ºæœ¬åœ°é•œåƒ
            docker tag "$IMAGE_NAME:$IMAGE_TAG" "btc-shopflow/$APP_NAME:latest" 2>/dev/null || true
            echo "âœ… Image pulled and tagged successfully"
            
            echo "ğŸ”„ Updating container..."
            
            # å¼ºåˆ¶åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰åŒåå®¹å™¨ï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„ï¼‰
            echo "ğŸ“‹ æ£€æŸ¥å¹¶æ¸…ç†ç°æœ‰å®¹å™¨..."
            echo "   ç›®æ ‡å®¹å™¨å: $CONTAINER_NAME"
            
            # æ–¹æ³•1: ä½¿ç”¨å®¹å™¨åç§°ç²¾ç¡®åŒ¹é…ï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„å®¹å™¨ï¼‰
            # ä½¿ç”¨ ^${CONTAINER_NAME}$ ç¡®ä¿å®Œå…¨åŒ¹é…ï¼Œé¿å…è¯¯åˆ å…¶ä»–å®¹å™¨
            EXISTING_CONTAINERS=$(docker ps -a --filter "name=^${CONTAINER_NAME}$" --format "{{.ID}}" 2>/dev/null || true)
            if [ -n "$EXISTING_CONTAINERS" ]; then
              echo "ğŸ›‘ å‘ç°åŒåå®¹å™¨ï¼Œæ­£åœ¨å¼ºåˆ¶åˆ é™¤..."
              echo "$EXISTING_CONTAINERS" | while read -r container_id; do
                if [ -n "$container_id" ]; then
                  # éªŒè¯å®¹å™¨åç¡®å®åŒ¹é…ï¼ˆé˜²æ­¢è¯¯åˆ ï¼‰
                  CONTAINER_NAME_CHECK=$(docker ps -a --filter "id=$container_id" --format "{{.Names}}" 2>/dev/null || echo "")
                  if [ "$CONTAINER_NAME_CHECK" = "$CONTAINER_NAME" ]; then
                    echo "  åœæ­¢å¹¶åˆ é™¤å®¹å™¨ ID: $container_id (åç§°: $CONTAINER_NAME_CHECK)"
                    docker stop "$container_id" 2>/dev/null || true
                    docker rm -f "$container_id" 2>/dev/null || true
                  else
                    echo "  âš ï¸  è·³è¿‡å®¹å™¨ ID: $container_id (åç§°ä¸åŒ¹é…: $CONTAINER_NAME_CHECK != $CONTAINER_NAME)"
                  fi
                fi
              done
            fi
            
            # æ–¹æ³•2: ç›´æ¥å°è¯•åˆ é™¤ï¼ˆé˜²æ­¢æ–¹æ³•1é—æ¼ï¼‰
            echo "ğŸ›‘ å¼ºåˆ¶åˆ é™¤å®¹å™¨: $CONTAINER_NAME"
            docker stop "$CONTAINER_NAME" 2>/dev/null || true
            docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
            
            # æ–¹æ³•3: é€šè¿‡å®¹å™¨ååˆ—è¡¨æŸ¥æ‰¾ï¼ˆé¢å¤–ä¿é™©ï¼‰
            echo "ğŸ” é€šè¿‡å®¹å™¨ååˆ—è¡¨å†æ¬¡æ£€æŸ¥..."
            ALL_CONTAINERS=$(docker ps -a --format "{{.Names}}\t{{.ID}}" 2>/dev/null || true)
            if [ -n "$ALL_CONTAINERS" ]; then
              echo "$ALL_CONTAINERS" | while IFS=$'\t' read -r name id; do
                if [ "$name" = "$CONTAINER_NAME" ] && [ -n "$id" ]; then
                  echo "  ğŸ›‘ å‘ç°æ®‹ç•™å®¹å™¨: $name (ID: $id)ï¼Œæ­£åœ¨åˆ é™¤..."
                  docker stop "$id" 2>/dev/null || true
                  docker rm -f "$id" 2>/dev/null || true
                fi
              done
            fi
            
            # æ£€æŸ¥å¹¶åœæ­¢å ç”¨ç«¯å£çš„å®¹å™¨
            echo "ğŸ” æ£€æŸ¥ç«¯å£ $PORT å ç”¨æƒ…å†µ..."
            PORT_CONTAINERS=$(docker ps --format "{{.Names}}\t{{.Ports}}" | grep ":$PORT->" | awk '{print $1}' || true)
            if [ -n "$PORT_CONTAINERS" ]; then
              echo "âš ï¸  å‘ç°å ç”¨ç«¯å£ $PORT çš„å®¹å™¨:"
              echo "$PORT_CONTAINERS"
              echo "$PORT_CONTAINERS" | while read -r container; do
                if [ -n "$container" ] && [ "$container" != "$CONTAINER_NAME" ]; then
                  echo "ğŸ›‘ åœæ­¢å®¹å™¨: $container"
                  docker stop "$container" 2>/dev/null || true
                  docker rm -f "$container" 2>/dev/null || true
                fi
              done
            fi
            
            # ä½¿ç”¨åº”ç”¨ç‰¹å®šçš„ compose æ–‡ä»¶åï¼Œé¿å…å½±å“å…¶ä»–åº”ç”¨
            COMPOSE_FILE="docker-compose.${APP_NAME}.yml"
            
            # åªæ¸…ç†å½“å‰åº”ç”¨çš„ compose é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f "$COMPOSE_FILE" ]; then
              echo "ğŸ§¹ æ¸…ç†å½“å‰åº”ç”¨çš„ docker-compose æœåŠ¡..."
              docker-compose -f "$COMPOSE_FILE" down 2>/dev/null || true
            fi
            
            # å†æ¬¡ç¡®è®¤å®¹å™¨å·²è¢«åˆ é™¤
            echo "ğŸ” éªŒè¯å®¹å™¨æ˜¯å¦å·²å®Œå…¨åˆ é™¤..."
            REMAINING=$(docker ps -a --filter "name=^${CONTAINER_NAME}$" --format "{{.ID}}" | wc -l || echo "0")
            if [ "$REMAINING" -gt 0 ]; then
              echo "âš ï¸  ä»æœ‰å®¹å™¨æ®‹ç•™ï¼Œå°è¯•å¼ºåˆ¶æ¸…ç†..."
              docker ps -a --filter "name=^${CONTAINER_NAME}$" --format "{{.ID}}" | xargs -r docker rm -f 2>/dev/null || true
            else
              echo "âœ… å®¹å™¨å·²å®Œå…¨æ¸…ç†"
            fi
            
            # ç­‰å¾…ç«¯å£é‡Šæ”¾ï¼ˆä½¿ç”¨ Docker å‘½ä»¤æ£€æŸ¥ï¼‰
            echo "â³ ç­‰å¾…ç«¯å£ $PORT é‡Šæ”¾..."
            for i in {1..10}; do
              ACTIVE_CONTAINERS=$(docker ps --format "{{.Names}}\t{{.Ports}}" | grep ":$PORT->" | wc -l || echo "0")
              if [ "$ACTIVE_CONTAINERS" = "0" ]; then
                echo "âœ… ç«¯å£ $PORT å·²é‡Šæ”¾"
                break
              fi
              echo "   ç­‰å¾…ä¸­... ($i/10)"
              sleep 1
            done
            
            # ä½¿ç”¨åº”ç”¨ç‰¹å®šçš„ compose æ–‡ä»¶åï¼Œé¿å…è¦†ç›–å…¶ä»–åº”ç”¨çš„é…ç½®
            cat > "$COMPOSE_FILE" << EOF
            version: '3.8'
            services:
              $APP_NAME:
                image: btc-shopflow/$APP_NAME:latest
                container_name: $CONTAINER_NAME
                ports:
                  - "$PORT:80"
                restart: unless-stopped
                networks:
                  - btc-network
            networks:
              btc-network:
                driver: bridge
            EOF
            
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            if ! docker-compose -f "$COMPOSE_FILE" up -d; then
              echo "[ERROR] å®¹å™¨å¯åŠ¨å¤±è´¥"
              echo "[ERROR] æ£€æŸ¥ docker-compose é…ç½®..."
              cat "$COMPOSE_FILE"
              echo "[ERROR] æ£€æŸ¥å®¹å™¨æ—¥å¿—..."
              docker-compose -f "$COMPOSE_FILE" logs 2>&1 || true
              exit 1
            fi
            
            sleep 5
            
            echo "ğŸ“‹ Container status:"
            docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # éªŒè¯å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
            echo "ğŸ” éªŒè¯å®¹å™¨çŠ¶æ€..."
            CONTAINER_STATUS=$(docker ps --filter "name=^${CONTAINER_NAME}$" --format "{{.Status}}" || echo "")
            if [ -z "$CONTAINER_STATUS" ]; then
              echo "[ERROR] å®¹å™¨æœªè¿è¡Œï¼"
              echo "[ERROR] æ£€æŸ¥å®¹å™¨æ—¥å¿—..."
              docker logs "$CONTAINER_NAME" 2>&1 || true
              echo "[ERROR] æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€..."
              docker ps -a | grep "$CONTAINER_NAME" || true
              exit 1
            else
              echo "âœ… å®¹å™¨æ­£åœ¨è¿è¡Œ: $CONTAINER_STATUS"
            fi
            
            echo ""
            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f || true
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
