name: Deploy App (Reusable)

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
      app_port:
        required: true
        type: string
      container_name:
        required: true
        type: string
      image_tag:
        required: false
        type: string
        description: "Docker image tag (defaults to SHA or latest)"
    secrets:
      SERVER_HOST:
        required: false
      SERVER_USER:
        required: false
      SERVER_KEY:
        required: false
      SERVER_PORT:
        required: false
      SERVER_PAT:
        required: false

permissions:
  contents: read
  packages: read

jobs:
  deploy-app:
    name: Deploy ${{ inputs.app_name }}
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Detect deployment info
        id: detect-deploy
        run: |
          APP_NAME="${{ inputs.app_name }}"
          ENVIRONMENT="production"
          
          # è·å–é•œåƒæ ‡ç­¾ï¼ˆä¼˜å…ˆçº§ï¼šè¾“å…¥ > client_payload > SHA > latestï¼‰
          if [ -n "${{ inputs.image_tag }}" ]; then
            # ä½¿ç”¨ä¼ å…¥çš„é•œåƒæ ‡ç­¾
            IMAGE_TAG="${{ inputs.image_tag }}"
          elif [ -n "${{ github.event.client_payload.image_tag }}" ]; then
            # ä» client_payload æå–æ ‡ç­¾ï¼ˆå»æ‰ registry å‰ç¼€ï¼‰
            FULL_TAG="${{ github.event.client_payload.image_tag }}"
            IMAGE_TAG=$(echo "$FULL_TAG" | sed 's|.*:||' || echo "")
          elif [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            # ä½¿ç”¨ client_payload ä¸­çš„ github_sha
            IMAGE_TAG="${{ github.event.client_payload.github_sha }}"
          else
            # ä½¿ç”¨å½“å‰ commit SHA çš„å‰7ä½
            GITHUB_SHA="${{ github.sha }}"
            IMAGE_TAG="${GITHUB_SHA:0:7}"
          fi
          
          # å¦‚æœæ ‡ç­¾ä¸ºç©ºæˆ–å¤ªçŸ­ï¼Œä½¿ç”¨ latest
          if [ -z "$IMAGE_TAG" ] || [ ${#IMAGE_TAG} -lt 7 ]; then
            IMAGE_TAG="latest"
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          echo "âœ… æ£€æµ‹åˆ°éƒ¨ç½²è¯·æ±‚:"
          echo "   App: $APP_NAME"
          echo "   Image Tag: $IMAGE_TAG"
          echo "   Environment: $ENVIRONMENT"
        
      - name: Deploy application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          timeout: 1800s
          command_timeout: 20m
          script: |
            set -e
            
            APP_NAME="${{ inputs.app_name }}"
            IMAGE_TAG="${{ steps.detect-deploy.outputs.image_tag }}"
            PORT="${{ inputs.app_port }}"
            CONTAINER_NAME="${{ inputs.container_name }}"
            
            REPO_LOWER="bellisgit/btc-shopflow-monorepo"
            REGISTRY="ghcr.io"
            IMAGE_NAME="$REGISTRY/$REPO_LOWER/$APP_NAME"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Starting BTC ShopFlow Deployment"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "App: $APP_NAME"
            echo "Image: $IMAGE_NAME:$IMAGE_TAG"
            echo "Port: $PORT"
            echo ""
            
            # ç™»å½•åˆ° GHCRï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ï¼‰
            echo "ğŸ” Logging into container registry..."
            mkdir -p /tmp/.docker
            export DOCKER_CONFIG=/tmp/.docker
            
            # ä½¿ç”¨ GitHub Token ç™»å½•ï¼ˆä»ç¯å¢ƒå˜é‡æˆ– secretsï¼‰
            if [ -n "${{ secrets.SERVER_PAT }}" ]; then
              TOKEN="${{ secrets.SERVER_PAT }}"
            else
              # ä½¿ç”¨ç³»ç»Ÿè‡ªåŠ¨æä¾›çš„ github.tokenï¼ˆä¸éœ€è¦ä½œä¸º secret ä¼ é€’ï¼‰
              TOKEN="${{ github.token }}"
            fi
            
            # Docker ç™»å½•å‡½æ•°ï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•ï¼‰
            docker_login_with_timeout() {
              local registry=$1
              local username=$2
              local token=$3
              local timeout_seconds=${4:-30}  # é»˜è®¤30ç§’è¶…æ—¶
              local max_retries=${5:-3}  # é»˜è®¤é‡è¯•3æ¬¡
              local retry_count=0
              
              while [ $retry_count -lt $max_retries ]; do
                retry_count=$((retry_count + 1))
                echo "ğŸ”„ å°è¯•ç™»å½•åˆ° $registry (ç¬¬ $retry_count/$max_retries æ¬¡)..."
                
                START_TIME=$(date +%s)
                
                # ä½¿ç”¨ timeout å‘½ä»¤é™åˆ¶ç™»å½•æ—¶é—´
                if echo "$token" | timeout $timeout_seconds docker login "$registry" -u "$username" --password-stdin 2>&1; then
                  ELAPSED=$(($(date +%s) - START_TIME))
                  echo "âœ… ç™»å½•æˆåŠŸ (è€—æ—¶: ${ELAPSED} ç§’)"
                  return 0
                else
                  EXIT_CODE=$?
                  ELAPSED=$(($(date +%s) - START_TIME))
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "â±ï¸  ç™»å½•è¶…æ—¶ (${timeout_seconds} ç§’)"
                  else
                    echo "âŒ ç™»å½•å¤±è´¥ (é€€å‡ºç : $EXIT_CODE, è€—æ—¶: ${ELAPSED} ç§’)"
                  fi
                  
                  if [ $retry_count -lt $max_retries ]; then
                    echo "â³ ç­‰å¾… 3 ç§’åé‡è¯•..."
                    sleep 3
                  fi
                fi
              done
              
              return 1
            }
            
            # æ‰§è¡Œç™»å½•ï¼ˆ30ç§’è¶…æ—¶ï¼Œé‡è¯•3æ¬¡ï¼‰
            if ! docker_login_with_timeout "$REGISTRY" "${{ github.actor }}" "$TOKEN" 30 3; then
              echo "[ERROR] æ— æ³•ç™»å½•åˆ° $REGISTRY"
              echo "[ERROR] è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ Token æƒé™"
              exit 1
            fi
            
            # ä» GHCR æ‹‰å–é•œåƒï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ï¼‰
            echo "ğŸ“¥ Pulling Docker image from $REGISTRY..."
            
            # é…ç½® Docker å®¢æˆ·ç«¯è¶…æ—¶å’Œé‡è¯•è®¾ç½®
            echo "âš™ï¸  é…ç½® Docker å®¢æˆ·ç«¯..."
            mkdir -p /etc/docker
            # é…ç½® Docker daemon çš„è¶…æ—¶è®¾ç½®ï¼ˆå¦‚æœå¯èƒ½ï¼‰
            if [ -f /etc/docker/daemon.json ]; then
              echo "âš ï¸  Docker daemon.json å·²å­˜åœ¨ï¼Œè·³è¿‡é…ç½®"
            else
              echo "ğŸ“ åˆ›å»º Docker daemon é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰..."
              printf '%s\n' '{' '  "max-concurrent-downloads": 3,' '  "max-concurrent-uploads": 5,' '  "registry-mirrors": []' '}' > /tmp/docker-daemon.json
              # åªæœ‰åœ¨æ˜¯ root ç”¨æˆ·ä¸”å¯ä»¥ä¿®æ”¹æ—¶æ‰åº”ç”¨
              if [ "$(id -u)" -eq 0 ] && command -v systemctl >/dev/null 2>&1; then
                cp /tmp/docker-daemon.json /etc/docker/daemon.json 2>/dev/null || true
              fi
            fi
            
            # é…ç½® Docker å®¢æˆ·ç«¯
            mkdir -p ~/.docker
            printf '%s\n' '{' '  "max-concurrent-downloads": 3,' '  "max-concurrent-uploads": 5' '}' > ~/.docker/config.json
            
            # é…ç½®ç¯å¢ƒå˜é‡ä»¥ä¼˜åŒ– Docker æ‹‰å–
            export DOCKER_CLI_EXPERIMENTAL=enabled
            
            # æ¸…ç† Docker ç½‘ç»œç¼“å­˜ï¼ˆå¯èƒ½æœ‰åŠ©äºè§£å†³ç½‘ç»œé—®é¢˜ï¼‰
            echo "ğŸ§¹ æ¸…ç† Docker ç½‘ç»œç¼“å­˜..."
            docker network prune -f 2>/dev/null || true
            
            # æ£€æŸ¥ç½‘ç»œè¿æ¥
            echo "ğŸŒ æ£€æŸ¥ç½‘ç»œè¿æ¥..."
            if timeout 15 curl -sSf -m 10 https://ghcr.io >/dev/null 2>&1; then
              echo "âœ… ç½‘ç»œè¿æ¥æ­£å¸¸"
            else
              echo "âš ï¸  ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•æ‹‰å–é•œåƒ..."
              echo "ğŸ“Š DNS è§£ææµ‹è¯•..."
              nslookup ghcr.io 2>/dev/null || echo "  DNS è§£æå¤±è´¥"
              echo "ğŸ“Š è·¯ç”±æµ‹è¯•..."
              ping -c 2 ghcr.io 2>/dev/null || echo "  è·¯ç”±æµ‹è¯•å¤±è´¥"
            fi
            
            # æ‹‰å–é•œåƒçš„å‡½æ•°ï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•ï¼Œæ”¯æŒè¿›åº¦æ˜¾ç¤ºï¼‰
            pull_image_with_timeout() {
              local image=$1
              local timeout_seconds=${2:-300}  # é»˜è®¤5åˆ†é’Ÿè¶…æ—¶ï¼ˆç¼©çŸ­è¶…æ—¶æ—¶é—´ï¼‰
              local max_retries=${3:-3}  # é»˜è®¤é‡è¯•3æ¬¡
              local retry_count=0
              
              while [ $retry_count -lt $max_retries ]; do
                retry_count=$((retry_count + 1))
                echo "ğŸ”„ å°è¯•æ‹‰å–é•œåƒ (ç¬¬ $retry_count/$max_retries æ¬¡): $image"
                echo "â±ï¸  è¶…æ—¶è®¾ç½®: ${timeout_seconds} ç§’"
                
                START_TIME=$(date +%s)
                
                # åœ¨åå°è¿è¡Œè¿›åº¦ç›‘æ§
                (
                  while true; do
                    sleep 30
                    ELAPSED=$(($(date +%s) - START_TIME))
                    echo "ğŸ’“ ä¸‹è½½è¿›è¡Œä¸­... (å·²è€—æ—¶: ${ELAPSED}ç§’)"
                  done
                ) &
                PROGRESS_PID=$!
                
                # ä½¿ç”¨ timeout å‘½ä»¤é™åˆ¶æ‹‰å–æ—¶é—´
                if timeout $timeout_seconds docker pull "$image" 2>&1; then
                  kill $PROGRESS_PID 2>/dev/null || true
                  wait $PROGRESS_PID 2>/dev/null || true
                  ELAPSED=$(($(date +%s) - START_TIME))
                  echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ (è€—æ—¶: ${ELAPSED} ç§’)"
                  return 0
                else
                  kill $PROGRESS_PID 2>/dev/null || true
                  wait $PROGRESS_PID 2>/dev/null || true
                  EXIT_CODE=$?
                  ELAPSED=$(($(date +%s) - START_TIME))
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "â±ï¸  æ‹‰å–è¶…æ—¶ (${timeout_seconds} ç§’)"
                  else
                    echo "âŒ æ‹‰å–å¤±è´¥ (é€€å‡ºç : $EXIT_CODE, è€—æ—¶: ${ELAPSED} ç§’)"
                  fi
                  
                  if [ $retry_count -lt $max_retries ]; then
                    echo "â³ ç­‰å¾… 10 ç§’åé‡è¯•..."
                    sleep 10
                  fi
                fi
              done
              
              return 1
            }
            
            # æ£€æŸ¥é•œåƒæ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…ä¸å¿…è¦çš„æ‹‰å–ï¼‰
            echo "ğŸ” æ£€æŸ¥é•œåƒæ˜¯å¦å·²å­˜åœ¨..."
            if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "^${IMAGE_NAME}:${IMAGE_TAG}$"; then
              echo "âœ… é•œåƒå·²å­˜åœ¨æœ¬åœ°: $IMAGE_NAME:$IMAGE_TAG"
              echo "ğŸ”„ éªŒè¯é•œåƒå®Œæ•´æ€§..."
              if docker inspect "$IMAGE_NAME:$IMAGE_TAG" >/dev/null 2>&1; then
                echo "âœ… é•œåƒéªŒè¯é€šè¿‡ï¼Œè·³è¿‡æ‹‰å–"
              else
                echo "âš ï¸  é•œåƒæŸåï¼Œé‡æ–°æ‹‰å–..."
                docker rmi "$IMAGE_NAME:$IMAGE_TAG" 2>/dev/null || true
                if ! pull_image_with_timeout "$IMAGE_NAME:$IMAGE_TAG" 300 3; then
                  echo "âš ï¸  æ— æ³•æ‹‰å– $IMAGE_NAME:$IMAGE_TAGï¼Œå°è¯• latest æ ‡ç­¾..."
                  IMAGE_TAG="latest"
                  if ! pull_image_with_timeout "$IMAGE_NAME:$IMAGE_TAG" 300 3; then
                    echo "[ERROR] æ— æ³•ä» $REGISTRY æ‹‰å–é•œåƒ"
                    echo "[ERROR] å·²å°è¯•çš„æ ‡ç­¾: $IMAGE_TAG, latest"
                    echo ""
                    echo "[ERROR] ç½‘ç»œè¯Šæ–­ä¿¡æ¯:"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    timeout 15 curl -v https://ghcr.io 2>&1 | head -30 || echo "  âŒ æ— æ³•è¿æ¥åˆ° ghcr.io"
                    echo ""
                    echo "ğŸ“Š Docker ç³»ç»Ÿä¿¡æ¯:"
                    docker system df 2>&1 || true
                    exit 1
                  fi
                fi
              fi
            else
              # å°è¯•æ‹‰å–æŒ‡å®šæ ‡ç­¾çš„é•œåƒ
              if ! pull_image_with_timeout "$IMAGE_NAME:$IMAGE_TAG" 300 3; then
                echo "âš ï¸  æ— æ³•æ‹‰å– $IMAGE_NAME:$IMAGE_TAGï¼Œå°è¯• latest æ ‡ç­¾..."
                  if ! pull_image_with_timeout "$IMAGE_NAME:latest" 300 3; then
                    echo "[ERROR] æ— æ³•ä» $REGISTRY æ‹‰å–é•œåƒ"
                    echo "[ERROR] å·²å°è¯•çš„æ ‡ç­¾: $IMAGE_TAG, latest"
                    echo ""
                    echo "[ERROR] ç½‘ç»œè¯Šæ–­ä¿¡æ¯:"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    timeout 15 curl -v https://ghcr.io 2>&1 | head -30 || echo "  âŒ æ— æ³•è¿æ¥åˆ° ghcr.io"
                    echo ""
                    echo "ğŸ“Š Docker ç³»ç»Ÿä¿¡æ¯:"
                    docker system df 2>&1 || true
                    echo ""
                    echo "ğŸ“Š Docker ç½‘ç»œä¿¡æ¯:"
                    docker network ls 2>&1 || true
                    echo ""
                    echo "ğŸ“Š æœ¬åœ°é•œåƒåˆ—è¡¨:"
                    docker images | head -10 || true
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    exit 1
                  fi
                IMAGE_TAG="latest"
              fi
            fi
            
            # æ ‡è®°ä¸ºæœ¬åœ°é•œåƒ
            docker tag "$IMAGE_NAME:$IMAGE_TAG" "btc-shopflow/$APP_NAME:latest" 2>/dev/null || true
            echo "âœ… Image pulled and tagged successfully"
            
            echo "ğŸ”„ Updating container..."
            
            # å¼ºåˆ¶åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰åŒåå®¹å™¨ï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„ï¼‰
            echo "ğŸ“‹ æ£€æŸ¥å¹¶æ¸…ç†ç°æœ‰å®¹å™¨..."
            echo "   ç›®æ ‡å®¹å™¨å: $CONTAINER_NAME"
            
            # æ–¹æ³•1: é€šè¿‡å®¹å™¨ååˆ—è¡¨ç²¾ç¡®æŸ¥æ‰¾ï¼ˆæœ€å¯é çš„æ–¹æ³•ï¼‰
            # è·å–æ‰€æœ‰å®¹å™¨ï¼Œç„¶åç²¾ç¡®åŒ¹é…å®¹å™¨å
            echo "ğŸ” æ–¹æ³•1: é€šè¿‡å®¹å™¨ååˆ—è¡¨ç²¾ç¡®æŸ¥æ‰¾..."
            ALL_CONTAINERS=$(docker ps -a --format "{{.Names}}\t{{.ID}}" 2>/dev/null || true)
            FOUND_CONTAINERS=""
            if [ -n "$ALL_CONTAINERS" ]; then
              while IFS=$'\t' read -r name id; do
                if [ "$name" = "$CONTAINER_NAME" ] && [ -n "$id" ]; then
                  echo "  ğŸ›‘ å‘ç°å®¹å™¨: $name (ID: $id)"
                  FOUND_CONTAINERS="$FOUND_CONTAINERS $id"
                fi
              done <<< "$ALL_CONTAINERS"
            fi
            
            # åˆ é™¤æ‰¾åˆ°çš„å®¹å™¨
            if [ -n "$FOUND_CONTAINERS" ]; then
              echo "ğŸ›‘ æ­£åœ¨åœæ­¢å¹¶åˆ é™¤æ‰¾åˆ°çš„å®¹å™¨..."
              for container_id in $FOUND_CONTAINERS; do
                echo "  åœæ­¢å¹¶åˆ é™¤å®¹å™¨ ID: $container_id"
                docker stop "$container_id" 2>/dev/null || true
                docker rm -f "$container_id" 2>/dev/null || true
              done
            fi
            
            # æ–¹æ³•2: ä½¿ç”¨ Docker filterï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ³•ï¼‰
            echo "ğŸ” æ–¹æ³•2: ä½¿ç”¨ Docker filter æŸ¥æ‰¾..."
            EXISTING_CONTAINERS=$(docker ps -a --filter "name=^${CONTAINER_NAME}$" --format "{{.ID}}" 2>/dev/null || true)
            if [ -n "$EXISTING_CONTAINERS" ]; then
              echo "ğŸ›‘ é€šè¿‡ filter å‘ç°å®¹å™¨ï¼Œæ­£åœ¨åˆ é™¤..."
              echo "$EXISTING_CONTAINERS" | while read -r container_id; do
                if [ -n "$container_id" ]; then
                  # éªŒè¯å®¹å™¨åç¡®å®åŒ¹é…ï¼ˆé˜²æ­¢è¯¯åˆ ï¼‰
                  CONTAINER_NAME_CHECK=$(docker ps -a --filter "id=$container_id" --format "{{.Names}}" 2>/dev/null || echo "")
                  if [ "$CONTAINER_NAME_CHECK" = "$CONTAINER_NAME" ]; then
                    echo "  åœæ­¢å¹¶åˆ é™¤å®¹å™¨ ID: $container_id (åç§°: $CONTAINER_NAME_CHECK)"
                    docker stop "$container_id" 2>/dev/null || true
                    docker rm -f "$container_id" 2>/dev/null || true
                  else
                    echo "  âš ï¸  è·³è¿‡å®¹å™¨ ID: $container_id (åç§°ä¸åŒ¹é…: $CONTAINER_NAME_CHECK != $CONTAINER_NAME)"
                  fi
                fi
              done
            fi
            
            # æ–¹æ³•3: ç›´æ¥å°è¯•åˆ é™¤ï¼ˆé˜²æ­¢æ–¹æ³•1å’Œæ–¹æ³•2é—æ¼ï¼‰
            echo "ğŸ›‘ æ–¹æ³•3: ç›´æ¥å°è¯•åˆ é™¤å®¹å™¨: $CONTAINER_NAME"
            docker stop "$CONTAINER_NAME" 2>/dev/null || true
            docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
            
            # æ£€æŸ¥å¹¶åœæ­¢å ç”¨ç«¯å£çš„å®¹å™¨
            echo "ğŸ” æ£€æŸ¥ç«¯å£ $PORT å ç”¨æƒ…å†µ..."
            PORT_CONTAINERS=$(docker ps --format "{{.Names}}\t{{.Ports}}" | grep ":$PORT->" | awk '{print $1}' || true)
            if [ -n "$PORT_CONTAINERS" ]; then
              echo "âš ï¸  å‘ç°å ç”¨ç«¯å£ $PORT çš„å®¹å™¨:"
              echo "$PORT_CONTAINERS"
              echo "$PORT_CONTAINERS" | while read -r container; do
                if [ -n "$container" ] && [ "$container" != "$CONTAINER_NAME" ]; then
                  echo "ğŸ›‘ åœæ­¢å®¹å™¨: $container"
                  docker stop "$container" 2>/dev/null || true
                  docker rm -f "$container" 2>/dev/null || true
                fi
              done
            fi
            
            # ä½¿ç”¨åº”ç”¨ç‰¹å®šçš„ compose æ–‡ä»¶åï¼Œé¿å…å½±å“å…¶ä»–åº”ç”¨
            COMPOSE_FILE="docker-compose.${APP_NAME}.yml"
            
            # åªæ¸…ç†å½“å‰åº”ç”¨çš„ compose é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f "$COMPOSE_FILE" ]; then
              echo "ğŸ§¹ æ¸…ç†å½“å‰åº”ç”¨çš„ docker-compose æœåŠ¡..."
              # æ£€æµ‹ docker-compose å‘½ä»¤ï¼ˆæ”¯æŒæ–°æ—§ç‰ˆæœ¬ï¼‰
              if command -v docker-compose >/dev/null 2>&1; then
                docker-compose -f "$COMPOSE_FILE" down 2>/dev/null || true
              elif docker compose version >/dev/null 2>&1; then
                docker compose -f "$COMPOSE_FILE" down 2>/dev/null || true
              fi
            fi
            
            # å†æ¬¡ç¡®è®¤å®¹å™¨å·²è¢«åˆ é™¤ï¼ˆä½¿ç”¨å¤šç§æ–¹æ³•éªŒè¯ï¼‰
            echo "ğŸ” éªŒè¯å®¹å™¨æ˜¯å¦å·²å®Œå…¨åˆ é™¤..."
            
            # æ–¹æ³•1: ä½¿ç”¨ filter æ£€æŸ¥
            REMAINING_FILTER=$(docker ps -a --filter "name=^${CONTAINER_NAME}$" --format "{{.ID}}" 2>/dev/null | wc -l || echo "0")
            
            # æ–¹æ³•2: é€šè¿‡å®¹å™¨ååˆ—è¡¨æ£€æŸ¥ï¼ˆæ›´å¯é ï¼‰
            REMAINING_LIST=$(docker ps -a --format "{{.Names}}" 2>/dev/null | grep -c "^${CONTAINER_NAME}$" || echo "0")
            
            # æ–¹æ³•3: ç›´æ¥å°è¯•æŸ¥æ‰¾å®¹å™¨
            REMAINING_DIRECT=$(docker ps -a --format "{{.Names}}\t{{.ID}}" 2>/dev/null | grep -P "^${CONTAINER_NAME}\t" | wc -l || echo "0")
            
            echo "   é€šè¿‡ filter æ£€æŸ¥: $REMAINING_FILTER ä¸ªå®¹å™¨"
            echo "   é€šè¿‡åˆ—è¡¨æ£€æŸ¥: $REMAINING_LIST ä¸ªå®¹å™¨"
            echo "   é€šè¿‡ç›´æ¥æŸ¥æ‰¾: $REMAINING_DIRECT ä¸ªå®¹å™¨"
            
            # å¦‚æœä»»ä¸€æ–¹æ³•å‘ç°å®¹å™¨ï¼Œå°è¯•åˆ é™¤
            if [ "$REMAINING_FILTER" -gt 0 ] || [ "$REMAINING_LIST" -gt 0 ] || [ "$REMAINING_DIRECT" -gt 0 ]; then
              echo "âš ï¸  ä»æœ‰å®¹å™¨æ®‹ç•™ï¼Œå°è¯•å¼ºåˆ¶æ¸…ç†..."
              
              # å†æ¬¡é€šè¿‡åˆ—è¡¨ç²¾ç¡®æŸ¥æ‰¾å¹¶åˆ é™¤
              ALL_REMAINING=$(docker ps -a --format "{{.Names}}\t{{.ID}}" 2>/dev/null || true)
              if [ -n "$ALL_REMAINING" ]; then
                while IFS=$'\t' read -r name id; do
                  if [ "$name" = "$CONTAINER_NAME" ] && [ -n "$id" ]; then
                    echo "  ğŸ›‘ å¼ºåˆ¶åˆ é™¤æ®‹ç•™å®¹å™¨: $name (ID: $id)"
                    docker stop "$id" 2>/dev/null || true
                    docker rm -f "$id" 2>/dev/null || true
                  fi
                done <<< "$ALL_REMAINING"
              fi
              
              # ä½¿ç”¨ filter å’Œ xargs ä½œä¸ºæœ€åæ‰‹æ®µ
              docker ps -a --filter "name=^${CONTAINER_NAME}$" --format "{{.ID}}" 2>/dev/null | xargs -r docker rm -f 2>/dev/null || true
              
              # ç›´æ¥å°è¯•åˆ é™¤
              docker stop "$CONTAINER_NAME" 2>/dev/null || true
              docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
            else
              echo "âœ… å®¹å™¨å·²å®Œå…¨æ¸…ç†"
            fi
            
            # ç­‰å¾…ç«¯å£é‡Šæ”¾ï¼ˆä½¿ç”¨ Docker å‘½ä»¤æ£€æŸ¥ï¼‰
            echo "â³ ç­‰å¾…ç«¯å£ $PORT é‡Šæ”¾..."
            for i in {1..10}; do
              ACTIVE_CONTAINERS=$(docker ps --format "{{.Names}}\t{{.Ports}}" | grep ":$PORT->" | wc -l || echo "0")
              if [ "$ACTIVE_CONTAINERS" = "0" ]; then
                echo "âœ… ç«¯å£ $PORT å·²é‡Šæ”¾"
                break
              fi
              echo "   ç­‰å¾…ä¸­... ($i/10)"
              sleep 1
            done
            
            # æ£€æŸ¥å¹¶åˆ›å»ºç½‘ç»œï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            echo "ğŸŒ æ£€æŸ¥ Docker ç½‘ç»œ..."
            if ! docker network inspect btc-network >/dev/null 2>&1; then
              echo "ğŸ“¦ åˆ›å»º Docker ç½‘ç»œ: btc-network"
              docker network create btc-network || true
            else
              echo "âœ… Docker ç½‘ç»œå·²å­˜åœ¨: btc-network"
            fi
            
            # éªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨
            echo "ğŸ” éªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨..."
            if ! docker images | grep -q "btc-shopflow/$APP_NAME.*latest"; then
              echo "[ERROR] é•œåƒä¸å­˜åœ¨: btc-shopflow/$APP_NAME:latest"
              echo "[ERROR] å¯ç”¨é•œåƒåˆ—è¡¨:"
              docker images | grep "btc-shopflow/$APP_NAME" || echo "  (æ— )"
              exit 1
            fi
            echo "âœ… é•œåƒéªŒè¯é€šè¿‡: btc-shopflow/$APP_NAME:latest"
            
            # ä½¿ç”¨åº”ç”¨ç‰¹å®šçš„ compose æ–‡ä»¶åï¼Œé¿å…è¦†ç›–å…¶ä»–åº”ç”¨çš„é…ç½®
            # ä½¿ç”¨ printf é€è¡Œå†™å…¥ï¼Œé¿å… YAML è§£æé—®é¢˜
            {
              echo "version: '3.8'"
              echo "services:"
              echo "  $APP_NAME:"
              echo "    image: btc-shopflow/$APP_NAME:latest"
              echo "    container_name: $CONTAINER_NAME"
              echo "    ports:"
              echo "      - \"$PORT:80\""
              echo "    restart: unless-stopped"
              echo "    networks:"
              echo "      - btc-network"
              echo "networks:"
              echo "  btc-network:"
              echo "    external: true"
            } > "$COMPOSE_FILE"
            
            echo "ğŸ“‹ Docker Compose é…ç½®:"
            cat "$COMPOSE_FILE"
            echo ""
            
            # æ£€æµ‹ docker-compose å‘½ä»¤ï¼ˆæ”¯æŒæ–°æ—§ç‰ˆæœ¬ï¼‰
            DOCKER_COMPOSE_CMD=""
            if command -v docker-compose >/dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker-compose"
              echo "âœ… ä½¿ç”¨ docker-compose å‘½ä»¤"
            elif docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker compose"
              echo "âœ… ä½¿ç”¨ docker compose å‘½ä»¤"
            else
              echo "[ERROR] æœªæ‰¾åˆ° docker-compose æˆ– docker compose å‘½ä»¤"
              exit 1
            fi
            
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            if ! $DOCKER_COMPOSE_CMD -f "$COMPOSE_FILE" up -d; then
              echo "[ERROR] å®¹å™¨å¯åŠ¨å¤±è´¥"
              echo "[ERROR] æ£€æŸ¥ docker-compose é…ç½®..."
              cat "$COMPOSE_FILE"
              echo "[ERROR] æ£€æŸ¥å®¹å™¨æ—¥å¿—..."
              $DOCKER_COMPOSE_CMD -f "$COMPOSE_FILE" logs 2>&1 || true
              echo "[ERROR] æ£€æŸ¥é•œåƒ..."
              docker images | grep "btc-shopflow/$APP_NAME" || echo "  (æ— ç›¸å…³é•œåƒ)"
              echo "[ERROR] æ£€æŸ¥ç½‘ç»œ..."
              docker network ls | grep btc-network || echo "  (ç½‘ç»œä¸å­˜åœ¨)"
              exit 1
            fi
            
            sleep 5
            
            echo "ğŸ“‹ Container status:"
            docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # éªŒè¯å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼ˆå¸¦è¶…æ—¶æœºåˆ¶å’Œå¤šç§æŸ¥æ‰¾æ–¹æ³•ï¼‰
            echo "ğŸ” éªŒè¯å®¹å™¨çŠ¶æ€ï¼ˆæœ€å¤šç­‰å¾…30ç§’ï¼‰..."
            CONTAINER_STATUS=""
            CONTAINER_ID=""
            MAX_WAIT=30  # å¢åŠ åˆ°30ç§’
            WAIT_INTERVAL=2  # æ¯æ¬¡æ£€æŸ¥é—´éš”2ç§’
            ELAPSED=0
            
            # å®¹å™¨æŸ¥æ‰¾å‡½æ•°ï¼ˆä½¿ç”¨å¤šç§æ–¹æ³•ï¼‰
            find_container() {
              local found_id=""
              local found_status=""
              
              # æ–¹æ³•1: ä½¿ç”¨ filter æŸ¥æ‰¾
              found_id=$(docker ps --filter "name=^${CONTAINER_NAME}$" --format "{{.ID}}" 2>/dev/null | head -1 || echo "")
              if [ -n "$found_id" ]; then
                found_status=$(docker ps --filter "id=$found_id" --format "{{.Status}}" 2>/dev/null || echo "")
                if [ -n "$found_status" ]; then
                  echo "$found_id|$found_status"
                  return 0
                fi
              fi
              
              # æ–¹æ³•2: é€šè¿‡å®¹å™¨ååˆ—è¡¨æŸ¥æ‰¾ï¼ˆæ›´å¯é ï¼‰
              local all_containers=$(docker ps --format "{{.Names}}\t{{.ID}}\t{{.Status}}" 2>/dev/null || true)
              if [ -n "$all_containers" ]; then
                while IFS=$'\t' read -r name id status; do
                  if [ "$name" = "$CONTAINER_NAME" ] && [ -n "$id" ]; then
                    echo "$id|$status"
                    return 0
                  fi
                done <<< "$all_containers"
              fi
              
              # æ–¹æ³•3: é€šè¿‡ docker-compose æŸ¥æ‰¾
              local compose_containers=$($DOCKER_COMPOSE_CMD -f "$COMPOSE_FILE" ps -q 2>/dev/null || true)
              if [ -n "$compose_containers" ]; then
                for compose_id in $compose_containers; do
                  local compose_name=$(docker ps --filter "id=$compose_id" --format "{{.Names}}" 2>/dev/null || echo "")
                  if [ "$compose_name" = "$CONTAINER_NAME" ]; then
                    found_status=$(docker ps --filter "id=$compose_id" --format "{{.Status}}" 2>/dev/null || echo "")
                    if [ -n "$found_status" ]; then
                      echo "$compose_id|$found_status"
                      return 0
                    fi
                  fi
                done
              fi
              
              return 1
            }
            
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              # ä½¿ç”¨å¤šç§æ–¹æ³•æŸ¥æ‰¾å®¹å™¨
              CONTAINER_INFO=$(find_container 2>/dev/null || echo "")
              
              if [ -n "$CONTAINER_INFO" ]; then
                CONTAINER_ID=$(echo "$CONTAINER_INFO" | cut -d'|' -f1)
                CONTAINER_STATUS=$(echo "$CONTAINER_INFO" | cut -d'|' -f2)
                
                if [ -n "$CONTAINER_STATUS" ] && [ -n "$CONTAINER_ID" ]; then
                  echo "âœ… å®¹å™¨æ­£åœ¨è¿è¡Œ: $CONTAINER_STATUS (ID: ${CONTAINER_ID:0:12})"
                  break
                fi
              fi
              
              ELAPSED=$((ELAPSED + WAIT_INTERVAL))
              if [ $ELAPSED -lt $MAX_WAIT ]; then
                echo "   ç­‰å¾…å®¹å™¨å¯åŠ¨... (${ELAPSED}/${MAX_WAIT}ç§’)"
                # æ˜¾ç¤ºå½“å‰æ‰€æœ‰å®¹å™¨çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                if [ $((ELAPSED % 6)) -eq 0 ]; then
                  echo "   ğŸ“Š å½“å‰æ‰€æœ‰å®¹å™¨:"
                  docker ps --format "  {{.Names}}\t{{.Status}}" | grep -E "(NAME|$CONTAINER_NAME)" || echo "  (æ— ç›¸å…³å®¹å™¨)"
                fi
                sleep $WAIT_INTERVAL
              fi
            done
            
            # å¦‚æœè¶…æ—¶ä»æœªæ‰¾åˆ°å®¹å™¨ï¼ŒæŠ¥å‘Šé”™è¯¯å¹¶é€€å‡º
            if [ -z "$CONTAINER_STATUS" ] || [ -z "$CONTAINER_ID" ]; then
              echo "[ERROR] å®¹å™¨éªŒè¯è¶…æ—¶ï¼ˆ${MAX_WAIT}ç§’ï¼‰ï¼å®¹å™¨æœªè¿è¡Œï¼"
              echo "[ERROR] è¯¦ç»†è¯Šæ–­ä¿¡æ¯:"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "[ERROR] 1. æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€..."
              docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.ID}}" | grep -E "(NAME|$CONTAINER_NAME)" || echo "  (æ— ç›¸å…³å®¹å™¨)"
              echo ""
              echo "[ERROR] 2. æ£€æŸ¥ docker-compose çŠ¶æ€..."
              $DOCKER_COMPOSE_CMD -f "$COMPOSE_FILE" ps 2>&1 || true
              echo ""
              echo "[ERROR] 3. æ£€æŸ¥ docker-compose æ—¥å¿—..."
              $DOCKER_COMPOSE_CMD -f "$COMPOSE_FILE" logs --tail=50 2>&1 || true
              echo ""
              echo "[ERROR] 4. å°è¯•ç›´æ¥æŸ¥æ‰¾å®¹å™¨..."
              docker ps -a | grep "$CONTAINER_NAME" || echo "  (æœªæ‰¾åˆ°)"
              echo ""
              echo "[ERROR] 5. æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨ï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„ï¼‰..."
              docker ps -a --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.ID}}" || echo "  (æœªæ‰¾åˆ°)"
              echo ""
              echo "[ERROR] 6. æ£€æŸ¥ Docker äº‹ä»¶ï¼ˆæœ€è¿‘5æ¡ï¼‰..."
              docker events --since 30s --until 0s --filter "container=$CONTAINER_NAME" 2>&1 | tail -5 || echo "  (æ— æ³•è·å–äº‹ä»¶)"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            fi
            
            echo ""
            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f || true
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
