name: Deploy App (Reusable)

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
      app_port:
        required: true
        type: string
      container_name:
        required: true
        type: string

permissions:
  contents: read

jobs:
  deploy-app:
    name: Deploy ${{ inputs.app_name }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Detect deployment info
      id: detect-deploy
      run: |
        APP_NAME="${{ inputs.app_name }}"
        DEPLOY_FILE=".deploy/$APP_NAME/deploy.json"
        
        if [ ! -f "$DEPLOY_FILE" ]; then
          echo "[ERROR] Deployment marker not found: $DEPLOY_FILE"
          exit 1
        fi
        
        IMAGE_PATH=$(cat "$DEPLOY_FILE" | grep -o '"image_path":\s*"[^"]*"' | cut -d'"' -f4 || echo "")
        ENVIRONMENT=$(cat "$DEPLOY_FILE" | grep -o '"environment":\s*"[^"]*"' | cut -d'"' -f4 || echo "production")
        
        if [ -z "$IMAGE_PATH" ]; then
          echo "[ERROR] Could not extract image_path from $DEPLOY_FILE"
          exit 1
        fi
        
        echo "image_path=$IMAGE_PATH" >> $GITHUB_OUTPUT
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
        
        echo "âœ… æ£€æµ‹åˆ°éƒ¨ç½²è¯·æ±‚:"
        echo "   App: $APP_NAME"
        echo "   Image: $IMAGE_PATH"
        echo "   Environment: $ENVIRONMENT"
        
    - name: Deploy application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER || 'root' }}
        key: ${{ secrets.SERVER_KEY }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        timeout: 900s
        command_timeout: 10m
        script: |
          set -e
          
          APP_NAME="${{ inputs.app_name }}"
          IMAGE_PATH="${{ steps.detect-deploy.outputs.image_path }}"
          PORT="${{ inputs.app_port }}"
          CONTAINER_NAME="${{ inputs.container_name }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Starting BTC ShopFlow Deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "App: $APP_NAME"
          echo "Image Path: $IMAGE_PATH"
          echo "Port: $PORT"
          echo ""
          
          if [ ! -f "$IMAGE_PATH" ]; then
            echo "[ERROR] Image file not found: $IMAGE_PATH"
            exit 1
          fi
          
          echo "ğŸ“¥ Loading Docker image..."
          docker load < "$IMAGE_PATH"
          
          LOADED_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "$APP_NAME" | head -1)
          if [ -n "$LOADED_IMAGE" ]; then
            docker tag "$LOADED_IMAGE" "btc-shopflow/$APP_NAME:latest" 2>/dev/null || true
          fi
          
          echo "ğŸ”„ Updating container..."
          docker stop "$CONTAINER_NAME" 2>/dev/null || true
          docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
          
          cat > docker-compose.prod.yml << EOF
          version: '3.8'
          services:
            $APP_NAME:
              image: btc-shopflow/$APP_NAME:latest
              container_name: $CONTAINER_NAME
              ports:
                - "$PORT:80"
              restart: unless-stopped
              networks:
                - btc-network
          networks:
            btc-network:
              driver: bridge
          EOF
          
          docker-compose -f docker-compose.prod.yml up -d
          sleep 5
          
          echo "ğŸ“‹ Container status:"
          docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          rm -f "$IMAGE_PATH" || true
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
