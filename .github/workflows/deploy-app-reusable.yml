name: Deploy App (Reusable)

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
      app_port:
        required: true
        type: string
      container_name:
        required: true
        type: string

permissions:
  contents: read
  packages: read

jobs:
  deploy-app:
    name: Deploy ${{ inputs.app_name }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Detect deployment info
      id: detect-deploy
      run: |
        APP_NAME="${{ inputs.app_name }}"
        ENVIRONMENT="production"
        
        # èŽ·å–é•œåƒæ ‡ç­¾ï¼ˆä¼˜å…ˆä½¿ç”¨ SHAï¼Œå¦åˆ™ä½¿ç”¨ latestï¼‰
        GITHUB_SHA="${{ github.sha }}"
        IMAGE_TAG="${GITHUB_SHA:0:7}"
        
        # å¦‚æžœ SHA å¤ªçŸ­ï¼Œä½¿ç”¨ latest
        if [ ${#IMAGE_TAG} -lt 7 ]; then
          IMAGE_TAG="latest"
        fi
        
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        
        echo "âœ… æ£€æµ‹åˆ°éƒ¨ç½²è¯·æ±‚:"
        echo "   App: $APP_NAME"
        echo "   Image Tag: $IMAGE_TAG"
        echo "   Environment: $ENVIRONMENT"
        
      - name: Deploy application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER || 'root' }}
        key: ${{ secrets.SERVER_KEY }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        timeout: 900s
        command_timeout: 10m
        script: |
          set -e
          
          APP_NAME="${{ inputs.app_name }}"
          IMAGE_TAG="${{ steps.detect-deploy.outputs.image_tag }}"
          PORT="${{ inputs.app_port }}"
          CONTAINER_NAME="${{ inputs.container_name }}"
          
          REPO_LOWER="bellisgit/btc-shopflow-monorepo"
          REGISTRY="ghcr.io"
          IMAGE_NAME="$REGISTRY/$REPO_LOWER/$APP_NAME"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš€ Starting BTC ShopFlow Deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "App: $APP_NAME"
          echo "Image: $IMAGE_NAME:$IMAGE_TAG"
          echo "Port: $PORT"
          echo ""
          
          # ç™»å½•åˆ° GHCR
          echo "ðŸ” Logging into container registry..."
          mkdir -p /tmp/.docker
          export DOCKER_CONFIG=/tmp/.docker
          
          # ä½¿ç”¨ GitHub Token ç™»å½•ï¼ˆä»ŽçŽ¯å¢ƒå˜é‡æˆ– secretsï¼‰
          if [ -n "${{ secrets.SERVER_PAT }}" ]; then
            TOKEN="${{ secrets.SERVER_PAT }}"
          elif [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
          else
            echo "[ERROR] No token available for registry"
            exit 1
          fi
          
          echo "$TOKEN" | docker login $REGISTRY -u ${{ github.actor }} --password-stdin
          
          # ä»Ž GHCR æ‹‰å–é•œåƒ
          echo "ðŸ“¥ Pulling Docker image from $REGISTRY..."
          if ! docker pull "$IMAGE_NAME:$IMAGE_TAG"; then
            echo "âš ï¸  Failed to pull $IMAGE_NAME:$IMAGE_TAG, trying latest..."
            if ! docker pull "$IMAGE_NAME:latest"; then
              echo "[ERROR] Failed to pull image from $REGISTRY"
              exit 1
            fi
            IMAGE_TAG="latest"
          fi
          
          # æ ‡è®°ä¸ºæœ¬åœ°é•œåƒ
          docker tag "$IMAGE_NAME:$IMAGE_TAG" "btc-shopflow/$APP_NAME:latest" 2>/dev/null || true
          echo "âœ… Image pulled and tagged successfully"
          
          echo "ðŸ”„ Updating container..."
          
          # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ï¼ˆåŒ…æ‹¬ä½¿ç”¨ç›¸åŒç«¯å£çš„å®¹å™¨ï¼‰
          echo "ðŸ“‹ æ£€æŸ¥çŽ°æœ‰å®¹å™¨..."
          EXISTING_CONTAINER=$(docker ps -a --filter "name=$CONTAINER_NAME" --format "{{.ID}}" | head -1)
          if [ -n "$EXISTING_CONTAINER" ]; then
            echo "ðŸ›‘ åœæ­¢æ—§å®¹å™¨: $CONTAINER_NAME"
            docker stop "$CONTAINER_NAME" 2>/dev/null || true
            docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
          fi
          
          # æ£€æŸ¥å¹¶åœæ­¢å ç”¨ç«¯å£çš„å®¹å™¨ï¼ˆä½¿ç”¨æ›´å¯é çš„æ–¹æ³•ï¼‰
          echo "ðŸ” æ£€æŸ¥ç«¯å£ $PORT å ç”¨æƒ…å†µ..."
          PORT_CONTAINERS=$(docker ps --format "{{.Names}}\t{{.Ports}}" | grep ":$PORT->" | awk '{print $1}' || true)
          if [ -n "$PORT_CONTAINERS" ]; then
            echo "âš ï¸  å‘çŽ°å ç”¨ç«¯å£ $PORT çš„å®¹å™¨:"
            echo "$PORT_CONTAINERS"
            echo "$PORT_CONTAINERS" | while read -r container; do
              if [ -n "$container" ] && [ "$container" != "$CONTAINER_NAME" ]; then
                echo "ðŸ›‘ åœæ­¢å®¹å™¨: $container"
                docker stop "$container" 2>/dev/null || true
                docker rm -f "$container" 2>/dev/null || true
              fi
            done
          fi
          
          # ä½¿ç”¨ docker-compose down ç¡®ä¿å®Œå…¨æ¸…ç†ï¼ˆå¦‚æžœå­˜åœ¨æ—§çš„ compose é…ç½®ï¼‰
          if [ -f "docker-compose.prod.yml" ]; then
            echo "ðŸ§¹ æ¸…ç†æ—§çš„ docker-compose æœåŠ¡..."
            docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
          fi
          
          # ç­‰å¾…ç«¯å£é‡Šæ”¾ï¼ˆä½¿ç”¨ Docker å‘½ä»¤æ£€æŸ¥ï¼‰
          echo "â³ ç­‰å¾…ç«¯å£ $PORT é‡Šæ”¾..."
          for i in {1..10}; do
            ACTIVE_CONTAINERS=$(docker ps --format "{{.Names}}\t{{.Ports}}" | grep ":$PORT->" | wc -l || echo "0")
            if [ "$ACTIVE_CONTAINERS" = "0" ]; then
              echo "âœ… ç«¯å£ $PORT å·²é‡Šæ”¾"
              break
            fi
            echo "   ç­‰å¾…ä¸­... ($i/10)"
            sleep 1
          done
          
          cat > docker-compose.prod.yml << EOF
          version: '3.8'
          services:
            $APP_NAME:
              image: btc-shopflow/$APP_NAME:latest
              container_name: $CONTAINER_NAME
              ports:
                - "$PORT:80"
              restart: unless-stopped
              networks:
                - btc-network
          networks:
            btc-network:
              driver: bridge
          EOF
          
          echo "ðŸš€ å¯åŠ¨æ–°å®¹å™¨..."
          docker-compose -f docker-compose.prod.yml up -d
          sleep 5
          
          echo "ðŸ“‹ Container status:"
          docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo ""
          echo "ðŸ§¹ Cleaning up unused images..."
          docker image prune -f || true
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
