name: Build App (Reusable)

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application name (e.g., system-app, admin-app)'
        required: true
        type: string
      registry:
        description: 'Container registry URL'
        required: true
        type: string
      github_repository:
        description: 'GitHub repository name'
        required: true
        type: string
      github_sha:
        description: 'GitHub commit SHA'
        required: true
        type: string
    secrets:
      gh_token:
        description: 'GitHub token for registry access'
        required: true

jobs:
  build-app:
    name: Build ${{ inputs.app_name }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
    
    - name: Cache pnpm store
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
    
    - name: Install dependencies
      run: |
        pnpm install --frozen-lockfile --prefer-offline
    
    - name: Restore built packages cache
      uses: actions/cache@v3
      with:
        path: |
          packages/*/dist
          packages/*/build
        key: packages-build-${{ github.sha }}
        restore-keys: |
          packages-build-
    
    - name: Build dependencies if needed
      run: |
        if [ ! -d "packages/vite-plugin/dist" ] || [ ! -f "packages/vite-plugin/dist/index.js" ]; then
          echo "Building dependencies for ${{ inputs.app_name }}..."
          # Build vite-plugin first as other packages may depend on it
          pnpm --filter @btc/vite-plugin run build
          # Build all package dependencies in order
          pnpm --filter @btc/shared-utils run build
          pnpm --filter @btc/shared-core run build
          pnpm --filter @btc/shared-components run build
          pnpm --filter @btc/subapp-manifests run build
        else
          echo "Using cached built packages"
        fi
    
    - name: Build application
      run: cd apps/${{ inputs.app_name }} && pnpm run build
    
    - name: Validate GitHub Token
      run: |
        echo "Validating GitHub token for registry access..."
        
        if [ -n "${{ secrets.gh_token }}" ]; then
          echo "[SUCCESS] gh_token is available for Docker registry"
          echo "Token length: $(echo '${{ secrets.gh_token }}' | wc -c) characters"
          
          # Test token permissions
          echo "Testing token permissions for ghcr.io..."
          if echo "${{ secrets.gh_token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin; then
            echo "[SUCCESS] Token has valid permissions for ghcr.io"
          else
            echo "[ERROR] Token authentication failed for ghcr.io"
            echo "Please ensure SERVER_PAT has 'write:packages' scope"
            exit 1
          fi
        else
          echo "[ERROR] gh_token is not available"
          echo "Please set SERVER_PAT secret with 'write:packages' scope in repository settings"
          echo "Falling back to GITHUB_TOKEN may not work for package registry"
          exit 1
        fi

    - name: Prepare Docker tags
      id: tags
      run: |
        # Convert repository name to lowercase for Docker compatibility
        REPO_LOWER=$(echo "${{ inputs.github_repository }}" | tr '[:upper:]' '[:lower:]')
        echo "repository_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
        echo "[INFO] Docker tags will use: $REPO_LOWER"
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ github.actor }}
        password: ${{ secrets.gh_token }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        build-args: |
          APP_DIR=apps/${{ inputs.app_name }}
        push: true
        tags: |
          ${{ inputs.registry }}/${{ steps.tags.outputs.repository_lower }}/${{ inputs.app_name }}:latest
          ${{ inputs.registry }}/${{ steps.tags.outputs.repository_lower }}/${{ inputs.app_name }}:${{ inputs.github_sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      env:
        DOCKER_BUILDKIT: 1
