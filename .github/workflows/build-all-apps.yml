name: Build All Apps

# å…¨é‡æ„å»ºå·¥ä½œæµï¼šä½¿ç”¨å¯å¤ç”¨å·¥ä½œæµå¹¶è¡Œæ„å»ºæ‰€æœ‰8ä¸ªåº”ç”¨
# - è§¦å‘æ¡ä»¶ï¼š
#   1. repository_dispatch äº‹ä»¶ï¼ˆé€šè¿‡ API è§¦å‘ï¼Œevent_type: build-all-appsï¼‰
#   2. workflow_dispatchï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
# - ä½¿ç”¨çŸ©é˜µç­–ç•¥å¹¶è¡Œæ„å»ºæ‰€æœ‰åº”ç”¨
# - æ„å»ºå®Œæˆåï¼Œè‡ªåŠ¨è§¦å‘å…¨é‡éƒ¨ç½²å·¥ä½œæµ
on:
  repository_dispatch:
    types: [build-all-apps]
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  packages: write

jobs:
  build-all:
    name: Build All Apps
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - app_name: system-app
          - app_name: admin-app
          - app_name: logistics-app
          - app_name: quality-app
          - app_name: production-app
          - app_name: engineering-app
          - app_name: finance-app
      fail-fast: false
      max-parallel: 8
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Get pnpm store directory
        shell: bash
        id: pnpm-cache
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT
          echo "PNPM_STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            **/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline
      
      - name: Restore built packages cache
        uses: actions/cache@v3
        with:
          path: |
            packages/*/dist
            packages/*/build
          key: packages-build-${{ github.sha }}
          restore-keys: |
            packages-build-
      
      - name: Build shared dependencies
        run: |
          echo "ğŸ”¨ æ„å»ºå…±äº«ä¾èµ–åŒ…..."
          echo "  è¿™ç¡®ä¿å…±äº«ç»„ä»¶åŒ…ï¼ˆå¦‚ @btc/shared-componentsï¼‰çš„ä¿®æ”¹èƒ½å¤Ÿç”Ÿæ•ˆ"
          echo ""
          
          # å§‹ç»ˆé‡æ–°æ„å»ºå…±äº«ä¾èµ–ï¼Œç¡®ä¿ä¿®æ”¹ç”Ÿæ•ˆ
          # ä½¿ç”¨ --force ç¡®ä¿å³ä½¿ç¼“å­˜å­˜åœ¨ä¹Ÿé‡æ–°æ„å»º
          echo "ğŸ“¦ æ„å»º @btc/vite-plugin..."
          pnpm --filter @btc/vite-plugin run build --force || pnpm --filter @btc/vite-plugin run build
          
          echo "ğŸ“¦ æ„å»º @btc/shared-utils..."
          pnpm --filter @btc/shared-utils run build --force || pnpm --filter @btc/shared-utils run build
          
          echo "ğŸ“¦ æ„å»º @btc/shared-core..."
          pnpm --filter @btc/shared-core run build --force || pnpm --filter @btc/shared-core run build
          
          echo "ğŸ“¦ æ„å»º @btc/shared-components..."
          pnpm --filter @btc/shared-components run build --force || pnpm --filter @btc/shared-components run build
          
          echo "ğŸ“¦ æ„å»º @btc/subapp-manifests..."
          pnpm --filter @btc/subapp-manifests run build --force || pnpm --filter @btc/subapp-manifests run build
          
          echo "âœ… å…±äº«ä¾èµ–åŒ…æ„å»ºå®Œæˆ"
      
      - name: Build ${{ matrix.app_name }}
        run: |
          echo "Building ${{ matrix.app_name }}..."
          pnpm --filter ${{ matrix.app_name }} run build
      
      - name: Verify build output
        run: |
          if [ ! -d "apps/${{ matrix.app_name }}/dist" ] || [ -z "$(ls -A apps/${{ matrix.app_name }}/dist 2>/dev/null)" ]; then
            echo "[ERROR] Build output is empty or does not exist"
            exit 1
          fi
          echo "[SUCCESS] Build output verified"
      
      - name: Validate GitHub Token
        run: |
          echo "Validating GitHub token for registry access..."
          
          if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
            echo "[INFO] Using GITHUB_TOKEN"
          else
            echo "[ERROR] No token available"
            exit 1
          fi
          
          echo "[SUCCESS] Token is available"
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
      
      - name: Prepare Docker tags
        id: tags
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          GIT_SHA="${{ github.sha }}"
          GIT_SHA_SHORT="${GIT_SHA:0:7}"
          echo "repository_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
          echo "git_sha_short=$GIT_SHA_SHORT" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ env.TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            APP_DIR=apps/${{ matrix.app_name }}
          push: true
          tags: |
            ghcr.io/${{ steps.tags.outputs.repository_lower }}/${{ matrix.app_name }}:latest
            ghcr.io/${{ steps.tags.outputs.repository_lower }}/${{ matrix.app_name }}:${{ steps.tags.outputs.git_sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        env:
          DOCKER_BUILDKIT: 1

  trigger-deploy:
    name: Trigger Deploy All Apps
    needs: build-all
    if: always() && !contains(needs.build-all.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Check build results
        run: |
          echo "æ£€æŸ¥æ„å»ºç»“æœ..."
          echo "build-all result: ${{ needs.build-all.result }}"
      
      - name: Trigger deploy-all-apps workflow
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const response = await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'deploy-all-apps.yml',
                ref: 'develop',
                inputs: {}
              });
              console.log('âœ… å…¨é‡éƒ¨ç½²å·¥ä½œæµå·²è§¦å‘');
            } catch (error) {
              console.error('âŒ è§¦å‘å…¨é‡éƒ¨ç½²å·¥ä½œæµå¤±è´¥:', error.message);
              throw error;
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

