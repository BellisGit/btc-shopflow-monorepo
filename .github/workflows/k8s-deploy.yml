name: â˜¸ï¸ Kubernetes Deployment

on:
  workflow_run:
    workflows: ["ğŸ³ Build Docker Images"]
    branches: [master]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½²ï¼ˆå¿½ç•¥æ„å»ºçŠ¶æ€ï¼‰'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  NAMESPACE: btc-shopflow

jobs:
  check-build:
    name: ğŸ” Check Build Status
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    
    steps:
    - name: ğŸ” Check build status
      id: check
      run: |
        if [ "${{ github.event.workflow_run.conclusion }}" == "success" ] || [ "${{ github.event.inputs.force_deploy }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… Build successful or force deploy requested"
        else
          echo "should-deploy=false" >> $GITHUB_OUTPUT
          echo "âŒ Build failed, skipping deployment"
        fi

  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: check-build
    if: needs.check-build.outputs.should-deploy == 'true'
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: ğŸ” Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config

    - name: ğŸ” Verify cluster connection
      run: |
        echo "ğŸ” Verifying cluster connection..."
        kubectl cluster-info
        kubectl get nodes
        echo "âœ… Cluster connection verified"

    - name: ğŸ“‹ Check namespace
      run: |
        if ! kubectl get namespace ${{ env.NAMESPACE }} &> /dev/null; then
          echo "ğŸ“ Creating namespace ${{ env.NAMESPACE }}..."
          kubectl apply -f k8s/namespace.yaml
        else
          echo "âœ… Namespace ${{ env.NAMESPACE }} already exists"
        fi

    - name: ğŸ”§ Apply ConfigMaps
      run: |
        echo "ğŸ”§ Applying ConfigMaps..."
        kubectl apply -f k8s/configmap.yaml -n ${{ env.NAMESPACE }}

    - name: ğŸ—ï¸ Deploy applications
      run: |
        echo "ğŸ—ï¸ Deploying applications..."
        
        # åº”ç”¨æ‰€æœ‰éƒ¨ç½²é…ç½®
        if [ -f "k8s/deployments/complete-apps.yaml" ]; then
          kubectl apply -f k8s/deployments/complete-apps.yaml -n ${{ env.NAMESPACE }}
        else
          # é€ä¸ªåº”ç”¨éƒ¨ç½²æ–‡ä»¶
          for deployment in k8s/deployments/*.yaml; do
            if [ -f "$deployment" ] && [ "$(basename "$deployment")" != "complete-apps.yaml" ]; then
              echo "ğŸ“¦ Applying $deployment..."
              kubectl apply -f "$deployment" -n ${{ env.NAMESPACE }}
            fi
          done
        fi

    - name: ğŸ”„ Update images
      run: |
        echo "ğŸ”„ Updating deployment images..."
        
        apps=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
        
        for app in "${apps[@]}"; do
          deployment_name="btc-$app"
          image_name="${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }}"
          
          echo "ğŸ”„ Updating $deployment_name with image $image_name..."
          
          # æ£€æŸ¥éƒ¨ç½²æ˜¯å¦å­˜åœ¨
          if kubectl get deployment "$deployment_name" -n ${{ env.NAMESPACE }} &> /dev/null; then
            kubectl set image deployment/"$deployment_name" "$app"="$image_name" -n ${{ env.NAMESPACE }}
          else
            echo "âš ï¸ Deployment $deployment_name not found, skipping image update"
          fi
        done

    - name: ğŸŒ Apply Ingress
      run: |
        echo "ğŸŒ Applying Ingress configuration..."
        if [ -f "k8s/ingress.yaml" ]; then
          kubectl apply -f k8s/ingress.yaml -n ${{ env.NAMESPACE }}
        fi

    - name: ğŸ“ˆ Apply HPA
      run: |
        echo "ğŸ“ˆ Applying HPA configuration..."
        if [ -f "k8s/hpa.yaml" ]; then
          kubectl apply -f k8s/hpa.yaml -n ${{ env.NAMESPACE }}
        fi

    - name: â³ Wait for rollout
      run: |
        echo "â³ Waiting for deployments to be ready..."
        
        apps=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
        
        for app in "${apps[@]}"; do
          deployment_name="btc-$app"
          
          if kubectl get deployment "$deployment_name" -n ${{ env.NAMESPACE }} &> /dev/null; then
            echo "â³ Waiting for $deployment_name rollout..."
            kubectl rollout status deployment/"$deployment_name" -n ${{ env.NAMESPACE }} --timeout=600s
          else
            echo "âš ï¸ Deployment $deployment_name not found, skipping rollout wait"
          fi
        done

    - name: ğŸ” Verify deployment
      run: |
        echo "ğŸ” Verifying deployment status..."
        
        echo "ğŸ“Š Deployments:"
        kubectl get deployments -n ${{ env.NAMESPACE }}
        
        echo ""
        echo "ğŸƒ Pods:"
        kubectl get pods -n ${{ env.NAMESPACE }}
        
        echo ""
        echo "ğŸŒ Services:"
        kubectl get services -n ${{ env.NAMESPACE }}
        
        echo ""
        echo "ğŸ”— Ingress:"
        kubectl get ingress -n ${{ env.NAMESPACE }} || echo "No ingress found"

    - name: ğŸ§ª Health check
      run: |
        echo "ğŸ§ª Running health checks..."
        
        # æ£€æŸ¥æ‰€æœ‰ Pod æ˜¯å¦è¿è¡Œæ­£å¸¸
        failed_pods=$(kubectl get pods -n ${{ env.NAMESPACE }} --field-selector=status.phase!=Running --no-headers | wc -l)
        
        if [ "$failed_pods" -eq 0 ]; then
          echo "âœ… All pods are running successfully"
        else
          echo "âŒ $failed_pods pods are not running properly"
          kubectl get pods -n ${{ env.NAMESPACE }} --field-selector=status.phase!=Running
        fi
        
        # æ£€æŸ¥æœåŠ¡ç«¯ç‚¹
        services=$(kubectl get services -n ${{ env.NAMESPACE }} -o jsonpath='{.items[*].metadata.name}')
        
        for service in $services; do
          if [[ "$service" == *"-service" ]]; then
            echo "ğŸ” Checking service: $service"
            kubectl describe service "$service" -n ${{ env.NAMESPACE }} | grep -E "(Endpoints|Port)" || true
          fi
        done

    - name: ğŸ“Š Generate deployment report
      run: |
        echo "## ğŸš€ Kubernetes Deployment Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Namespace**: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“¦ Deployed Applications:" >> $GITHUB_STEP_SUMMARY
        kubectl get deployments -n ${{ env.NAMESPACE }} --no-headers | while read line; do
          name=$(echo $line | awk '{print $1}')
          ready=$(echo $line | awk '{print $2}')
          echo "- **$name**: $ready" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ Services:" >> $GITHUB_STEP_SUMMARY
        kubectl get services -n ${{ env.NAMESPACE }} --no-headers | while read line; do
          name=$(echo $line | awk '{print $1}')
          type=$(echo $line | awk '{print $2}')
          ports=$(echo $line | awk '{print $5}')
          echo "- **$name** ($type): $ports" >> $GITHUB_STEP_SUMMARY
        done

  rollback:
    name: ğŸ”„ Rollback on Failure
    runs-on: ubuntu-latest
    needs: [check-build, deploy]
    if: failure() && needs.check-build.outputs.should-deploy == 'true'
    
    steps:
    - name: ğŸ”§ Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: ğŸ” Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config

    - name: ğŸ”„ Rollback deployments
      run: |
        echo "ğŸ”„ Rolling back deployments due to failure..."
        
        apps=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
        
        for app in "${apps[@]}"; do
          deployment_name="btc-$app"
          
          if kubectl get deployment "$deployment_name" -n ${{ env.NAMESPACE }} &> /dev/null; then
            echo "ğŸ”„ Rolling back $deployment_name..."
            kubectl rollout undo deployment/"$deployment_name" -n ${{ env.NAMESPACE }}
          fi
        done

    - name: â³ Wait for rollback
      run: |
        echo "â³ Waiting for rollback to complete..."
        
        apps=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
        
        for app in "${apps[@]}"; do
          deployment_name="btc-$app"
          
          if kubectl get deployment "$deployment_name" -n ${{ env.NAMESPACE }} &> /dev/null; then
            kubectl rollout status deployment/"$deployment_name" -n ${{ env.NAMESPACE }} --timeout=300s
          fi
        done

  notify:
    name: ğŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [check-build, deploy]
    if: always() && needs.check-build.outputs.should-deploy == 'true'
    
    steps:
    - name: ğŸ“¢ Success notification
      if: needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ **Deployment Successful!**"
        echo "âœ… All applications have been successfully deployed to Kubernetes"
        echo "ğŸŒ Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "ğŸ”— URL: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}"
        
    - name: ğŸ“¢ Failure notification
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ **Deployment Failed!**"
        echo "ğŸ” Please check the deployment logs for details"
        echo "ğŸ”„ Automatic rollback has been initiated"
        exit 1
