name: â˜¸ï¸ Kubernetes Deployment

on:
  workflow_run:
    workflows: ["ğŸ³ Build Docker Images"]
    branches: [master]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½²ï¼ˆå¿½ç•¥æ„å»ºçŠ¶æ€ï¼‰'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  NAMESPACE: btc-shopflow

jobs:
  check-build:
    name: ğŸ” Check Build Status
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    
    steps:
    - name: ğŸ” Check build status
      id: check
      run: |
        if [ "${{ github.event.workflow_run.conclusion }}" == "success" ] || [ "${{ github.event.inputs.force_deploy }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… Build successful or force deploy requested"
        else
          echo "should-deploy=false" >> $GITHUB_OUTPUT
          echo "âŒ Build failed, skipping deployment"
        fi

  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: check-build
    if: needs.check-build.outputs.should-deploy == 'true'
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸ” Verify server connection
      run: |
        echo "ğŸ” Verifying server connection..."
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'Server connection successful'"
        echo "âœ… Server connection verified"

    - name: ğŸš€ Deploy to server via SSH
      run: |
        echo "ğŸš€ Deploying to server via SSH..."
        
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        set -e
        
        echo "ğŸ“ Navigating to project directory..."
        cd /www/wwwroot/btc-shopflow-monorepo
        
        echo "ğŸ“¥ Pulling latest code..."
        git pull origin master
        
        echo "ğŸ³ Pulling latest Docker images..."
        apps=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
        
        for app in "${apps[@]}"; do
          echo "ğŸ“¥ Pulling ${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }}..."
          docker pull ${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }} || echo "âš ï¸ Failed to pull $app image"
          
          # Tag as latest for local use
          docker tag ${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }} btc-shopflow/$app:latest || echo "âš ï¸ Failed to tag $app image"
        done
        
        echo "ğŸ”„ Restarting services..."
        if [ -f "docker-compose.prod.yml" ]; then
          docker-compose -f docker-compose.prod.yml down
          docker-compose -f docker-compose.prod.yml up -d
        else
          echo "ğŸ“ Creating docker-compose.prod.yml..."
          cat > docker-compose.prod.yml << 'COMPOSE_EOF'
        version: '3.8'
        
        services:
          system-app:
            image: btc-shopflow/system-app:latest
            container_name: btc-system-app
            ports:
              - "30080:80"
            restart: unless-stopped
            environment:
              - NODE_ENV=production
            networks:
              - btc-network
        
          admin-app:
            image: btc-shopflow/admin-app:latest
            container_name: btc-admin-app
            ports:
              - "30081:80"
            restart: unless-stopped
            environment:
              - NODE_ENV=production
            networks:
              - btc-network
        
          finance-app:
            image: btc-shopflow/finance-app:latest
            container_name: btc-finance-app
            ports:
              - "30086:80"
            restart: unless-stopped
            environment:
              - NODE_ENV=production
            networks:
              - btc-network
        
          logistics-app:
            image: btc-shopflow/logistics-app:latest
            container_name: btc-logistics-app
            ports:
              - "30082:80"
            restart: unless-stopped
            environment:
              - NODE_ENV=production
            networks:
              - btc-network
        
          quality-app:
            image: btc-shopflow/quality-app:latest
            container_name: btc-quality-app
            ports:
              - "30083:80"
            restart: unless-stopped
            environment:
              - NODE_ENV=production
            networks:
              - btc-network
        
          production-app:
            image: btc-shopflow/production-app:latest
            container_name: btc-production-app
            ports:
              - "30084:80"
            restart: unless-stopped
            environment:
              - NODE_ENV=production
            networks:
              - btc-network
        
          engineering-app:
            image: btc-shopflow/engineering-app:latest
            container_name: btc-engineering-app
            ports:
              - "30085:80"
            restart: unless-stopped
            environment:
              - NODE_ENV=production
            networks:
              - btc-network
        
          mobile-app:
            image: btc-shopflow/mobile-app:latest
            container_name: btc-mobile-app
            ports:
              - "30091:80"
            restart: unless-stopped
            environment:
              - NODE_ENV=production
            networks:
              - btc-network
        
        networks:
          btc-network:
            driver: bridge
        COMPOSE_EOF
          
          docker-compose -f docker-compose.prod.yml up -d
        fi
        
        echo "â³ Waiting for services to start..."
        sleep 30
        
        echo "ğŸ” Checking service status..."
        docker-compose -f docker-compose.prod.yml ps
        
        EOF

    - name: ğŸ§ª Health check via SSH
      run: |
        echo "ğŸ§ª Running health checks via SSH..."
        
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        
        echo "ğŸ§ª Testing application endpoints..."
        
        ports=(30080 30081 30082 30083 30084 30085 30086 30091)
        app_names=("ä¸»åº”ç”¨" "ç®¡ç†åå°" "ç‰©æµç³»ç»Ÿ" "è´¨é‡ç³»ç»Ÿ" "ç”Ÿäº§ç³»ç»Ÿ" "å·¥ç¨‹ç³»ç»Ÿ" "è´¢åŠ¡ç³»ç»Ÿ" "ç§»åŠ¨ç«¯")
        
        for i in "${!ports[@]}"; do
          port=${ports[$i]}
          app_name=${app_names[$i]}
          
          if curl -f -s --max-time 10 "http://localhost:$port" > /dev/null 2>&1; then
            echo "âœ… $app_name ($port) æœåŠ¡æ­£å¸¸"
          else
            echo "âš ï¸ $app_name ($port) æœåŠ¡å¯èƒ½ä»åœ¨å¯åŠ¨"
          fi
        done
        
        echo ""
        echo "ğŸ“Š Docker å®¹å™¨çŠ¶æ€:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
        EOF

    - name: ğŸ“Š Generate deployment report
      run: |
        echo "## ğŸš€ SSH Deployment Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Server**: ${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ Deployment Method:" >> $GITHUB_STEP_SUMMARY
        echo "- SSHè¿æ¥åˆ°æœåŠ¡å™¨" >> $GITHUB_STEP_SUMMARY
        echo "- æ‹‰å–æœ€æ–°ä»£ç å’ŒDockeré•œåƒ" >> $GITHUB_STEP_SUMMARY
        echo "- ä½¿ç”¨Docker Composeé‡å¯æœåŠ¡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ åº”ç”¨ç«¯å£:" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸»åº”ç”¨: 30080" >> $GITHUB_STEP_SUMMARY
        echo "- ç®¡ç†åå°: 30081" >> $GITHUB_STEP_SUMMARY
        echo "- ç‰©æµç³»ç»Ÿ: 30082" >> $GITHUB_STEP_SUMMARY
        echo "- è´¨é‡ç³»ç»Ÿ: 30083" >> $GITHUB_STEP_SUMMARY
        echo "- ç”Ÿäº§ç³»ç»Ÿ: 30084" >> $GITHUB_STEP_SUMMARY
        echo "- å·¥ç¨‹ç³»ç»Ÿ: 30085" >> $GITHUB_STEP_SUMMARY
        echo "- è´¢åŠ¡ç³»ç»Ÿ: 30086" >> $GITHUB_STEP_SUMMARY
        echo "- ç§»åŠ¨ç«¯: 30091" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: ğŸ”„ Rollback on Failure
    runs-on: ubuntu-latest
    needs: [check-build, deploy]
    if: failure() && needs.check-build.outputs.should-deploy == 'true'
    
    steps:
    - name: ğŸ” Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸ”„ Rollback via SSH
      run: |
        echo "ğŸ”„ Rolling back deployment due to failure..."
        
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        set -e
        
        echo "ğŸ”„ Stopping current services..."
        cd /www/wwwroot/btc-shopflow-monorepo
        
        if [ -f "docker-compose.prod.yml" ]; then
          docker-compose -f docker-compose.prod.yml down
        fi
        
        echo "ğŸ”„ Reverting to previous commit..."
        git reset --hard HEAD~1
        
        echo "ğŸ”„ Restarting services with previous version..."
        if [ -f "docker-compose.prod.yml" ]; then
          docker-compose -f docker-compose.prod.yml up -d
        fi
        
        echo "â³ Waiting for rollback to complete..."
        sleep 30
        
        echo "ğŸ” Checking rollback status..."
        docker-compose -f docker-compose.prod.yml ps
        
        EOF

  notify:
    name: ğŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [check-build, deploy]
    if: always() && needs.check-build.outputs.should-deploy == 'true'
    
    steps:
    - name: ğŸ“¢ Success notification
      if: needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ **Deployment Successful!**"
        echo "âœ… All applications have been successfully deployed to Kubernetes"
        echo "ğŸŒ Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "ğŸ”— URL: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}"
        
    - name: ğŸ“¢ Failure notification
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ **Deployment Failed!**"
        echo "ğŸ” Please check the deployment logs for details"
        echo "ğŸ”„ Automatic rollback has been initiated"
        exit 1
