name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      apps:
        description: '选择要部署的应用 (用逗号分隔，或填写 "all" 部署所有应用)'
        required: true
        default: 'all'
        type: string
      environment:
        description: '部署环境'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_build:
        description: '跳过构建，直接部署现有镜像'
        required: false
        default: false
        type: boolean
      force_recreate:
        description: '强制重新创建Pod'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io

jobs:
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      apps-matrix: ${{ steps.apps.outputs.matrix }}
      should-build: ${{ steps.build.outputs.should-build }}
    
    steps:
    - name: Parse applications
      id: apps
      run: |
        input_apps="${{ github.event.inputs.apps }}"
        if [ "$input_apps" == "all" ]; then
          apps='["system-app","admin-app","logistics-app","quality-app","production-app","engineering-app","finance-app","mobile-app"]'
        else
          # 将逗号分隔的字符串转换为JSON数组
          apps=$(echo "$input_apps" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/') 
        fi
        echo "matrix=$apps" >> $GITHUB_OUTPUT
        echo "Selected apps: $apps"
    
    - name: Determine build requirement
      id: build
      run: |
        if [ "${{ github.event.inputs.skip_build }}" == "true" ]; then
          echo "should-build=false" >> $GITHUB_OUTPUT
          echo "Skipping build, using existing images"
        else
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "Will build new images"
        fi

  build:
    name: Build Selected Apps
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should-build == 'true'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        app: ${{ fromJson(needs.prepare.outputs.apps-matrix) }}
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
    
    - name: Build application
      run: |
        echo "Building ${{ matrix.app }}..."
        if [ ! -d "apps/${{ matrix.app }}" ]; then
          echo "App directory apps/${{ matrix.app }} does not exist"
          exit 1
        fi
        cd apps/${{ matrix.app }} && pnpm run build
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create Dockerfile
      run: |
        cat > apps/${{ matrix.app }}/Dockerfile << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        COPY package*.json pnpm-*.yaml ./
        COPY packages ./packages
        COPY apps/${{ matrix.app }} ./apps/${{ matrix.app }}
        RUN npm install -g pnpm
        RUN pnpm install --frozen-lockfile
        RUN cd apps/${{ matrix.app }} && pnpm run build

        FROM nginx:alpine
        COPY --from=builder /app/apps/${{ matrix.app }}/dist /usr/share/nginx/html
        COPY apps/${{ matrix.app }}/nginx.conf /etc/nginx/conf.d/default.conf 2>/dev/null || echo "server { listen 80; location / { try_files \$uri \$uri/ /index.html; } }" > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: apps/${{ matrix.app }}/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.app }}:latest
          ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.app }}:${{ github.sha }}

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: always() && (needs.build.result == 'success' || needs.prepare.outputs.should-build == 'false')
    environment:
      name: ${{ github.event.inputs.environment }}
      url: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
        sed -i 's/\\n/\n/g' ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: Verify server connection
      run: |
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || '22' }} \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} \
            "echo 'Server connection successful'"
    
    - name: Deploy applications
      run: |
        echo "Deploying selected applications..."
        selected_apps='${{ needs.prepare.outputs.apps-matrix }}'
        echo "Selected apps: $selected_apps"
        
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || '22' }} \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} << EOF
        set -e
        
        echo "Navigating to project directory..."
        cd /www/wwwroot/btc-shopflow-monorepo
        
        echo "Pulling latest code..."
        git pull origin master
        
        echo "Logging into container registry..."
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
        
        echo "Starting selective deployment..."
        chmod +x scripts/deploy.sh
        
        # 设置环境变量来指定要部署的应用
        export DEPLOY_APPS="$selected_apps"
        export FORCE_RECREATE="${{ github.event.inputs.force_recreate }}"
        
        ./scripts/deploy.sh
        
        echo "Deployment completed successfully"
        EOF
    
    - name: Generate deployment report
      run: |
        echo "## Manual Deployment Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Selected Apps**: ${{ github.event.inputs.apps }}" >> $GITHUB_STEP_SUMMARY
        echo "**Skip Build**: ${{ github.event.inputs.skip_build }}" >> $GITHUB_STEP_SUMMARY
        echo "**Force Recreate**: ${{ github.event.inputs.force_recreate }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Application URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- 主应用: http://${{ secrets.SERVER_HOST }}:30080" >> $GITHUB_STEP_SUMMARY
        echo "- 管理后台: http://${{ secrets.SERVER_HOST }}:30081" >> $GITHUB_STEP_SUMMARY
        echo "- 财务系统: http://${{ secrets.SERVER_HOST }}:30086" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Result
    runs-on: ubuntu-latest
    needs: [prepare, build, deploy]
    if: always()
    
    steps:
    - name: Success notification
      if: needs.deploy.result == 'success'
      run: |
        echo "**Manual Deployment Successful!**" >> $GITHUB_STEP_SUMMARY
        echo "Selected applications deployed successfully" >> $GITHUB_STEP_SUMMARY
        echo "Apps: ${{ github.event.inputs.apps }}" >> $GITHUB_STEP_SUMMARY
        echo "Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        
    - name: Failure notification
      if: needs.deploy.result == 'failure' || needs.build.result == 'failure'
      run: |
        echo "**Manual Deployment Failed!**" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs for details" >> $GITHUB_STEP_SUMMARY
        exit 1