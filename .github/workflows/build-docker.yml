name: ðŸ³ Build Docker Images

on:
  push:
    branches: [ master, develop ]
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'auth/**'
      - 'scripts/build-all.sh'
      - 'package.json'
      - 'pnpm-lock.yaml'
  pull_request:
    branches: [ master ]
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'auth/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.changes.outputs.apps }}
      packages: ${{ steps.changes.outputs.packages }}
      auth: ${{ steps.changes.outputs.auth }}
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ” Detect changes
      id: changes
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -E '^(apps|packages|auth)/'; then
          echo "apps=true" >> $GITHUB_OUTPUT
        else
          echo "apps=false" >> $GITHUB_OUTPUT
        fi
        
        if git diff --name-only HEAD~1 HEAD | grep -E '^packages/'; then
          echo "packages=true" >> $GITHUB_OUTPUT
        else
          echo "packages=false" >> $GITHUB_OUTPUT
        fi
        
        if git diff --name-only HEAD~1 HEAD | grep -E '^auth/'; then
          echo "auth=true" >> $GITHUB_OUTPUT
        else
          echo "auth=false" >> $GITHUB_OUTPUT
        fi

  build-matrix:
    name: ðŸ—ï¸ Build Apps Matrix
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.apps == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        app: [system-app, admin-app, logistics-app, quality-app, production-app, engineering-app, finance-app, mobile-app]
      fail-fast: false
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ” Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8.15.0

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.0'
        cache: 'pnpm'

    - name: ðŸ“¥ Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: ðŸ—ï¸ Build ${{ matrix.app }}
      run: |
        echo "ðŸ—ï¸ Building ${{ matrix.app }}..."
        
        # æ£€æŸ¥åº”ç”¨ç›®å½•æ˜¯å¦å­˜åœ¨
        if [ ! -d "apps/${{ matrix.app }}" ]; then
          echo "âš ï¸ App directory apps/${{ matrix.app }} does not exist, skipping..."
          exit 0
        fi
        
        # åˆ›å»º Dockerfileï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        if [ ! -f "apps/${{ matrix.app }}/Dockerfile" ]; then
          echo "ðŸ“ Creating Dockerfile for ${{ matrix.app }}..."
          cat > "apps/${{ matrix.app }}/Dockerfile" << 'EOF'
        # Multi-stage build for ${{ matrix.app }}
        FROM node:18-alpine as builder
        
        WORKDIR /app
        
        # å¤åˆ¶æ‰€æœ‰ package.json æ–‡ä»¶
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY apps/ ./apps/
        COPY packages/ ./packages/
        COPY auth/ ./auth/
        
        # å®‰è£… pnpm
        RUN npm install -g pnpm
        
        # å®‰è£…æ‰€æœ‰ä¾èµ–
        RUN pnpm install --frozen-lockfile
        
        # æž„å»ºåº”ç”¨
        RUN cd apps/${{ matrix.app }} && pnpm run build
        
        # Production stage
        FROM nginx:alpine
        
        # å¤åˆ¶æž„å»ºäº§ç‰©
        COPY --from=builder /app/apps/${{ matrix.app }}/dist /usr/share/nginx/html
        
        # å¤åˆ¶ nginx é…ç½®æˆ–åˆ›å»ºé»˜è®¤é…ç½®
        RUN if [ -f "apps/${{ matrix.app }}/nginx.conf" ]; then \
                cp apps/${{ matrix.app }}/nginx.conf /etc/nginx/conf.d/default.conf; \
            else \
                echo 'server { listen 80; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf; \
            fi
        
        EXPOSE 80
        
        CMD ["nginx", "-g", "daemon off;"]
        EOF
        fi
        
        # æž„å»º Docker é•œåƒ
        docker build -t btc-shopflow/${{ matrix.app }}:latest -f apps/${{ matrix.app }}/Dockerfile .

    - name: ðŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.app }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ðŸ“¤ Push to registry
      if: github.event_name != 'pull_request'
      run: |
        echo "ðŸ“¤ Pushing ${{ matrix.app }} to registry..."
        docker tag btc-shopflow/${{ matrix.app }}:latest ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.app }}:latest
        docker tag btc-shopflow/${{ matrix.app }}:latest ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.app }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.app }}:latest
        docker push ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.app }}:${{ github.sha }}

    - name: ðŸ§ª Test image
      run: |
        echo "ðŸ§ª Testing ${{ matrix.app }} image..."
        
        # å¯åŠ¨å®¹å™¨è¿›è¡Œæµ‹è¯•
        docker run -d --name test-${{ matrix.app }} -p 8080:80 btc-shopflow/${{ matrix.app }}:latest
        
        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        sleep 10
        
        # å¥åº·æ£€æŸ¥
        if curl -f -s --max-time 10 http://localhost:8080 > /dev/null; then
          echo "âœ… ${{ matrix.app }} health check passed"
        else
          echo "âŒ ${{ matrix.app }} health check failed"
          docker logs test-${{ matrix.app }}
          exit 1
        fi
        
        # æ¸…ç†æµ‹è¯•å®¹å™¨
        docker stop test-${{ matrix.app }}
        docker rm test-${{ matrix.app }}

  summary:
    name: ðŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [changes, build-matrix]
    if: always()
    
    steps:
    - name: ðŸ“Š Summary
      run: |
        echo "## ðŸ³ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.changes.outputs.apps }}" == "true" ]; then
          echo "âœ… **Apps changed**: Building Docker images" >> $GITHUB_STEP_SUMMARY
        else
          echo "â­ï¸ **No app changes**: Skipping Docker builds" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Built Applications:" >> $GITHUB_STEP_SUMMARY
        echo "- system-app" >> $GITHUB_STEP_SUMMARY
        echo "- admin-app" >> $GITHUB_STEP_SUMMARY
        echo "- logistics-app" >> $GITHUB_STEP_SUMMARY
        echo "- quality-app" >> $GITHUB_STEP_SUMMARY
        echo "- production-app" >> $GITHUB_STEP_SUMMARY
        echo "- engineering-app" >> $GITHUB_STEP_SUMMARY
        echo "- finance-app" >> $GITHUB_STEP_SUMMARY
        echo "- mobile-app" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build-matrix.result }}" == "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **All builds completed successfully!**" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-matrix.result }}" == "failure" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Some builds failed. Please check the logs.**" >> $GITHUB_STEP_SUMMARY
        fi
