name: Deploy App to K8s (Reusable)

# âš ï¸ æ­¤å·¥ä½œæµæ˜¯å¯å¤ç”¨çš„ï¼Œä¸ä¼šè‡ªåŠ¨è§¦å‘
# - åªèƒ½é€šè¿‡å…¶ä»–å·¥ä½œæµè°ƒç”¨ï¼ˆworkflow_callï¼‰
# - ç”¨äºå°†åº”ç”¨éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤
on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application name (e.g., system-app, admin-app)'
        required: true
        type: string
      image_tag:
        description: 'Docker image tag (e.g., commit SHA)'
        required: true
        type: string
      registry:
        description: 'Container registry URL'
        required: true
        type: string
      github_repository_owner:
        description: 'GitHub repository owner (lowercase)'
        required: true
        type: string
      k8s_namespace:
        description: 'K8s namespace (default: btc-shopflow)'
        required: false
        type: string
        default: 'btc-shopflow'
    secrets:
      K8S_SERVER:
        required: false
      K8S_CA_CERT:
        required: false
      K8S_TOKEN:
        required: false

permissions:
  contents: read

jobs:
  deploy-app:
    name: Deploy ${{ inputs.app_name }} to K8s
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure K8s
        run: |
          # é…ç½® kubectlï¼ˆä½¿ç”¨ secrets ä¸­çš„é…ç½®ï¼‰
          if [ -n "${{ secrets.K8S_SERVER }}" ]; then
            mkdir -p ~/.kube
            cat > ~/.kube/config <<EOF
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              server: ${{ secrets.K8S_SERVER }}
              certificate-authority-data: ${{ secrets.K8S_CA_CERT }}
            name: k8s-cluster
          contexts:
          - context:
              cluster: k8s-cluster
              user: k8s-user
            name: k8s-context
          current-context: k8s-context
          users:
          - name: k8s-user
            user:
              token: ${{ secrets.K8S_TOKEN }}
          EOF
            kubectl config use-context k8s-context
            echo "âœ… K8s é…ç½®å®Œæˆ"
          else
            echo "âš ï¸  æœªé…ç½® K8s é›†ç¾¤ä¿¡æ¯ï¼Œè·³è¿‡éƒ¨ç½²"
            echo "è¯·åœ¨ GitHub Secrets ä¸­é…ç½®ï¼š"
            echo "  - K8S_SERVER: K8s API æœåŠ¡å™¨åœ°å€"
            echo "  - K8S_CA_CERT: CA è¯ä¹¦ï¼ˆbase64 ç¼–ç ï¼‰"
            echo "  - K8S_TOKEN: è®¿é—®ä»¤ç‰Œ"
            exit 0
          fi
      
      - name: Deploy application
        run: |
          APP_NAME="${{ inputs.app_name }}"
          IMAGE_TAG="${{ inputs.image_tag }}"
          REGISTRY="${{ inputs.registry }}"
          REPO_OWNER="${{ inputs.github_repository_owner }}"
          K8S_NAMESPACE="${{ inputs.k8s_namespace }}"
          
          # åº”ç”¨åç§°åˆ° Deployment åç§°çš„æ˜ å°„
          declare -A DEPLOYMENT_NAMES=(
            ["system-app"]="btc-system-app"
            ["admin-app"]="btc-admin-app"
          ["logistics-app"]="btc-logistics-app"
            ["quality-app"]="btc-quality-app"
            ["production-app"]="btc-production-app"
            ["engineering-app"]="btc-engineering-app"
            ["finance-app"]="btc-finance-app"
            ["mobile-app"]="btc-mobile-app"
          )
          
          DEPLOYMENT_NAME="${DEPLOYMENT_NAMES[$APP_NAME]}"
          FULL_IMAGE_TAG="$REGISTRY/$REPO_OWNER/$APP_NAME:$IMAGE_TAG"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ éƒ¨ç½²åº”ç”¨: $APP_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Deployment: $DEPLOYMENT_NAME"
          echo "é•œåƒ: $FULL_IMAGE_TAG"
          echo "å‘½åç©ºé—´: $K8S_NAMESPACE"
          
          # æ£€æŸ¥ Deployment æ˜¯å¦å­˜åœ¨
          if kubectl get deployment "$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" >/dev/null 2>&1; then
            echo "âœ… æ›´æ–°ç°æœ‰ Deployment..."
            kubectl set image deployment/"$DEPLOYMENT_NAME" "$APP_NAME=$FULL_IMAGE_TAG" -n "$K8S_NAMESPACE"
            kubectl rollout status deployment/"$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" --timeout=5m
            echo "âœ… $APP_NAME éƒ¨ç½²å®Œæˆ"
          else
            echo "âš ï¸  Deployment ä¸å­˜åœ¨: $DEPLOYMENT_NAME"
            echo "è¯·å…ˆåˆ›å»º Deployment æˆ–ä½¿ç”¨ YAML æ–‡ä»¶"
            exit 1
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… $APP_NAME éƒ¨ç½²æˆåŠŸ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

