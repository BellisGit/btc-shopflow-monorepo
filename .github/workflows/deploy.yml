name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: btc-shopflow

jobs:
  build:
    name: ğŸ—ï¸ Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8.15.0

    - name: ğŸ“¥ Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ğŸ—ï¸ Build all applications
      run: |
        chmod +x scripts/build-all.sh
        ./scripts/build-all.sh

    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ“¤ Push images to registry
      run: |
        # ä¸ºæ¯ä¸ªåº”ç”¨æ‰“æ ‡ç­¾å¹¶æ¨é€åˆ°GitHub Container Registry
        apps=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
        
        for app in "${apps[@]}"; do
          echo "ğŸ·ï¸ Tagging and pushing $app..."
          docker tag btc-shopflow/$app:latest ${{ env.REGISTRY }}/${{ github.repository }}/$app:latest
          docker tag btc-shopflow/$app:latest ${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ github.repository }}/$app:latest
          docker push ${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }}
        done

  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: ğŸ” Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config

    - name: ğŸ” Verify cluster connection
      run: |
        kubectl cluster-info
        kubectl get nodes

    - name: ğŸ—ï¸ Update deployment images
      run: |
        # æ›´æ–°æ‰€æœ‰åº”ç”¨çš„é•œåƒ
        apps=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
        
        for app in "${apps[@]}"; do
          echo "ğŸ”„ Updating $app deployment..."
          kubectl set image deployment/btc-$app $app=${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }} -n btc-shopflow
        done

    - name: â³ Wait for rollout
      run: |
        apps=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
        
        for app in "${apps[@]}"; do
          echo "â³ Waiting for $app rollout..."
          kubectl rollout status deployment/btc-$app -n btc-shopflow --timeout=600s
        done

    - name: ğŸ” Verify deployment
      run: |
        echo "ğŸ“Š Deployment status:"
        kubectl get deployments -n btc-shopflow
        kubectl get pods -n btc-shopflow
        kubectl get services -n btc-shopflow

    - name: ğŸ§ª Health check
      run: |
        echo "ğŸ§ª Running health checks..."
        
        # è·å–æœåŠ¡ç«¯ç‚¹
        SYSTEM_APP_IP=$(kubectl get svc btc-system-app-service -n btc-shopflow -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "")
        ADMIN_APP_IP=$(kubectl get svc btc-admin-app-service -n btc-shopflow -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "")
        
        if [ -n "$SYSTEM_APP_IP" ]; then
          echo "ğŸ” Testing system app at $SYSTEM_APP_IP..."
          curl -f -s --max-time 30 "http://$SYSTEM_APP_IP" > /dev/null && echo "âœ… System app is healthy" || echo "âŒ System app health check failed"
        fi
        
        if [ -n "$ADMIN_APP_IP" ]; then
          echo "ğŸ” Testing admin app at $ADMIN_APP_IP..."
          curl -f -s --max-time 30 "http://$ADMIN_APP_IP" > /dev/null && echo "âœ… Admin app is healthy" || echo "âŒ Admin app health check failed"
        fi

  notify:
    name: ğŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment Success Notification
      if: needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        echo "âœ… æ‰€æœ‰åº”ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        echo "ğŸ”— è®¿é—®åœ°å€: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}"
        
    - name: ğŸ“¢ Deployment Failure Notification
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        echo "ğŸ” è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
        exit 1
