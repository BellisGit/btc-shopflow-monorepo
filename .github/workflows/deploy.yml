name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: btc-shopflow

jobs:
  build:
    name: ğŸ—ï¸ Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8.15.0

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'pnpm-lock.yaml'

    - name: ğŸ“¥ Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: ğŸ—ï¸ Build all applications
      run: |
        chmod +x scripts/build-all.sh
        ./scripts/build-all.sh

    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ“¤ Push images to registry
      run: |
        # ä¸ºæ¯ä¸ªåº”ç”¨æ‰“æ ‡ç­¾å¹¶æ¨é€åˆ°GitHub Container Registry
        apps=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
        
        for app in "${apps[@]}"; do
          echo "ğŸ·ï¸ Tagging and pushing $app..."
          docker tag btc-shopflow/$app:latest ${{ env.REGISTRY }}/${{ github.repository }}/$app:latest
          docker tag btc-shopflow/$app:latest ${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ github.repository }}/$app:latest
          docker push ${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }}
        done

  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸ” Verify server connection
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'Server connection successful'"

    - name: ğŸš€ Deploy to server
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        set -e
        
        echo "ğŸ“ Navigating to project directory..."
        cd /www/wwwroot/btc-shopflow-monorepo
        
        echo "ğŸ“¥ Pulling latest code..."
        git pull origin master
        
        echo "ğŸš€ Running deployment script..."
        chmod +x scripts/deploy.sh
        ./scripts/deploy.sh
        
        EOF

    - name: ğŸ§ª Health check
      run: |
        echo "ğŸ§ª Running health checks..."
        
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        
        ports=(30080 30081 30082 30083 30084 30085 30086 30091)
        app_names=("ä¸»åº”ç”¨" "ç®¡ç†åå°" "ç‰©æµç³»ç»Ÿ" "è´¨é‡ç³»ç»Ÿ" "ç”Ÿäº§ç³»ç»Ÿ" "å·¥ç¨‹ç³»ç»Ÿ" "è´¢åŠ¡ç³»ç»Ÿ" "ç§»åŠ¨ç«¯")
        
        for i in "${!ports[@]}"; do
          port=${ports[$i]}
          app_name=${app_names[$i]}
          
          if curl -f -s --max-time 10 "http://localhost:$port" > /dev/null 2>&1; then
            echo "âœ… $app_name ($port) æœåŠ¡æ­£å¸¸"
          else
            echo "âš ï¸ $app_name ($port) æœåŠ¡å¯èƒ½ä»åœ¨å¯åŠ¨"
          fi
        done
        
        EOF

  notify:
    name: ğŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment Success Notification
      if: needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        echo "âœ… æ‰€æœ‰åº”ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        echo "ğŸ”— è®¿é—®åœ°å€: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}"
        
    - name: ğŸ“¢ Deployment Failure Notification
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        echo "ğŸ” è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
        exit 1
