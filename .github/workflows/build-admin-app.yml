name: Build Admin App

on:
  workflow_dispatch:
    inputs:
      registry:
        description: 'Container registry URL'
        required: false
        default: 'ghcr.io'
        type: string
      github_repository:
        description: 'GitHub repository name'
        required: false
        type: string
      github_sha:
        description: 'GitHub commit SHA'
        required: false
        type: string
  repository_dispatch:
    types: [build-admin-app]

jobs:
  build-admin-app:
    name: Build Admin App
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set build parameters
      id: params
      run: |
        # è®¾ç½®æž„å»ºå‚æ•°ï¼Œæ”¯æŒworkflow_dispatchå’Œrepository_dispatch
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          REGISTRY="${{ github.event.inputs.registry || 'ghcr.io' }}"
          REPO="${{ github.event.inputs.github_repository || github.repository }}"
          SHA="${{ github.event.inputs.github_sha || github.sha }}"
        else
          # repository_dispatch
          REGISTRY="${{ github.event.client_payload.registry || 'ghcr.io' }}"
          REPO="${{ github.event.client_payload.github_repository || github.repository }}"
          SHA="${{ github.event.client_payload.github_sha || github.sha }}"
        fi
        
        echo "registry=$REGISTRY" >> $GITHUB_OUTPUT
        echo "repository=$REPO" >> $GITHUB_OUTPUT
        echo "sha=$SHA" >> $GITHUB_OUTPUT
        
        echo "ðŸ“‹ Build parameters:"
        echo "- Registry: $REGISTRY"
        echo "- Repository: $REPO"
        echo "- SHA: $SHA"

    - name: Validate GitHub Token
      run: |
        echo "Validating GitHub token for registry access..."
        
        if [ -n "${{ secrets.SERVER_PAT }}" ]; then
          echo "âœ… SERVER_PAT is available for Docker registry"
        elif [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
          echo "âœ… GITHUB_TOKEN is available (fallback)"
        else
          echo "âŒ No GitHub token available"
          exit 1
        fi
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
    
    - name: Build dependencies
      run: |
        echo "Building dependencies for admin-app..."
        pnpm --filter @btc/vite-plugin run build
        node scripts/turbo.js run build --filter="@btc/*"
    
    - name: Build admin-app
      run: cd apps/admin-app && pnpm run build
    
    - name: Create Dockerfile
      run: |
        cat > apps/admin-app/Dockerfile << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        COPY package*.json pnpm-*.yaml ./
        COPY packages ./packages
        COPY apps/admin-app ./apps/admin-app
        RUN npm install -g pnpm
        RUN pnpm install --frozen-lockfile
        RUN cd apps/admin-app && pnpm run build

        FROM nginx:alpine
        COPY --from=builder /app/apps/admin-app/dist /usr/share/nginx/html
        RUN echo 'server { listen 80; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ steps.params.outputs.registry }}
        username: ${{ github.actor }}
        password: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: apps/admin-app/Dockerfile
        push: true
        tags: |
          ${{ steps.params.outputs.registry }}/${{ steps.params.outputs.repository }}/admin-app:latest
          ${{ steps.params.outputs.registry }}/${{ steps.params.outputs.repository }}/admin-app:${{ steps.params.outputs.sha }}