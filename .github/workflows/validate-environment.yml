name: Validate Environment

on:
  workflow_call:
    secrets:
      SERVER_KEY:
        description: 'SSH Private Key'
        required: false
      SERVER_HOST:
        description: 'Server Host IP'
        required: false
      SERVER_USER:
        description: 'Server User'
        required: false
      SERVER_PORT:
        description: 'Server Port'
        required: false
    outputs:
      resources_validated:
        description: 'Server resources validation result'
        value: ${{ jobs.validate-environment.outputs.resources_validated }}

jobs:
  validate-environment:
    name: Validate Environment
    runs-on: ubuntu-latest
    outputs:
      resources_validated: ${{ steps.resources-check.outputs.validated }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      run: |
        echo "üîß Setting up SSH connection..."
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Process SSH key
        SERVER_KEY="${{ secrets.SERVER_KEY }}"
        if echo "$SERVER_KEY" | grep -q "^[A-Za-z0-9+/]*={0,2}$" && [ ${#SERVER_KEY} -gt 100 ]; then
          echo "Detected base64 encoded key, decoding..."
          echo "${{ secrets.SERVER_KEY }}" | base64 -d > ~/.ssh/id_rsa
        else
          echo "Processing key as plain text..."
          echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
          sed -i 's/\\n/\n/g' ~/.ssh/id_rsa
        fi
        
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
    
    - name: Validate Server Resources
      id: resources-check
      run: |
        echo "üîç Validating server resources (disk space, memory, Docker)..."
        
        SERVER_HOST="${{ secrets.SERVER_HOST }}"
        SERVER_USER="${{ secrets.SERVER_USER || 'root' }}"
        SERVER_PORT="${{ secrets.SERVER_PORT || '22' }}"
        
        # Check resources via SSH
        RESOURCES_CHECK=$(ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes \
          -i ~/.ssh/id_rsa -p $SERVER_PORT \
          $SERVER_USER@$SERVER_HOST \
          'bash -s' << 'REMOTE_SCRIPT'
        set -e
        
        echo "=== ÊúçÂä°Âô®ËµÑÊ∫êÊ£ÄÊü• ==="
        echo ""
        
        # 1. Ê£ÄÊü•Á£ÅÁõòÁ©∫Èó¥ÔºàÈúÄË¶ÅËá≥Â∞ë10GBÂèØÁî®Á©∫Èó¥Ôºâ
        echo "üìä Ê£ÄÊü•Á£ÅÁõòÁ©∫Èó¥..."
        DISK_INFO=$(df -h / | tail -1)
        DISK_AVAILABLE=$(echo "$DISK_INFO" | awk '{print $4}')
        DISK_USAGE=$(echo "$DISK_INFO" | awk '{print $5}' | sed 's/%//')
        DISK_TOTAL=$(echo "$DISK_INFO" | awk '{print $2}')
        
        echo "  ÊÄªÁ©∫Èó¥: $DISK_TOTAL"
        echo "  Â∑≤‰ΩøÁî®: $(echo "$DISK_INFO" | awk '{print $3}')"
        echo "  ÂèØÁî®Á©∫Èó¥: $DISK_AVAILABLE"
        echo "  ‰ΩøÁî®Áéá: ${DISK_USAGE}%"
        echo ""
        
        # ËΩ¨Êç¢ÂèØÁî®Á©∫Èó¥‰∏∫KBËøõË°åÊØîËæÉ
        DISK_AVAILABLE_KB=$(df / | tail -1 | awk '{print $4}')
        DISK_REQUIRED_KB=10485760  # 10GB = 10 * 1024 * 1024 KB
        
        if [ "$DISK_AVAILABLE_KB" -lt "$DISK_REQUIRED_KB" ]; then
          echo "‚ùå ÈîôËØØ: Á£ÅÁõòÁ©∫Èó¥‰∏çË∂≥ÔºÅ"
          echo "  ÈúÄË¶Å: Ëá≥Â∞ë10GBÂèØÁî®Á©∫Èó¥"
          echo "  ÂΩìÂâçÂèØÁî®: $DISK_AVAILABLE"
          echo ""
          echo "Âª∫ËÆÆÊâßË°å‰ª•‰∏ãÂëΩ‰ª§ÈáäÊîæÁ©∫Èó¥Ôºö"
          echo "  docker system prune -af --volumes"
          echo "  docker image prune -af"
          exit 1
        fi
        
        if [ "$DISK_USAGE" -gt 90 ]; then
          echo "‚ö†Ô∏è  Ë≠¶Âëä: Á£ÅÁõò‰ΩøÁî®ÁéáËøáÈ´ò (${DISK_USAGE}%)"
          echo "  Âª∫ËÆÆÂú®90%‰ª•‰∏ãÔºåËØ∑ËÄÉËôëÊ∏ÖÁêÜÁ£ÅÁõòÁ©∫Èó¥"
        fi
        
        echo "‚úÖ Á£ÅÁõòÁ©∫Èó¥Ê£ÄÊü•ÈÄöËøá"
        echo ""
        
        # 2. Ê£ÄÊü•ÂÜÖÂ≠òÔºàÈúÄË¶ÅËá≥Â∞ë2GBÂèØÁî®ÂÜÖÂ≠òÔºâ
        echo "üíæ Ê£ÄÊü•ÂÜÖÂ≠ò..."
        MEM_INFO=$(free -h)
        MEM_TOTAL=$(echo "$MEM_INFO" | grep Mem | awk '{print $2}')
        MEM_AVAILABLE=$(echo "$MEM_INFO" | grep Mem | awk '{print $7}')
        
        # ËΩ¨Êç¢‰∏∫MBËøõË°åÊØîËæÉ
        MEM_TOTAL_MB=$(free -m | grep Mem | awk '{print $2}')
        MEM_AVAILABLE_MB=$(free -m | grep Mem | awk '{print $7}')
        MEM_REQUIRED_MB=2048  # 2GB = 2048 MB
        
        echo "  ÊÄªÂÜÖÂ≠ò: $MEM_TOTAL"
        echo "  ÂèØÁî®ÂÜÖÂ≠ò: $MEM_AVAILABLE"
        echo ""
        
        if [ "$MEM_TOTAL_MB" -lt "$MEM_REQUIRED_MB" ]; then
          echo "‚ùå ÈîôËØØ: ÂÜÖÂ≠ò‰∏çË∂≥ÔºÅ"
          echo "  ÈúÄË¶Å: Ëá≥Â∞ë2GBÊÄªÂÜÖÂ≠ò"
          echo "  ÂΩìÂâçÊÄªÂÜÖÂ≠ò: $MEM_TOTAL"
          exit 1
        fi
        
        if [ "$MEM_AVAILABLE_MB" -lt 512 ]; then
          echo "‚ö†Ô∏è  Ë≠¶Âëä: ÂèØÁî®ÂÜÖÂ≠òËæÉÂ∞ë (${MEM_AVAILABLE_MB}MB)"
          echo "  Âª∫ËÆÆËá≥Â∞ëÊúâ512MBÂèØÁî®ÂÜÖÂ≠òÁî®‰∫éÈÉ®ÁΩ≤"
        fi
        
        echo "‚úÖ ÂÜÖÂ≠òÊ£ÄÊü•ÈÄöËøá"
        echo ""
        
        # 3. Ê£ÄÊü•Docker
        echo "üê≥ Ê£ÄÊü•Docker..."
        if ! command -v docker &> /dev/null; then
          echo "‚ùå ÈîôËØØ: DockerÊú™ÂÆâË£Ö"
          exit 1
        fi
        
        DOCKER_VERSION=$(docker --version)
        echo "  DockerÁâàÊú¨: $DOCKER_VERSION"
        
        if ! docker info &> /dev/null; then
          echo "‚ùå ÈîôËØØ: DockerÊúçÂä°Êú™ËøêË°å"
          exit 1
        fi
        
        echo "‚úÖ DockerÊ£ÄÊü•ÈÄöËøá"
        echo ""
        
        # 4. Ê£ÄÊü•Docker ComposeÔºàÂèØÈÄâÔºå‰ΩÜÊé®ËçêÔºâ
        if command -v docker-compose &> /dev/null; then
          COMPOSE_VERSION=$(docker-compose --version)
          echo "‚úÖ Docker ComposeÂ∑≤ÂÆâË£Ö: $COMPOSE_VERSION"
        elif docker compose version &> /dev/null; then
          COMPOSE_VERSION=$(docker compose version)
          echo "‚úÖ Docker Compose (Êèí‰ª∂)Â∑≤ÂÆâË£Ö: $COMPOSE_VERSION"
        else
          echo "‚ö†Ô∏è  Ë≠¶Âëä: Docker ComposeÊú™ÂÆâË£ÖÔºàÂ∞ÜÂ∞ùËØï‰ΩøÁî®docker composeÊèí‰ª∂Ôºâ"
        fi
        echo ""
        
        # 5. Ê£ÄÊü•DockerÊï∞ÊçÆÁõÆÂΩïÁ©∫Èó¥Ôºà/var/lib/dockerÔºâ
        echo "üì¶ Ê£ÄÊü•DockerÊï∞ÊçÆÁõÆÂΩïÁ©∫Èó¥..."
        if [ -d "/var/lib/docker" ]; then
          DOCKER_DISK_INFO=$(df -h /var/lib/docker 2>/dev/null | tail -1 || df -h / | tail -1)
          DOCKER_DISK_USAGE=$(echo "$DOCKER_DISK_INFO" | awk '{print $5}' | sed 's/%//')
          DOCKER_DISK_AVAILABLE=$(echo "$DOCKER_DISK_INFO" | awk '{print $4}')
          
          echo "  DockerÊï∞ÊçÆÁõÆÂΩïÂèØÁî®Á©∫Èó¥: $DOCKER_DISK_AVAILABLE"
          echo "  ‰ΩøÁî®Áéá: ${DOCKER_DISK_USAGE}%"
          
          if [ "$DOCKER_DISK_USAGE" -gt 85 ]; then
            echo "‚ö†Ô∏è  Ë≠¶Âëä: DockerÊï∞ÊçÆÁõÆÂΩïÁ©∫Èó¥‰ΩøÁî®ÁéáËæÉÈ´ò (${DOCKER_DISK_USAGE}%)"
            echo "  Âª∫ËÆÆÊ∏ÖÁêÜDockerÈïúÂÉèÂíåÂÆπÂô®"
            echo "  ÊâßË°å: docker system prune -af --volumes"
          fi
        fi
        echo ""
        
        echo "=== ‚úÖ ÊâÄÊúâËµÑÊ∫êÊ£ÄÊü•ÈÄöËøá ==="
        echo "Á£ÅÁõòÁ©∫Èó¥: ‚úÖ"
        echo "ÂÜÖÂ≠ò: ‚úÖ"
        echo "Docker: ‚úÖ"
        
REMOTE_SCRIPT
        ) || {
          echo "‚ùå ÊúçÂä°Âô®ËµÑÊ∫êÊ£ÄÊü•Â§±Ë¥•"
          echo "$RESOURCES_CHECK"
          exit 1
        }
        
        echo "$RESOURCES_CHECK"
        echo "resources_validated=true" >> $GITHUB_OUTPUT
      
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
        SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
    
    - name: Environment validation summary
      run: |
        echo "‚úÖ Environment validation completed"
        echo "‚úÖ Server resources validated successfully"
    
