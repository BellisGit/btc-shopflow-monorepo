name: Validate Environment

on:
  workflow_call:
    secrets:
      SERVER_KEY:
        description: 'SSH Private Key'
        required: false
      SERVER_HOST:
        description: 'Server Host IP'
        required: false
      SERVER_USER:
        description: 'Server User'
        required: false
      SERVER_PORT:
        description: 'Server Port'
        required: false
    outputs:
      resources_validated:
        description: 'Server resources validation result'
        value: ${{ jobs.validate-environment.outputs.resources_validated }}

jobs:
  validate-environment:
    name: Validate Environment
    runs-on: ubuntu-latest
    outputs:
      resources_validated: ${{ steps.set-output.outputs.resources_validated }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate Server Resources
      id: resources-check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER || 'root' }}
        key: ${{ secrets.SERVER_KEY }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          set -e
          
          echo "=== æœåŠ¡å™¨èµ„æºæ£€æŸ¥ ==="
          echo ""
          
          # 1. æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆéœ€è¦è‡³å°‘10GBå¯ç”¨ç©ºé—´ï¼‰
          echo "ðŸ“Š æ£€æŸ¥ç£ç›˜ç©ºé—´..."
          DISK_INFO=$(df -h / | tail -1)
          DISK_AVAILABLE=$(echo "$DISK_INFO" | awk '{print $4}')
          DISK_USAGE=$(echo "$DISK_INFO" | awk '{print $5}' | sed 's/%//')
          DISK_TOTAL=$(echo "$DISK_INFO" | awk '{print $2}')
          
          echo "  æ€»ç©ºé—´: $DISK_TOTAL"
          echo "  å·²ä½¿ç”¨: $(echo "$DISK_INFO" | awk '{print $3}')"
          echo "  å¯ç”¨ç©ºé—´: $DISK_AVAILABLE"
          echo "  ä½¿ç”¨çŽ‡: ${DISK_USAGE}%"
          echo ""
          
          # è½¬æ¢å¯ç”¨ç©ºé—´ä¸ºKBè¿›è¡Œæ¯”è¾ƒ
          DISK_AVAILABLE_KB=$(df / | tail -1 | awk '{print $4}')
          DISK_REQUIRED_KB=10485760  # 10GB = 10 * 1024 * 1024 KB
          
          if [ "$DISK_AVAILABLE_KB" -lt "$DISK_REQUIRED_KB" ]; then
            echo "âŒ é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³ï¼"
            echo "  éœ€è¦: è‡³å°‘10GBå¯ç”¨ç©ºé—´"
            echo "  å½“å‰å¯ç”¨: $DISK_AVAILABLE"
            echo ""
            echo "å»ºè®®æ‰§è¡Œä»¥ä¸‹å‘½ä»¤é‡Šæ”¾ç©ºé—´ï¼š"
            echo "  docker system prune -af --volumes"
            echo "  docker image prune -af"
            exit 1
          fi
          
          if [ "$DISK_USAGE" -gt 90 ]; then
            echo "âš ï¸  è­¦å‘Š: ç£ç›˜ä½¿ç”¨çŽ‡è¿‡é«˜ (${DISK_USAGE}%)"
            echo "  å»ºè®®åœ¨90%ä»¥ä¸‹ï¼Œè¯·è€ƒè™‘æ¸…ç†ç£ç›˜ç©ºé—´"
          fi
          
          echo "âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡"
          echo ""
          
          # 2. æ£€æŸ¥å†…å­˜ï¼ˆéœ€è¦è‡³å°‘2GBå¯ç”¨å†…å­˜ï¼‰
          echo "ðŸ’¾ æ£€æŸ¥å†…å­˜..."
          MEM_INFO=$(free -h)
          MEM_TOTAL=$(echo "$MEM_INFO" | grep Mem | awk '{print $2}')
          MEM_AVAILABLE=$(echo "$MEM_INFO" | grep Mem | awk '{print $7}')
          
          # è½¬æ¢ä¸ºMBè¿›è¡Œæ¯”è¾ƒ
          MEM_TOTAL_MB=$(free -m | grep Mem | awk '{print $2}')
          MEM_AVAILABLE_MB=$(free -m | grep Mem | awk '{print $7}')
          MEM_REQUIRED_MB=2048  # 2GB = 2048 MB
          
          echo "  æ€»å†…å­˜: $MEM_TOTAL"
          echo "  å¯ç”¨å†…å­˜: $MEM_AVAILABLE"
          echo ""
          
          if [ "$MEM_TOTAL_MB" -lt "$MEM_REQUIRED_MB" ]; then
            echo "âŒ é”™è¯¯: å†…å­˜ä¸è¶³ï¼"
            echo "  éœ€è¦: è‡³å°‘2GBæ€»å†…å­˜"
            echo "  å½“å‰æ€»å†…å­˜: $MEM_TOTAL"
            exit 1
          fi
          
          if [ "$MEM_AVAILABLE_MB" -lt 512 ]; then
            echo "âš ï¸  è­¦å‘Š: å¯ç”¨å†…å­˜è¾ƒå°‘ (${MEM_AVAILABLE_MB}MB)"
            echo "  å»ºè®®è‡³å°‘æœ‰512MBå¯ç”¨å†…å­˜ç”¨äºŽéƒ¨ç½²"
          fi
          
          echo "âœ… å†…å­˜æ£€æŸ¥é€šè¿‡"
          echo ""
          
          # 3. æ£€æŸ¥Docker
          echo "ðŸ³ æ£€æŸ¥Docker..."
          if ! command -v docker &> /dev/null; then
            echo "âŒ é”™è¯¯: Dockeræœªå®‰è£…"
            exit 1
          fi
          
          DOCKER_VERSION=$(docker --version)
          echo "  Dockerç‰ˆæœ¬: $DOCKER_VERSION"
          
          if ! docker info &> /dev/null; then
            echo "âŒ é”™è¯¯: DockeræœåŠ¡æœªè¿è¡Œ"
            exit 1
          fi
          
          echo "âœ… Dockeræ£€æŸ¥é€šè¿‡"
          echo ""
          
          # 4. æ£€æŸ¥Docker Composeï¼ˆå¯é€‰ï¼Œä½†æŽ¨èï¼‰
          if command -v docker-compose &> /dev/null; then
            COMPOSE_VERSION=$(docker-compose --version)
            echo "âœ… Docker Composeå·²å®‰è£…: $COMPOSE_VERSION"
          elif docker compose version &> /dev/null; then
            COMPOSE_VERSION=$(docker compose version)
            echo "âœ… Docker Compose (æ’ä»¶)å·²å®‰è£…: $COMPOSE_VERSION"
          else
            echo "âš ï¸  è­¦å‘Š: Docker Composeæœªå®‰è£…ï¼ˆå°†å°è¯•ä½¿ç”¨docker composeæ’ä»¶ï¼‰"
          fi
          echo ""
          
          # 5. æ£€æŸ¥Dockeræ•°æ®ç›®å½•ç©ºé—´ï¼ˆ/var/lib/dockerï¼‰
          echo "ðŸ“¦ æ£€æŸ¥Dockeræ•°æ®ç›®å½•ç©ºé—´..."
          if [ -d "/var/lib/docker" ]; then
            DOCKER_DISK_INFO=$(df -h /var/lib/docker 2>/dev/null | tail -1 || df -h / | tail -1)
            DOCKER_DISK_USAGE=$(echo "$DOCKER_DISK_INFO" | awk '{print $5}' | sed 's/%//')
            DOCKER_DISK_AVAILABLE=$(echo "$DOCKER_DISK_INFO" | awk '{print $4}')
            
            echo "  Dockeræ•°æ®ç›®å½•å¯ç”¨ç©ºé—´: $DOCKER_DISK_AVAILABLE"
            echo "  ä½¿ç”¨çŽ‡: ${DOCKER_DISK_USAGE}%"
            
            if [ "$DOCKER_DISK_USAGE" -gt 85 ]; then
              echo "âš ï¸  è­¦å‘Š: Dockeræ•°æ®ç›®å½•ç©ºé—´ä½¿ç”¨çŽ‡è¾ƒé«˜ (${DOCKER_DISK_USAGE}%)"
              echo "  å»ºè®®æ¸…ç†Dockeré•œåƒå’Œå®¹å™¨"
              echo "  æ‰§è¡Œ: docker system prune -af --volumes"
            fi
          fi
          echo ""
          
          echo "=== âœ… æ‰€æœ‰èµ„æºæ£€æŸ¥é€šè¿‡ ==="
          echo "ç£ç›˜ç©ºé—´: âœ…"
          echo "å†…å­˜: âœ…"
          echo "Docker: âœ…"
    
    - name: Set validation output
      id: set-output
      if: success()
      run: |
        echo "resources_validated=true" >> $GITHUB_OUTPUT
    
    - name: Environment validation summary
      run: |
        echo "âœ… Environment validation completed"
        echo "âœ… Server resources validated successfully"
    
