name: Build and Deploy to K8s (Incremental)

# é…ç½®è¯´æ˜ï¼š
# 1. é•œåƒä»“åº“é…ç½®ï¼ˆåœ¨ GitHub Secrets ä¸­è®¾ç½®ï¼‰ï¼š
#    - PRIVATE_REGISTRY: é•œåƒä»“åº“åœ°å€
#      * ä½¿ç”¨ GHCR: ç•™ç©ºï¼ˆé»˜è®¤ä½¿ç”¨ ghcr.ioï¼‰
#      * ä½¿ç”¨ç§æœ‰ä»“åº“: è®¾ç½®ä¸º IP:PORTï¼ˆå¦‚ï¼š192.168.1.100:5000ï¼‰
#      * ä½¿ç”¨ Docker Hub: è®¾ç½®ä¸º docker.io
#    - PRIVATE_REGISTRY_USERNAME: ä»“åº“ç”¨æˆ·å
#      * GHCR: ç•™ç©ºï¼ˆè‡ªåŠ¨ä½¿ç”¨ github.actorï¼‰
#      * ç§æœ‰ä»“åº“ï¼ˆéœ€è¦è®¤è¯ï¼‰: å¡«å†™ç”¨æˆ·å
#      * ç§æœ‰ä»“åº“ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰: ç•™ç©º
#      * Docker Hub: Docker Hub ç”¨æˆ·å
#    - PRIVATE_REGISTRY_PASSWORD: ä»“åº“å¯†ç /Token
#      * GHCR: ç•™ç©ºï¼ˆè‡ªåŠ¨ä½¿ç”¨ GITHUB_TOKENï¼‰
#      * ç§æœ‰ä»“åº“ï¼ˆéœ€è¦è®¤è¯ï¼‰: å¡«å†™å¯†ç 
#      * ç§æœ‰ä»“åº“ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰: ç•™ç©º
#      * Docker Hub: Docker Hub å¯†ç æˆ– Access Token
# 2. K8s éƒ¨ç½²é…ç½®ï¼ˆå¯é€‰ï¼Œåœ¨ GitHub Secrets ä¸­è®¾ç½®ï¼‰ï¼š
#    - K8S_SERVER: K8s API æœåŠ¡å™¨åœ°å€
#    - K8S_CA_CERT: K8s CA è¯ä¹¦ï¼ˆbase64 ç¼–ç ï¼‰
#    - K8S_TOKEN: K8s è®¿é—®ä»¤ç‰Œ
#    - K8S_NAMESPACE: K8s å‘½åç©ºé—´ï¼ˆé»˜è®¤ï¼šbtc-shopflowï¼‰
# è¯¦ç»†é…ç½®è¯´æ˜è¯·å‚è€ƒï¼šdocs/GITHUB_ACTIONS_K8S_SETUP.md

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      deploy_all:
        description: 'Deploy all apps (not just changed)'
        required: false
        type: boolean
        default: false
      force_rebuild:
        description: 'Force rebuild even if no changes detected (useful after failed builds)'
        required: false
        type: boolean
        default: false
      skip_build:
        description: 'Skip build step'
        required: false
        type: boolean
        default: false
      skip_deploy:
        description: 'Skip deploy step'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  detect-config:
    name: Detect and Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      registry: ${{ steps.config.outputs.registry }}
      registry_username: ${{ steps.config.outputs.registry_username }}
      registry_password: ${{ steps.config.outputs.registry_password }}
      use_ghcr: ${{ steps.config.outputs.use_ghcr }}
      needs_auth: ${{ steps.config.outputs.needs_auth }}
    steps:
      - name: Detect registry configuration
        id: config
        run: |
          echo "ğŸ” æ£€æµ‹é•œåƒä»“åº“é…ç½®..."
          
          # æ£€æµ‹æ˜¯å¦é…ç½®äº†ç§æœ‰ä»“åº“
          if [ -n "${{ secrets.PRIVATE_REGISTRY }}" ]; then
            PRIVATE_REGISTRY="${{ secrets.PRIVATE_REGISTRY }}"
            echo "âœ… æ£€æµ‹åˆ°ç§æœ‰ä»“åº“é…ç½®: $PRIVATE_REGISTRY"
            echo "registry=$PRIVATE_REGISTRY" >> $GITHUB_OUTPUT
            echo "use_ghcr=false" >> $GITHUB_OUTPUT
            
            # æ£€æµ‹æ˜¯å¦éœ€è¦è®¤è¯
            if [ -n "${{ secrets.PRIVATE_REGISTRY_USERNAME }}" ] && [ -n "${{ secrets.PRIVATE_REGISTRY_PASSWORD }}" ]; then
              echo "âœ… æ£€æµ‹åˆ°è®¤è¯é…ç½®ï¼Œå°†ä½¿ç”¨è®¤è¯ç™»å½•"
              {
                echo "registry_username<<EOF"
                echo "${{ secrets.PRIVATE_REGISTRY_USERNAME }}"
                echo "EOF"
              } >> $GITHUB_OUTPUT
              {
                echo "registry_password<<EOF"
                echo "${{ secrets.PRIVATE_REGISTRY_PASSWORD }}"
                echo "EOF"
              } >> $GITHUB_OUTPUT
              echo "needs_auth=true" >> $GITHUB_OUTPUT
            else
              echo "â„¹ï¸  æœªé…ç½®è®¤è¯ä¿¡æ¯ï¼Œå°†å°è¯•åŒ¿åè®¿é—®ï¼ˆé€‚ç”¨äºä¸éœ€è¦è®¤è¯çš„ç§æœ‰ä»“åº“ï¼‰"
              echo "registry_username=" >> $GITHUB_OUTPUT
              echo "registry_password=" >> $GITHUB_OUTPUT
              echo "needs_auth=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… æœªé…ç½®ç§æœ‰ä»“åº“ï¼Œå°†ä½¿ç”¨ GitHub Container Registry (GHCR)"
            echo "registry=ghcr.io" >> $GITHUB_OUTPUT
            echo "use_ghcr=true" >> $GITHUB_OUTPUT
            {
              echo "registry_username<<EOF"
              echo "${{ github.actor }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            {
              echo "registry_password<<EOF"
              echo "${{ github.token }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "needs_auth=true" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ é…ç½®æ‘˜è¦"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "é•œåƒä»“åº“: $(echo '${{ steps.config.outputs.registry }}' || echo 'ghcr.io')"
          echo "ä½¿ç”¨ GHCR: $(echo '${{ steps.config.outputs.use_ghcr }}' || echo 'true')"
          echo "éœ€è¦è®¤è¯: $(echo '${{ steps.config.outputs.needs_auth }}' || echo 'false')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  detect-changes:
    name: Detect Changed Apps
    runs-on: ubuntu-latest
    outputs:
      changed_apps: ${{ steps.detect.outputs.changed_apps }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      changed_apps_json: ${{ steps.detect.outputs.changed_apps_json }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # éœ€è¦è·å–å†å²æäº¤ä»¥æ£€æµ‹å˜æ›´
      
      - name: Setup jq
        run: |
          # jq ç”¨äºç”Ÿæˆ JSON æ•°ç»„
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Detect changed applications
        id: detect
        run: |
          echo "ğŸ” æ£€æµ‹å˜æ›´çš„åº”ç”¨..."
          
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi
          
          # å¦‚æœæ— æ³•è·å–åŸºå‡†ï¼Œä½¿ç”¨ HEAD~1
          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="HEAD~1"
          fi
          
          echo "åŸºå‡†æäº¤: $BASE_SHA"
          echo "å½“å‰æäº¤: $HEAD_SHA"
          
          # æ‰€æœ‰åº”ç”¨åˆ—è¡¨
          ALL_APPS=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
          CHANGED_APPS=()
          
          # æ£€æµ‹æ¯ä¸ªåº”ç”¨çš„å˜æ›´
          for app in "${ALL_APPS[@]}"; do
            if git diff --quiet "$BASE_SHA" "$HEAD_SHA" -- "apps/$app/" 2>/dev/null; then
              # æ£€æŸ¥å…±äº«åŒ…æ˜¯å¦æœ‰å˜æ›´
              if ! git diff --quiet "$BASE_SHA" "$HEAD_SHA" -- packages/ configs/ scripts/ turbo.json package.json pnpm-lock.yaml 2>/dev/null; then
                echo "âš ï¸  $app: å…±äº«åŒ…æœ‰å˜æ›´ï¼Œéœ€è¦é‡æ–°æ„å»º"
                CHANGED_APPS+=("$app")
              else
                echo "âœ… $app: æ— å˜æ›´"
              fi
            else
              echo "âš ï¸  $app: æœ‰å˜æ›´ï¼Œéœ€è¦æ„å»º"
              CHANGED_APPS+=("$app")
            fi
          done
          
          # å¦‚æœæ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©äº† deploy_allï¼Œåˆ™æ„å»ºæ‰€æœ‰åº”ç”¨
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.deploy_all }}" = "true" ]; then
            CHANGED_APPS=("${ALL_APPS[@]}")
            echo "æ‰‹åŠ¨è§¦å‘ï¼šæ„å»ºæ‰€æœ‰åº”ç”¨"
          fi
          
          # å¦‚æœæ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©äº† force_rebuildï¼Œå³ä½¿æ²¡æœ‰å˜åŒ–ä¹Ÿæ„å»ºæ‰€æœ‰åº”ç”¨
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            if [ ${#CHANGED_APPS[@]} -eq 0 ]; then
              CHANGED_APPS=("${ALL_APPS[@]}")
              echo "å¼ºåˆ¶é‡æ–°æ„å»ºï¼šæ„å»ºæ‰€æœ‰åº”ç”¨ï¼ˆå³ä½¿æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼‰"
            else
              echo "å¼ºåˆ¶é‡æ–°æ„å»ºï¼šå·²æ£€æµ‹åˆ°å˜æ›´çš„åº”ç”¨ï¼Œå°†æ„å»ºè¿™äº›åº”ç”¨"
            fi
          fi
          
          if [ ${#CHANGED_APPS[@]} -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changed_apps=" >> $GITHUB_OUTPUT
            echo 'changed_apps_json=[]' >> $GITHUB_OUTPUT
            echo "æœªæ£€æµ‹åˆ°éœ€è¦æ„å»ºçš„åº”ç”¨"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_apps=${CHANGED_APPS[*]}" >> $GITHUB_OUTPUT
            # ç”Ÿæˆ JSON æ•°ç»„ç”¨äº matrix
            # ä½¿ç”¨ jq ç”Ÿæˆï¼Œå¦‚æœå¤±è´¥åˆ™æ‰‹åŠ¨æ„å»º
            JSON_APPS="["
            for i in "${!CHANGED_APPS[@]}"; do
              if [ $i -gt 0 ]; then
                JSON_APPS+=","
              fi
              JSON_APPS+="\"${CHANGED_APPS[$i]}\""
            done
            JSON_APPS+="]"
            
            # ä½¿ç”¨å¤šè¡Œè¾“å‡ºæ ¼å¼ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
            {
              echo "changed_apps_json<<EOF"
              echo "$JSON_APPS"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°éœ€è¦æ„å»ºçš„åº”ç”¨: ${CHANGED_APPS[*]}"
          fi

  build:
    name: Build Changed Apps
    needs: [detect-config, detect-changes]
    if: (needs.detect-changes.outputs.has_changes == 'true' || github.event.inputs.force_rebuild == 'true') && github.event.inputs.skip_build != 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.changed_apps_json) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline
      
      - name: Restore built packages cache
        uses: actions/cache@v3
        with:
          path: |
            packages/*/dist
            packages/*/build
          key: packages-build-${{ github.sha }}
          restore-keys: |
            packages-build-
      
      - name: Build dependencies if needed
        run: |
          if [ ! -d "packages/vite-plugin/dist" ] || [ ! -f "packages/vite-plugin/dist/index.js" ]; then
            echo "Building shared dependencies..."
            pnpm --filter @btc/vite-plugin run build
            pnpm --filter @btc/shared-utils run build
            pnpm --filter @btc/shared-core run build
            pnpm --filter @btc/shared-components run build
            pnpm --filter @btc/subapp-manifests run build
          fi
      
      - name: Build ${{ matrix.app }}
        run: cd apps/${{ matrix.app }} && pnpm run build
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          # ä½¿ç”¨æ£€æµ‹åˆ°çš„é…ç½®ï¼ˆè‡ªåŠ¨é€‰æ‹© GHCR æˆ–ç§æœ‰ä»“åº“ï¼‰
          registry: ${{ needs.detect-config.outputs.registry }}
          username: ${{ needs.detect-config.outputs.registry_username }}
          password: ${{ needs.detect-config.outputs.registry_password || github.token }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            APP_DIR=apps/${{ matrix.app }}
          push: true
          tags: |
            ${{ needs.detect-config.outputs.registry }}/${{ github.repository_owner }}/${{ matrix.app }}:${{ github.sha }}
            ${{ needs.detect-config.outputs.registry }}/${{ github.repository_owner }}/${{ matrix.app }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
        env:
          DOCKER_BUILDKIT: 1

  deploy:
    name: Deploy to K8s
    needs: [detect-config, detect-changes, build]
    if: (needs.detect-changes.outputs.has_changes == 'true' || github.event.inputs.force_rebuild == 'true') && github.event.inputs.skip_deploy != 'true' && (needs.build.result == 'success' || github.event.inputs.skip_build == 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure K8s
        run: |
          # é…ç½® kubectlï¼ˆä½¿ç”¨ secrets ä¸­çš„é…ç½®ï¼‰
          if [ -n "${{ secrets.K8S_SERVER }}" ]; then
            mkdir -p ~/.kube
            cat > ~/.kube/config <<EOF
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              server: ${{ secrets.K8S_SERVER }}
              certificate-authority-data: ${{ secrets.K8S_CA_CERT }}
            name: k8s-cluster
          contexts:
          - context:
              cluster: k8s-cluster
              user: k8s-user
            name: k8s-context
          current-context: k8s-context
          users:
          - name: k8s-user
            user:
              token: ${{ secrets.K8S_TOKEN }}
          EOF
            kubectl config use-context k8s-context
          else
            echo "âš ï¸  æœªé…ç½® K8s é›†ç¾¤ä¿¡æ¯ï¼Œè·³è¿‡éƒ¨ç½²"
            echo "è¯·åœ¨ GitHub Secrets ä¸­é…ç½®ï¼š"
            echo "  - K8S_SERVER: K8s API æœåŠ¡å™¨åœ°å€"
            echo "  - K8S_CA_CERT: CA è¯ä¹¦ï¼ˆbase64 ç¼–ç ï¼‰"
            echo "  - K8S_TOKEN: è®¿é—®ä»¤ç‰Œ"
            exit 0
          fi
      
      - name: Deploy changed applications
        run: |
          CHANGED_APPS="${{ needs.detect-changes.outputs.changed_apps }}"
          # ä½¿ç”¨æ£€æµ‹åˆ°çš„é•œåƒä»“åº“é…ç½®
          PRIVATE_REGISTRY="${{ needs.detect-config.outputs.registry }}/${{ github.repository_owner }}"
          K8S_NAMESPACE="${{ secrets.K8S_NAMESPACE || 'btc-shopflow' }}"
          GIT_SHA="${{ github.sha }}"
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° K8s..."
          echo "å˜æ›´çš„åº”ç”¨: $CHANGED_APPS"
          echo "ç§æœ‰ä»“åº“: $PRIVATE_REGISTRY"
          echo "å‘½åç©ºé—´: $K8S_NAMESPACE"
          echo "Git SHA: $GIT_SHA"
          
          # åº”ç”¨åç§°åˆ° Deployment åç§°çš„æ˜ å°„
          declare -A DEPLOYMENT_NAMES=(
            ["system-app"]="btc-system-app"
            ["admin-app"]="btc-admin-app"
            ["logistics-app"]="btc-logistics-app"
            ["quality-app"]="btc-quality-app"
            ["production-app"]="btc-production-app"
            ["engineering-app"]="btc-engineering-app"
            ["finance-app"]="btc-finance-app"
            ["mobile-app"]="btc-mobile-app"
          )
          
          # å°†åº”ç”¨åˆ—è¡¨è½¬æ¢ä¸ºæ•°ç»„
          IFS=' ' read -r -a APPS_ARRAY <<< "$CHANGED_APPS"
          
          # éƒ¨ç½²æ¯ä¸ªå˜æ›´çš„åº”ç”¨
          for app in "${APPS_ARRAY[@]}"; do
            DEPLOYMENT_NAME="${DEPLOYMENT_NAMES[$app]}"
            IMAGE_TAG="$PRIVATE_REGISTRY/$app:${GIT_SHA:0:7}"
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ éƒ¨ç½²åº”ç”¨: $app"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Deployment: $DEPLOYMENT_NAME"
            echo "é•œåƒ: $IMAGE_TAG"
            
            # æ£€æŸ¥ Deployment æ˜¯å¦å­˜åœ¨
            if kubectl get deployment "$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" >/dev/null 2>&1; then
              echo "æ›´æ–°ç°æœ‰ Deployment..."
              kubectl set image deployment/"$DEPLOYMENT_NAME" "$app=$IMAGE_TAG" -n "$K8S_NAMESPACE"
              kubectl rollout status deployment/"$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" --timeout=5m
            else
              echo "åˆ›å»ºæ–° Deployment..."
              # è¿™é‡Œå¯ä»¥åº”ç”¨ YAML æ–‡ä»¶æˆ–ä½¿ç”¨ kubectl create
              echo "âš ï¸  Deployment ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»ºæˆ–ä½¿ç”¨ YAML æ–‡ä»¶"
            fi
            
            echo "âœ… $app éƒ¨ç½²å®Œæˆ"
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… æ‰€æœ‰åº”ç”¨éƒ¨ç½²å®Œæˆ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

