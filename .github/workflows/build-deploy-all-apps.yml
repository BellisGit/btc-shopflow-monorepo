name: Build and Deploy All Apps

on:
  repository_dispatch:
    types: [build-deploy-all-apps]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  actions: write

jobs:
  detect-image-tag:
    name: Detect Image Tag
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
      repo_owner_lower: ${{ steps.detect.outputs.repo_owner_lower }}
      registry: ${{ steps.detect.outputs.registry }}
    steps:
      - name: Detect image tag and repository owner
        id: detect
        run: |
          echo "ğŸ” å¼€å§‹æ£€æµ‹é•œåƒæ ‡ç­¾å’Œä»“åº“ä¿¡æ¯..."
          echo "  - client_payload.github_sha: ${{ github.event.client_payload.github_sha }}"
          echo "  - github.sha: ${{ github.sha }}"
          
          # è½¬æ¢ä»“åº“æ‰€æœ‰è€…åç§°ä¸ºå°å†™
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner_lower=$REPO_OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "  âœ… ä»“åº“æ‰€æœ‰è€…ï¼ˆå°å†™ï¼‰: $REPO_OWNER_LOWER"
          
          # ç”Ÿæˆé•œåƒæ ‡ç­¾ï¼ˆä½¿ç”¨ SHA å‰7ä½ï¼‰
          if [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            GIT_SHA="${{ github.event.client_payload.github_sha }}"
            echo "  âœ… ä» client_payload.github_sha è·å–: $GIT_SHA"
          else
            GIT_SHA="${{ github.sha }}"
            echo "  âœ… ä» github.sha è·å–: $GIT_SHA"
          fi
          
          if [ ${#GIT_SHA} -gt 7 ]; then
            IMAGE_TAG="${GIT_SHA:0:7}"
          elif [ ${#GIT_SHA} -lt 7 ]; then
            IMAGE_TAG="latest"
            echo "  âš ï¸  SHA å¤ªçŸ­ï¼Œä½¿ç”¨ latest"
          else
            IMAGE_TAG="$GIT_SHA"
          fi
          
          if [ -z "$IMAGE_TAG" ]; then
            echo "  âš ï¸  æ ‡ç­¾ä¸ºç©ºï¼Œä½¿ç”¨ latest"
            IMAGE_TAG="latest"
          fi
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "âœ… æœ€ç»ˆé•œåƒæ ‡ç­¾: $IMAGE_TAG"
          
          # æ£€æµ‹é•œåƒä»“åº“ï¼ˆé»˜è®¤ä½¿ç”¨ ghcr.ioï¼‰
          if [ -n "${{ secrets.PRIVATE_REGISTRY }}" ]; then
            REGISTRY="${{ secrets.PRIVATE_REGISTRY }}"
            echo "  âœ… ä½¿ç”¨ç§æœ‰ä»“åº“: $REGISTRY"
          else
            REGISTRY="ghcr.io"
            echo "  âœ… ä½¿ç”¨é»˜è®¤ä»“åº“: $REGISTRY"
          fi
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT

  # æ­¥éª¤1: åŒæ—¶æ„å»ºæ‰€æœ‰åº”ç”¨
  build-all:
    name: Build All Apps
    needs: detect-image-tag
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app:
          - system-app
          - admin-app
          - logistics-app
          - quality-app
          - production-app
          - engineering-app
          - finance-app
          - mobile-app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile --prefer-offline
      
      - name: Restore built packages cache
        uses: actions/cache@v3
        with:
          path: |
            packages/*/dist
            packages/*/build
          key: packages-build-${{ github.sha }}
          restore-keys: |
            packages-build-
      
      - name: Build dependencies if needed
        run: |
          if [ ! -d "packages/vite-plugin/dist" ] || [ ! -f "packages/vite-plugin/dist/index.js" ]; then
            echo "Building shared dependencies..."
            pnpm --filter @btc/vite-plugin run build
            pnpm --filter @btc/shared-utils run build
            pnpm --filter @btc/shared-core run build
            pnpm --filter @btc/shared-components run build
            pnpm --filter @btc/subapp-manifests run build
          fi
      
      - name: Build ${{ matrix.app }}
        run: cd apps/${{ matrix.app }} && pnpm run build
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ needs.detect-image-tag.outputs.registry }}
          username: ${{ github.actor }}
          password: ${{ github.token }}
      
      - name: Prepare Docker tags
        id: tags
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repository_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            APP_DIR=apps/${{ matrix.app }}
          push: true
          tags: |
            ${{ needs.detect-image-tag.outputs.registry }}/${{ steps.tags.outputs.repository_lower }}/${{ matrix.app }}:latest
            ${{ needs.detect-image-tag.outputs.registry }}/${{ steps.tags.outputs.repository_lower }}/${{ matrix.app }}:${{ needs.detect-image-tag.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        env:
          DOCKER_BUILDKIT: 1

  # æ­¥éª¤2: åŒæ—¶éƒ¨ç½²æ‰€æœ‰åº”ç”¨
  deploy-system:
    name: Deploy System App
    needs: [detect-image-tag, build-all]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: system-app
      app_port: "30080"
      container_name: btc-system-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-admin:
    name: Deploy Admin App
    needs: [detect-image-tag, build-all]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: admin-app
      app_port: "30081"
      container_name: btc-admin-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-logistics:
    name: Deploy Logistics App
    needs: [detect-image-tag, build-all]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: logistics-app
      app_port: "30082"
      container_name: btc-logistics-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-quality:
    name: Deploy Quality App
    needs: [detect-image-tag, build-all]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: quality-app
      app_port: "30083"
      container_name: btc-quality-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-production:
    name: Deploy Production App
    needs: [detect-image-tag, build-all]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: production-app
      app_port: "30084"
      container_name: btc-production-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-engineering:
    name: Deploy Engineering App
    needs: [detect-image-tag, build-all]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: engineering-app
      app_port: "30085"
      container_name: btc-engineering-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-finance:
    name: Deploy Finance App
    needs: [detect-image-tag, build-all]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: finance-app
      app_port: "30086"
      container_name: btc-finance-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-mobile:
    name: Deploy Mobile App
    needs: [detect-image-tag, build-all]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: mobile-app
      app_port: "30091"
      container_name: btc-mobile-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  # æ­¥éª¤3: æ€»ç»“æˆåŠŸå’Œå¤±è´¥çš„åº”ç”¨
  summary:
    name: Summary
    needs: [build-all, deploy-all]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: read
    outputs:
      successful_apps: ${{ steps.collect.outputs.successful_apps }}
      failed_apps: ${{ steps.collect.outputs.failed_apps }}
      total_apps: ${{ steps.collect.outputs.total_apps }}
      success_count: ${{ steps.collect.outputs.success_count }}
      fail_count: ${{ steps.collect.outputs.fail_count }}
    steps:
      - name: Collect results
        id: collect
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const APPS = ['system-app', 'admin-app', 'logistics-app', 'quality-app', 'production-app', 'engineering-app', 'finance-app', 'mobile-app'];
            const SUCCESSFUL_APPS = [];
            const FAILED_APPS = [];
            
            // è·å–å½“å‰å·¥ä½œæµè¿è¡Œçš„æ‰€æœ‰ jobs
            const runId = context.runId;
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });
            
            // æ£€æŸ¥æ¯ä¸ªåº”ç”¨çš„æ„å»ºå’Œéƒ¨ç½²çŠ¶æ€
            const deployJobMap = {
              'system-app': 'Deploy System App',
              'admin-app': 'Deploy Admin App',
              'logistics-app': 'Deploy Logistics App',
              'quality-app': 'Deploy Quality App',
              'production-app': 'Deploy Production App',
              'engineering-app': 'Deploy Engineering App',
              'finance-app': 'Deploy Finance App',
              'mobile-app': 'Deploy Mobile App',
            };
            
            for (const app of APPS) {
              const buildJobName = `Build All Apps (${app})`;
              const deployJobName = deployJobMap[app];
              
              const buildJob = jobs.data.jobs.find(job => job.name === buildJobName);
              const deployJob = jobs.data.jobs.find(job => job.name === deployJobName);
              
              const buildSuccess = buildJob && buildJob.conclusion === 'success';
              const deploySuccess = deployJob && deployJob.conclusion === 'success';
              
              if (buildSuccess && deploySuccess) {
                SUCCESSFUL_APPS.push(app);
              } else {
                FAILED_APPS.push(app);
                if (!buildSuccess) {
                  console.log(`âŒ ${app}: æ„å»ºå¤±è´¥`);
                }
                if (!deploySuccess) {
                  console.log(`âŒ ${app}: éƒ¨ç½²å¤±è´¥`);
                }
              }
            }
            
            // è¾“å‡ºç»“æœ
            core.setOutput('successful_apps', SUCCESSFUL_APPS.join(','));
            core.setOutput('failed_apps', FAILED_APPS.join(','));
            core.setOutput('total_apps', APPS.length.toString());
            core.setOutput('success_count', SUCCESSFUL_APPS.length.toString());
            core.setOutput('fail_count', FAILED_APPS.length.toString());
            
            console.log('');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“Š æ„å»ºå’Œéƒ¨ç½²ç»“æœæ±‡æ€»');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log(`æ€»åº”ç”¨æ•°: ${APPS.length}`);
            console.log(`æˆåŠŸ: ${SUCCESSFUL_APPS.length}`);
            console.log(`å¤±è´¥: ${FAILED_APPS.length}`);
            console.log('');
            if (SUCCESSFUL_APPS.length > 0) {
              console.log('âœ… æˆåŠŸåº”ç”¨:');
              SUCCESSFUL_APPS.forEach(app => console.log(`  - ${app}`));
            }
            console.log('');
            if (FAILED_APPS.length > 0) {
              console.log('âŒ å¤±è´¥åº”ç”¨:');
              FAILED_APPS.forEach(app => console.log(`  - ${app}`));
            }
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      - name: Generate summary report
        run: |
          SUMMARY_TITLE="## ğŸ“Š æ„å»ºå’Œéƒ¨ç½²ç»“æœæ±‡æ€»"
          STATS_INFO="### ç»Ÿè®¡ä¿¡æ¯"
          TOTAL_APPS_COUNT="${{ steps.collect.outputs.total_apps }}"
          SUCCESS_COUNT_VAL="${{ steps.collect.outputs.success_count }}"
          FAIL_COUNT_VAL="${{ steps.collect.outputs.fail_count }}"
          
          SUCCESS_APPS_HEADER="### âœ… æˆåŠŸåº”ç”¨"
          SUCCESSFUL_APPS_STR="${{ steps.collect.outputs.successful_apps }}"
          
          FAILED_APPS_HEADER="### âŒ å¤±è´¥åº”ç”¨"
          FAILED_APPS_STR="${{ steps.collect.outputs.failed_apps }}"
          
          DETAIL_INFO_HEADER="### ğŸ“‹ è¯¦ç»†ä¿¡æ¯"
          IMAGE_TAG_VAL="${{ needs.detect-image-tag.outputs.image_tag }}"
          REGISTRY_VAL="${{ needs.detect-image-tag.outputs.registry }}"
          GIT_SHA_VAL="${{ github.sha }}"
          
          {
            echo "$SUMMARY_TITLE"
            echo ""
            echo "$STATS_INFO"
            echo "- **æ€»åº”ç”¨æ•°**: $TOTAL_APPS_COUNT"
            echo "- **æˆåŠŸ**: $SUCCESS_COUNT_VAL"
            echo "- **å¤±è´¥**: $FAIL_COUNT_VAL"
            echo ""
            
            if [ -n "$SUCCESSFUL_APPS_STR" ]; then
              echo "$SUCCESS_APPS_HEADER"
              IFS=',' read -ra APPS <<< "$SUCCESSFUL_APPS_STR"
              for app in "${APPS[@]}"; do
                echo "- \`$app\`"
              done
              echo ""
            fi
            
            if [ -n "$FAILED_APPS_STR" ]; then
              echo "$FAILED_APPS_HEADER"
              IFS=',' read -ra APPS <<< "$FAILED_APPS_STR"
              for app in "${APPS[@]}"; do
                echo "- \`$app\`"
              done
              echo ""
            fi
            
            echo "$DETAIL_INFO_HEADER"
            echo "- **é•œåƒæ ‡ç­¾**: $IMAGE_TAG_VAL"
            echo "- **ä»“åº“**: $REGISTRY_VAL"
            echo "- **Git SHA**: $GIT_SHA_VAL"
          } >> $GITHUB_STEP_SUMMARY
