name: Build-Deploy All Apps

on:
  repository_dispatch:
    types: [build-deploy-all-apps]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  actions: write

jobs:
  detect-image-tag:
    name: Detect Image Tag
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
      repo_owner_lower: ${{ steps.detect.outputs.repo_owner_lower }}
      registry: ${{ steps.detect.outputs.registry }}
    steps:
      - name: Detect image tag and repository owner
        id: detect
        run: |
          echo "ğŸ” å¼€å§‹æ£€æµ‹é•œåƒæ ‡ç­¾å’Œä»“åº“ä¿¡æ¯..."
          echo "  - client_payload.github_sha: ${{ github.event.client_payload.github_sha }}"
          echo "  - github.sha: ${{ github.sha }}"
          
          # è½¬æ¢ä»“åº“æ‰€æœ‰è€…åç§°ä¸ºå°å†™
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner_lower=$REPO_OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "  âœ… ä»“åº“æ‰€æœ‰è€…ï¼ˆå°å†™ï¼‰: $REPO_OWNER_LOWER"
          
          # ç”Ÿæˆé•œåƒæ ‡ç­¾ï¼ˆä½¿ç”¨ SHA å‰7ä½ï¼‰
          if [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            GIT_SHA="${{ github.event.client_payload.github_sha }}"
            echo "  âœ… ä» client_payload.github_sha è·å–: $GIT_SHA"
          else
            GIT_SHA="${{ github.sha }}"
            echo "  âœ… ä» github.sha è·å–: $GIT_SHA"
          fi
          
          if [ ${#GIT_SHA} -gt 7 ]; then
            IMAGE_TAG="${GIT_SHA:0:7}"
          elif [ ${#GIT_SHA} -lt 7 ]; then
            IMAGE_TAG="latest"
            echo "  âš ï¸  SHA å¤ªçŸ­ï¼Œä½¿ç”¨ latest"
          else
            IMAGE_TAG="$GIT_SHA"
          fi
          
          if [ -z "$IMAGE_TAG" ]; then
            echo "  âš ï¸  æ ‡ç­¾ä¸ºç©ºï¼Œä½¿ç”¨ latest"
            IMAGE_TAG="latest"
          fi
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "âœ… æœ€ç»ˆé•œåƒæ ‡ç­¾: $IMAGE_TAG"
          
          # æ£€æµ‹é•œåƒä»“åº“ï¼ˆé»˜è®¤ä½¿ç”¨ ghcr.ioï¼‰
          if [ -n "${{ secrets.PRIVATE_REGISTRY }}" ]; then
            REGISTRY="${{ secrets.PRIVATE_REGISTRY }}"
            echo "  âœ… ä½¿ç”¨ç§æœ‰ä»“åº“: $REGISTRY"
          else
            REGISTRY="ghcr.io"
            echo "  âœ… ä½¿ç”¨é»˜è®¤ä»“åº“: $REGISTRY"
          fi
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT

  # æ­¥éª¤1: æ„å»ºå…±äº«ä¾èµ–ï¼ˆå¯é€‰ï¼Œå¤±è´¥ä¸å½±å“åº”ç”¨æ„å»ºï¼‰
  build-shared-deps:
    name: Build Shared Dependencies
    needs: detect-image-tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile --prefer-offline
      
      - name: Restore built packages cache
        uses: actions/cache@v3
        with:
          path: |
            packages/*/dist
            packages/*/build
          key: packages-build-${{ github.sha }}
          restore-keys: |
            packages-build-
      
      - name: Build shared dependencies
        continue-on-error: true
        run: |
          echo "ğŸ”¨ æ„å»ºå…±äº«ä¾èµ–åŒ…..."
          echo "  è¿™ç¡®ä¿å…±äº«ç»„ä»¶åŒ…ï¼ˆå¦‚ @btc/shared-componentsï¼‰çš„ä¿®æ”¹èƒ½å¤Ÿç”Ÿæ•ˆ"
          echo ""
          
          # å§‹ç»ˆé‡æ–°æ„å»ºå…±äº«ä¾èµ–ï¼Œç¡®ä¿ä¿®æ”¹ç”Ÿæ•ˆ
          # ä½¿ç”¨ --force ç¡®ä¿å³ä½¿ç¼“å­˜å­˜åœ¨ä¹Ÿé‡æ–°æ„å»º
          echo "ğŸ“¦ æ„å»º @btc/vite-plugin..."
          pnpm --filter @btc/vite-plugin run build --force || pnpm --filter @btc/vite-plugin run build
          
          echo "ğŸ“¦ æ„å»º @btc/shared-utils..."
          pnpm --filter @btc/shared-utils run build --force || pnpm --filter @btc/shared-utils run build
          
          echo "ğŸ“¦ æ„å»º @btc/shared-core..."
          pnpm --filter @btc/shared-core run build --force || pnpm --filter @btc/shared-core run build
          
          echo "ğŸ“¦ æ„å»º @btc/shared-components..."
          pnpm --filter @btc/shared-components run build --force || pnpm --filter @btc/shared-components run build
          
          echo "ğŸ“¦ æ„å»º @btc/subapp-manifests..."
          pnpm --filter @btc/subapp-manifests run build --force || pnpm --filter @btc/subapp-manifests run build
          
          echo "âœ… å…±äº«ä¾èµ–åŒ…æ„å»ºå®Œæˆ"
      
      - name: Save built packages cache
        if: success() || failure()
        uses: actions/cache@v3
        with:
          path: |
            packages/*/dist
            packages/*/build
          key: packages-build-${{ github.sha }}

  # æ­¥éª¤2: æ¯ä¸ªåº”ç”¨ç‹¬ç«‹æ„å»ºå’Œéƒ¨ç½²ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼Œäº’ä¸å½±å“ï¼‰
  build-deploy-app:
    name: Build & Deploy ${{ matrix.app }}
    needs: [detect-image-tag, build-shared-deps]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: system-app
            port: "30080"
            container_name: btc-system-app
          - app: admin-app
            port: "30081"
            container_name: btc-admin-app
          - app: logistics-app
            port: "30082"
            container_name: btc-logistics-app
          - app: quality-app
            port: "30083"
            container_name: btc-quality-app
          - app: production-app
            port: "30084"
            container_name: btc-production-app
          - app: engineering-app
            port: "30085"
            container_name: btc-engineering-app
          - app: finance-app
            port: "30086"
            container_name: btc-finance-app
          - app: mobile-app
            port: "30091"
            container_name: btc-mobile-app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile --prefer-offline
      
      - name: Restore built packages cache
        uses: actions/cache@v3
        with:
          path: |
            packages/*/dist
            packages/*/build
          key: packages-build-${{ github.sha }}
          restore-keys: |
            packages-build-
      
      - name: Build shared dependencies (fallback)
        continue-on-error: true
        run: |
          echo "ğŸ”¨ æ£€æŸ¥å¹¶æ„å»ºå…±äº«ä¾èµ–åŒ…ï¼ˆå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼‰..."
          echo "ğŸ“¦ æ„å»º @btc/vite-plugin..."
          pnpm --filter @btc/vite-plugin run build --force || pnpm --filter @btc/vite-plugin run build || true
          
          echo "ğŸ“¦ æ„å»º @btc/shared-utils..."
          pnpm --filter @btc/shared-utils run build --force || pnpm --filter @btc/shared-utils run build || true
          
          echo "ğŸ“¦ æ„å»º @btc/shared-core..."
          pnpm --filter @btc/shared-core run build --force || pnpm --filter @btc/shared-core run build || true
          
          echo "ğŸ“¦ æ„å»º @btc/shared-components..."
          pnpm --filter @btc/shared-components run build --force || pnpm --filter @btc/shared-components run build || true
          
          echo "ğŸ“¦ æ„å»º @btc/subapp-manifests..."
          pnpm --filter @btc/subapp-manifests run build --force || pnpm --filter @btc/subapp-manifests run build || true
      
      - name: Clean build artifacts
        run: |
          echo "ğŸ§¹ æ¸…ç† ${{ matrix.app }} çš„æ„å»ºäº§ç‰©..."
          rm -rf apps/${{ matrix.app }}/dist
          rm -rf apps/${{ matrix.app }}/build
          echo "âœ… æ¸…ç†å®Œæˆ"
      
      - name: Build ${{ matrix.app }}
        run: cd apps/${{ matrix.app }} && pnpm run build
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ needs.detect-image-tag.outputs.registry }}
          username: ${{ github.actor }}
          password: ${{ github.token }}
      
      - name: Prepare Docker tags
        id: tags
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repository_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            APP_DIR=apps/${{ matrix.app }}
          push: true
          tags: |
            ${{ needs.detect-image-tag.outputs.registry }}/${{ steps.tags.outputs.repository_lower }}/${{ matrix.app }}:latest
            ${{ needs.detect-image-tag.outputs.registry }}/${{ steps.tags.outputs.repository_lower }}/${{ matrix.app }}:${{ needs.detect-image-tag.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        env:
          DOCKER_BUILDKIT: 1
      
      - name: Deploy ${{ matrix.app }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          timeout: 1800s
          command_timeout: 20m
          script: |
            set -e
            
            APP_NAME="${{ matrix.app }}"
            IMAGE_TAG="${{ needs.detect-image-tag.outputs.image_tag }}"
            PORT="${{ matrix.port }}"
            CONTAINER_NAME="${{ matrix.container_name }}"
            
            REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
            REGISTRY="${{ needs.detect-image-tag.outputs.registry }}"
            IMAGE_NAME="$REGISTRY/$REPO_LOWER/$APP_NAME"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Starting BTC ShopFlow Deployment"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "App: $APP_NAME"
            echo "Image: $IMAGE_NAME:$IMAGE_TAG"
            echo "Port: $PORT"
            echo ""
            
            # ç™»å½•åˆ° GHCRï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ï¼‰
            echo "ğŸ” Logging into container registry..."
            mkdir -p /tmp/.docker
            export DOCKER_CONFIG=/tmp/.docker
            
            # ä½¿ç”¨ GitHub Token ç™»å½•
            if [ -n "${{ secrets.SERVER_PAT }}" ]; then
              TOKEN="${{ secrets.SERVER_PAT }}"
            else
              TOKEN="${{ github.token }}"
            fi
            
            # Docker ç™»å½•å‡½æ•°ï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•ï¼‰
            docker_login_with_timeout() {
              local registry=$1
              local username=$2
              local token=$3
              local timeout_seconds=${4:-30}
              local max_retries=${5:-3}
              local retry_count=0
              
              while [ $retry_count -lt $max_retries ]; do
                retry_count=$((retry_count + 1))
                echo "ğŸ”„ å°è¯•ç™»å½•åˆ° $registry (ç¬¬ $retry_count/$max_retries æ¬¡)..."
                
                START_TIME=$(date +%s)
                
                if echo "$token" | timeout $timeout_seconds docker login "$registry" -u "$username" --password-stdin 2>&1; then
                  ELAPSED=$(($(date +%s) - START_TIME))
                  echo "âœ… ç™»å½•æˆåŠŸ (è€—æ—¶: ${ELAPSED} ç§’)"
                  return 0
                else
                  EXIT_CODE=$?
                  ELAPSED=$(($(date +%s) - START_TIME))
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "â±ï¸  ç™»å½•è¶…æ—¶ (${timeout_seconds} ç§’)"
                  else
                    echo "âŒ ç™»å½•å¤±è´¥ (é€€å‡ºç : $EXIT_CODE, è€—æ—¶: ${ELAPSED} ç§’)"
                  fi
                  
                  if [ $retry_count -lt $max_retries ]; then
                    echo "â³ ç­‰å¾… 3 ç§’åé‡è¯•..."
                    sleep 3
                  fi
                fi
              done
              
              return 1
            }
            
            # æ‰§è¡Œç™»å½•
            if ! docker_login_with_timeout "$REGISTRY" "${{ github.actor }}" "$TOKEN" 30 3; then
              echo "[ERROR] æ— æ³•ç™»å½•åˆ° $REGISTRY"
              exit 1
            fi
            
            # æ‹‰å–é•œåƒçš„å‡½æ•°ï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•ï¼‰
            pull_image_with_timeout() {
              local image=$1
              local timeout_seconds=${2:-300}
              local max_retries=${3:-3}
              local retry_count=0
              
              while [ $retry_count -lt $max_retries ]; do
                retry_count=$((retry_count + 1))
                echo "ğŸ”„ å°è¯•æ‹‰å–é•œåƒ (ç¬¬ $retry_count/$max_retries æ¬¡): $image"
                
                START_TIME=$(date +%s)
                
                if timeout $timeout_seconds docker pull "$image" 2>&1; then
                  ELAPSED=$(($(date +%s) - START_TIME))
                  echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ (è€—æ—¶: ${ELAPSED} ç§’)"
                  return 0
                else
                  EXIT_CODE=$?
                  ELAPSED=$(($(date +%s) - START_TIME))
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "â±ï¸  æ‹‰å–è¶…æ—¶ (${timeout_seconds} ç§’)"
                  else
                    echo "âŒ æ‹‰å–å¤±è´¥ (é€€å‡ºç : $EXIT_CODE, è€—æ—¶: ${ELAPSED} ç§’)"
                  fi
                  
                  if [ $retry_count -lt $max_retries ]; then
                    echo "â³ ç­‰å¾… 10 ç§’åé‡è¯•..."
                    sleep 10
                  fi
                fi
              done
              
              return 1
            }
            
            # å¼ºåˆ¶æ‹‰å–æœ€æ–°é•œåƒï¼ˆç¦ç”¨ç¼“å­˜ï¼‰
            echo "ğŸ“¥ Pulling Docker image from $REGISTRY..."
            echo "ğŸ”„ å¼ºåˆ¶æ‹‰å–æœ€æ–°é•œåƒ: $IMAGE_NAME:$IMAGE_TAG"

            # å…ˆå°è¯•åˆ é™¤æœ¬åœ°å¯èƒ½å­˜åœ¨çš„æ—§é•œåƒ
            docker rmi "$IMAGE_NAME:$IMAGE_TAG" 2>/dev/null || true
            docker rmi "$IMAGE_NAME:latest" 2>/dev/null || true

            if ! pull_image_with_timeout "$IMAGE_NAME:$IMAGE_TAG" 300 3; then
              echo "âš ï¸  æ— æ³•æ‹‰å– $IMAGE_NAME:$IMAGE_TAGï¼Œå°è¯• latest æ ‡ç­¾..."
              if ! pull_image_with_timeout "$IMAGE_NAME:latest" 300 3; then
                echo "[ERROR] æ— æ³•ä» $REGISTRY æ‹‰å–é•œåƒ"
                exit 1
              fi
              IMAGE_TAG="latest"
            fi
            
            # æ ‡è®°ä¸ºæœ¬åœ°é•œåƒ
            docker tag "$IMAGE_NAME:$IMAGE_TAG" "btc-shopflow/$APP_NAME:latest" 2>/dev/null || true
            echo "âœ… Image pulled and tagged successfully"
            
            echo "ğŸ”„ Updating container..."
            
            # åœæ­¢å¹¶åˆ é™¤ç°æœ‰å®¹å™¨
            echo "ğŸ“‹ æ¸…ç†ç°æœ‰å®¹å™¨: $CONTAINER_NAME"
            docker stop "$CONTAINER_NAME" 2>/dev/null || true
            docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
            docker ps -a --filter "name=^${CONTAINER_NAME}$" --format "{{.ID}}" 2>/dev/null | xargs -r docker rm -f 2>/dev/null || true
            
            # æ£€æŸ¥å¹¶åœæ­¢å ç”¨ç«¯å£çš„å®¹å™¨
            echo "ğŸ” æ£€æŸ¥ç«¯å£ $PORT å ç”¨æƒ…å†µ..."
            PORT_CONTAINERS=$(docker ps --format "{{.Names}}\t{{.Ports}}" | grep ":$PORT->" | awk '{print $1}' || true)
            if [ -n "$PORT_CONTAINERS" ]; then
              echo "$PORT_CONTAINERS" | while read -r container; do
                if [ -n "$container" ] && [ "$container" != "$CONTAINER_NAME" ]; then
                  echo "ğŸ›‘ åœæ­¢å®¹å™¨: $container"
                  docker stop "$container" 2>/dev/null || true
                  docker rm -f "$container" 2>/dev/null || true
                fi
              done
            fi
            
            # ç­‰å¾…ç«¯å£é‡Šæ”¾
            echo "â³ ç­‰å¾…ç«¯å£ $PORT é‡Šæ”¾..."
            for i in {1..10}; do
              ACTIVE_CONTAINERS=$(docker ps --format "{{.Names}}\t{{.Ports}}" | grep ":$PORT->" | wc -l || echo "0")
              if [ "$ACTIVE_CONTAINERS" = "0" ]; then
                echo "âœ… ç«¯å£ $PORT å·²é‡Šæ”¾"
                break
              fi
              sleep 1
            done
            
            # æ£€æŸ¥å¹¶åˆ›å»ºç½‘ç»œ
            echo "ğŸŒ æ£€æŸ¥ Docker ç½‘ç»œ..."
            if ! docker network inspect btc-network >/dev/null 2>&1; then
              echo "ğŸ“¦ åˆ›å»º Docker ç½‘ç»œ: btc-network"
              docker network create btc-network || true
            fi
            
            # éªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨
            if ! docker images | grep -q "btc-shopflow/$APP_NAME.*latest"; then
              echo "[ERROR] é•œåƒä¸å­˜åœ¨: btc-shopflow/$APP_NAME:latest"
              exit 1
            fi
            
            # åˆ›å»º docker-compose é…ç½®
            COMPOSE_FILE="docker-compose.${APP_NAME}.yml"
            {
              echo "version: '3.8'"
              echo "services:"
              echo "  $APP_NAME:"
              echo "    image: btc-shopflow/$APP_NAME:latest"
              echo "    container_name: $CONTAINER_NAME"
              echo "    ports:"
              echo "      - \"$PORT:80\""
              echo "    restart: unless-stopped"
              echo "    networks:"
              echo "      - btc-network"
              echo "networks:"
              echo "  btc-network:"
              echo "    external: true"
            } > "$COMPOSE_FILE"
            
            # æ£€æµ‹ docker-compose å‘½ä»¤
            DOCKER_COMPOSE_CMD=""
            if command -v docker-compose >/dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker-compose"
            elif docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker compose"
            else
              echo "[ERROR] æœªæ‰¾åˆ° docker-compose æˆ– docker compose å‘½ä»¤"
              exit 1
            fi
            
            # å¯åŠ¨å®¹å™¨
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            if ! $DOCKER_COMPOSE_CMD -f "$COMPOSE_FILE" up -d; then
              echo "[ERROR] å®¹å™¨å¯åŠ¨å¤±è´¥"
              exit 1
            fi
            
            sleep 5
            
            # éªŒè¯å®¹å™¨çŠ¶æ€
            echo "ğŸ” éªŒè¯å®¹å™¨çŠ¶æ€..."
            CONTAINER_ID=""
            MAX_WAIT=30
            WAIT_INTERVAL=2
            ELAPSED=0
            
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              CONTAINER_ID=$(docker ps --filter "name=^${CONTAINER_NAME}$" --format "{{.ID}}" 2>/dev/null | head -1 || echo "")
              if [ -n "$CONTAINER_ID" ]; then
                echo "âœ… å®¹å™¨æ­£åœ¨è¿è¡Œ"
                break
              fi
              ELAPSED=$((ELAPSED + WAIT_INTERVAL))
              sleep $WAIT_INTERVAL
            done
            
            if [ -z "$CONTAINER_ID" ]; then
              echo "[ERROR] å®¹å™¨éªŒè¯è¶…æ—¶ï¼"
              exit 1
            fi
            
            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f || true
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # æ­¥éª¤3: æ€»ç»“æˆåŠŸå’Œå¤±è´¥çš„åº”ç”¨
  summary:
    name: Summary
    needs: [detect-image-tag, build-deploy-app]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: read
      actions: read
    outputs:
      successful_apps: ${{ steps.collect.outputs.successful_apps }}
      failed_apps: ${{ steps.collect.outputs.failed_apps }}
      total_apps: ${{ steps.collect.outputs.total_apps }}
      success_count: ${{ steps.collect.outputs.success_count }}
      fail_count: ${{ steps.collect.outputs.fail_count }}
    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Collect results
        id: collect
        run: |
          APPS=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
          SUCCESSFUL_APPS=()
          FAILED_APPS=()
          
          # æ£€æŸ¥æ¯ä¸ªåº”ç”¨çš„æ„å»ºå’Œéƒ¨ç½²çŠ¶æ€
          # ç”±äºä½¿ç”¨äº† matrixï¼Œæ¯ä¸ªåº”ç”¨éƒ½æœ‰ç‹¬ç«‹çš„ job å®ä¾‹
          # æˆ‘ä»¬éœ€è¦é€šè¿‡ GitHub API æ¥è·å–æ¯ä¸ª matrix job çš„ç»“æœ
          
          echo "ğŸ” å¼€å§‹æ”¶é›†å„åº”ç”¨çš„æ„å»ºå’Œéƒ¨ç½²ç»“æœ..."
          
          # ä½¿ç”¨ GitHub API è·å–å½“å‰ workflow run çš„ jobs
          RUN_ID="${{ github.run_id }}"
          REPO="${{ github.repository }}"
          TOKEN="${{ github.token }}"
          
          # è·å–æ‰€æœ‰ jobsï¼ˆå¯èƒ½éœ€è¦åˆ†é¡µï¼‰
          JOBS_JSON=$(curl -s -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/jobs?per_page=100")
          
          # æ£€æŸ¥ API è°ƒç”¨æ˜¯å¦æˆåŠŸ
          if [ $? -ne 0 ] || [ -z "$JOBS_JSON" ]; then
            echo "âš ï¸  æ— æ³•ä» GitHub API è·å– jobs ä¿¡æ¯ï¼Œä½¿ç”¨ç®€åŒ–é€»è¾‘..."
            # ä½¿ç”¨ç®€åŒ–é€»è¾‘ï¼šå¦‚æœæ•´ä½“ job æˆåŠŸï¼Œå‡è®¾æ‰€æœ‰åº”ç”¨éƒ½æˆåŠŸ
            OVERALL_RESULT="${{ needs.build-deploy-app.result }}"
            if [ "$OVERALL_RESULT" = "success" ]; then
              for app in "${APPS[@]}"; do
                SUCCESSFUL_APPS+=("$app")
                echo "âœ… $app: å‡è®¾æˆåŠŸï¼ˆæ•´ä½“çŠ¶æ€: $OVERALL_RESULTï¼‰"
              done
            else
              for app in "${APPS[@]}"; do
                FAILED_APPS+=("$app")
                echo "âŒ $app: å‡è®¾å¤±è´¥ï¼ˆæ•´ä½“çŠ¶æ€: $OVERALL_RESULTï¼‰"
              done
            fi
          else
            # è§£ææ¯ä¸ªåº”ç”¨çš„çŠ¶æ€
            for app in "${APPS[@]}"; do
              # æŸ¥æ‰¾å¯¹åº”çš„ jobï¼ˆjob åç§°æ ¼å¼: "Build & Deploy {app}"ï¼‰
              JOB_NAME="Build & Deploy $app"
              
              # ä» JSON ä¸­æå– job çŠ¶æ€
              JOB_RESULT=$(echo "$JOBS_JSON" | jq -r --arg name "$JOB_NAME" '.jobs[] | select(.name == $name) | .conclusion' | head -1)
              
              if [ -z "$JOB_RESULT" ] || [ "$JOB_RESULT" = "null" ]; then
                # å¦‚æœæ‰¾ä¸åˆ° jobï¼Œæ ‡è®°ä¸ºæœªçŸ¥
                echo "âš ï¸  æ— æ³•ä» API è·å– $app çš„çŠ¶æ€"
                JOB_RESULT="unknown"
              fi
              
              echo "  $app: $JOB_RESULT"
              
              # åˆ¤æ–­æˆåŠŸæˆ–å¤±è´¥
              if [ "$JOB_RESULT" = "success" ]; then
                SUCCESSFUL_APPS+=("$app")
                echo "âœ… $app: æ„å»ºå’Œéƒ¨ç½²éƒ½æˆåŠŸ"
              else
                FAILED_APPS+=("$app")
                echo "âŒ $app: çŠ¶æ€ = $JOB_RESULT"
              fi
            done
          fi
          
          # ç”Ÿæˆè¾“å‡º
          if [ ${#SUCCESSFUL_APPS[@]} -gt 0 ]; then
            SUCCESSFUL_APPS_STR=$(IFS=','; echo "${SUCCESSFUL_APPS[*]}")
            echo "successful_apps=$SUCCESSFUL_APPS_STR" >> $GITHUB_OUTPUT
          else
            echo "successful_apps=" >> $GITHUB_OUTPUT
          fi
          
          if [ ${#FAILED_APPS[@]} -gt 0 ]; then
            FAILED_APPS_STR=$(IFS=','; echo "${FAILED_APPS[*]}")
            echo "failed_apps=$FAILED_APPS_STR" >> $GITHUB_OUTPUT
          else
            echo "failed_apps=" >> $GITHUB_OUTPUT
          fi
          
          echo "total_apps=${#APPS[@]}" >> $GITHUB_OUTPUT
          echo "success_count=${#SUCCESSFUL_APPS[@]}" >> $GITHUB_OUTPUT
          echo "fail_count=${#FAILED_APPS[@]}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š æ„å»ºå’Œéƒ¨ç½²ç»“æœæ±‡æ€»"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "æ€»åº”ç”¨æ•°: ${#APPS[@]}"
          echo "æˆåŠŸ: ${#SUCCESSFUL_APPS[@]}"
          echo "å¤±è´¥: ${#FAILED_APPS[@]}"
          echo ""
          if [ ${#SUCCESSFUL_APPS[@]} -gt 0 ]; then
            echo "âœ… æˆåŠŸåº”ç”¨:"
            for app in "${SUCCESSFUL_APPS[@]}"; do
              echo "  - $app"
            done
          fi
          echo ""
          if [ ${#FAILED_APPS[@]} -gt 0 ]; then
            echo "âŒ å¤±è´¥åº”ç”¨:"
            for app in "${FAILED_APPS[@]}"; do
              echo "  - $app"
            done
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Generate summary report
        run: |
          SUMMARY_TITLE="## ğŸ“Š æ„å»ºå’Œéƒ¨ç½²ç»“æœæ±‡æ€»"
          STATS_INFO="### ç»Ÿè®¡ä¿¡æ¯"
          TOTAL_APPS_COUNT="${{ steps.collect.outputs.total_apps }}"
          SUCCESS_COUNT_VAL="${{ steps.collect.outputs.success_count }}"
          FAIL_COUNT_VAL="${{ steps.collect.outputs.fail_count }}"
          
          SUCCESS_APPS_HEADER="### âœ… æˆåŠŸåº”ç”¨"
          SUCCESSFUL_APPS_STR="${{ steps.collect.outputs.successful_apps }}"
          
          FAILED_APPS_HEADER="### âŒ å¤±è´¥åº”ç”¨"
          FAILED_APPS_STR="${{ steps.collect.outputs.failed_apps }}"
          
          DETAIL_INFO_HEADER="### ğŸ“‹ è¯¦ç»†ä¿¡æ¯"
          IMAGE_TAG_VAL="${{ needs.detect-image-tag.outputs.image_tag }}"
          REGISTRY_VAL="${{ needs.detect-image-tag.outputs.registry }}"
          GIT_SHA_VAL="${{ github.sha }}"
          
          # å¦‚æœ detect-image-tag å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
          if [ -z "$IMAGE_TAG_VAL" ]; then
            IMAGE_TAG_VAL="latest"
          fi
          if [ -z "$REGISTRY_VAL" ]; then
            REGISTRY_VAL="ghcr.io"
          fi
          
          {
            echo "$SUMMARY_TITLE"
            echo ""
            echo "$STATS_INFO"
            echo "- **æ€»åº”ç”¨æ•°**: $TOTAL_APPS_COUNT"
            echo "- **æˆåŠŸ**: $SUCCESS_COUNT_VAL"
            echo "- **å¤±è´¥**: $FAIL_COUNT_VAL"
            echo ""
            
            if [ -n "$SUCCESSFUL_APPS_STR" ]; then
              echo "$SUCCESS_APPS_HEADER"
              IFS=',' read -ra APPS <<< "$SUCCESSFUL_APPS_STR"
              for app in "${APPS[@]}"; do
                echo "- \`$app\`"
              done
              echo ""
            fi
            
            if [ -n "$FAILED_APPS_STR" ]; then
              echo "$FAILED_APPS_HEADER"
              IFS=',' read -ra APPS <<< "$FAILED_APPS_STR"
              for app in "${APPS[@]}"; do
                echo "- \`$app\`"
              done
              echo ""
            fi
            
            echo "$DETAIL_INFO_HEADER"
            echo "- **é•œåƒæ ‡ç­¾**: $IMAGE_TAG_VAL"
            echo "- **ä»“åº“**: $REGISTRY_VAL"
            echo "- **Git SHA**: $GIT_SHA_VAL"
          } >> $GITHUB_STEP_SUMMARY
