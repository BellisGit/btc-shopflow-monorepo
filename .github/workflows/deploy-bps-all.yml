name: Deploy with BPS All

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'è·³è¿‡æž„å»ºæ­¥éª¤ï¼ˆä»…éƒ¨ç½²å·²æœ‰äº§ç‰©ï¼‰'
        required: false
        type: boolean
        default: false
  # æž„å»ºå®ŒæˆåŽè‡ªåŠ¨è§¦å‘ï¼ˆä»…å½“æž„å»ºæˆåŠŸæ—¶ï¼‰
  workflow_run:
    workflows: ["Build-Deploy All Apps"]
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:
  deploy:
    name: Deploy All Apps (BPS)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Determine skip build flag
        id: config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SKIP_BUILD="${{ inputs.skip_build }}"
          else
            # æž„å»ºå®ŒæˆåŽè‡ªåŠ¨è§¦å‘ï¼šè·³è¿‡æž„å»ºï¼Œä½¿ç”¨å·²æœ‰äº§ç‰©
            SKIP_BUILD="true"
          fi
          
          echo "skip_build=$SKIP_BUILD" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ è·³è¿‡æž„å»º: $SKIP_BUILD"
      
      # ä»Žæž„å»ºå·¥ä½œæµä¸‹è½½æž„å»ºäº§ç‰©ï¼ˆå¦‚æžœæ˜¯ä»Ž workflow_run è§¦å‘ï¼‰
      - name: Download build artifacts from workflow run
        if: github.event_name == 'workflow_run' && steps.config.outputs.skip_build == 'true'
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: 'dist-*'
          path: artifacts
          github_token: ${{ secrets.GITHUB_TOKEN }}
          check_artifacts: false
        continue-on-error: true
      
      - name: Extract and organize build artifacts
        if: github.event_name == 'workflow_run' && steps.config.outputs.skip_build == 'true'
        run: |
          echo "ðŸ“¦ æå–æž„å»ºäº§ç‰©..."
          
          if [ -d "artifacts" ]; then
            for artifact_dir in artifacts/dist-*; do
              if [ -d "$artifact_dir" ]; then
                APP_NAME=$(basename "$artifact_dir" | sed 's/^dist-//')
                if [ -n "$APP_NAME" ]; then
                  echo "  ðŸ“¦ æå– $APP_NAME çš„æž„å»ºäº§ç‰©..."
                  mkdir -p "apps/$APP_NAME"
                  cp -r "$artifact_dir" "apps/$APP_NAME/dist" || true
                fi
              fi
            done
            rm -rf artifacts
          fi
          
          # éªŒè¯æž„å»ºäº§ç‰©
          echo ""
          echo "ðŸ“¦ æž„å»ºäº§ç‰©éªŒè¯:"
          for app in system-app admin-app logistics-app quality-app production-app engineering-app finance-app layout-app; do
            if [ -d "apps/$app/dist" ] && [ "$(ls -A apps/$app/dist 2>/dev/null)" ]; then
              file_count=$(find "apps/$app/dist" -type f 2>/dev/null | wc -l)
              size=$(du -sh "apps/$app/dist" 2>/dev/null | awk '{print $1}')
              echo "  âœ… $app: $file_count ä¸ªæ–‡ä»¶, å¤§å°: $size"
            else
              echo "  âŒ $app: æž„å»ºäº§ç‰©ä¸å­˜åœ¨"
            fi
          done
        continue-on-error: true
      
      # å¦‚æžœéœ€è¦æž„å»ºï¼Œå…ˆå®‰è£…çŽ¯å¢ƒå’Œæž„å»º
      - name: Setup Node.js
        if: steps.config.outputs.skip_build == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        if: steps.config.outputs.skip_build == 'false'
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: false
      
      - name: Install dependencies
        if: steps.config.outputs.skip_build == 'false'
        run: |
          pnpm install --frozen-lockfile
      
      - name: Build all apps
        if: steps.config.outputs.skip_build == 'false'
        run: |
          # æž„å»º system-app ç”Ÿæˆ EPS
          pnpm build:system
          # å¤åˆ¶ EPS æ•°æ®
          node scripts/copy-eps-from-system.mjs
          # æž„å»ºæ‰€æœ‰åº”ç”¨
          pnpm build:all
      
      # å®‰è£… sshpass å¹¶è®¾ç½® SSH è¿žæŽ¥
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          sshpass -V
      
      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # æµ‹è¯•è¿žæŽ¥ï¼ˆä½¿ç”¨å¯†ç è®¤è¯ï¼‰
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                -o ConnectTimeout=30 \
                -o ServerAliveInterval=60 \
                -o ServerAliveCountMax=3 \
                ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} \
            "echo 'SSH connection successful'" || {
            echo "âŒ SSH è¿žæŽ¥æµ‹è¯•å¤±è´¥"
            exit 1
          }
      
      # æ‰§è¡Œéƒ¨ç½²ï¼ˆåªéƒ¨ç½²ï¼Œä¸æž„å»ºï¼‰
      - name: Run BPS All deployment
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
          REMOTE_BASE_PATH: ${{ secrets.REMOTE_BASE_PATH || '/www/wwwroot' }}
        run: |
          set -e
          chmod +x scripts/bps-all.sh
          
          # åœ¨å·¥ä½œæµä¸­ï¼Œæ€»æ˜¯è·³è¿‡æž„å»ºï¼ˆå› ä¸ºå·²ç»åœ¨å‰é¢æ­¥éª¤ä¸­å®Œæˆï¼‰
          ./scripts/bps-all.sh --skip-build
      
      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸ“‹ éƒ¨ç½²æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è·³è¿‡æž„å»º**: ${{ steps.config.outputs.skip_build }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æœåŠ¡å™¨**: ${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
