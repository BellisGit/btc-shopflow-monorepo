name: Build and Deploy to K8s (Parallel with Reusable Workflows)

# å®Œæ•´çš„å·¥ä½œæµï¼šä½¿ç”¨å¯å¤ç”¨å·¥ä½œæµå¹¶è¡Œæ„å»ºå’Œå¹¶è¡Œéƒ¨ç½²åˆ° K8s
# - è§¦å‘æ¡ä»¶ï¼š
#   1. push åˆ° master åˆ†æ”¯
#   2. workflow_dispatchï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
# - åŠŸèƒ½ï¼š
#   1. æ£€æµ‹å˜æ›´çš„åº”ç”¨
#   2. ä½¿ç”¨å¯å¤ç”¨å·¥ä½œæµå¹¶è¡Œæ„å»ºå˜æ›´çš„åº”ç”¨
#   3. æ„å»ºå®Œæˆåï¼Œä½¿ç”¨å¯å¤ç”¨å·¥ä½œæµå¹¶è¡Œéƒ¨ç½²åˆ° K8s
# - é…ç½®è¯´æ˜ï¼š
#   1. é•œåƒä»“åº“é…ç½®ï¼ˆåœ¨ GitHub Secrets ä¸­è®¾ç½®ï¼‰ï¼š
#      - PRIVATE_REGISTRY: é•œåƒä»“åº“åœ°å€ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ ghcr.ioï¼‰
#      - PRIVATE_REGISTRY_USERNAME: ä»“åº“ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰
#      - PRIVATE_REGISTRY_PASSWORD: ä»“åº“å¯†ç /Tokenï¼ˆå¯é€‰ï¼‰
#   2. K8s éƒ¨ç½²é…ç½®ï¼ˆåœ¨ GitHub Secrets ä¸­è®¾ç½®ï¼‰ï¼š
#      - K8S_SERVER: K8s API æœåŠ¡å™¨åœ°å€
#      - K8S_CA_CERT: K8s CA è¯ä¹¦ï¼ˆbase64 ç¼–ç ï¼‰
#      - K8S_TOKEN: K8s è®¿é—®ä»¤ç‰Œ
#      - K8S_NAMESPACE: K8s å‘½åç©ºé—´ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼šbtc-shopflowï¼‰

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all apps (even if no changes detected)'
        required: false
        type: boolean
        default: false
      skip_build:
        description: 'Skip build step'
        required: false
        type: boolean
        default: false
      skip_deploy:
        description: 'Skip deploy step'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  detect-config:
    name: Detect and Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      registry: ${{ steps.config.outputs.registry }}
      registry_username: ${{ steps.config.outputs.registry_username }}
      registry_password: ${{ steps.config.outputs.registry_password }}
      use_ghcr: ${{ steps.config.outputs.use_ghcr }}
      needs_auth: ${{ steps.config.outputs.needs_auth }}
    steps:
      - name: Detect registry configuration
        id: config
        run: |
          echo "ğŸ” æ£€æµ‹é•œåƒä»“åº“é…ç½®..."
          
          # æ£€æµ‹æ˜¯å¦é…ç½®äº†ç§æœ‰ä»“åº“
          if [ -n "${{ secrets.PRIVATE_REGISTRY }}" ]; then
            PRIVATE_REGISTRY="${{ secrets.PRIVATE_REGISTRY }}"
            echo "âœ… æ£€æµ‹åˆ°ç§æœ‰ä»“åº“é…ç½®: $PRIVATE_REGISTRY"
            echo "registry=$PRIVATE_REGISTRY" >> $GITHUB_OUTPUT
            echo "use_ghcr=false" >> $GITHUB_OUTPUT
            
            # æ£€æµ‹æ˜¯å¦éœ€è¦è®¤è¯
            if [ -n "${{ secrets.PRIVATE_REGISTRY_USERNAME }}" ] && [ -n "${{ secrets.PRIVATE_REGISTRY_PASSWORD }}" ]; then
              echo "âœ… æ£€æµ‹åˆ°è®¤è¯é…ç½®ï¼Œå°†ä½¿ç”¨è®¤è¯ç™»å½•"
              {
                echo "registry_username<<EOF"
                echo "${{ secrets.PRIVATE_REGISTRY_USERNAME }}"
                echo "EOF"
              } >> $GITHUB_OUTPUT
              {
                echo "registry_password<<EOF"
                echo "${{ secrets.PRIVATE_REGISTRY_PASSWORD }}"
                echo "EOF"
              } >> $GITHUB_OUTPUT
              echo "needs_auth=true" >> $GITHUB_OUTPUT
            else
              echo "â„¹ï¸  æœªé…ç½®è®¤è¯ä¿¡æ¯ï¼Œå°†å°è¯•åŒ¿åè®¿é—®ï¼ˆé€‚ç”¨äºä¸éœ€è¦è®¤è¯çš„ç§æœ‰ä»“åº“ï¼‰"
              echo "registry_username=" >> $GITHUB_OUTPUT
              echo "registry_password=" >> $GITHUB_OUTPUT
              echo "needs_auth=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… æœªé…ç½®ç§æœ‰ä»“åº“ï¼Œå°†ä½¿ç”¨ GitHub Container Registry (GHCR)"
            echo "registry=ghcr.io" >> $GITHUB_OUTPUT
            echo "use_ghcr=true" >> $GITHUB_OUTPUT
            {
              echo "registry_username<<EOF"
              echo "${{ github.actor }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            {
              echo "registry_password<<EOF"
              echo "${{ github.token }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "needs_auth=true" >> $GITHUB_OUTPUT
          fi

  detect-changes:
    name: Detect Changed Applications
    needs: detect-config
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.changes.outputs.has_changes }}
      changed_apps: ${{ steps.changes.outputs.changed_apps }}
      changed_apps_json: ${{ steps.changes.outputs.changed_apps_json }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changed applications
        id: changes
        run: |
          echo "ğŸ” æ£€æµ‹å˜æ›´çš„åº”ç”¨..."
          
          # å®šä¹‰æ‰€æœ‰åº”ç”¨
          declare -a ALL_APPS=(
            "system-app"
            "admin-app"
            "logistics-app"
            "quality-app"
            "production-app"
            "engineering-app"
            "finance-app"
            "mobile-app"
          )
          
          # å¦‚æœæ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©äº† force_rebuildï¼Œåˆ™æ„å»ºæ‰€æœ‰åº”ç”¨
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            CHANGED_APPS=("${ALL_APPS[@]}")
            echo "æ‰‹åŠ¨è§¦å‘ï¼šå¼ºåˆ¶é‡å»ºæ‰€æœ‰åº”ç”¨"
          else
            # æ£€æµ‹å˜æ›´çš„åº”ç”¨
            CHANGED_APPS=()
            
            # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              # PR äº‹ä»¶ï¼šæ¯”è¾ƒ base å’Œ head
              BASE_SHA="${{ github.event.pull_request.base.sha }}"
              HEAD_SHA="${{ github.event.pull_request.head.sha }}"
              CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" || echo "")
            else
              # Push äº‹ä»¶ï¼šæ¯”è¾ƒå‰ä¸€ä¸ª commit
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
            fi
            
            echo "å˜æ›´çš„æ–‡ä»¶ï¼š"
            echo "$CHANGED_FILES"
            
            # æ£€æŸ¥æ¯ä¸ªåº”ç”¨æ˜¯å¦æœ‰å˜æ›´
            for app in "${ALL_APPS[@]}"; do
              if echo "$CHANGED_FILES" | grep -q "^apps/$app/"; then
                CHANGED_APPS+=("$app")
                echo "âœ… æ£€æµ‹åˆ°å˜æ›´: $app"
              fi
            done
            
            # æ£€æŸ¥å…±äº«åŒ…æ˜¯å¦æœ‰å˜æ›´ï¼ˆå¦‚æœæœ‰ï¼Œéœ€è¦æ„å»ºæ‰€æœ‰åº”ç”¨ï¼‰
            if echo "$CHANGED_FILES" | grep -q "^packages/"; then
              echo "âš ï¸  æ£€æµ‹åˆ°å…±äº«åŒ…å˜æ›´ï¼Œå°†æ„å»ºæ‰€æœ‰åº”ç”¨"
              CHANGED_APPS=("${ALL_APPS[@]}")
            fi
          fi
          
          if [ ${#CHANGED_APPS[@]} -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changed_apps=" >> $GITHUB_OUTPUT
            echo 'changed_apps_json=[]' >> $GITHUB_OUTPUT
            echo "æœªæ£€æµ‹åˆ°éœ€è¦æ„å»ºçš„åº”ç”¨"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_apps=${CHANGED_APPS[*]}" >> $GITHUB_OUTPUT
            # ç”Ÿæˆ JSON æ•°ç»„ç”¨äº matrix
            JSON_APPS="["
            for i in "${!CHANGED_APPS[@]}"; do
              if [ $i -gt 0 ]; then
                JSON_APPS+=","
              fi
              JSON_APPS+="\"${CHANGED_APPS[$i]}\""
            done
            JSON_APPS+="]"
            
            # ä½¿ç”¨å¤šè¡Œè¾“å‡ºæ ¼å¼ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
            {
              echo "changed_apps_json<<EOF"
              echo "$JSON_APPS"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°éœ€è¦æ„å»ºçš„åº”ç”¨: ${CHANGED_APPS[*]}"
          fi

  build:
    name: Build Changed Apps (Parallel)
    needs: [detect-config, detect-changes]
    if: (needs.detect-changes.outputs.has_changes == 'true' || github.event.inputs.force_rebuild == 'true') && github.event.inputs.skip_build != 'true'
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.changed_apps_json) }}
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: ${{ matrix.app }}
      registry: ${{ needs.detect-config.outputs.registry }}
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ needs.detect-config.outputs.registry_password || github.token }}

  prepare-deploy:
    name: Prepare Deployment Info
    needs: [detect-config, detect-changes, build]
    if: (needs.detect-changes.outputs.has_changes == 'true' || github.event.inputs.force_rebuild == 'true') && github.event.inputs.skip_deploy != 'true' && (needs.build.result == 'success' || github.event.inputs.skip_build == 'true')
    runs-on: ubuntu-latest
    outputs:
      repo_owner_lower: ${{ steps.prepare.outputs.repo_owner_lower }}
      image_tag: ${{ steps.prepare.outputs.image_tag }}
    steps:
      - name: Prepare deployment info
        id: prepare
        run: |
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          echo "repo_owner_lower=$REPO_OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        env:
          GITHUB_SHA: ${{ github.sha }}

  deploy:
    name: Deploy to K8s (Parallel)
    needs: [detect-config, detect-changes, build, prepare-deploy]
    if: (needs.detect-changes.outputs.has_changes == 'true' || github.event.inputs.force_rebuild == 'true') && github.event.inputs.skip_deploy != 'true' && (needs.build.result == 'success' || github.event.inputs.skip_build == 'true')
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.changed_apps_json) }}
    uses: ./.github/workflows/deploy-app-k8s-reusable.yml
    with:
      app_name: ${{ matrix.app }}
      image_tag: ${{ needs.prepare-deploy.outputs.image_tag }}
      registry: ${{ needs.detect-config.outputs.registry }}
      github_repository_owner: ${{ needs.prepare-deploy.outputs.repo_owner_lower }}
      k8s_namespace: ${{ secrets.K8S_NAMESPACE || 'btc-shopflow' }}
    secrets:
      K8S_SERVER: ${{ secrets.K8S_SERVER }}
      K8S_CA_CERT: ${{ secrets.K8S_CA_CERT }}
      K8S_TOKEN: ${{ secrets.K8S_TOKEN }}

