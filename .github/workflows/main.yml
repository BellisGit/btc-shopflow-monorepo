name: BTC ShopFlow CI/CD Pipeline

# Trigger workflow to test updated SSH key configuration
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
      deploy_only:
        description: 'Skip quality checks and build, deploy only'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY: ghcr.io

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  # Step 1: SSH Connection Validation (Fast Fail)
  validate-ssh:
    name: Validate SSH Connection
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Test SSH connection
      run: |
        echo "[INFO] Testing SSH connection first to fail fast if credentials are invalid..."
        
        if [ -z "${{ secrets.SERVER_KEY }}" ]; then
          echo "[WARNING] SERVER_KEY not set - SSH deployment will be skipped"
          echo "ssh_available=false" >> $GITHUB_ENV
          exit 0
        fi
        
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "[WARNING] SERVER_HOST not set - SSH deployment will be skipped"
          echo "ssh_available=false" >> $GITHUB_ENV
          exit 0
        fi
        
        echo "[INFO] Setting up SSH key..."
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Process SSH key
        echo "Processing SSH key..."
        SERVER_KEY="${{ secrets.SERVER_KEY }}"
        if echo "$SERVER_KEY" | grep -q "^[A-Za-z0-9+/]*={0,2}$" && [ ${#SERVER_KEY} -gt 100 ]; then
          echo "Detected base64 encoded key, decoding..."
          echo "${{ secrets.SERVER_KEY }}" | base64 -d > ~/.ssh/id_rsa
        else
          echo "Processing key as plain text..."
          echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
          sed -i 's/\\n/\n/g' ~/.ssh/id_rsa
        fi
        
        chmod 600 ~/.ssh/id_rsa
        
        # Validate key format
        if ! ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1; then
          echo "[ERROR] SSH key format is invalid"
          echo "Please check your SERVER_KEY secret format"
          exit 1
        fi
        
        # Show key fingerprint for debugging
        echo "[INFO] SSH key fingerprint: $(ssh-keygen -l -f ~/.ssh/id_rsa)"
        echo "[INFO] SSH key type: $(ssh-keygen -l -f ~/.ssh/id_rsa | awk '{print $4}')"
        
        # Add host key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        
        echo "[INFO] Testing SSH connection..."
        echo "[DEBUG] Connection details:"
        echo "  Host: ${{ secrets.SERVER_HOST }}"
        echo "  Port: ${{ secrets.SERVER_PORT || '22' }}"
        echo "  User: ${{ secrets.SERVER_USER || 'root' }}"
        
        if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes \
            -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || '22' }} \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} \
            "echo 'SSH connection test successful'"; then
          echo "[SUCCESS] SSH connection successful!"
          echo "ssh_available=true" >> $GITHUB_ENV
        else
          echo "[ERROR] SSH connection failed!"
          echo ""
          echo "TROUBLESHOOTING STEPS:"
          echo "1. Verify your SSH key is added to the server:"
          echo "   - Copy your PUBLIC key (not private) to ~/.ssh/authorized_keys on server"
          echo "   - Run: cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys"
          echo ""
          echo "2. Check server SSH configuration:"
          echo "   - Ensure PubkeyAuthentication is enabled in /etc/ssh/sshd_config"
          echo "   - Restart SSH service: sudo systemctl restart sshd"
          echo ""
          echo "3. Verify file permissions on server:"
          echo "   - chmod 700 ~/.ssh"
          echo "   - chmod 600 ~/.ssh/authorized_keys"
          echo ""
          echo "4. Test manually from your local machine:"
          echo "   - ssh -i your_private_key ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }}"
          echo ""
          echo "Common issues:"
          echo "- SSH key not added to server's authorized_keys"
          echo "- Wrong server IP address: ${{ secrets.SERVER_HOST }}"
          echo "- Firewall blocking SSH port: ${{ secrets.SERVER_PORT || '22' }}"
          echo "- SSH service not running on server"
          exit 1
        fi

  # Step 2: Pre-build Validation
  validate-build-config:
    name: Validate Build Configuration
    runs-on: ubuntu-latest
    needs: [validate-ssh]
    if: always() && github.event.inputs.deploy_only != 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate TypeScript configurations
      run: |
        echo "Validating TypeScript configurations..."
        
        # Check for problematic tsconfig inheritance
        echo "Checking for tsconfig inheritance issues..."
        
        # List all tsconfig files that might have inheritance issues
        find packages -name "tsconfig.json" -exec echo "Checking: {}" \;
        
        # Check if any tsconfig files have problematic extends
        PROBLEMATIC_FILES=$(find packages -name "tsconfig.json" -exec grep -l '"extends".*"\.\./tsconfig\.json"' {} \; 2>/dev/null || true)
        if [ -n "$PROBLEMATIC_FILES" ]; then
          echo "âŒ Found tsconfig files with problematic inheritance:"
          echo "$PROBLEMATIC_FILES"
          echo ""
          echo "These files extend '../tsconfig.json' which may not be available in Docker build context."
          echo "Please use standalone tsconfig files or fix the inheritance chain."
          exit 1
        fi
        
        # Check if required base files exist
        echo "Checking for required base configuration files..."
        
        if [ -f "packages/tsconfig.base.json" ]; then
          if grep -q '"extends".*"\.\./tsconfig\.json"' packages/tsconfig.base.json; then
            echo "âŒ packages/tsconfig.base.json extends '../tsconfig.json' which may cause build issues"
            echo "Content of packages/tsconfig.base.json:"
            cat packages/tsconfig.base.json
            exit 1
          fi
        fi
        
        echo "âœ… TypeScript configuration validation passed"
    
    - name: Validate package dependencies
      run: |
        echo "Validating package dependencies..."
        
        # Check if all required packages have build scripts
        echo "Checking build scripts in packages..."
        
        for pkg in packages/*/package.json; do
          pkg_name=$(dirname "$pkg")
          if [ -f "$pkg" ]; then
            echo "Checking $pkg_name..."
            if ! grep -q '"build"' "$pkg"; then
              echo "âš ï¸  Warning: $pkg_name does not have a build script"
            else
              echo "âœ… $pkg_name has build script"
            fi
          fi
        done
        
        echo "âœ… Package dependency validation completed"

  # Step 3: Build Dependencies
  build-dependencies:
    needs: [validate-ssh, validate-build-config]
    if: always() && github.event.inputs.deploy_only != 'true'
    uses: ./.github/workflows/build-dependencies.yml

  # Step 4: Code Quality Check
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    needs: [validate-ssh, validate-build-config, build-dependencies]
    if: always() && github.event.inputs.deploy_only != 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
    
    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Restore built packages cache
      uses: actions/cache@v3
      with:
        path: |
          packages/*/dist
          packages/*/build
        key: packages-build-${{ github.sha }}
        restore-keys: |
          packages-build-

    - name: Install dependencies (skip if cached)
      run: |
        if [ ! -d "${{ env.STORE_PATH }}" ] || [ -z "$(ls -A ${{ env.STORE_PATH }} 2>/dev/null)" ]; then
          echo "Installing dependencies..."
          pnpm install --frozen-lockfile
        else
          echo "Using cached pnpm store, installing missing dependencies..."
          pnpm install --frozen-lockfile --prefer-offline
        fi

    - name: Build packages if cache miss
      run: |
        if [ ! -d "packages/shared-core/dist" ] || [ ! -f "packages/shared-core/dist/index.js" ]; then
          echo "Cache miss, building packages..."
          pnpm --filter @btc/vite-plugin run build
          pnpm --filter @btc/shared-utils run build
          pnpm --filter @btc/shared-core run build
          pnpm --filter @btc/shared-components run build
          pnpm --filter @btc/subapp-manifests run build
        else
          echo "Using cached packages"
        fi

    - name: Type check and Lint (parallel)
      run: |
        echo "Running type-check and lint in parallel..."
        pnpm run type-check &
        pnpm run lint &
        wait

  # Step 5: Environment Validation
  validate-environment:
    needs: [validate-ssh, validate-build-config, build-dependencies, quality-check]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/validate-environment.yml
    secrets:
      SERVER_KEY: ${{ secrets.SERVER_KEY }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}

  # Step 6: Build all application Docker images (8 parallel tasks)
  build-system-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-system-app-reusable.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GH_TOKEN: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-admin-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: admin-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-logistics-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: logistics-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-quality-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: quality-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-production-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: production-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-engineering-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: engineering-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-finance-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: finance-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-mobile-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: mobile-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  # Step 7: Deploy to Server
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [validate-ssh, validate-environment, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app]
    if: always() && needs.validate-ssh.result == 'success' && needs.validate-environment.result == 'success' && github.ref == 'refs/heads/master'
    
    steps:
    - name: Deploy applications
      uses: appleboy/ssh-action@v1.0.3
      if: always() && needs.validate-ssh.result == 'success'
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER || 'root' }}
        key: ${{ secrets.SERVER_KEY }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        timeout: 1800s
        command_timeout: 25m
        script: |
          set -e
          
          echo "Starting BTC ShopFlow deployment..."
          
          # Check project directory
          if [ ! -d "/www/wwwroot/btc-shopflow-monorepo" ]; then
            echo "Creating project directory..."
            mkdir -p /www/wwwroot
            cd /www/wwwroot
            git clone https://github.com/BellisGit/btc-shopflow-monorepo.git
          fi
          
          echo "Navigating to project directory..."
          cd /www/wwwroot/btc-shopflow-monorepo
          
          echo "âœ… æœåŠ¡å™¨èµ„æºå·²åœ¨åˆå§‹åŒ–é˜¶æ®µéªŒè¯é€šè¿‡"
          echo "ðŸ“Š å½“å‰ç£ç›˜ç©ºé—´çŠ¶æ€:"
          df -h
          
          echo "ðŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„Dockerèµ„æºï¼ˆè½»é‡çº§æ¸…ç†ï¼‰..."
          # è½»é‡çº§æ¸…ç†ï¼šåªæ¸…ç†æœªä½¿ç”¨çš„èµ„æºï¼Œä¸å½±å“æ­£åœ¨è¿è¡Œçš„å®¹å™¨
          docker image prune -f || true
          docker builder prune -af || true
          
          echo "ðŸ” Logging into container registry..."
          # ä½¿ç”¨ä¸´æ—¶å‡­è¯å­˜å‚¨ä½ç½®ï¼Œé¿å…ç£ç›˜ç©ºé—´é—®é¢˜
          mkdir -p /tmp/.docker
          export DOCKER_CONFIG=/tmp/.docker
          echo "${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          echo "ðŸ“¥ Pulling Docker images from container registry (parallel)..."
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # å¹¶è¡Œæ‹‰å–æ‰€æœ‰åº”ç”¨é•œåƒçš„å‡½æ•°
          pull_image_async() {
            local app=$1
            local tag=$2
            local timeout_duration=${3:-300}
            local max_retries=${4:-2}
            
            echo "[$app] Starting pull for $tag..."
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $max_retries ]; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if timeout $timeout_duration docker pull ghcr.io/$REPO_LOWER/$app:$tag 2>&1; then
                docker tag ghcr.io/$REPO_LOWER/$app:$tag btc-shopflow/$app:latest 2>/dev/null || true
                echo "[$app] âœ… Successfully pulled $tag"
                return 0
              else
                echo "[$app] âš ï¸  Failed to pull $tag (attempt $RETRY_COUNT/$max_retries)"
                if [ $RETRY_COUNT -lt $max_retries ]; then
                  sleep $((RETRY_COUNT * 5))
                fi
              fi
            done
            return 1
          }
          
          # å¹¶è¡Œæ‹‰å–æ‰€æœ‰é•œåƒï¼ˆåŽå°æ‰§è¡Œï¼‰
          PIDS=()
          for app in system-app admin-app finance-app logistics-app quality-app production-app engineering-app mobile-app; do
            # å…ˆå°è¯• latestï¼Œå¤±è´¥åˆ™å°è¯• SHA
            (
              if ! pull_image_async "$app" "latest" 300 2; then
                pull_image_async "$app" "${{ github.sha }}" 300 2 || true
              fi
              
              # å¦‚æžœéƒ½å¤±è´¥ï¼Œæ£€æŸ¥æ˜¯å¦å·²æœ‰é•œåƒ
              if ! docker images btc-shopflow/$app --format "{{.Repository}}:{{.Tag}}" 2>/dev/null | grep -q "$app"; then
                echo "[$app] âš ï¸  No image available"
              fi
            ) &
            PIDS+=($!)
          done
          
          # ç­‰å¾…æ‰€æœ‰åŽå°ä»»åŠ¡å®Œæˆ
          echo "â³ Waiting for all images to be pulled..."
          FAILED=0
          for pid in "${PIDS[@]}"; do
            if ! wait "$pid"; then
              FAILED=$((FAILED + 1))
            fi
          done
          
          if [ $FAILED -gt 0 ]; then
            echo "âš ï¸  $FAILED images failed to pull, checking existing images..."
          fi
          
          echo ""
          echo "ðŸ“Š Final image status:"
          
          echo "ðŸ“Š Final image status:"
          docker images btc-shopflow/ --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" || true
          
          echo "Creating Docker Compose configuration..."
          printf '%s\n' \
            "version: '3.8'" \
            "" \
            "services:" \
            "  system-app:" \
            "    image: btc-shopflow/system-app:latest" \
            "    container_name: btc-system-app" \
            "    ports:" \
            "      - \"30080:80\"" \
            "    restart: unless-stopped" \
            "    networks:" \
            "      - btc-network" \
            "" \
            "  admin-app:" \
            "    image: btc-shopflow/admin-app:latest" \
            "    container_name: btc-admin-app" \
            "    ports:" \
            "      - \"30081:80\"" \
            "    restart: unless-stopped" \
            "    networks:" \
            "      - btc-network" \
            "" \
            "  finance-app:" \
            "    image: btc-shopflow/finance-app:latest" \
            "    container_name: btc-finance-app" \
            "    ports:" \
            "      - \"30086:80\"" \
            "    restart: unless-stopped" \
            "    networks:" \
            "      - btc-network" \
            "" \
            "  logistics-app:" \
            "    image: btc-shopflow/logistics-app:latest" \
            "    container_name: btc-logistics-app" \
            "    ports:" \
            "      - \"30082:80\"" \
            "    restart: unless-stopped" \
            "    networks:" \
            "      - btc-network" \
            "" \
            "  quality-app:" \
            "    image: btc-shopflow/quality-app:latest" \
            "    container_name: btc-quality-app" \
            "    ports:" \
            "      - \"30083:80\"" \
            "    restart: unless-stopped" \
            "    networks:" \
            "      - btc-network" \
            "" \
            "  production-app:" \
            "    image: btc-shopflow/production-app:latest" \
            "    container_name: btc-production-app" \
            "    ports:" \
            "      - \"30084:80\"" \
            "    restart: unless-stopped" \
            "    networks:" \
            "      - btc-network" \
            "" \
            "  engineering-app:" \
            "    image: btc-shopflow/engineering-app:latest" \
            "    container_name: btc-engineering-app" \
            "    ports:" \
            "      - \"30085:80\"" \
            "    restart: unless-stopped" \
            "    networks:" \
            "      - btc-network" \
            "" \
            "  mobile-app:" \
            "    image: btc-shopflow/mobile-app:latest" \
            "    container_name: btc-mobile-app" \
            "    ports:" \
            "      - \"30091:80\"" \
            "    restart: unless-stopped" \
            "    networks:" \
            "      - btc-network" \
            "" \
            "networks:" \
            "  btc-network:" \
            "    driver: bridge" > docker-compose.prod.yml
          
          echo "Starting services..."
          # åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰ btc-shopflow ç›¸å…³çš„æ—§å®¹å™¨ï¼ˆåŒ…æ‹¬ä½¿ç”¨æ—§é•œåƒçš„ï¼‰
          echo "ðŸ§¹ æ¸…ç†æ‰€æœ‰ btc-shopflow ç›¸å…³å®¹å™¨..."
          docker ps -a --filter "name=btc-" --format "{{.ID}} {{.Names}}" | while read -r container_id container_name; do
            if [ -n "$container_id" ]; then
              echo "åœæ­¢å¹¶åˆ é™¤å®¹å™¨: $container_name ($container_id)"
              docker stop "$container_id" 2>/dev/null || true
              docker rm -f "$container_id" 2>/dev/null || true
            fi
          done
          
          # ä½¿ç”¨ docker-compose åœæ­¢ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
          
          # å¯åŠ¨æ–°æœåŠ¡
          docker-compose -f docker-compose.prod.yml up -d
          
          echo "Cleaning up unused images after deployment..."
          # åªæ¸…ç†æœªä½¿ç”¨çš„é•œåƒï¼Œä¿ç•™æ­£åœ¨ä½¿ç”¨çš„
          docker image prune -f || true
          
          # åˆ é™¤æ—§ç‰ˆæœ¬çš„é•œåƒï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          if [ -n "$REPO_LOWER" ]; then
            # åˆ é™¤é™¤äº†æœ€æ–°æ ‡ç­¾ä¹‹å¤–çš„å…¶ä»–æ ‡ç­¾
            for app in system-app admin-app finance-app logistics-app quality-app production-app engineering-app mobile-app; do
              docker images ghcr.io/$REPO_LOWER/$app --format "{{.ID}} {{.Tag}}" | grep -v "latest" | grep -v "${{ github.sha }}" | awk '{print $1}' | xargs -r docker rmi -f || true
            done
          fi
          
          echo "Final disk space:"
          df -h
          
          echo "Deployment completed successfully"

    - name: Health checks
      run: |
        echo "Performing health checks..."
        
        # Wait for services to start
        sleep 30
        
        echo "Checking application health on IP: ${{ secrets.SERVER_HOST }}"
        
        # Check main applications
        for port in 30080 30081 30086; do
          if curl -f -s --max-time 10 http://${{ secrets.SERVER_HOST }}:$port > /dev/null; then
            echo "Port $port is healthy"
          else
            echo "Port $port health check failed (this may be normal if the service is still starting)"
          fi
        done

    - name: Deployment summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Built Images:" >> $GITHUB_STEP_SUMMARY
        echo "- System App: ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Admin App: ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Logistics App: ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality App: ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Production App: ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Engineering App: ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Finance App: ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mobile App: ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Application URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- Main App: http://${{ secrets.SERVER_HOST }}:30080" >> $GITHUB_STEP_SUMMARY
        echo "- Admin Panel: http://${{ secrets.SERVER_HOST }}:30081" >> $GITHUB_STEP_SUMMARY
        echo "- Finance System: http://${{ secrets.SERVER_HOST }}:30086" >> $GITHUB_STEP_SUMMARY

  # Step 8: Notification
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [validate-ssh, quality-check, validate-environment, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app, deploy]
    if: always()
    
    steps:
    - name: Success notification
      if: needs.deploy.result == 'success'
      run: |
        echo "**Deployment Successful!**" >> $GITHUB_STEP_SUMMARY
        echo "All steps completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "URL: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}" >> $GITHUB_STEP_SUMMARY
        
    - name: Failure notification
      if: needs.deploy.result == 'failure' || needs.build-system-app.result == 'failure' || needs.build-admin-app.result == 'failure' || needs.build-logistics-app.result == 'failure' || needs.build-quality-app.result == 'failure' || needs.build-production-app.result == 'failure' || needs.build-engineering-app.result == 'failure' || needs.build-finance-app.result == 'failure' || needs.build-mobile-app.result == 'failure' || needs.quality-check.result == 'failure' || needs.validate-environment.result == 'failure'
      run: |
        echo "**Deployment Failed!**" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs for details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Results:" >> $GITHUB_STEP_SUMMARY
        echo "- Quality Check: ${{ needs.quality-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Environment Validation: ${{ needs.validate-environment.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- System App: ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Admin App: ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Logistics App: ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality App: ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Production App: ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Engineering App: ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Finance App: ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mobile App: ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
        exit 1





