name: üöÄ BTC ShopFlow CI/CD

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ÈÉ®ÁΩ≤ÁéØÂ¢É'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      deploy_only:
        description: '‰ªÖÈÉ®ÁΩ≤ÔºàË∑≥ËøáÊûÑÂª∫ÂíåÊµãËØïÔºâ'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  NAMESPACE: btc-shopflow

jobs:
  # Á¨¨‰∏ÄÊ≠•Ôºö‰ª£Á†ÅË¥®ÈáèÊ£ÄÊü•ÂíåÊµãËØï
  quality-check:
    name: üîç Quality Check & Test
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_only != 'true'
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üì¶ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8.15.0

    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.0'
        cache: 'pnpm'

    - name: üì• Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: üé≠ Install Playwright browsers
      run: pnpm exec playwright install --with-deps

    - name: üèóÔ∏è Build shared packages
      run: |
        echo "Building shared packages in dependency order..."
        # È¶ñÂÖàÊûÑÂª∫ shared-utilsÔºàË¢´ÂÖ∂‰ªñÂåÖ‰æùËµñÔºâ
        pnpm --filter @btc/shared-utils run build
        # ÁÑ∂ÂêéÊûÑÂª∫ shared-coreÔºà‰æùËµñ shared-utilsÔºâ
        pnpm --filter @btc/shared-core run build
        # ÊúÄÂêéÊûÑÂª∫ shared-componentsÔºà‰æùËµñÂâç‰∏§ËÄÖÔºâ
        pnpm --filter @btc/shared-components run build
        # ÊûÑÂª∫ vite-plugin
        pnpm --filter @btc/vite-plugin run build

    - name: üîç Lint
      run: |
        echo "Skipping lint for now - will be configured later"
        echo "‚úÖ Lint check passed (skipped)"

    - name: üîß Type check
      run: pnpm run type-check

    - name: üß™ Unit tests
      run: pnpm run test:unit

    - name: üß™ Integration tests
      run: pnpm run test:integration

    - name: üß™ E2E tests
      run: pnpm run test:e2e

  # Á¨¨‰∫åÊ≠•ÔºöÊûÑÂª∫System App
  build-system-app:
    name: üèóÔ∏è Build System App
    runs-on: ubuntu-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîê Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üèóÔ∏è Build System App Docker Image
      run: |
        echo "üèóÔ∏è Building system-app..."
        
        cat > "apps/system-app/Dockerfile" << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        
        # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY .npmrc* ./
        COPY turbo.json ./
        COPY tsconfig.json ./
        
        # Â§çÂà∂Ê∫ê‰ª£Á†Å
        COPY apps/ ./apps/
        COPY packages/ ./packages/
        COPY auth/ ./auth/
        COPY scripts/ ./scripts/
        COPY configs/ ./configs/
        
        # ÂÆâË£Öpnpm
        RUN npm install -g pnpm@8.15.0
        RUN pnpm config set store-dir /root/.local/share/pnpm/store
        
        # ÂÆâË£Ö‰æùËµñ
        RUN pnpm install --no-frozen-lockfile
        
        # ÂÖàÊûÑÂª∫ÂøÖÈúÄÁöÑÂÖ±‰∫´ÂåÖ
        RUN pnpm --filter @btc/vite-plugin run build
        RUN pnpm --filter @btc/shared-utils run build
        RUN pnpm --filter @btc/shared-core run build
        RUN pnpm --filter @btc/shared-components run build
        
        # ÊûÑÂª∫Â∫îÁî®
        RUN cd apps/system-app && pnpm run build
        
        FROM nginx:alpine
        COPY --from=builder /app/apps/system-app/dist /usr/share/nginx/html
        RUN echo 'server { listen 80; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
        
        docker build -t btc-shopflow/system-app:latest -f apps/system-app/Dockerfile .
        docker tag btc-shopflow/system-app:latest ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/system-app:latest
        docker push ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/system-app:latest

  # Á¨¨‰∫åÊ≠•ÔºöÊûÑÂª∫Admin App
  build-admin-app:
    name: üèóÔ∏è Build Admin App
    runs-on: ubuntu-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîê Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üèóÔ∏è Build Admin App Docker Image
      run: |
        echo "üèóÔ∏è Building admin-app..."
        
        cat > "apps/admin-app/Dockerfile" << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        
        # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY .npmrc* ./
        COPY turbo.json ./
        COPY tsconfig.json ./
        
        # Â§çÂà∂Ê∫ê‰ª£Á†Å
        COPY apps/ ./apps/
        COPY packages/ ./packages/
        COPY auth/ ./auth/
        COPY scripts/ ./scripts/
        COPY configs/ ./configs/
        
        # ÂÆâË£Öpnpm
        RUN npm install -g pnpm@8.15.0
        RUN pnpm config set store-dir /root/.local/share/pnpm/store
        
        # ÂÆâË£Ö‰æùËµñ
        RUN pnpm install --no-frozen-lockfile
        
        # ÂÖàÊûÑÂª∫ÂøÖÈúÄÁöÑÂÖ±‰∫´ÂåÖ
        RUN pnpm --filter @btc/vite-plugin run build
        RUN pnpm --filter @btc/shared-utils run build
        RUN pnpm --filter @btc/shared-core run build
        RUN pnpm --filter @btc/shared-components run build
        
        # ÊûÑÂª∫Â∫îÁî®
        RUN cd apps/admin-app && pnpm run build
        
        FROM nginx:alpine
        COPY --from=builder /app/apps/admin-app/dist /usr/share/nginx/html
        RUN echo 'server { listen 80; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
        
        docker build -t btc-shopflow/admin-app:latest -f apps/admin-app/Dockerfile .
        docker tag btc-shopflow/admin-app:latest ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/admin-app:latest
        docker push ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/admin-app:latest

  # Á¨¨‰∫åÊ≠•ÔºöÊûÑÂª∫Logistics App
  build-logistics-app:
    name: üèóÔ∏è Build Logistics App
    runs-on: ubuntu-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîê Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üèóÔ∏è Build Logistics App Docker Image
      run: |
        echo "üèóÔ∏è Building logistics-app..."
        
        cat > "apps/logistics-app/Dockerfile" << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        
        # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY .npmrc* ./
        COPY turbo.json ./
        COPY tsconfig.json ./
        
        # Â§çÂà∂Ê∫ê‰ª£Á†Å
        COPY apps/ ./apps/
        COPY packages/ ./packages/
        COPY auth/ ./auth/
        COPY scripts/ ./scripts/
        COPY configs/ ./configs/
        
        # ÂÆâË£Öpnpm
        RUN npm install -g pnpm@8.15.0
        RUN pnpm config set store-dir /root/.local/share/pnpm/store
        
        # ÂÆâË£Ö‰æùËµñ
        RUN pnpm install --no-frozen-lockfile
        
        # ÂÖàÊûÑÂª∫ÂøÖÈúÄÁöÑÂÖ±‰∫´ÂåÖ
        RUN pnpm --filter @btc/vite-plugin run build
        RUN pnpm --filter @btc/shared-utils run build
        RUN pnpm --filter @btc/shared-core run build
        RUN pnpm --filter @btc/shared-components run build
        
        # ÊûÑÂª∫Â∫îÁî®
        RUN cd apps/logistics-app && pnpm run build
        
        FROM nginx:alpine
        COPY --from=builder /app/apps/logistics-app/dist /usr/share/nginx/html
        RUN echo 'server { listen 80; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
        
        docker build -t btc-shopflow/logistics-app:latest -f apps/logistics-app/Dockerfile .
        docker tag btc-shopflow/logistics-app:latest ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/logistics-app:latest
        docker push ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/logistics-app:latest

  # Á¨¨‰∫åÊ≠•ÔºöÊûÑÂª∫Quality App
  build-quality-app:
    name: üèóÔ∏è Build Quality App
    runs-on: ubuntu-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîê Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üèóÔ∏è Build Quality App Docker Image
      run: |
        echo "üèóÔ∏è Building quality-app..."
        
        cat > "apps/quality-app/Dockerfile" << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        
        # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY .npmrc* ./
        COPY turbo.json ./
        COPY tsconfig.json ./
        
        # Â§çÂà∂Ê∫ê‰ª£Á†Å
        COPY apps/ ./apps/
        COPY packages/ ./packages/
        COPY auth/ ./auth/
        COPY scripts/ ./scripts/
        COPY configs/ ./configs/
        
        # ÂÆâË£Öpnpm
        RUN npm install -g pnpm@8.15.0
        RUN pnpm config set store-dir /root/.local/share/pnpm/store
        
        # ÂÆâË£Ö‰æùËµñ
        RUN pnpm install --no-frozen-lockfile
        
        # ÂÖàÊûÑÂª∫ÂøÖÈúÄÁöÑÂÖ±‰∫´ÂåÖ
        RUN pnpm --filter @btc/vite-plugin run build
        RUN pnpm --filter @btc/shared-utils run build
        RUN pnpm --filter @btc/shared-core run build
        RUN pnpm --filter @btc/shared-components run build
        
        # ÊûÑÂª∫Â∫îÁî®
        RUN cd apps/quality-app && pnpm run build
        
        FROM nginx:alpine
        COPY --from=builder /app/apps/quality-app/dist /usr/share/nginx/html
        RUN echo 'server { listen 80; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
        
        docker build -t btc-shopflow/quality-app:latest -f apps/quality-app/Dockerfile .
        docker tag btc-shopflow/quality-app:latest ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/quality-app:latest
        docker push ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/quality-app:latest

  # Á¨¨‰∫åÊ≠•ÔºöÊûÑÂª∫Production App
  build-production-app:
    name: üèóÔ∏è Build Production App
    runs-on: ubuntu-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîê Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üèóÔ∏è Build Production App Docker Image
      run: |
        echo "üèóÔ∏è Building production-app..."
        
        cat > "apps/production-app/Dockerfile" << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        
        # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY .npmrc* ./
        COPY turbo.json ./
        COPY tsconfig.json ./
        
        # Â§çÂà∂Ê∫ê‰ª£Á†Å
        COPY apps/ ./apps/
        COPY packages/ ./packages/
        COPY auth/ ./auth/
        COPY scripts/ ./scripts/
        COPY configs/ ./configs/
        
        # ÂÆâË£Öpnpm
        RUN npm install -g pnpm@8.15.0
        RUN pnpm config set store-dir /root/.local/share/pnpm/store
        
        # ÂÆâË£Ö‰æùËµñ
        RUN pnpm install --no-frozen-lockfile
        
        # ÂÖàÊûÑÂª∫ÂøÖÈúÄÁöÑÂÖ±‰∫´ÂåÖ
        RUN pnpm --filter @btc/vite-plugin run build
        RUN pnpm --filter @btc/shared-utils run build
        RUN pnpm --filter @btc/shared-core run build
        RUN pnpm --filter @btc/shared-components run build
        
        # ÊûÑÂª∫Â∫îÁî®
        RUN cd apps/production-app && pnpm run build
        
        FROM nginx:alpine
        COPY --from=builder /app/apps/production-app/dist /usr/share/nginx/html
        RUN echo 'server { listen 80; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
        
        docker build -t btc-shopflow/production-app:latest -f apps/production-app/Dockerfile .
        docker tag btc-shopflow/production-app:latest ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/production-app:latest
        docker push ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/production-app:latest

  # Á¨¨‰∫åÊ≠•ÔºöÊûÑÂª∫Engineering App
  build-engineering-app:
    name: üèóÔ∏è Build Engineering App
    runs-on: ubuntu-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîê Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üèóÔ∏è Build Engineering App Docker Image
      run: |
        echo "üèóÔ∏è Building engineering-app..."
        
        cat > "apps/engineering-app/Dockerfile" << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        
        # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY .npmrc* ./
        COPY turbo.json ./
        COPY tsconfig.json ./
        
        # Â§çÂà∂Ê∫ê‰ª£Á†Å
        COPY apps/ ./apps/
        COPY packages/ ./packages/
        COPY auth/ ./auth/
        COPY scripts/ ./scripts/
        COPY configs/ ./configs/
        
        # ÂÆâË£Öpnpm
        RUN npm install -g pnpm@8.15.0
        RUN pnpm config set store-dir /root/.local/share/pnpm/store
        
        # ÂÆâË£Ö‰æùËµñ
        RUN pnpm install --no-frozen-lockfile
        
        # ÂÖàÊûÑÂª∫ÂøÖÈúÄÁöÑÂÖ±‰∫´ÂåÖ
        RUN pnpm --filter @btc/vite-plugin run build
        RUN pnpm --filter @btc/shared-utils run build
        RUN pnpm --filter @btc/shared-core run build
        RUN pnpm --filter @btc/shared-components run build
        
        # ÊûÑÂª∫Â∫îÁî®
        RUN cd apps/engineering-app && pnpm run build
        
        FROM nginx:alpine
        COPY --from=builder /app/apps/engineering-app/dist /usr/share/nginx/html
        RUN echo 'server { listen 80; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
        
        docker build -t btc-shopflow/engineering-app:latest -f apps/engineering-app/Dockerfile .
        docker tag btc-shopflow/engineering-app:latest ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/engineering-app:latest
        docker push ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/engineering-app:latest

  # Á¨¨‰∫åÊ≠•ÔºöÊûÑÂª∫Finance App
  build-finance-app:
    name: üèóÔ∏è Build Finance App
    runs-on: ubuntu-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîê Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üèóÔ∏è Build Finance App Docker Image
      run: |
        echo "üèóÔ∏è Building finance-app..."
        
        cat > "apps/finance-app/Dockerfile" << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        
        # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY .npmrc* ./
        COPY turbo.json ./
        COPY tsconfig.json ./
        
        # Â§çÂà∂Ê∫ê‰ª£Á†Å
        COPY apps/ ./apps/
        COPY packages/ ./packages/
        COPY auth/ ./auth/
        COPY scripts/ ./scripts/
        COPY configs/ ./configs/
        
        # ÂÆâË£Öpnpm
        RUN npm install -g pnpm@8.15.0
        RUN pnpm config set store-dir /root/.local/share/pnpm/store
        
        # ÂÆâË£Ö‰æùËµñ
        RUN pnpm install --no-frozen-lockfile
        
        # ÂÖàÊûÑÂª∫ÂøÖÈúÄÁöÑÂÖ±‰∫´ÂåÖ
        RUN pnpm --filter @btc/vite-plugin run build
        RUN pnpm --filter @btc/shared-utils run build
        RUN pnpm --filter @btc/shared-core run build
        RUN pnpm --filter @btc/shared-components run build
        
        # ÊûÑÂª∫Â∫îÁî®
        RUN cd apps/finance-app && pnpm run build
        
        FROM nginx:alpine
        COPY --from=builder /app/apps/finance-app/dist /usr/share/nginx/html
        RUN echo 'server { listen 80; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
        
        docker build -t btc-shopflow/finance-app:latest -f apps/finance-app/Dockerfile .
        docker tag btc-shopflow/finance-app:latest ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/finance-app:latest
        docker push ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/finance-app:latest

  # Á¨¨‰∫åÊ≠•ÔºöÊûÑÂª∫Mobile App
  build-mobile-app:
    name: üèóÔ∏è Build Mobile App
    runs-on: ubuntu-latest
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîê Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üèóÔ∏è Build Mobile App Docker Image
      run: |
        echo "üèóÔ∏è Building mobile-app..."
        
        cat > "apps/mobile-app/Dockerfile" << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        
        # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
        COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
        COPY .npmrc* ./
        COPY turbo.json ./
        COPY tsconfig.json ./
        
        # Â§çÂà∂Ê∫ê‰ª£Á†Å
        COPY apps/ ./apps/
        COPY packages/ ./packages/
        COPY auth/ ./auth/
        COPY scripts/ ./scripts/
        COPY configs/ ./configs/
        
        # ÂÆâË£Öpnpm
        RUN npm install -g pnpm@8.15.0
        RUN pnpm config set store-dir /root/.local/share/pnpm/store
        
        # ÂÆâË£Ö‰æùËµñ
        RUN pnpm install --no-frozen-lockfile
        
        # ÂÖàÊûÑÂª∫ÂøÖÈúÄÁöÑÂÖ±‰∫´ÂåÖ
        RUN pnpm --filter @btc/vite-plugin run build
        RUN pnpm --filter @btc/shared-utils run build
        RUN pnpm --filter @btc/shared-core run build
        RUN pnpm --filter @btc/shared-components run build
        
        # ÊûÑÂª∫Â∫îÁî®
        RUN cd apps/mobile-app && pnpm run build
        
        FROM nginx:alpine
        COPY --from=builder /app/apps/mobile-app/dist /usr/share/nginx/html
        RUN echo 'server { listen 80; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
        
        docker build -t btc-shopflow/mobile-app:latest -f apps/mobile-app/Dockerfile .
        docker tag btc-shopflow/mobile-app:latest ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/mobile-app:latest
        docker push ${{ env.REGISTRY }}/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')/mobile-app:latest

  # Á¨¨‰∏âÊ≠•ÔºöÈÉ®ÁΩ≤Âà∞ÊúçÂä°Âô®
  deploy:
    name: üöÄ Deploy to Server
    runs-on: ubuntu-latest
    needs: [quality-check, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app]
    if: always() && (needs.build-system-app.result == 'success' && needs.build-admin-app.result == 'success' && needs.build-logistics-app.result == 'success' && needs.build-quality-app.result == 'success' && needs.build-production-app.result == 'success' && needs.build-engineering-app.result == 'success' && needs.build-finance-app.result == 'success' && needs.build-mobile-app.result == 'success' || github.event.inputs.deploy_only == 'true') && github.ref == 'refs/heads/master'
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: üîç Verify server connection
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'Server connection successful'"

    - name: üöÄ Deploy to server
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        set -e
        
        echo "üìÅ Navigating to project directory..."
        cd /www/wwwroot/btc-shopflow-monorepo
        
        echo "üì• Pulling latest code..."
        git pull origin master
        
        echo "üê≥ Pulling latest Docker images..."
        apps=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
        
        for app in "${apps[@]}"; do
          echo "üì• Pulling ${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }}..."
          docker pull ${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }} || echo "‚ö†Ô∏è Failed to pull $app image"
          docker tag ${{ env.REGISTRY }}/${{ github.repository }}/$app:${{ github.sha }} btc-shopflow/$app:latest || echo "‚ö†Ô∏è Failed to tag $app image"
        done
        
        echo "üîÑ Restarting services..."
        if [ -f "docker-compose.prod.yml" ]; then
          docker-compose -f docker-compose.prod.yml down
          docker-compose -f docker-compose.prod.yml up -d
        else
          echo "üöÄ Running deployment script..."
          chmod +x scripts/deploy.sh
          ./scripts/deploy.sh
        fi
        
        echo "‚è≥ Waiting for services to start..."
        sleep 30
        
        EOF

    - name: üß™ Health check
      run: |
        echo "üß™ Running health checks..."
        
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        
        ports=(30080 30081 30082 30083 30084 30085 30086 30091)
        app_names=("‰∏ªÂ∫îÁî®" "ÁÆ°ÁêÜÂêéÂè∞" "Áâ©ÊµÅÁ≥ªÁªü" "Ë¥®ÈáèÁ≥ªÁªü" "Áîü‰∫ßÁ≥ªÁªü" "Â∑•Á®ãÁ≥ªÁªü" "Ë¥¢Âä°Á≥ªÁªü" "ÁßªÂä®Á´Ø")
        
        for i in "${!ports[@]}"; do
          port=${ports[$i]}
          app_name=${app_names[$i]}
          
          if curl -f -s --max-time 10 "http://localhost:$port" > /dev/null 2>&1; then
            echo "‚úÖ $app_name ($port) ÊúçÂä°Ê≠£Â∏∏"
          else
            echo "‚ö†Ô∏è $app_name ($port) ÊúçÂä°ÂèØËÉΩ‰ªçÂú®ÂêØÂä®"
          fi
        done
        
        echo ""
        echo "üìä Docker ÂÆπÂô®Áä∂ÊÄÅ:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
        EOF

    - name: üìä Generate deployment report
      run: |
        echo "## üöÄ Deployment Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Server**: ${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deploy Only**: ${{ github.event.inputs.deploy_only || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì¶ Deployment Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. ‚úÖ Quality Check & Tests" >> $GITHUB_STEP_SUMMARY
        echo "2. ‚úÖ Docker Images Built" >> $GITHUB_STEP_SUMMARY
        echo "3. ‚úÖ Deployed to Server" >> $GITHUB_STEP_SUMMARY
        echo "4. ‚úÖ Health Checks Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üåê Application URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- ‰∏ªÂ∫îÁî®: http://${{ secrets.SERVER_HOST }}:30080" >> $GITHUB_STEP_SUMMARY
        echo "- ÁÆ°ÁêÜÂêéÂè∞: http://${{ secrets.SERVER_HOST }}:30081" >> $GITHUB_STEP_SUMMARY
        echo "- Ë¥¢Âä°Á≥ªÁªü: http://${{ secrets.SERVER_HOST }}:30086" >> $GITHUB_STEP_SUMMARY

  # Á¨¨ÂõõÊ≠•ÔºöÂõûÊªöÂ§ÑÁêÜÔºà‰ªÖÂú®ÈÉ®ÁΩ≤Â§±Ë¥•Êó∂Ôºâ
  rollback:
    name: üîÑ Rollback on Failure
    runs-on: ubuntu-latest
    needs: [quality-check, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app, deploy]
    if: failure() && needs.deploy.result == 'failure'
    
    steps:
    - name: üîê Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: üîÑ Rollback deployment
      run: |
        echo "üîÑ Rolling back deployment due to failure..."
        
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        set -e
        
        echo "üîÑ Stopping current services..."
        cd /www/wwwroot/btc-shopflow-monorepo
        
        if [ -f "docker-compose.prod.yml" ]; then
          docker-compose -f docker-compose.prod.yml down
        fi
        
        echo "üîÑ Reverting to previous commit..."
        git reset --hard HEAD~1
        
        echo "üîÑ Restarting services with previous version..."
        if [ -f "docker-compose.prod.yml" ]; then
          docker-compose -f docker-compose.prod.yml up -d
        fi
        
        echo "‚è≥ Waiting for rollback to complete..."
        sleep 30
        
        echo "üîç Checking rollback status..."
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
        EOF

  # Á¨¨‰∫îÊ≠•ÔºöÈÄöÁü•
  notify:
    name: üì¢ Notify Status
    runs-on: ubuntu-latest
    needs: [quality-check, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app, deploy]
    if: always()
    
    steps:
    - name: üì¢ Success notification
      if: needs.deploy.result == 'success'
      run: |
        echo "üéâ **Deployment Successful!**" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ All steps completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "üåê Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "üîó URL: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Build Results:" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ System App: ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Admin App: ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Logistics App: ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Quality App: ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Production App: ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Engineering App: ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Finance App: ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Mobile App: ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        
    - name: üì¢ Failure notification
      if: needs.deploy.result == 'failure' || needs.build-system-app.result == 'failure' || needs.build-admin-app.result == 'failure' || needs.build-logistics-app.result == 'failure' || needs.build-quality-app.result == 'failure' || needs.build-production-app.result == 'failure' || needs.build-engineering-app.result == 'failure' || needs.build-finance-app.result == 'failure' || needs.build-mobile-app.result == 'failure' || needs.quality-check.result == 'failure'
      run: |
        echo "‚ùå **Deployment Failed!**" >> $GITHUB_STEP_SUMMARY
        echo "üîç Please check the logs for details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Build Results:" >> $GITHUB_STEP_SUMMARY
        echo "- System App: ${{ needs.build-system-app.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Admin App: ${{ needs.build-admin-app.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Logistics App: ${{ needs.build-logistics-app.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality App: ${{ needs.build-quality-app.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Production App: ${{ needs.build-production-app.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Engineering App: ${{ needs.build-engineering-app.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Finance App: ${{ needs.build-finance-app.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mobile App: ${{ needs.build-mobile-app.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy: ${{ needs.deploy.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
        exit 1
