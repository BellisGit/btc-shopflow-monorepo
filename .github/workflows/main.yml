name: BTC ShopFlow CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
      deploy_only:
        description: 'Skip quality checks and build, deploy only'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY: ghcr.io

jobs:
  # 第一步：代码质量检查
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_only != 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4

    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: Type check
      run: pnpm run type-check

    - name: Lint check
      run: pnpm run lint

  # 第二步：构建所有应用的Docker镜像（8个并行任务）
  build-system-app:
    name: Build System App
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
    
    - name: Build system-app
      run: cd apps/system-app && pnpm run build
    
    - name: Create Dockerfile
      run: |
        cat > apps/system-app/Dockerfile << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        COPY package*.json pnpm-*.yaml ./
        COPY packages ./packages
        COPY apps/system-app ./apps/system-app
        RUN npm install -g pnpm
        RUN pnpm install --frozen-lockfile
        RUN cd apps/system-app && pnpm run build

        FROM nginx:alpine
        COPY --from=builder /app/apps/system-app/dist /usr/share/nginx/html
        COPY apps/system-app/nginx.conf /etc/nginx/conf.d/default.conf 2>/dev/null || echo "server { listen 80; location / { try_files \$uri \$uri/ /index.html; } }" > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: apps/system-app/Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/system-app:latest
          ghcr.io/${{ github.repository }}/system-app:${{ github.sha }}

  build-admin-app:
    name: Build Admin App
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
    
    - name: Build admin-app
      run: cd apps/admin-app && pnpm run build
    
    - name: Create Dockerfile
      run: |
        cat > apps/admin-app/Dockerfile << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        COPY package*.json pnpm-*.yaml ./
        COPY packages ./packages
        COPY apps/admin-app ./apps/admin-app
        RUN npm install -g pnpm
        RUN pnpm install --frozen-lockfile
        RUN cd apps/admin-app && pnpm run build

        FROM nginx:alpine
        COPY --from=builder /app/apps/admin-app/dist /usr/share/nginx/html
        COPY apps/admin-app/nginx.conf /etc/nginx/conf.d/default.conf 2>/dev/null || echo "server { listen 80; location / { try_files \$uri \$uri/ /index.html; } }" > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: apps/admin-app/Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/admin-app:latest
          ghcr.io/${{ github.repository }}/admin-app:${{ github.sha }}

  build-logistics-app:
    name: Build Logistics App
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
    
    - name: Build logistics-app
      run: cd apps/logistics-app && pnpm run build
    
    - name: Create Dockerfile
      run: |
        cat > apps/logistics-app/Dockerfile << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        COPY package*.json pnpm-*.yaml ./
        COPY packages ./packages
        COPY apps/logistics-app ./apps/logistics-app
        RUN npm install -g pnpm
        RUN pnpm install --frozen-lockfile
        RUN cd apps/logistics-app && pnpm run build

        FROM nginx:alpine
        COPY --from=builder /app/apps/logistics-app/dist /usr/share/nginx/html
        COPY apps/logistics-app/nginx.conf /etc/nginx/conf.d/default.conf 2>/dev/null || echo "server { listen 80; location / { try_files \$uri \$uri/ /index.html; } }" > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: apps/logistics-app/Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/logistics-app:latest
          ghcr.io/${{ github.repository }}/logistics-app:${{ github.sha }}

  build-quality-app:
    name: Build Quality App
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
    
    - name: Build quality-app
      run: cd apps/quality-app && pnpm run build
    
    - name: Create Dockerfile
      run: |
        cat > apps/quality-app/Dockerfile << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        COPY package*.json pnpm-*.yaml ./
        COPY packages ./packages
        COPY apps/quality-app ./apps/quality-app
        RUN npm install -g pnpm
        RUN pnpm install --frozen-lockfile
        RUN cd apps/quality-app && pnpm run build

        FROM nginx:alpine
        COPY --from=builder /app/apps/quality-app/dist /usr/share/nginx/html
        COPY apps/quality-app/nginx.conf /etc/nginx/conf.d/default.conf 2>/dev/null || echo "server { listen 80; location / { try_files \$uri \$uri/ /index.html; } }" > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: apps/quality-app/Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/quality-app:latest
          ghcr.io/${{ github.repository }}/quality-app:${{ github.sha }}

  build-production-app:
    name: Build Production App
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
    
    - name: Build production-app
      run: cd apps/production-app && pnpm run build
    
    - name: Create Dockerfile
      run: |
        cat > apps/production-app/Dockerfile << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        COPY package*.json pnpm-*.yaml ./
        COPY packages ./packages
        COPY apps/production-app ./apps/production-app
        RUN npm install -g pnpm
        RUN pnpm install --frozen-lockfile
        RUN cd apps/production-app && pnpm run build

        FROM nginx:alpine
        COPY --from=builder /app/apps/production-app/dist /usr/share/nginx/html
        COPY apps/production-app/nginx.conf /etc/nginx/conf.d/default.conf 2>/dev/null || echo "server { listen 80; location / { try_files \$uri \$uri/ /index.html; } }" > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: apps/production-app/Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/production-app:latest
          ghcr.io/${{ github.repository }}/production-app:${{ github.sha }}

  build-engineering-app:
    name: Build Engineering App
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
    
    - name: Build engineering-app
      run: cd apps/engineering-app && pnpm run build
    
    - name: Create Dockerfile
      run: |
        cat > apps/engineering-app/Dockerfile << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        COPY package*.json pnpm-*.yaml ./
        COPY packages ./packages
        COPY apps/engineering-app ./apps/engineering-app
        RUN npm install -g pnpm
        RUN pnpm install --frozen-lockfile
        RUN cd apps/engineering-app && pnpm run build

        FROM nginx:alpine
        COPY --from=builder /app/apps/engineering-app/dist /usr/share/nginx/html
        COPY apps/engineering-app/nginx.conf /etc/nginx/conf.d/default.conf 2>/dev/null || echo "server { listen 80; location / { try_files \$uri \$uri/ /index.html; } }" > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: apps/engineering-app/Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/engineering-app:latest
          ghcr.io/${{ github.repository }}/engineering-app:${{ github.sha }}

  build-finance-app:
    name: Build Finance App
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
    
    - name: Build finance-app
      run: cd apps/finance-app && pnpm run build
    
    - name: Create Dockerfile
      run: |
        cat > apps/finance-app/Dockerfile << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        COPY package*.json pnpm-*.yaml ./
        COPY packages ./packages
        COPY apps/finance-app ./apps/finance-app
        RUN npm install -g pnpm
        RUN pnpm install --frozen-lockfile
        RUN cd apps/finance-app && pnpm run build

        FROM nginx:alpine
        COPY --from=builder /app/apps/finance-app/dist /usr/share/nginx/html
        COPY apps/finance-app/nginx.conf /etc/nginx/conf.d/default.conf 2>/dev/null || echo "server { listen 80; location / { try_files \$uri \$uri/ /index.html; } }" > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: apps/finance-app/Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/finance-app:latest
          ghcr.io/${{ github.repository }}/finance-app:${{ github.sha }}

  build-mobile-app:
    name: Build Mobile App
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
    
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
    
    - name: Build mobile-app
      run: cd apps/mobile-app && pnpm run build
    
    - name: Create Dockerfile
      run: |
        cat > apps/mobile-app/Dockerfile << 'EOF'
        FROM node:20-alpine AS builder
        WORKDIR /app
        COPY package*.json pnpm-*.yaml ./
        COPY packages ./packages
        COPY apps/mobile-app ./apps/mobile-app
        RUN npm install -g pnpm
        RUN pnpm install --frozen-lockfile
        RUN cd apps/mobile-app && pnpm run build

        FROM nginx:alpine
        COPY --from=builder /app/apps/mobile-app/dist /usr/share/nginx/html
        COPY apps/mobile-app/nginx.conf /etc/nginx/conf.d/default.conf 2>/dev/null || echo "server { listen 80; location / { try_files \$uri \$uri/ /index.html; } }" > /etc/nginx/conf.d/default.conf
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]
        EOF
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: apps/mobile-app/Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/mobile-app:latest
          ghcr.io/${{ github.repository }}/mobile-app:${{ github.sha }}

  # 第三步：部署到服务器
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [quality-check, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app]
    if: always() && (needs.build-system-app.result == 'success' && needs.build-admin-app.result == 'success' && needs.build-logistics-app.result == 'success' && needs.build-quality-app.result == 'success' && needs.build-production-app.result == 'success' && needs.build-engineering-app.result == 'success' && needs.build-finance-app.result == 'success' && needs.build-mobile-app.result == 'success' || github.event.inputs.deploy_only == 'true') && github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        echo "Setting up SSH connection..."
        
        # 检查必需的secrets
        if [ -z "${{ secrets.SERVER_KEY }}" ]; then
          echo "❌ Error: SERVER_KEY (SSH private key) is not set"
          echo "Please add SERVER_KEY (your SSH private key) to your GitHub repository secrets"
          exit 1
        fi
        
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "❌ Error: SERVER_HOST is not set"
          echo "Please add SERVER_HOST (your server IP address) to your GitHub repository secrets"
          exit 1
        fi
        
        echo "✅ Required secrets are available"
        
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # 创建SSH私钥文件
        echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
        
        # 修复密钥格式（处理可能的换行符问题）
        sed -i 's/\\n/\n/g' ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # 添加主机密钥
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        
        # 验证密钥格式
        if ! ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1; then
          echo "❌ SSH key format is invalid"
          echo "Key file structure:"
          echo "Lines: $(wc -l < ~/.ssh/id_rsa)"
          echo "First line: $(head -1 ~/.ssh/id_rsa)"
          echo "Last line: $(tail -1 ~/.ssh/id_rsa)"
          exit 1
        fi
        
        echo "✅ SSH key setup completed successfully"
        echo "Key fingerprint: $(ssh-keygen -l -f ~/.ssh/id_rsa)"

    - name: Verify server connection
      run: |
        echo "Testing SSH connection..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes \
            -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || '22' }} \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} \
            "echo 'Server connection successful'" || {
          echo "❌ SSH connection failed"
          echo "Debugging information:"
          echo "Host: ${{ secrets.SERVER_HOST }}"
          echo "Port: ${{ secrets.SERVER_PORT || '22' }}"
          echo "User: ${{ secrets.SERVER_USER || 'root' }}"
          echo "Key file permissions:"
          ls -la ~/.ssh/id_rsa
          echo "Key fingerprint:"
          ssh-keygen -l -f ~/.ssh/id_rsa 2>/dev/null || echo "Cannot read key fingerprint"
          exit 1
        }

    - name: Deploy applications
      run: |
        echo "Deploying BTC ShopFlow applications via SSH..."
        
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || '22' }} \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} << 'EOF'
        set -e
        
        echo "Starting BTC ShopFlow deployment..."
        
        # 检查项目目录
        if [ ! -d "/www/wwwroot/btc-shopflow-monorepo" ]; then
          echo "Creating project directory..."
          mkdir -p /www/wwwroot
          cd /www/wwwroot
          git clone https://github.com/BellisGit/btc-shopflow-monorepo.git
        fi
        
        echo "Navigating to project directory..."
        cd /www/wwwroot/btc-shopflow-monorepo
        
        echo "Pulling latest code..."
        git pull origin master
        
        echo "Logging into container registry..."
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
        echo "Starting deployment script..."
        chmod +x scripts/deploy.sh
        ./scripts/deploy.sh
        
        echo "Deployment completed successfully"
        EOF

    - name: Health checks
      run: |
        echo "Performing health checks..."
        
        # 等待服务启动
        sleep 30
        
        echo "Checking application health on IP: ${{ secrets.SERVER_HOST }}"
        
        # 检查主要应用
        for port in 30080 30081 30086; do
          if curl -f -s --max-time 10 http://${{ secrets.SERVER_HOST }}:$port > /dev/null; then
            echo "Port $port is healthy"
          else
            echo "Port $port health check failed (this may be normal if the service is still starting)"
          fi
        done

    - name: Deployment summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Built Images:" >> $GITHUB_STEP_SUMMARY
        echo "- System App: ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Admin App: ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Logistics App: ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality App: ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Production App: ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Engineering App: ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Finance App: ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mobile App: ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Application URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- 主应用: http://${{ secrets.SERVER_HOST }}:30080" >> $GITHUB_STEP_SUMMARY
        echo "- 管理后台: http://${{ secrets.SERVER_HOST }}:30081" >> $GITHUB_STEP_SUMMARY
        echo "- 财务系统: http://${{ secrets.SERVER_HOST }}:30086" >> $GITHUB_STEP_SUMMARY

  # 第四步：通知
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [quality-check, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app, deploy]
    if: always()
    
    steps:
    - name: Success notification
      if: needs.deploy.result == 'success'
      run: |
        echo "**Deployment Successful!**" >> $GITHUB_STEP_SUMMARY
        echo "All steps completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "URL: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}" >> $GITHUB_STEP_SUMMARY
        
    - name: Failure notification
      if: needs.deploy.result == 'failure' || needs.build-system-app.result == 'failure' || needs.build-admin-app.result == 'failure' || needs.build-logistics-app.result == 'failure' || needs.build-quality-app.result == 'failure' || needs.build-production-app.result == 'failure' || needs.build-engineering-app.result == 'failure' || needs.build-finance-app.result == 'failure' || needs.build-mobile-app.result == 'failure' || needs.quality-check.result == 'failure'
      run: |
        echo "**Deployment Failed!**" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs for details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Results:" >> $GITHUB_STEP_SUMMARY
        echo "- System App: ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Admin App: ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Logistics App: ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality App: ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Production App: ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Engineering App: ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Finance App: ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mobile App: ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
        exit 1