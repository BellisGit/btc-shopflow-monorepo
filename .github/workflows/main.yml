name: ðŸš€ BTC ShopFlow CI/CD

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      deploy_only:
        description: 'ä»…éƒ¨ç½²ï¼ˆè·³è¿‡æž„å»ºå’Œæµ‹è¯•ï¼‰'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  NAMESPACE: btc-shopflow

jobs:
  # ç¬¬ä¸€æ­¥ï¼šä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  quality-check:
    name: ðŸ” Quality Check & Test
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_only != 'true'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8.15.0

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.0'
        cache: 'pnpm'

    - name: ðŸ“¥ Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: ðŸ§ª Install Playwright browsers
      run: pnpm exec playwright install --with-deps

    - name: ðŸ—ï¸ Build shared packages
      run: |
        echo "ðŸ”§ Building shared packages in dependency order..."
        pnpm --filter @btc/vite-plugin run build
        pnpm --filter @btc/shared-utils run build
        pnpm --filter @btc/shared-core run build
        pnpm --filter @btc/shared-components run build

    # - name: ðŸ§¹ Lint
    #   run: pnpm run lint

    - name: ðŸ” Type check
      run: pnpm run type-check

    - name: ðŸ§ª Unit tests
      run: pnpm run test:unit

    - name: ðŸ§ª Integration tests
      run: pnpm run test:integration

    - name: ðŸ§ª E2E tests
      run: pnpm run test:e2e

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºSystem App
  build-system-app:
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    uses: ./.github/workflows/build-system-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºAdmin App
  build-admin-app:
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    uses: ./.github/workflows/build-admin-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºLogistics App
  build-logistics-app:
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    uses: ./.github/workflows/build-logistics-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºQuality App
  build-quality-app:
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    uses: ./.github/workflows/build-quality-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºProduction App
  build-production-app:
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    uses: ./.github/workflows/build-production-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºEngineering App
  build-engineering-app:
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    uses: ./.github/workflows/build-engineering-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºFinance App
  build-finance-app:
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    uses: ./.github/workflows/build-finance-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºMobile App
  build-mobile-app:
    needs: quality-check
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    uses: ./.github/workflows/build-mobile-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    name: ðŸš€ Deploy to Server
    runs-on: ubuntu-latest
    needs: [quality-check, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app]
    if: always() && (needs.build-system-app.result == 'success' && needs.build-admin-app.result == 'success' && needs.build-logistics-app.result == 'success' && needs.build-quality-app.result == 'success' && needs.build-production-app.result == 'success' && needs.build-engineering-app.result == 'success' && needs.build-finance-app.result == 'success' && needs.build-mobile-app.result == 'success' || github.event.inputs.deploy_only == 'true') && github.ref == 'refs/heads/master'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # å¤„ç†SSHå¯†é’¥ï¼ˆæ”¯æŒbase64ç¼–ç å’ŒåŽŸå§‹æ ¼å¼ï¼‰
        if echo "${{ secrets.SERVER_KEY }}" | base64 -d >/dev/null 2>&1; then
          echo "ðŸ”§ Decoding base64 SSH key..."
          echo "${{ secrets.SERVER_KEY }}" | base64 -d > ~/.ssh/id_rsa
        else
          echo "ðŸ”§ Using raw SSH key..."
          echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
        fi
        
        # ä¿®å¤å¯†é’¥æ ¼å¼ï¼ˆå¤„ç†\nè½¬ä¹‰ï¼‰
        sed -i 's/\\n/\n/g' ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # æ·»åŠ ä¸»æœºå¯†é’¥
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        
        # éªŒè¯å¯†é’¥æ ¼å¼
        if ! ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1; then
          echo "âŒ SSH key format is invalid"
          echo "ðŸ” Key file content (first 2 lines):"
          head -2 ~/.ssh/id_rsa
          exit 1
        fi
        
        echo "âœ… SSH key setup completed"

    - name: ðŸ” Verify server connection
      run: |
        echo "ðŸ§ª Testing SSH connection..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes \
            -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "echo 'âœ… Server connection successful'" || {
          echo "âŒ SSH connection failed"
          echo "ðŸ” Debugging information:"
          echo "Host: ${{ secrets.SERVER_HOST }}"
          echo "Port: ${{ secrets.SERVER_PORT }}"
          echo "User: ${{ secrets.SERVER_USER }}"
          echo "Key file permissions:"
          ls -la ~/.ssh/id_rsa
          echo "Key fingerprint:"
          ssh-keygen -l -f ~/.ssh/id_rsa 2>/dev/null || echo "Cannot read key fingerprint"
          exit 1
        }

    - name: ðŸš€ Deploy applications
      run: |
        echo "ðŸš€ Deploying BTC ShopFlow applications..."
        
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        set -e
        
        echo "ðŸ“‚ Navigating to project directory..."
        cd /www/wwwroot/btc-shopflow-monorepo || { echo "âŒ Project directory not found"; exit 1; }
        
        echo "ðŸ“¥ Pulling latest code..."
        git pull origin master
        
        echo "ðŸ” Logging into container registry..."
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
        
        echo "ðŸš€ Starting deployment script..."
        chmod +x scripts/deploy.sh
        ./scripts/deploy.sh
        
        echo "âœ… Deployment completed successfully"
        EOF

    - name: ðŸ§ª Health checks
      run: |
        echo "ðŸ§ª Performing health checks..."
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 30
        
        # æ£€æŸ¥ä¸»è¦åº”ç”¨
        for port in 30080 30081 30086; do
          if curl -f -s --max-time 10 http://${{ secrets.SERVER_HOST }}:$port > /dev/null; then
            echo "âœ… Port $port is healthy"
          else
            echo "âŒ Port $port health check failed"
          fi
        done

    - name: ðŸ“Š Deployment summary
      run: |
        echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Built Images:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… System App: ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Admin App: ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Logistics App: ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Quality App: ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Production App: ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Engineering App: ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Finance App: ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Mobile App: ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Application URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸»åº”ç”¨: http://${{ secrets.SERVER_HOST }}:30080" >> $GITHUB_STEP_SUMMARY
        echo "- ç®¡ç†åŽå°: http://${{ secrets.SERVER_HOST }}:30081" >> $GITHUB_STEP_SUMMARY
        echo "- è´¢åŠ¡ç³»ç»Ÿ: http://${{ secrets.SERVER_HOST }}:30086" >> $GITHUB_STEP_SUMMARY

  # ç¬¬å››æ­¥ï¼šé€šçŸ¥
  notify:
    name: ðŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [quality-check, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app, deploy]
    if: always()
    
    steps:
    - name: ðŸ“¢ Success notification
      if: needs.deploy.result == 'success'
      run: |
        echo "ðŸŽ‰ **Deployment Successful!**" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All steps completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— URL: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ“¢ Failure notification
      if: needs.deploy.result == 'failure' || needs.build-system-app.result == 'failure' || needs.build-admin-app.result == 'failure' || needs.build-logistics-app.result == 'failure' || needs.build-quality-app.result == 'failure' || needs.build-production-app.result == 'failure' || needs.build-engineering-app.result == 'failure' || needs.build-finance-app.result == 'failure' || needs.build-mobile-app.result == 'failure' || needs.quality-check.result == 'failure'
      run: |
        echo "âŒ **Deployment Failed!**" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ” Please check the logs for details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Build Results:" >> $GITHUB_STEP_SUMMARY
        echo "- System App: ${{ needs.build-system-app.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Admin App: ${{ needs.build-admin-app.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Logistics App: ${{ needs.build-logistics-app.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality App: ${{ needs.build-quality-app.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Production App: ${{ needs.build-production-app.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Engineering App: ${{ needs.build-engineering-app.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Finance App: ${{ needs.build-finance-app.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mobile App: ${{ needs.build-mobile-app.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy: ${{ needs.deploy.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
        exit 1
