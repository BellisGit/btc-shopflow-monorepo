name: BTC ShopFlow CI/CD

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      deploy_only:
        description: 'ä»…éƒ¨ç½²ï¼ˆè·³è¿‡æž„å»ºå’Œæµ‹è¯•ï¼‰'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  NAMESPACE: btc-shopflow

jobs:
  # ç¬¬ä¸€æ­¥ï¼šä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  quality-check:
    name: Quality Check & Test
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_only != 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8.15.0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.0'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: Install Playwright browsers
      run: pnpm exec playwright install --with-deps

    - name: Build shared packages
      run: |
        echo "Building shared packages in dependency order..."
        pnpm --filter @btc/vite-plugin run build
        pnpm --filter @btc/shared-utils run build
        pnpm --filter @btc/shared-core run build
        pnpm --filter @btc/shared-components run build

    # - name: Lint
    #   run: pnpm run lint

    - name: Type check
      run: pnpm run type-check

    - name: Unit tests
      run: pnpm run test:unit

    - name: Integration tests
      run: pnpm run test:integration

    - name: E2E tests
      run: pnpm run test:e2e

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºSystem App
  build-system-app:
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-system-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºAdmin App
  build-admin-app:
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-admin-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºLogistics App
  build-logistics-app:
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-logistics-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºQuality App
  build-quality-app:
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-quality-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºProduction App
  build-production-app:
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-production-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºEngineering App
  build-engineering-app:
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-engineering-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºFinance App
  build-finance-app:
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-finance-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºMobile App
  build-mobile-app:
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || github.event.inputs.deploy_only == 'true')
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-mobile-app.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [quality-check, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app]
    if: always() && (needs.build-system-app.result == 'success' && needs.build-admin-app.result == 'success' && needs.build-logistics-app.result == 'success' && needs.build-quality-app.result == 'success' && needs.build-production-app.result == 'success' && needs.build-engineering-app.result == 'success' && needs.build-finance-app.result == 'success' && needs.build-mobile-app.result == 'success' || github.event.inputs.deploy_only == 'true') && github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Aliyun CLI
      run: |
        echo "Setting up Aliyun CLI for deployment..."
        
        # æ£€æŸ¥å¿…éœ€çš„secrets
        if [ -z "${{ secrets.ALIYUN_ACCESS_KEY_ID }}" ]; then
          echo "âŒ Error: ALIYUN_ACCESS_KEY_ID secret is not set"
          echo "Please add ALIYUN_ACCESS_KEY_ID to your GitHub repository secrets"
          exit 1
        fi
        
        if [ -z "${{ secrets.SERVER_KEY }}" ]; then
          echo "âŒ Error: SERVER_KEY (AccessKey Secret) is not set"
          echo "Please add SERVER_KEY (your Aliyun AccessKey Secret) to your GitHub repository secrets"
          exit 1
        fi
        
        echo "âœ… Required secrets are available"
        
        # å®‰è£…é˜¿é‡Œäº‘CLI
        echo "ðŸ“¥ Downloading Aliyun CLI..."
        curl -L https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz -o aliyun-cli.tgz
        tar -xzf aliyun-cli.tgz
        sudo mv aliyun /usr/local/bin/
        
        echo "ðŸ”§ Configuring Aliyun CLI..."
        # é…ç½®é˜¿é‡Œäº‘å‡­è¯
        aliyun configure set \
          --profile default \
          --mode AK \
          --region "${{ secrets.ALIYUN_REGION || 'cn-hangzhou' }}" \
          --access-key-id "${{ secrets.ALIYUN_ACCESS_KEY_ID }}" \
          --access-key-secret "${{ secrets.SERVER_KEY }}"
        
        echo "âœ… Aliyun CLI configured successfully"
        echo "Region: ${{ secrets.ALIYUN_REGION || 'cn-hangzhou' }}"
        echo "Access Key ID: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}"

    - name: Verify Aliyun connection
      run: |
        echo "Testing Aliyun API connection..."
        
        # æµ‹è¯•é˜¿é‡Œäº‘APIè¿žæŽ¥
        if aliyun ecs DescribeRegions --output json >/dev/null 2>&1; then
          echo "Aliyun API connection successful"
          echo "Available regions:"
          aliyun ecs DescribeRegions --output table
        else
          echo "Aliyun API connection failed"
          echo "Please check your ALIYUN_ACCESS_KEY_ID and SERVER_KEY (AccessKey Secret)"
          exit 1
        fi

    - name: Deploy applications
      run: |
        echo "Deploying BTC ShopFlow applications to Aliyun..."
        
        # èŽ·å–ECSå®žä¾‹ä¿¡æ¯
        echo "Getting ECS instance information..."
        INSTANCE_ID=$(aliyun ecs DescribeInstances \
          --RegionId ${{ secrets.ALIYUN_REGION || 'cn-hangzhou' }} \
          --output json | jq -r '.Instances.Instance[0].InstanceId')
        
        if [ "$INSTANCE_ID" = "null" ] || [ -z "$INSTANCE_ID" ]; then
          echo "No ECS instances found. Please ensure you have ECS instances in the specified region."
          exit 1
        fi
        
        echo "Found ECS instance: $INSTANCE_ID"
        
        # ä½¿ç”¨é˜¿é‡Œäº‘ECSåŠ©æ‰‹æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
        COMMAND_ID=$(aliyun ecs CreateCommand \
          --RegionId ${{ secrets.ALIYUN_REGION || 'cn-hangzhou' }} \
          --Type RunShellScript \
          --CommandContent "$(echo '#!/bin/bash
        set -e
        
        echo "Starting BTC ShopFlow deployment..."
        
        # æ£€æŸ¥é¡¹ç›®ç›®å½•
        if [ ! -d "/www/wwwroot/btc-shopflow-monorepo" ]; then
          echo "Creating project directory..."
          mkdir -p /www/wwwroot
          cd /www/wwwroot
          git clone https://github.com/BellisGit/btc-shopflow-monorepo.git
        fi
        
        echo "Navigating to project directory..."
        cd /www/wwwroot/btc-shopflow-monorepo
        
        echo "Pulling latest code..."
        git pull origin master
        
        echo "Logging into container registry..."
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
        
        echo "Starting deployment script..."
        chmod +x scripts/deploy.sh
        ./scripts/deploy.sh
        
        echo "Deployment completed successfully"
        ' | base64 -w 0)" \
          --Name "btc-shopflow-deploy-$(date +%Y%m%d%H%M%S)" \
          --Description "Deploy BTC ShopFlow applications" \
          --output json | jq -r '.CommandId')
        
        echo "Created deployment command: $COMMAND_ID"
        
        # æ‰§è¡Œå‘½ä»¤
        INVOKE_ID=$(aliyun ecs InvokeCommand \
          --RegionId ${{ secrets.ALIYUN_REGION || 'cn-hangzhou' }} \
          --CommandId $COMMAND_ID \
          --InstanceId.1 $INSTANCE_ID \
          --output json | jq -r '.InvokeId')
        
        echo "Command invocation started: $INVOKE_ID"
        
        # ç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæˆ
        echo "Waiting for deployment to complete..."
        for i in {1..60}; do
          STATUS=$(aliyun ecs DescribeInvocations \
            --RegionId ${{ secrets.ALIYUN_REGION || 'cn-hangzhou' }} \
            --InvokeId $INVOKE_ID \
            --output json | jq -r '.Invocations.Invocation[0].InvokeStatus')
          
          if [ "$STATUS" = "Finished" ]; then
            echo "Deployment completed successfully"
            break
          elif [ "$STATUS" = "Failed" ]; then
            echo "Deployment failed"
            exit 1
          else
            echo "Deployment in progress... ($i/60)"
            sleep 10
          fi
        done
        
        # èŽ·å–æ‰§è¡Œç»“æžœ
        echo "Getting deployment results..."
        aliyun ecs DescribeInvocationResults \
          --RegionId ${{ secrets.ALIYUN_REGION || 'cn-hangzhou' }} \
          --InvokeId $INVOKE_ID \
          --output json | jq -r '.Invocation.InvocationResults.InvocationResult[0].Output' | base64 -d

    - name: Health checks
      run: |
        echo "Performing health checks..."
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 30
        
        # èŽ·å–ECSå®žä¾‹çš„å…¬ç½‘IP
        PUBLIC_IP=$(aliyun ecs DescribeInstances \
          --RegionId ${{ secrets.ALIYUN_REGION || 'cn-hangzhou' }} \
          --output json | jq -r '.Instances.Instance[0].PublicIpAddress.IpAddress[0]')
        
        if [ "$PUBLIC_IP" = "null" ] || [ -z "$PUBLIC_IP" ]; then
          echo "Could not get public IP, using SERVER_HOST from secrets"
          PUBLIC_IP="${{ secrets.SERVER_HOST }}"
        fi
        
        echo "Checking application health on IP: $PUBLIC_IP"
        
        # æ£€æŸ¥ä¸»è¦åº”ç”¨
        for port in 30080 30081 30086; do
          if curl -f -s --max-time 10 http://$PUBLIC_IP:$port > /dev/null; then
            echo "Port $port is healthy"
          else
            echo "Port $port health check failed (this may be normal if the service is still starting)"
          fi
        done

    - name: Deployment summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Built Images:" >> $GITHUB_STEP_SUMMARY
        echo "- System App: ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Admin App: ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Logistics App: ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality App: ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Production App: ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Engineering App: ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Finance App: ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mobile App: ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Application URLs:" >> $GITHUB_STEP_SUMMARY
        
        # èŽ·å–ECSå®žä¾‹çš„å…¬ç½‘IPç”¨äºŽæ˜¾ç¤º
        PUBLIC_IP=$(aliyun ecs DescribeInstances \
          --RegionId ${{ secrets.ALIYUN_REGION || 'cn-hangzhou' }} \
          --output json | jq -r '.Instances.Instance[0].PublicIpAddress.IpAddress[0]' 2>/dev/null || echo "${{ secrets.SERVER_HOST }}")
        
        echo "- ä¸»åº”ç”¨: http://$PUBLIC_IP:30080" >> $GITHUB_STEP_SUMMARY
        echo "- ç®¡ç†åŽå°: http://$PUBLIC_IP:30081" >> $GITHUB_STEP_SUMMARY
        echo "- è´¢åŠ¡ç³»ç»Ÿ: http://$PUBLIC_IP:30086" >> $GITHUB_STEP_SUMMARY

  # ç¬¬å››æ­¥ï¼šé€šçŸ¥
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [quality-check, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app, deploy]
    if: always()
    
    steps:
    - name: Success notification
      if: needs.deploy.result == 'success'
      run: |
        echo "**Deployment Successful!**" >> $GITHUB_STEP_SUMMARY
        echo "All steps completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "URL: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}" >> $GITHUB_STEP_SUMMARY
        
    - name: Failure notification
      if: needs.deploy.result == 'failure' || needs.build-system-app.result == 'failure' || needs.build-admin-app.result == 'failure' || needs.build-logistics-app.result == 'failure' || needs.build-quality-app.result == 'failure' || needs.build-production-app.result == 'failure' || needs.build-engineering-app.result == 'failure' || needs.build-finance-app.result == 'failure' || needs.build-mobile-app.result == 'failure' || needs.quality-check.result == 'failure'
      run: |
        echo "**Deployment Failed!**" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs for details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Results:" >> $GITHUB_STEP_SUMMARY
        echo "- System App: ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Admin App: ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Logistics App: ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality App: ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Production App: ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Engineering App: ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Finance App: ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mobile App: ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
        exit 1
