name: BTC ShopFlow CI/CD Pipeline

# Trigger workflow to test updated SSH key configuration
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
      deploy_only:
        description: 'Skip quality checks and build, deploy only'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY: ghcr.io

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  # Step 1: SSH Connection Validation (Fast Fail)
  validate-ssh:
    name: Validate SSH Connection
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Test SSH connection
      run: |
        echo "[INFO] Testing SSH connection first to fail fast if credentials are invalid..."
        
        if [ -z "${{ secrets.SERVER_KEY }}" ]; then
          echo "[WARNING] SERVER_KEY not set - SSH deployment will be skipped"
          echo "ssh_available=false" >> $GITHUB_ENV
          exit 0
        fi
        
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "[WARNING] SERVER_HOST not set - SSH deployment will be skipped"
          echo "ssh_available=false" >> $GITHUB_ENV
          exit 0
        fi
        
        echo "[INFO] Setting up SSH key..."
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Process SSH key
        echo "Processing SSH key..."
        SERVER_KEY="${{ secrets.SERVER_KEY }}"
        if echo "$SERVER_KEY" | grep -q "^[A-Za-z0-9+/]*={0,2}$" && [ ${#SERVER_KEY} -gt 100 ]; then
          echo "Detected base64 encoded key, decoding..."
          echo "${{ secrets.SERVER_KEY }}" | base64 -d > ~/.ssh/id_rsa
        else
          echo "Processing key as plain text..."
          echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
          sed -i 's/\\n/\n/g' ~/.ssh/id_rsa
        fi
        
        chmod 600 ~/.ssh/id_rsa
        
        # Validate key format
        if ! ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1; then
          echo "[ERROR] SSH key format is invalid"
          echo "Please check your SERVER_KEY secret format"
          exit 1
        fi
        
        # Show key fingerprint for debugging
        echo "[INFO] SSH key fingerprint: $(ssh-keygen -l -f ~/.ssh/id_rsa)"
        echo "[INFO] SSH key type: $(ssh-keygen -l -f ~/.ssh/id_rsa | awk '{print $4}')"
        
        # Add host key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        
        echo "[INFO] Testing SSH connection..."
        echo "[DEBUG] Connection details:"
        echo "  Host: ${{ secrets.SERVER_HOST }}"
        echo "  Port: ${{ secrets.SERVER_PORT || '22' }}"
        echo "  User: ${{ secrets.SERVER_USER || 'root' }}"
        
        if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes \
            -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || '22' }} \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} \
            "echo 'SSH connection test successful'"; then
          echo "[SUCCESS] SSH connection successful!"
          echo "ssh_available=true" >> $GITHUB_ENV
        else
          echo "[ERROR] SSH connection failed!"
          echo ""
          echo "TROUBLESHOOTING STEPS:"
          echo "1. Verify your SSH key is added to the server:"
          echo "   - Copy your PUBLIC key (not private) to ~/.ssh/authorized_keys on server"
          echo "   - Run: cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys"
          echo ""
          echo "2. Check server SSH configuration:"
          echo "   - Ensure PubkeyAuthentication is enabled in /etc/ssh/sshd_config"
          echo "   - Restart SSH service: sudo systemctl restart sshd"
          echo ""
          echo "3. Verify file permissions on server:"
          echo "   - chmod 700 ~/.ssh"
          echo "   - chmod 600 ~/.ssh/authorized_keys"
          echo ""
          echo "4. Test manually from your local machine:"
          echo "   - ssh -i your_private_key ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }}"
          echo ""
          echo "Common issues:"
          echo "- SSH key not added to server's authorized_keys"
          echo "- Wrong server IP address: ${{ secrets.SERVER_HOST }}"
          echo "- Firewall blocking SSH port: ${{ secrets.SERVER_PORT || '22' }}"
          echo "- SSH service not running on server"
          exit 1
        fi

  # Step 2: Build Dependencies
  build-dependencies:
    needs: [validate-ssh]
    if: always() && github.event.inputs.deploy_only != 'true'
    uses: ./.github/workflows/build-dependencies.yml

  # Step 3: Code Quality Check
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    needs: [validate-ssh, build-dependencies]
    if: always() && github.event.inputs.deploy_only != 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4

    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: Restore built packages cache
      uses: actions/cache@v3
      with:
        path: |
          packages/*/dist
          packages/*/build
        key: packages-build-${{ github.sha }}
        restore-keys: |
          packages-build-

    - name: Build packages if cache miss
      run: |
        if [ ! -d "packages/shared-core/dist" ]; then
          echo "Cache miss, building packages..."
          pnpm --filter @btc/vite-plugin run build
          pnpm --filter @btc/shared-utils run build
          pnpm --filter @btc/shared-core run build
          pnpm --filter @btc/shared-components run build
          pnpm --filter @btc/subapp-manifests run build
        else
          echo "Using cached packages"
        fi

    - name: Type check
      run: pnpm run type-check

    - name: Lint check
      run: pnpm run lint

  # Step 4: Environment Validation
  validate-environment:
    needs: [validate-ssh, build-dependencies, quality-check]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/validate-environment.yml
    secrets:
      SERVER_KEY: ${{ secrets.SERVER_KEY }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}

  # Step 5: Build all application Docker images (8 parallel tasks)
  build-system-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-system-app-reusable.yml
    with:
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      GH_TOKEN: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-admin-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: admin-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-logistics-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: logistics-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-quality-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: quality-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-production-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: production-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-engineering-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: engineering-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-finance-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: finance-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  build-mobile-app:
    needs: [validate-ssh, validate-environment]
    if: always() && (needs.validate-ssh.result == 'success' || needs.validate-ssh.result == 'skipped')
    uses: ./.github/workflows/build-app-reusable.yml
    with:
      app_name: mobile-app
      registry: ghcr.io
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
    secrets:
      gh_token: ${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}

  # Step 6: Deploy to Server
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [validate-ssh, validate-environment, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app]
    if: always() && needs.validate-ssh.result == 'success' && github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4


    - name: Setup SSH
      run: |
        echo "Setting up SSH connection..."
        
        if [ -z "${{ secrets.SERVER_KEY }}" ]; then
          echo " SERVER_KEY is not set, skipping SSH setup"
          exit 0
        fi
        
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Create SSH private key file with proper formatting
        echo "Processing SSH key..."
        
        # Try to detect if the key is base64 encoded
        SERVER_KEY="${{ secrets.SERVER_KEY }}"
        if echo "$SERVER_KEY" | grep -q "^[A-Za-z0-9+/]*={0,2}$" && [ ${#SERVER_KEY} -gt 100 ]; then
          echo "Detected base64 encoded key, decoding..."
          echo "${{ secrets.SERVER_KEY }}" | base64 -d > ~/.ssh/id_rsa
        else
          echo "Processing key as plain text..."
          # Write the key directly and fix formatting
          echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
          
          # Fix escaped newlines
          sed -i 's/\\n/\n/g' ~/.ssh/id_rsa
          
          # Ensure proper PEM format
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_rsa; then
            echo "?Key doesn't appear to be in PEM format"
            echo "First 100 characters of key:"
            head -c 100 ~/.ssh/id_rsa
            exit 1
          fi
          
          # Fix header/footer formatting
          sed -i 's/-----BEGIN RSA PRIVATE KEY-----/-----BEGIN RSA PRIVATE KEY-----/' ~/.ssh/id_rsa
          sed -i 's/-----END RSA PRIVATE KEY-----/-----END RSA PRIVATE KEY-----/' ~/.ssh/id_rsa
          sed -i 's/-----BEGIN PRIVATE KEY-----/-----BEGIN PRIVATE KEY-----/' ~/.ssh/id_rsa
          sed -i 's/-----END PRIVATE KEY-----/-----END PRIVATE KEY-----/' ~/.ssh/id_rsa
          
          # Ensure headers are on their own lines
          sed -i 's/-----BEGIN RSA PRIVATE KEY-----\(.\)/-----BEGIN RSA PRIVATE KEY-----\n\1/g' ~/.ssh/id_rsa
          sed -i 's/\(.\)-----END RSA PRIVATE KEY-----/\1\n-----END RSA PRIVATE KEY-----/g' ~/.ssh/id_rsa
          sed -i 's/-----BEGIN PRIVATE KEY-----\(.\)/-----BEGIN PRIVATE KEY-----\n\1/g' ~/.ssh/id_rsa
          sed -i 's/\(.\)-----END PRIVATE KEY-----/\1\n-----END PRIVATE KEY-----/g' ~/.ssh/id_rsa
        fi
        
        chmod 600 ~/.ssh/id_rsa
        
        # Validate SSH key format
        echo "Validating SSH key format..."
        echo "Key file size: $(wc -c < ~/.ssh/id_rsa) bytes"
        echo "Key file lines: $(wc -l < ~/.ssh/id_rsa)"
        echo "First line: $(head -1 ~/.ssh/id_rsa)"
        echo "Last line: $(tail -1 ~/.ssh/id_rsa)"
        
        if ! ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1; then
          echo "?SSH key format is still invalid after processing"
          echo ""
          echo "=== DEBUGGING INFORMATION ==="
          echo "Key file contents (first 5 lines):"
          head -5 ~/.ssh/id_rsa
          echo "..."
          echo "Key file contents (last 5 lines):"
          tail -5 ~/.ssh/id_rsa
          echo ""
          echo "Key validation error:"
          ssh-keygen -l -f ~/.ssh/id_rsa 2>&1 || true
          echo ""
          echo "Please ensure your SERVER_KEY secret contains a valid SSH private key in PEM format."
          echo "The key should start with '-----BEGIN [RSA] PRIVATE KEY-----' and end with '-----END [RSA] PRIVATE KEY-----'"
          echo ""
          echo " SSH key validation failed. You can:"
          echo "1. Fix your SERVER_KEY secret with a valid SSH private key"
          echo "2. Or remove SERVER_KEY to skip SSH-based deployment"
          echo ""
          echo "For now, marking this step as failed but allowing workflow to continue..."
          exit 1
        fi
        
        # Add host key
        if [ -n "${{ secrets.SERVER_HOST }}" ]; then
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        fi
        
        echo "?SSH key setup completed successfully"
        echo "Key fingerprint: $(ssh-keygen -l -f ~/.ssh/id_rsa)"

    - name: Deploy applications
      run: |
        echo "Deploying BTC ShopFlow applications via SSH..."
        
        # Check if SSH key exists
        if [ ! -f ~/.ssh/id_rsa ]; then
          echo " SSH key not found, skipping deployment"
          exit 0
        fi
        
        # Check if required secrets are set
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo " SERVER_HOST not set, skipping deployment"
          exit 0
        fi
        
        # Test SSH connection first
        echo "Testing SSH connection..."
        if ! ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes \
            -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || '22' }} \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} \
            "echo 'SSH connection test successful'"; then
          echo "?SSH connection failed, skipping deployment"
          echo "Please check your SERVER_KEY, SERVER_HOST, SERVER_USER, and SERVER_PORT secrets"
          exit 0
        fi
        
        echo "?SSH connection successful, proceeding with deployment..."
        
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT || '22' }} \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} << 'EOF'
        set -e
        
        echo "Starting BTC ShopFlow deployment..."
        
        # Check project directory
        if [ ! -d "/www/wwwroot/btc-shopflow-monorepo" ]; then
          echo "Creating project directory..."
          mkdir -p /www/wwwroot
          cd /www/wwwroot
          git clone https://github.com/BellisGit/btc-shopflow-monorepo.git
        fi
        
        echo "Navigating to project directory..."
        cd /www/wwwroot/btc-shopflow-monorepo
        
        echo "Pulling latest code..."
        # Check for local changes
        if ! git diff-index --quiet HEAD --; then
          echo "Local changes detected, stashing them..."
          git stash push -m "Auto-stash before deployment $(date)"
        fi
        
        # Reset any uncommitted changes and pull latest
        git reset --hard HEAD
        git clean -fd
        git pull origin master
        
        echo "Successfully updated to latest code"
        
        echo "Logging into container registry..."
        echo "${{ secrets.SERVER_PAT || secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
        echo "Starting deployment script..."
        chmod +x scripts/deploy.sh
        ./scripts/deploy.sh
        
        echo "Deployment completed successfully"
        EOF

    - name: Health checks
      run: |
        echo "Performing health checks..."
        
        # Wait for services to start
        sleep 30
        
        echo "Checking application health on IP: ${{ secrets.SERVER_HOST }}"
        
        # Check main applications
        for port in 30080 30081 30086; do
          if curl -f -s --max-time 10 http://${{ secrets.SERVER_HOST }}:$port > /dev/null; then
            echo "Port $port is healthy"
          else
            echo "Port $port health check failed (this may be normal if the service is still starting)"
          fi
        done

    - name: Deployment summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Built Images:" >> $GITHUB_STEP_SUMMARY
        echo "- System App: ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Admin App: ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Logistics App: ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality App: ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Production App: ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Engineering App: ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Finance App: ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mobile App: ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Application URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- Main App: http://${{ secrets.SERVER_HOST }}:30080" >> $GITHUB_STEP_SUMMARY
        echo "- Admin Panel: http://${{ secrets.SERVER_HOST }}:30081" >> $GITHUB_STEP_SUMMARY
        echo "- Finance System: http://${{ secrets.SERVER_HOST }}:30086" >> $GITHUB_STEP_SUMMARY

  # Step 7: Notification
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [validate-ssh, quality-check, validate-environment, build-system-app, build-admin-app, build-logistics-app, build-quality-app, build-production-app, build-engineering-app, build-finance-app, build-mobile-app, deploy]
    if: always()
    
    steps:
    - name: Success notification
      if: needs.deploy.result == 'success'
      run: |
        echo "**Deployment Successful!**" >> $GITHUB_STEP_SUMMARY
        echo "All steps completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "URL: ${{ vars.APP_URL || 'https://btc-shopflow.com' }}" >> $GITHUB_STEP_SUMMARY
        
    - name: Failure notification
      if: needs.deploy.result == 'failure' || needs.build-system-app.result == 'failure' || needs.build-admin-app.result == 'failure' || needs.build-logistics-app.result == 'failure' || needs.build-quality-app.result == 'failure' || needs.build-production-app.result == 'failure' || needs.build-engineering-app.result == 'failure' || needs.build-finance-app.result == 'failure' || needs.build-mobile-app.result == 'failure' || needs.quality-check.result == 'failure' || needs.validate-environment.result == 'failure'
      run: |
        echo "**Deployment Failed!**" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs for details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Results:" >> $GITHUB_STEP_SUMMARY
        echo "- Quality Check: ${{ needs.quality-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Environment Validation: ${{ needs.validate-environment.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- System App: ${{ needs.build-system-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Admin App: ${{ needs.build-admin-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Logistics App: ${{ needs.build-logistics-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality App: ${{ needs.build-quality-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Production App: ${{ needs.build-production-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Engineering App: ${{ needs.build-engineering-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Finance App: ${{ needs.build-finance-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mobile App: ${{ needs.build-mobile-app.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
        exit 1





