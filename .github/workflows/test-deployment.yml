name: Test Deployment

on:
  workflow_call:
    inputs:
      apps:
        required: false
        type: string
        description: "è¦æµ‹è¯•çš„åº”ç”¨åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼Œç•™ç©ºåˆ™æµ‹è¯•æ‰€æœ‰åº”ç”¨"
      timeout:
        required: false
        type: number
        description: "è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰"
        default: 30000
      base_url:
        required: false
        type: string
        description: "åŸºç¡€URLï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤ https://ï¼‰"
      max_retries:
        required: false
        type: number
        description: "æœ€å¤§é‡è¯•æ¬¡æ•°"
        default: 3
      retry_delay:
        required: false
        type: number
        description: "é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰"
        default: 300
  workflow_dispatch:
    inputs:
      apps:
        required: false
        type: string
        description: "è¦æµ‹è¯•çš„åº”ç”¨åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼Œç•™ç©ºåˆ™æµ‹è¯•æ‰€æœ‰åº”ç”¨"
      timeout:
        required: false
        type: number
        description: "è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰"
        default: 30000
      base_url:
        required: false
        type: string
        description: "åŸºç¡€URLï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤ https://ï¼‰"
      max_retries:
        required: false
        type: number
        description: "æœ€å¤§é‡è¯•æ¬¡æ•°"
        default: 3
      retry_delay:
        required: false
        type: number
        description: "é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰"
        default: 300
  repository_dispatch:
    types: [test-deployment]

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Test Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Load deploy config
        id: load-config
        run: |
          if [ ! -f "deploy.config.json" ]; then
            echo "âš ï¸ deploy.config.json ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç¤ºä¾‹é…ç½®"
            cp deploy.config.example.json deploy.config.json
          fi
          echo "âœ… éƒ¨ç½²é…ç½®å·²åŠ è½½"

      - name: Run deployment test
        id: test
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²æµ‹è¯•..."
          
          # æ„å»ºæµ‹è¯•å‘½ä»¤
          TEST_CMD="node scripts/test-deployment.mjs"
          
          # æ·»åŠ åº”ç”¨å‚æ•°
          if [ -n "${{ inputs.apps }}" ]; then
            APPS="${{ inputs.apps }}"
            # æ£€æŸ¥æ˜¯å•ä¸ªåº”ç”¨è¿˜æ˜¯å¤šä¸ªåº”ç”¨
            if [[ "$APPS" == *","* ]]; then
              TEST_CMD="$TEST_CMD --apps $APPS"
            else
              TEST_CMD="$TEST_CMD --app $APPS"
            fi
          else
            TEST_CMD="$TEST_CMD --all"
          fi
          
          # æ·»åŠ è¶…æ—¶å‚æ•°
          if [ -n "${{ inputs.timeout }}" ]; then
            TEST_CMD="$TEST_CMD --timeout ${{ inputs.timeout }}"
          fi
          
          # æ·»åŠ åŸºç¡€URLå‚æ•°
          if [ -n "${{ inputs.base_url }}" ]; then
            TEST_CMD="$TEST_CMD --base-url ${{ inputs.base_url }}"
          fi
          
          # è®¾ç½®è¾“å‡ºç›®å½•
          TEST_CMD="$TEST_CMD --output test-results"
          
          echo "æ‰§è¡Œå‘½ä»¤: $TEST_CMD"
          
          # æ‰§è¡Œæµ‹è¯•ï¼ˆæœ€å¤šé‡è¯•æŒ‡å®šæ¬¡æ•°ï¼‰
          MAX_RETRIES=${{ inputs.max_retries || 3 }}
          RETRY_DELAY=${{ inputs.retry_delay || 300 }}
          RETRY_COUNT=0
          TEST_SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ç¬¬ $((RETRY_COUNT + 1)) æ¬¡æµ‹è¯•å°è¯•"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if $TEST_CMD; then
              TEST_SUCCESS=true
              echo "âœ… æµ‹è¯•é€šè¿‡ï¼"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œå°†åœ¨ ${RETRY_DELAY} ç§’åé‡è¯•..."
                echo "å‰©ä½™é‡è¯•æ¬¡æ•°: $((MAX_RETRIES - RETRY_COUNT))"
                sleep $RETRY_DELAY
              else
                echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              fi
            fi
          done
          
          # è®¾ç½®è¾“å‡º
          if [ "$TEST_SUCCESS" = true ]; then
            echo "test_success=true" >> $GITHUB_OUTPUT
            echo "test_result=passed" >> $GITHUB_OUTPUT
          else
            echo "test_success=false" >> $GITHUB_OUTPUT
            echo "test_result=failed" >> $GITHUB_OUTPUT
          fi

      - name: Analyze test results
        if: always()
        run: |
          echo "ğŸ“Š åˆ†ææµ‹è¯•ç»“æœ..."
          
          if [ -d "test-results" ]; then
            echo "æµ‹è¯•ç»“æœç›®å½•:"
            ls -la test-results/
            
            # æŸ¥æ‰¾æœ€æ–°çš„æµ‹è¯•ç»“æœJSONæ–‡ä»¶
            LATEST_RESULT=$(ls -t test-results/test-results-*.json 2>/dev/null | head -1)
            if [ -n "$LATEST_RESULT" ]; then
              echo ""
              echo "æœ€æ–°çš„æµ‹è¯•ç»“æœæ–‡ä»¶: $LATEST_RESULT"
              echo ""
              echo "æµ‹è¯•ç»“æœæ‘˜è¦:"
              cat "$LATEST_RESULT" | jq -r '
                "æ€»è®¡: \(.summary.total)",
                "é€šè¿‡: \(.summary.passed) âœ…",
                "å¤±è´¥: \(.summary.failed) âŒ",
                "è€—æ—¶: \(.summary.duration)ms"
              ' || echo "æ— æ³•è§£ææµ‹è¯•ç»“æœ"
              
              # å¦‚æœæœ‰å¤±è´¥çš„åº”ç”¨ï¼Œåˆ—å‡ºè¯¦ç»†ä¿¡æ¯
              FAILED_APPS=$(cat "$LATEST_RESULT" | jq -r '.apps | to_entries | map(select(.value.success == false)) | .[].key' 2>/dev/null || echo "")
              if [ -n "$FAILED_APPS" ]; then
                echo ""
                echo "å¤±è´¥çš„åº”ç”¨:"
                echo "$FAILED_APPS" | while read app; do
                  echo "  - $app"
                  cat "$LATEST_RESULT" | jq -r ".apps[\"$app\"].errors[]?.message // .apps[\"$app\"].errors[]?.error // \"æ— è¯¦ç»†ä¿¡æ¯\"" 2>/dev/null | head -3 | sed 's/^/    /'
                done
              fi
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•ç»“æœç›®å½•"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-test-results
          path: test-results/
          retention-days: 30

      - name: Comment test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const resultsDir = 'test-results';
            if (!fs.existsSync(resultsDir)) {
              return;
            }
            
            // æŸ¥æ‰¾æœ€æ–°çš„æµ‹è¯•ç»“æœ
            const files = fs.readdirSync(resultsDir)
              .filter(f => f.startsWith('test-results-') && f.endsWith('.json'))
              .sort()
              .reverse();
            
            if (files.length === 0) {
              return;
            }
            
            const latestResult = JSON.parse(
              fs.readFileSync(path.join(resultsDir, files[0]), 'utf-8')
            );
            
            const summary = latestResult.summary;
            const passRate = summary.total > 0 
              ? Math.round((summary.passed / summary.total) * 100) 
              : 0;
            
            const emoji = summary.failed === 0 ? 'âœ…' : 'âŒ';
            const status = summary.failed === 0 ? 'é€šè¿‡' : 'å¤±è´¥';
            
            let comment = `## ${emoji} éƒ¨ç½²æµ‹è¯• ${status}\n\n`;
            comment += `- **æ€»è®¡**: ${summary.total}\n`;
            comment += `- **é€šè¿‡**: ${summary.passed} âœ…\n`;
            comment += `- **å¤±è´¥**: ${summary.failed} âŒ\n`;
            comment += `- **é€šè¿‡ç‡**: ${passRate}%\n`;
            comment += `- **è€—æ—¶**: ${(summary.duration / 1000).toFixed(2)} ç§’\n\n`;
            
            if (summary.failed > 0) {
              comment += `### å¤±è´¥çš„åº”ç”¨\n\n`;
              for (const [appName, result] of Object.entries(latestResult.apps)) {
                if (!result.success) {
                  comment += `- **${appName}**: ${result.errors?.length || 0} ä¸ªé”™è¯¯\n`;
                }
              }
            }
            
            comment += `\n[æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if tests failed
        if: steps.test.outputs.test_success == 'false'
        run: |
          echo "âŒ éƒ¨ç½²æµ‹è¯•å¤±è´¥"
          exit 1

