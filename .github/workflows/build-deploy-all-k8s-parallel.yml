name: Build and Deploy All Apps

on:
  repository_dispatch:
    types: [build-deploy-all-k8s]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  actions: read
  checks: read

jobs:
  detect-image-tag:
    name: Detect Image Tag
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
      repo_owner_lower: ${{ steps.detect.outputs.repo_owner_lower }}
      registry: ${{ steps.detect.outputs.registry }}
      k8s_namespace: ${{ steps.detect.outputs.k8s_namespace }}
      has_private_password: ${{ steps.detect.outputs.has_private_password }}
    steps:
      - name: Detect image tag and repository owner
        id: detect
        run: |
          echo "ğŸ” å¼€å§‹æ£€æµ‹é•œåƒæ ‡ç­¾å’Œä»“åº“ä¿¡æ¯..."
          echo "  - client_payload.github_sha: ${{ github.event.client_payload.github_sha }}"
          echo "  - github.sha: ${{ github.sha }}"
          
          # è½¬æ¢ä»“åº“æ‰€æœ‰è€…åç§°ä¸ºå°å†™
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner_lower=$REPO_OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "  âœ… ä»“åº“æ‰€æœ‰è€…ï¼ˆå°å†™ï¼‰: $REPO_OWNER_LOWER"
          
          # ç”Ÿæˆé•œåƒæ ‡ç­¾ï¼ˆä½¿ç”¨ SHA å‰7ä½ï¼‰
          if [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            GIT_SHA="${{ github.event.client_payload.github_sha }}"
            echo "  âœ… ä» client_payload.github_sha è·å–: $GIT_SHA"
          else
            GIT_SHA="${{ github.sha }}"
            echo "  âœ… ä» github.sha è·å–: $GIT_SHA"
          fi
          
          if [ ${#GIT_SHA} -gt 7 ]; then
            IMAGE_TAG="${GIT_SHA:0:7}"
          elif [ ${#GIT_SHA} -lt 7 ]; then
            IMAGE_TAG="latest"
            echo "  âš ï¸  SHA å¤ªçŸ­ï¼Œä½¿ç”¨ latest"
          else
            IMAGE_TAG="$GIT_SHA"
          fi
          
          if [ -z "$IMAGE_TAG" ]; then
            echo "  âš ï¸  æ ‡ç­¾ä¸ºç©ºï¼Œä½¿ç”¨ latest"
            IMAGE_TAG="latest"
          fi
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "âœ… æœ€ç»ˆé•œåƒæ ‡ç­¾: $IMAGE_TAG"
          
          # æ£€æµ‹é•œåƒä»“åº“ï¼ˆé»˜è®¤ä½¿ç”¨ ghcr.ioï¼‰
          if [ -n "${{ secrets.PRIVATE_REGISTRY }}" ]; then
            REGISTRY="${{ secrets.PRIVATE_REGISTRY }}"
            echo "  âœ… ä½¿ç”¨ç§æœ‰ä»“åº“: $REGISTRY"
          else
            REGISTRY="ghcr.io"
            echo "  âœ… ä½¿ç”¨é»˜è®¤ä»“åº“: $REGISTRY"
          fi
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT
          
          # æ£€æµ‹ K8s å‘½åç©ºé—´ï¼ˆé»˜è®¤ä½¿ç”¨ btc-shopflowï¼‰
          if [ -n "${{ secrets.K8S_NAMESPACE }}" ]; then
            K8S_NAMESPACE="${{ secrets.K8S_NAMESPACE }}"
            echo "  âœ… ä½¿ç”¨ K8s å‘½åç©ºé—´: $K8S_NAMESPACE"
          else
            K8S_NAMESPACE="btc-shopflow"
            echo "  âœ… ä½¿ç”¨é»˜è®¤ K8s å‘½åç©ºé—´: $K8S_NAMESPACE"
          fi
          echo "k8s_namespace=$K8S_NAMESPACE" >> $GITHUB_OUTPUT
          
          # æ£€æµ‹æ˜¯å¦æœ‰ç§æœ‰ä»“åº“å¯†ç ï¼ˆç”¨äºå†³å®šä½¿ç”¨å“ªä¸ª tokenï¼‰
          if [ -n "${{ secrets.PRIVATE_REGISTRY_PASSWORD }}" ]; then
            echo "has_private_password=true" >> $GITHUB_OUTPUT
            echo "  âœ… æ£€æµ‹åˆ°ç§æœ‰ä»“åº“å¯†ç "
          else
            echo "has_private_password=false" >> $GITHUB_OUTPUT
            echo "  âœ… æœªé…ç½®ç§æœ‰ä»“åº“å¯†ç ï¼Œå°†ä½¿ç”¨ github.token"
          fi
          

  build-deploy-all:
    name: Build and Deploy All Apps (Parallel)
    needs: detect-image-tag
    strategy:
      fail-fast: false
      matrix:
        app:
          - system-app
          - admin-app
          - logistics-app
          - quality-app
          - production-app
          - engineering-app
          - finance-app
          - mobile-app
    uses: ./.github/workflows/build-deploy-app-k8s-reusable.yml
    with:
      app_name: ${{ matrix.app }}
      registry: ${{ needs.detect-image-tag.outputs.registry }}
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
      github_repository_owner: ${{ needs.detect-image-tag.outputs.repo_owner_lower }}
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
      k8s_namespace: ${{ needs.detect-image-tag.outputs.k8s_namespace }}
      skip_build: false
      skip_deploy: false
    secrets:
      gh_token: ${{ needs.detect-image-tag.outputs.has_private_password == 'true' && secrets.PRIVATE_REGISTRY_PASSWORD || github.token }}
      K8S_SERVER: ${{ secrets.K8S_SERVER }}
      K8S_CA_CERT: ${{ secrets.K8S_CA_CERT }}
      K8S_TOKEN: ${{ secrets.K8S_TOKEN }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_KEY: ${{ secrets.SERVER_KEY }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SERVER_PAT: ${{ secrets.SERVER_PAT }}

  summary:
    name: Summary Successful Apps
    needs: [detect-image-tag, build-deploy-all]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      successful_apps: ${{ steps.collect.outputs.successful_apps }}
      successful_apps_json: ${{ steps.collect.outputs.successful_apps_json }}
      failed_apps: ${{ steps.collect.outputs.failed_apps }}
      failed_apps_json: ${{ steps.collect.outputs.failed_apps_json }}
      total_apps: ${{ steps.collect.outputs.total_apps }}
      success_count: ${{ steps.collect.outputs.success_count }}
      fail_count: ${{ steps.collect.outputs.fail_count }}
    steps:
      - name: Collect successful applications
        id: collect
        run: |
          echo "ğŸ“Š æ”¶é›†æ„å»ºå’Œéƒ¨ç½²ç»“æœ..."
          
          # è·å–å½“å‰å·¥ä½œæµè¿è¡Œ ID
          WORKFLOW_RUN_ID="${{ github.run_id }}"
          
          # è·å– GitHub Token
          GITHUB_TOKEN="${{ github.token }}"
          REPO="${{ github.repository }}"
          
          # é€šè¿‡ GitHub API è·å–æ‰€æœ‰ jobs çš„çŠ¶æ€
          echo "è·å–å·¥ä½œæµè¿è¡Œçš„æ‰€æœ‰ jobs..."
          JOBS_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/runs/$WORKFLOW_RUN_ID/jobs?per_page=100")
          
          # ä» jobs ä¸­åŠ¨æ€æå–åº”ç”¨åˆ—è¡¨ï¼ˆåŒ¹é… "Build and Deploy" å¼€å¤´çš„ jobsï¼‰
          # å¯å¤ç”¨å·¥ä½œæµçš„ job åç§°æ ¼å¼ä¸º "Build and Deploy $app"
          echo "ä»å®é™…è¿è¡Œçš„ jobs ä¸­æå–åº”ç”¨åˆ—è¡¨..."
          ALL_APPS_JSON=$(echo "$JOBS_JSON" | jq -r '[.jobs[] | select(.name | startswith("Build and Deploy")) | .name | sub("Build and Deploy "; "")] | unique | sort')
          
          # å°† JSON æ•°ç»„è½¬æ¢ä¸º bash æ•°ç»„
          ALL_APPS=()
          while IFS= read -r app; do
            if [ -n "$app" ] && [ "$app" != "null" ]; then
              # ç§»é™¤å¼•å·
              app=$(echo "$app" | tr -d '"')
              ALL_APPS+=("$app")
            fi
          done <<< "$(echo "$ALL_APPS_JSON" | jq -r '.[]')"
          
          echo "æ£€æµ‹åˆ°çš„åº”ç”¨åˆ—è¡¨: ${ALL_APPS[*]}"
          echo ""
          
          SUCCESSFUL_APPS=()
          FAILED_APPS=()
          
          echo "æ£€æŸ¥æ¯ä¸ªåº”ç”¨çš„æ„å»ºå’Œéƒ¨ç½²çŠ¶æ€..."
          
          # æ£€æŸ¥æ¯ä¸ªåº”ç”¨çš„è¿è¡ŒçŠ¶æ€
          for app in "${ALL_APPS[@]}"; do
            echo "æ£€æŸ¥ $app çš„çŠ¶æ€..."
            
            # æŸ¥æ‰¾åŒ…å«åº”ç”¨åç§°çš„ job
            # å¯å¤ç”¨å·¥ä½œæµçš„ job åç§°æ ¼å¼ä¸º "Build and Deploy $app"
            JOB_CONCLUSION=$(echo "$JOBS_JSON" | jq -r ".jobs[] | select(.name == \"Build and Deploy $app\") | .conclusion" | head -1)
            
            if [ "$JOB_CONCLUSION" = "success" ]; then
              SUCCESSFUL_APPS+=("$app")
              echo "  âœ… $app: æˆåŠŸ"
            elif [ "$JOB_CONCLUSION" = "failure" ] || [ "$JOB_CONCLUSION" = "cancelled" ]; then
              FAILED_APPS+=("$app")
              echo "  âŒ $app: å¤±è´¥ (çŠ¶æ€: $JOB_CONCLUSION)"
            else
              # å¦‚æœæ‰¾ä¸åˆ° job æˆ–çŠ¶æ€æœªçŸ¥ï¼Œæ£€æŸ¥æ˜¯å¦è¿˜åœ¨è¿è¡Œ
              JOB_STATUS=$(echo "$JOBS_JSON" | jq -r ".jobs[] | select(.name == \"Build and Deploy $app\") | .status" | head -1)
              if [ "$JOB_STATUS" = "in_progress" ] || [ "$JOB_STATUS" = "queued" ]; then
                echo "  â³ $app: è¿è¡Œä¸­ (çŠ¶æ€: $JOB_STATUS)"
                # è¿è¡Œä¸­çš„åº”ç”¨æš‚æ—¶ä¸åŠ å…¥å¤±è´¥åˆ—è¡¨
              else
                FAILED_APPS+=("$app")
                echo "  âŒ $app: æœªçŸ¥çŠ¶æ€ (çŠ¶æ€: ${JOB_CONCLUSION:-${JOB_STATUS:-unknown}})"
              fi
            fi
          done
          
          # ç”ŸæˆæˆåŠŸåº”ç”¨åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰
          if [ ${#SUCCESSFUL_APPS[@]} -gt 0 ]; then
            SUCCESSFUL_APPS_STR=$(IFS=','; echo "${SUCCESSFUL_APPS[*]}")
            echo "successful_apps=$SUCCESSFUL_APPS_STR" >> $GITHUB_OUTPUT
          else
            echo "successful_apps=" >> $GITHUB_OUTPUT
          fi
          
          # ç”Ÿæˆå¤±è´¥åº”ç”¨åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰
          if [ ${#FAILED_APPS[@]} -gt 0 ]; then
            FAILED_APPS_STR=$(IFS=','; echo "${FAILED_APPS[*]}")
            echo "failed_apps=$FAILED_APPS_STR" >> $GITHUB_OUTPUT
          else
            echo "failed_apps=" >> $GITHUB_OUTPUT
          fi
          
          # ç”Ÿæˆ JSON æ ¼å¼çš„æˆåŠŸåº”ç”¨åˆ—è¡¨ï¼ˆç”¨äº webhookï¼‰
          SUCCESSFUL_APPS_JSON="["
          for i in "${!SUCCESSFUL_APPS[@]}"; do
            if [ $i -gt 0 ]; then
              SUCCESSFUL_APPS_JSON+=","
            fi
            SUCCESSFUL_APPS_JSON+="\"${SUCCESSFUL_APPS[$i]}\""
          done
          SUCCESSFUL_APPS_JSON+="]"
          {
            echo "successful_apps_json<<EOF"
            echo "$SUCCESSFUL_APPS_JSON"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆ JSON æ ¼å¼çš„å¤±è´¥åº”ç”¨åˆ—è¡¨
          FAILED_APPS_JSON="["
          for i in "${!FAILED_APPS[@]}"; do
            if [ $i -gt 0 ]; then
              FAILED_APPS_JSON+=","
            fi
            FAILED_APPS_JSON+="\"${FAILED_APPS[$i]}\""
          done
          FAILED_APPS_JSON+="]"
          {
            echo "failed_apps_json<<EOF"
            echo "$FAILED_APPS_JSON"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # ç»Ÿè®¡ä¿¡æ¯
          TOTAL_APPS=${#ALL_APPS[@]}
          SUCCESS_COUNT=${#SUCCESSFUL_APPS[@]}
          FAIL_COUNT=${#FAILED_APPS[@]}
          
          echo "total_apps=$TOTAL_APPS" >> $GITHUB_OUTPUT
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š æ„å»ºå’Œéƒ¨ç½²ç»“æœæ±‡æ€»"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "æ€»åº”ç”¨æ•°: $TOTAL_APPS"
          echo "æˆåŠŸ: $SUCCESS_COUNT"
          echo "å¤±è´¥: $FAIL_COUNT"
          echo ""
          if [ $SUCCESS_COUNT -gt 0 ]; then
            echo "âœ… æˆåŠŸåº”ç”¨:"
            for app in "${SUCCESSFUL_APPS[@]}"; do
              echo "  - $app"
            done
          fi
          echo ""
          if [ $FAIL_COUNT -gt 0 ]; then
            echo "âŒ å¤±è´¥åº”ç”¨:"
            for app in "${FAILED_APPS[@]}"; do
              echo "  - $app"
            done
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
      - name: Generate summary report
        run: |
          TOTAL_APPS="${{ steps.collect.outputs.total_apps }}"
          SUCCESS_COUNT="${{ steps.collect.outputs.success_count }}"
          FAIL_COUNT="${{ steps.collect.outputs.fail_count }}"
          SUCCESSFUL_APPS="${{ steps.collect.outputs.successful_apps }}"
          FAILED_APPS="${{ steps.collect.outputs.failed_apps }}"
          SUCCESSFUL_APPS_JSON="${{ steps.collect.outputs.successful_apps_json }}"
          IMAGE_TAG="${{ needs.detect-image-tag.outputs.image_tag }}"
          REGISTRY="${{ needs.detect-image-tag.outputs.registry }}"
          K8S_NAMESPACE="${{ needs.detect-image-tag.outputs.k8s_namespace }}"
          GIT_SHA="${{ github.sha }}"
          
          {
            echo "## ğŸ“Š æ„å»ºå’Œéƒ¨ç½²ç»“æœæ±‡æ€»"
            echo ""
            echo "### ç»Ÿè®¡ä¿¡æ¯"
            echo "- **æ€»åº”ç”¨æ•°**: $TOTAL_APPS"
            echo "- **æˆåŠŸ**: $SUCCESS_COUNT"
            echo "- **å¤±è´¥**: $FAIL_COUNT"
            echo ""
          } >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$SUCCESSFUL_APPS" ] && [ "$SUCCESSFUL_APPS" != "" ]; then
            {
              echo "### âœ… æˆåŠŸåº”ç”¨"
              IFS=',' read -ra APPS <<< "$SUCCESSFUL_APPS"
              for app in "${APPS[@]}"; do
                echo "- \`$app\`"
              done
              echo ""
            } >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$FAILED_APPS" ] && [ "$FAILED_APPS" != "" ]; then
            {
              echo "### âŒ å¤±è´¥åº”ç”¨"
              IFS=',' read -ra APPS <<< "$FAILED_APPS"
              for app in "${APPS[@]}"; do
                echo "- \`$app\`"
              done
              echo ""
            } >> $GITHUB_STEP_SUMMARY
          fi
          
          {
            echo "### ğŸ“‹ è¯¦ç»†ä¿¡æ¯"
            echo "- **é•œåƒæ ‡ç­¾**: $IMAGE_TAG"
            echo "- **ä»“åº“**: $REGISTRY"
            echo "- **å‘½åç©ºé—´**: $K8S_NAMESPACE"
            echo "- **Git SHA**: $GIT_SHA"
            echo ""
            echo "### ğŸ”— Webhook æ•°æ®"
            echo "æˆåŠŸåº”ç”¨ JSON: \`$SUCCESSFUL_APPS_JSON\`"
            echo ""
            echo "> ğŸ’¡ æ­¤æ•°æ®å¯ç”¨äºé€šç”¨è¿ç»´ç³»ç»Ÿçš„ webhook é€šçŸ¥"
          } >> $GITHUB_STEP_SUMMARY
