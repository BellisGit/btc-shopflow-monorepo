name: Build and Deploy All Apps to K8s (Parallel)

# å®Œæ•´çš„å·¥ä½œæµï¼šå¹¶è¡Œæ„å»ºæ‰€æœ‰åº”ç”¨ï¼Œæ¯ä¸ªåº”ç”¨æ„å»ºå®Œæˆåç«‹å³éƒ¨ç½²
# - è§¦å‘æ¡ä»¶ï¼š
#   1. workflow_dispatchï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
#   2. push åˆ° master åˆ†æ”¯ï¼ˆå¯é€‰ï¼‰
# - åŠŸèƒ½ï¼š
#   1. å¹¶è¡Œæ„å»ºæ‰€æœ‰åº”ç”¨ï¼ˆä½¿ç”¨å¯å¤ç”¨å·¥ä½œæµï¼‰
#   2. æ¯ä¸ªåº”ç”¨æ„å»ºå®Œæˆåç«‹å³éƒ¨ç½²ï¼ˆä¸ç­‰å¾…å…¶ä»–åº”ç”¨ï¼‰
#   3. æ‰€æœ‰åº”ç”¨çš„æ„å»ºå’Œéƒ¨ç½²éƒ½åœ¨åŒä¸€ä¸ªä¸»å·¥ä½œæµå†…å®Œæˆ
# - é…ç½®è¯´æ˜ï¼š
#   1. é•œåƒä»“åº“é…ç½®ï¼ˆåœ¨ GitHub Secrets ä¸­è®¾ç½®ï¼‰ï¼š
#      - PRIVATE_REGISTRY: é•œåƒä»“åº“åœ°å€ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ ghcr.ioï¼‰
#      - PRIVATE_REGISTRY_USERNAME: ä»“åº“ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰
#      - PRIVATE_REGISTRY_PASSWORD: ä»“åº“å¯†ç /Tokenï¼ˆå¯é€‰ï¼‰
#   2. K8s éƒ¨ç½²é…ç½®ï¼ˆåœ¨ GitHub Secrets ä¸­è®¾ç½®ï¼‰ï¼š
#      - K8S_SERVER: K8s API æœåŠ¡å™¨åœ°å€
#      - K8S_CA_CERT: K8s CA è¯ä¹¦ï¼ˆbase64 ç¼–ç ï¼‰
#      - K8S_TOKEN: K8s è®¿é—®ä»¤ç‰Œ
#      - K8S_NAMESPACE: K8s å‘½åç©ºé—´ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼šbtc-shopflowï¼‰

on:
  repository_dispatch:
    types: [build-deploy-all-k8s]
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip build step'
        required: false
        type: boolean
        default: false
      skip_deploy:
        description: 'Skip deploy step'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  detect-config:
    name: Detect and Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      registry: ${{ steps.config.outputs.registry }}
      registry_username: ${{ steps.config.outputs.registry_username }}
      registry_password: ${{ steps.config.outputs.registry_password }}
      use_ghcr: ${{ steps.config.outputs.use_ghcr }}
      needs_auth: ${{ steps.config.outputs.needs_auth }}
      repo_owner_lower: ${{ steps.config.outputs.repo_owner_lower }}
      image_tag: ${{ steps.config.outputs.image_tag }}
      skip_build: ${{ steps.config.outputs.skip_build }}
      skip_deploy: ${{ steps.config.outputs.skip_deploy }}
    steps:
      - name: Detect registry configuration
        id: config
        run: |
          echo "ğŸ” æ£€æµ‹é•œåƒä»“åº“é…ç½®..."
          
          # è½¬æ¢ä»“åº“æ‰€æœ‰è€…åç§°ä¸ºå°å†™
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner_lower=$REPO_OWNER_LOWER" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆé•œåƒæ ‡ç­¾ï¼ˆä½¿ç”¨ SHA å‰7ä½ï¼‰
          # ä¼˜å…ˆä½¿ç”¨ client_payload ä¸­çš„ github_shaï¼Œå¦åˆ™ä½¿ç”¨å½“å‰ commit SHA
          if [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            GIT_SHA="${{ github.event.client_payload.github_sha }}"
          else
            GIT_SHA="${{ github.sha }}"
          fi
          IMAGE_TAG="${GIT_SHA:0:7}"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          # ä» client_payload è·å– skip_build å’Œ skip_deploy
          if [ "${{ github.event.client_payload.skip_build }}" = "true" ]; then
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "skip_build=${{ github.event.inputs.skip_build }}" >> $GITHUB_OUTPUT
          fi
          
          if [ "${{ github.event.client_payload.skip_deploy }}" = "true" ]; then
            echo "skip_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "skip_deploy=${{ github.event.inputs.skip_deploy }}" >> $GITHUB_OUTPUT
          fi
          
          # æ£€æµ‹æ˜¯å¦é…ç½®äº†ç§æœ‰ä»“åº“
          if [ -n "${{ secrets.PRIVATE_REGISTRY }}" ]; then
            PRIVATE_REGISTRY="${{ secrets.PRIVATE_REGISTRY }}"
            echo "âœ… æ£€æµ‹åˆ°ç§æœ‰ä»“åº“é…ç½®: $PRIVATE_REGISTRY"
            echo "registry=$PRIVATE_REGISTRY" >> $GITHUB_OUTPUT
            echo "use_ghcr=false" >> $GITHUB_OUTPUT
            
            # æ£€æµ‹æ˜¯å¦éœ€è¦è®¤è¯
            if [ -n "${{ secrets.PRIVATE_REGISTRY_USERNAME }}" ] && [ -n "${{ secrets.PRIVATE_REGISTRY_PASSWORD }}" ]; then
              echo "âœ… æ£€æµ‹åˆ°è®¤è¯é…ç½®ï¼Œå°†ä½¿ç”¨è®¤è¯ç™»å½•"
              {
                echo "registry_username<<EOF"
                echo "${{ secrets.PRIVATE_REGISTRY_USERNAME }}"
                echo "EOF"
              } >> $GITHUB_OUTPUT
              {
                echo "registry_password<<EOF"
                echo "${{ secrets.PRIVATE_REGISTRY_PASSWORD }}"
                echo "EOF"
              } >> $GITHUB_OUTPUT
              echo "needs_auth=true" >> $GITHUB_OUTPUT
            else
              echo "â„¹ï¸  æœªé…ç½®è®¤è¯ä¿¡æ¯ï¼Œå°†å°è¯•åŒ¿åè®¿é—®ï¼ˆé€‚ç”¨äºä¸éœ€è¦è®¤è¯çš„ç§æœ‰ä»“åº“ï¼‰"
              echo "registry_username=" >> $GITHUB_OUTPUT
              echo "registry_password=" >> $GITHUB_OUTPUT
              echo "needs_auth=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… æœªé…ç½®ç§æœ‰ä»“åº“ï¼Œå°†ä½¿ç”¨ GitHub Container Registry (GHCR)"
            echo "registry=ghcr.io" >> $GITHUB_OUTPUT
            echo "use_ghcr=true" >> $GITHUB_OUTPUT
            {
              echo "registry_username<<EOF"
              echo "${{ github.actor }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            {
              echo "registry_password<<EOF"
              echo "${{ github.token }}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "needs_auth=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_SHA: ${{ github.sha }}

  build-deploy-all:
    name: Build and Deploy All Apps (Parallel)
    needs: detect-config
    strategy:
      fail-fast: false
      matrix:
        app:
          - system-app
          - admin-app
          - logistics-app
          - quality-app
          - production-app
          - engineering-app
          - finance-app
          - mobile-app
    uses: ./.github/workflows/build-deploy-app-k8s-reusable.yml
    with:
      app_name: ${{ matrix.app }}
      registry: ${{ needs.detect-config.outputs.registry }}
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
      github_repository_owner: ${{ needs.detect-config.outputs.repo_owner_lower }}
      image_tag: ${{ needs.detect-config.outputs.image_tag }}
      k8s_namespace: ${{ secrets.K8S_NAMESPACE || 'btc-shopflow' }}
      skip_build: ${{ needs.detect-config.outputs.skip_build == 'true' }}
      skip_deploy: ${{ needs.detect-config.outputs.skip_deploy == 'true' }}
    secrets:
      gh_token: ${{ needs.detect-config.outputs.registry_password || github.token }}
      K8S_SERVER: ${{ secrets.K8S_SERVER }}
      K8S_CA_CERT: ${{ secrets.K8S_CA_CERT }}
      K8S_TOKEN: ${{ secrets.K8S_TOKEN }}

