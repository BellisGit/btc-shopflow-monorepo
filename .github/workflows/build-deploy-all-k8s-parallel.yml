name: Build and Deploy All Apps

on:
  repository_dispatch:
    types: [build-deploy-all-k8s]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  detect-image-tag:
    name: Detect Image Tag
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
      repo_owner_lower: ${{ steps.detect.outputs.repo_owner_lower }}
      registry: ${{ steps.detect.outputs.registry }}
      k8s_namespace: ${{ steps.detect.outputs.k8s_namespace }}
      has_private_password: ${{ steps.detect.outputs.has_private_password }}
    steps:
      - name: Detect image tag and repository owner
        id: detect
        run: |
          echo "ğŸ” å¼€å§‹æ£€æµ‹é•œåƒæ ‡ç­¾å’Œä»“åº“ä¿¡æ¯..."
          echo "  - client_payload.github_sha: ${{ github.event.client_payload.github_sha }}"
          echo "  - github.sha: ${{ github.sha }}"
          
          # è½¬æ¢ä»“åº“æ‰€æœ‰è€…åç§°ä¸ºå°å†™
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner_lower=$REPO_OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "  âœ… ä»“åº“æ‰€æœ‰è€…ï¼ˆå°å†™ï¼‰: $REPO_OWNER_LOWER"
          
          # ç”Ÿæˆé•œåƒæ ‡ç­¾ï¼ˆä½¿ç”¨ SHA å‰7ä½ï¼‰
          if [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            GIT_SHA="${{ github.event.client_payload.github_sha }}"
            echo "  âœ… ä» client_payload.github_sha è·å–: $GIT_SHA"
          else
            GIT_SHA="${{ github.sha }}"
            echo "  âœ… ä» github.sha è·å–: $GIT_SHA"
          fi
          
          if [ ${#GIT_SHA} -gt 7 ]; then
            IMAGE_TAG="${GIT_SHA:0:7}"
          elif [ ${#GIT_SHA} -lt 7 ]; then
            IMAGE_TAG="latest"
            echo "  âš ï¸  SHA å¤ªçŸ­ï¼Œä½¿ç”¨ latest"
          else
            IMAGE_TAG="$GIT_SHA"
          fi
          
          if [ -z "$IMAGE_TAG" ]; then
            echo "  âš ï¸  æ ‡ç­¾ä¸ºç©ºï¼Œä½¿ç”¨ latest"
            IMAGE_TAG="latest"
          fi
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "âœ… æœ€ç»ˆé•œåƒæ ‡ç­¾: $IMAGE_TAG"
          
          # æ£€æµ‹é•œåƒä»“åº“ï¼ˆé»˜è®¤ä½¿ç”¨ ghcr.ioï¼‰
          if [ -n "${{ secrets.PRIVATE_REGISTRY }}" ]; then
            REGISTRY="${{ secrets.PRIVATE_REGISTRY }}"
            echo "  âœ… ä½¿ç”¨ç§æœ‰ä»“åº“: $REGISTRY"
          else
            REGISTRY="ghcr.io"
            echo "  âœ… ä½¿ç”¨é»˜è®¤ä»“åº“: $REGISTRY"
          fi
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT
          
          # æ£€æµ‹ K8s å‘½åç©ºé—´ï¼ˆé»˜è®¤ä½¿ç”¨ btc-shopflowï¼‰
          if [ -n "${{ secrets.K8S_NAMESPACE }}" ]; then
            K8S_NAMESPACE="${{ secrets.K8S_NAMESPACE }}"
            echo "  âœ… ä½¿ç”¨ K8s å‘½åç©ºé—´: $K8S_NAMESPACE"
          else
            K8S_NAMESPACE="btc-shopflow"
            echo "  âœ… ä½¿ç”¨é»˜è®¤ K8s å‘½åç©ºé—´: $K8S_NAMESPACE"
          fi
          echo "k8s_namespace=$K8S_NAMESPACE" >> $GITHUB_OUTPUT
          
          # æ£€æµ‹æ˜¯å¦æœ‰ç§æœ‰ä»“åº“å¯†ç ï¼ˆç”¨äºå†³å®šä½¿ç”¨å“ªä¸ª tokenï¼‰
          if [ -n "${{ secrets.PRIVATE_REGISTRY_PASSWORD }}" ]; then
            echo "has_private_password=true" >> $GITHUB_OUTPUT
            echo "  âœ… æ£€æµ‹åˆ°ç§æœ‰ä»“åº“å¯†ç "
          else
            echo "has_private_password=false" >> $GITHUB_OUTPUT
            echo "  âœ… æœªé…ç½®ç§æœ‰ä»“åº“å¯†ç ï¼Œå°†ä½¿ç”¨ github.token"
          fi
          

  build-deploy-all:
    name: Build and Deploy All Apps (Parallel)
    needs: detect-image-tag
    strategy:
      fail-fast: false
      matrix:
        app:
          - system-app
          - admin-app
          - logistics-app
          - quality-app
          - production-app
          - engineering-app
          - finance-app
          - mobile-app
    uses: ./.github/workflows/build-deploy-app-k8s-reusable.yml
    with:
      app_name: ${{ matrix.app }}
      registry: ${{ needs.detect-image-tag.outputs.registry }}
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
      github_repository_owner: ${{ needs.detect-image-tag.outputs.repo_owner_lower }}
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
      k8s_namespace: ${{ needs.detect-image-tag.outputs.k8s_namespace }}
      skip_build: false
      skip_deploy: false
    secrets:
      gh_token: ${{ secrets.PRIVATE_REGISTRY_PASSWORD }}
      K8S_SERVER: ${{ secrets.K8S_SERVER }}
      K8S_CA_CERT: ${{ secrets.K8S_CA_CERT }}
      K8S_TOKEN: ${{ secrets.K8S_TOKEN }}
