name: Build and Deploy All Apps

on:
  repository_dispatch:
    types: [build-deploy-all-k8s]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  actions: read
  checks: read

jobs:
  detect-image-tag:
    name: Detect Image Tag
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
      repo_owner_lower: ${{ steps.detect.outputs.repo_owner_lower }}
      registry: ${{ steps.detect.outputs.registry }}
      k8s_namespace: ${{ steps.detect.outputs.k8s_namespace }}
      has_private_password: ${{ steps.detect.outputs.has_private_password }}
    steps:
      - name: Detect image tag and repository owner
        id: detect
        run: |
          echo "üîç ÂºÄÂßãÊ£ÄÊµãÈïúÂÉèÊ†áÁ≠æÂíå‰ªìÂ∫ì‰ø°ÊÅØ..."
          echo "  - client_payload.github_sha: ${{ github.event.client_payload.github_sha }}"
          echo "  - github.sha: ${{ github.sha }}"
          
          # ËΩ¨Êç¢‰ªìÂ∫ìÊâÄÊúâËÄÖÂêçÁß∞‰∏∫Â∞èÂÜô
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner_lower=$REPO_OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "  ‚úÖ ‰ªìÂ∫ìÊâÄÊúâËÄÖÔºàÂ∞èÂÜôÔºâ: $REPO_OWNER_LOWER"
          
          # ÁîüÊàêÈïúÂÉèÊ†áÁ≠æÔºà‰ΩøÁî® SHA Ââç7‰ΩçÔºâ
          if [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            GIT_SHA="${{ github.event.client_payload.github_sha }}"
            echo "  ‚úÖ ‰ªé client_payload.github_sha Ëé∑Âèñ: $GIT_SHA"
          else
            GIT_SHA="${{ github.sha }}"
            echo "  ‚úÖ ‰ªé github.sha Ëé∑Âèñ: $GIT_SHA"
          fi
          
          if [ ${#GIT_SHA} -gt 7 ]; then
            IMAGE_TAG="${GIT_SHA:0:7}"
          elif [ ${#GIT_SHA} -lt 7 ]; then
            IMAGE_TAG="latest"
            echo "  ‚ö†Ô∏è  SHA Â§™Áü≠Ôºå‰ΩøÁî® latest"
          else
            IMAGE_TAG="$GIT_SHA"
          fi
          
          if [ -z "$IMAGE_TAG" ]; then
            echo "  ‚ö†Ô∏è  Ê†áÁ≠æ‰∏∫Á©∫Ôºå‰ΩøÁî® latest"
            IMAGE_TAG="latest"
          fi
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "‚úÖ ÊúÄÁªàÈïúÂÉèÊ†áÁ≠æ: $IMAGE_TAG"
          
          # Ê£ÄÊµãÈïúÂÉè‰ªìÂ∫ìÔºàÈªòËÆ§‰ΩøÁî® ghcr.ioÔºâ
          if [ -n "${{ secrets.PRIVATE_REGISTRY }}" ]; then
            REGISTRY="${{ secrets.PRIVATE_REGISTRY }}"
            echo "  ‚úÖ ‰ΩøÁî®ÁßÅÊúâ‰ªìÂ∫ì: $REGISTRY"
          else
            REGISTRY="ghcr.io"
            echo "  ‚úÖ ‰ΩøÁî®ÈªòËÆ§‰ªìÂ∫ì: $REGISTRY"
          fi
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT
          
          # Ê£ÄÊµã K8s ÂëΩÂêçÁ©∫Èó¥ÔºàÈªòËÆ§‰ΩøÁî® btc-shopflowÔºâ
          if [ -n "${{ secrets.K8S_NAMESPACE }}" ]; then
            K8S_NAMESPACE="${{ secrets.K8S_NAMESPACE }}"
            echo "  ‚úÖ ‰ΩøÁî® K8s ÂëΩÂêçÁ©∫Èó¥: $K8S_NAMESPACE"
          else
            K8S_NAMESPACE="btc-shopflow"
            echo "  ‚úÖ ‰ΩøÁî®ÈªòËÆ§ K8s ÂëΩÂêçÁ©∫Èó¥: $K8S_NAMESPACE"
          fi
          echo "k8s_namespace=$K8S_NAMESPACE" >> $GITHUB_OUTPUT
          
          # Ê£ÄÊµãÊòØÂê¶ÊúâÁßÅÊúâ‰ªìÂ∫ìÂØÜÁ†ÅÔºàÁî®‰∫éÂÜ≥ÂÆö‰ΩøÁî®Âì™‰∏™ tokenÔºâ
          if [ -n "${{ secrets.PRIVATE_REGISTRY_PASSWORD }}" ]; then
            echo "has_private_password=true" >> $GITHUB_OUTPUT
            echo "  ‚úÖ Ê£ÄÊµãÂà∞ÁßÅÊúâ‰ªìÂ∫ìÂØÜÁ†Å"
          else
            echo "has_private_password=false" >> $GITHUB_OUTPUT
            echo "  ‚úÖ Êú™ÈÖçÁΩÆÁßÅÊúâ‰ªìÂ∫ìÂØÜÁ†ÅÔºåÂ∞Ü‰ΩøÁî® github.token"
          fi
          

  build-deploy-all:
    name: Build and Deploy All Apps (Parallel)
    needs: detect-image-tag
    strategy:
      fail-fast: false
      matrix:
        app:
          - system-app
          - admin-app
          - logistics-app
          - quality-app
          - production-app
          - engineering-app
          - finance-app
          - mobile-app
    uses: ./.github/workflows/build-deploy-app-k8s-reusable.yml
    with:
      app_name: ${{ matrix.app }}
      registry: ${{ needs.detect-image-tag.outputs.registry }}
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
      github_repository_owner: ${{ needs.detect-image-tag.outputs.repo_owner_lower }}
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
      k8s_namespace: ${{ needs.detect-image-tag.outputs.k8s_namespace }}
      skip_build: false
      skip_deploy: false
    secrets:
      gh_token: ${{ secrets.PRIVATE_REGISTRY_PASSWORD }}
      K8S_SERVER: ${{ secrets.K8S_SERVER }}
      K8S_CA_CERT: ${{ secrets.K8S_CA_CERT }}
      K8S_TOKEN: ${{ secrets.K8S_TOKEN }}

  summary:
    name: Summary Successful Apps
    needs: [detect-image-tag, build-deploy-all]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      successful_apps: ${{ steps.collect.outputs.successful_apps }}
      successful_apps_json: ${{ steps.collect.outputs.successful_apps_json }}
      failed_apps: ${{ steps.collect.outputs.failed_apps }}
      failed_apps_json: ${{ steps.collect.outputs.failed_apps_json }}
      total_apps: ${{ steps.collect.outputs.total_apps }}
      success_count: ${{ steps.collect.outputs.success_count }}
      fail_count: ${{ steps.collect.outputs.fail_count }}
    steps:
      - name: Collect successful applications
        id: collect
        run: |
          echo "üìä Êî∂ÈõÜÊûÑÂª∫ÂíåÈÉ®ÁΩ≤ÁªìÊûú..."
          
          # ÂÆö‰πâÊâÄÊúâÂ∫îÁî®ÂàóË°®Ôºà‰∏é matrix ‰∏≠ÁöÑÂ∫îÁî®ÂàóË°®ÂØπÂ∫îÔºâ
          ALL_APPS=("system-app" "admin-app" "logistics-app" "quality-app" "production-app" "engineering-app" "finance-app" "mobile-app")
          
          # Ëé∑ÂèñÂΩìÂâçÂ∑•‰ΩúÊµÅËøêË°å ID
          WORKFLOW_RUN_ID="${{ github.run_id }}"
          
          # Ëé∑Âèñ GitHub Token
          GITHUB_TOKEN="${{ github.token }}"
          REPO="${{ github.repository }}"
          
          SUCCESSFUL_APPS=()
          FAILED_APPS=()
          
          echo "Ê£ÄÊü•ÊØè‰∏™Â∫îÁî®ÁöÑÊûÑÂª∫ÂíåÈÉ®ÁΩ≤Áä∂ÊÄÅ..."
          
          # ÈÄöËøá GitHub API Ëé∑ÂèñÊâÄÊúâ jobs ÁöÑÁä∂ÊÄÅ
          echo "Ëé∑ÂèñÂ∑•‰ΩúÊµÅËøêË°åÁöÑÊâÄÊúâ jobs..."
          JOBS_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/runs/$WORKFLOW_RUN_ID/jobs?per_page=100")
          
          # Ê£ÄÊü•ÊØè‰∏™Â∫îÁî®ÁöÑËøêË°åÁä∂ÊÄÅ
          for app in "${ALL_APPS[@]}"; do
            echo "Ê£ÄÊü• $app ÁöÑÁä∂ÊÄÅ..."
            
            # Êü•ÊâæÂåÖÂê´Â∫îÁî®ÂêçÁß∞ÁöÑ job
            # ÂèØÂ§çÁî®Â∑•‰ΩúÊµÅÁöÑ job ÂêçÁß∞Ê†ºÂºè‰∏∫ "Build and Deploy $app"
            JOB_CONCLUSION=$(echo "$JOBS_JSON" | jq -r ".jobs[] | select(.name | contains(\"$app\")) | .conclusion" | head -1)
            
            if [ "$JOB_CONCLUSION" = "success" ]; then
              SUCCESSFUL_APPS+=("$app")
              echo "  ‚úÖ $app: ÊàêÂäü"
            elif [ "$JOB_CONCLUSION" = "failure" ] || [ "$JOB_CONCLUSION" = "cancelled" ]; then
              FAILED_APPS+=("$app")
              echo "  ‚ùå $app: Â§±Ë¥• (Áä∂ÊÄÅ: $JOB_CONCLUSION)"
            else
              # Â¶ÇÊûúÊâæ‰∏çÂà∞ job ÊàñÁä∂ÊÄÅÊú™Áü•ÔºåÊ£ÄÊü•ÊòØÂê¶ËøòÂú®ËøêË°å
              JOB_STATUS=$(echo "$JOBS_JSON" | jq -r ".jobs[] | select(.name | contains(\"$app\")) | .status" | head -1)
              if [ "$JOB_STATUS" = "in_progress" ] || [ "$JOB_STATUS" = "queued" ]; then
                echo "  ‚è≥ $app: ËøêË°å‰∏≠ (Áä∂ÊÄÅ: $JOB_STATUS)"
                # ËøêË°å‰∏≠ÁöÑÂ∫îÁî®ÊöÇÊó∂‰∏çÂä†ÂÖ•Â§±Ë¥•ÂàóË°®
              else
                FAILED_APPS+=("$app")
                echo "  ‚ùå $app: Êú™Áü•Áä∂ÊÄÅ (Áä∂ÊÄÅ: ${JOB_CONCLUSION:-${JOB_STATUS:-unknown}})"
              fi
            fi
          done
          
          # ÁîüÊàêÊàêÂäüÂ∫îÁî®ÂàóË°®ÔºàÈÄóÂè∑ÂàÜÈöîÔºâ
          if [ ${#SUCCESSFUL_APPS[@]} -gt 0 ]; then
            SUCCESSFUL_APPS_STR=$(IFS=','; echo "${SUCCESSFUL_APPS[*]}")
            echo "successful_apps=$SUCCESSFUL_APPS_STR" >> $GITHUB_OUTPUT
          else
            echo "successful_apps=" >> $GITHUB_OUTPUT
          fi
          
          # ÁîüÊàêÂ§±Ë¥•Â∫îÁî®ÂàóË°®ÔºàÈÄóÂè∑ÂàÜÈöîÔºâ
          if [ ${#FAILED_APPS[@]} -gt 0 ]; then
            FAILED_APPS_STR=$(IFS=','; echo "${FAILED_APPS[*]}")
            echo "failed_apps=$FAILED_APPS_STR" >> $GITHUB_OUTPUT
          else
            echo "failed_apps=" >> $GITHUB_OUTPUT
          fi
          
          # ÁîüÊàê JSON Ê†ºÂºèÁöÑÊàêÂäüÂ∫îÁî®ÂàóË°®ÔºàÁî®‰∫é webhookÔºâ
          SUCCESSFUL_APPS_JSON="["
          for i in "${!SUCCESSFUL_APPS[@]}"; do
            if [ $i -gt 0 ]; then
              SUCCESSFUL_APPS_JSON+=","
            fi
            SUCCESSFUL_APPS_JSON+="\"${SUCCESSFUL_APPS[$i]}\""
          done
          SUCCESSFUL_APPS_JSON+="]"
          {
            echo "successful_apps_json<<EOF"
            echo "$SUCCESSFUL_APPS_JSON"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # ÁîüÊàê JSON Ê†ºÂºèÁöÑÂ§±Ë¥•Â∫îÁî®ÂàóË°®
          FAILED_APPS_JSON="["
          for i in "${!FAILED_APPS[@]}"; do
            if [ $i -gt 0 ]; then
              FAILED_APPS_JSON+=","
            fi
            FAILED_APPS_JSON+="\"${FAILED_APPS[$i]}\""
          done
          FAILED_APPS_JSON+="]"
          {
            echo "failed_apps_json<<EOF"
            echo "$FAILED_APPS_JSON"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # ÁªüËÆ°‰ø°ÊÅØ
          TOTAL_APPS=${#ALL_APPS[@]}
          SUCCESS_COUNT=${#SUCCESSFUL_APPS[@]}
          FAIL_COUNT=${#FAILED_APPS[@]}
          
          echo "total_apps=$TOTAL_APPS" >> $GITHUB_OUTPUT
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä ÊûÑÂª∫ÂíåÈÉ®ÁΩ≤ÁªìÊûúÊ±áÊÄª"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "ÊÄªÂ∫îÁî®Êï∞: $TOTAL_APPS"
          echo "ÊàêÂäü: $SUCCESS_COUNT"
          echo "Â§±Ë¥•: $FAIL_COUNT"
          echo ""
          if [ $SUCCESS_COUNT -gt 0 ]; then
            echo "‚úÖ ÊàêÂäüÂ∫îÁî®:"
            for app in "${SUCCESSFUL_APPS[@]}"; do
              echo "  - $app"
            done
          fi
          echo ""
          if [ $FAIL_COUNT -gt 0 ]; then
            echo "‚ùå Â§±Ë¥•Â∫îÁî®:"
            for app in "${FAILED_APPS[@]}"; do
              echo "  - $app"
            done
          fi
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
      - name: Generate summary report
        run: |
          echo "## üìä ÊûÑÂª∫ÂíåÈÉ®ÁΩ≤ÁªìÊûúÊ±áÊÄª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ÁªüËÆ°‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
          echo "- **ÊÄªÂ∫îÁî®Êï∞**: ${{ steps.collect.outputs.total_apps }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ÊàêÂäü**: ${{ steps.collect.outputs.success_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Â§±Ë¥•**: ${{ steps.collect.outputs.fail_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.collect.outputs.successful_apps }}" ]; then
            echo "### ‚úÖ ÊàêÂäüÂ∫îÁî®" >> $GITHUB_STEP_SUMMARY
            SUCCESSFUL_APPS="${{ steps.collect.outputs.successful_apps }}"
            IFS=',' read -ra APPS <<< "$SUCCESSFUL_APPS"
            for app in "${APPS[@]}"; do
              echo "- \`$app\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ steps.collect.outputs.failed_apps }}" ]; then
            echo "### ‚ùå Â§±Ë¥•Â∫îÁî®" >> $GITHUB_STEP_SUMMARY
            FAILED_APPS="${{ steps.collect.outputs.failed_apps }}"
            IFS=',' read -ra APPS <<< "$FAILED_APPS"
            for app in "${APPS[@]}"; do
              echo "- \`$app\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### üìã ËØ¶ÁªÜ‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
          echo "- **ÈïúÂÉèÊ†áÁ≠æ**: ${{ needs.detect-image-tag.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **‰ªìÂ∫ì**: ${{ needs.detect-image-tag.outputs.registry }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ÂëΩÂêçÁ©∫Èó¥**: ${{ needs.detect-image-tag.outputs.k8s_namespace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Git SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Webhook Êï∞ÊçÆ" >> $GITHUB_STEP_SUMMARY
          echo "ÊàêÂäüÂ∫îÁî® JSON: \`${{ steps.collect.outputs.successful_apps_json }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> üí° Ê≠§Êï∞ÊçÆÂèØÁî®‰∫éÈÄöÁî®ËøêÁª¥Á≥ªÁªüÁöÑ webhook ÈÄöÁü•" >> $GITHUB_STEP_SUMMARY
