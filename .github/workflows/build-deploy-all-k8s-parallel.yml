name: Build and Deploy All Apps to K8s (Parallel)

# ÂÆåÊï¥ÁöÑÂ∑•‰ΩúÊµÅÔºöÂπ∂Ë°åÊûÑÂª∫ÊâÄÊúâÂ∫îÁî®ÔºåÊØè‰∏™Â∫îÁî®ÊûÑÂª∫ÂÆåÊàêÂêéÁ´ãÂç≥ÈÉ®ÁΩ≤
# - Ëß¶ÂèëÊù°‰ª∂Ôºö
#   1. repository_dispatchÔºàÈÄöËøáËÑöÊú¨Ëß¶ÂèëÔºåevent_type: build-deploy-all-k8sÔºâ
#   2. workflow_dispatchÔºàÊâãÂä®Ëß¶ÂèëÔºâ
# - ÂäüËÉΩÔºö
#   1. Âπ∂Ë°åÊûÑÂª∫ÊâÄÊúâÂ∫îÁî®Ôºà‰ΩøÁî®ÂèØÂ§çÁî®Â∑•‰ΩúÊµÅÔºâ
#   2. ÊØè‰∏™Â∫îÁî®ÊûÑÂª∫ÂÆåÊàêÂêéÁ´ãÂç≥ÈÉ®ÁΩ≤Ôºà‰∏çÁ≠âÂæÖÂÖ∂‰ªñÂ∫îÁî®Ôºâ
#   3. ÊâÄÊúâÂ∫îÁî®ÁöÑÊûÑÂª∫ÂíåÈÉ®ÁΩ≤ÈÉΩÂú®Âêå‰∏Ä‰∏™‰∏ªÂ∑•‰ΩúÊµÅÂÜÖÂÆåÊàê
# - ÈÖçÁΩÆËØ¥ÊòéÔºö
#   1. ÈïúÂÉè‰ªìÂ∫ìÈÖçÁΩÆÔºàÂú® GitHub Secrets ‰∏≠ËÆæÁΩÆÔºâÔºö
#      - PRIVATE_REGISTRY: ÈïúÂÉè‰ªìÂ∫ìÂú∞ÂùÄÔºàÂèØÈÄâÔºåÈªòËÆ§‰ΩøÁî® ghcr.ioÔºâ
#      - PRIVATE_REGISTRY_USERNAME: ‰ªìÂ∫ìÁî®Êà∑ÂêçÔºàÂèØÈÄâÔºâ
#      - PRIVATE_REGISTRY_PASSWORD: ‰ªìÂ∫ìÂØÜÁ†Å/TokenÔºàÂèØÈÄâÔºâ
#   2. K8s ÈÉ®ÁΩ≤ÈÖçÁΩÆÔºàÂú® GitHub Secrets ‰∏≠ËÆæÁΩÆÔºâÔºö
#      - K8S_SERVER: K8s API ÊúçÂä°Âô®Âú∞ÂùÄ
#      - K8S_CA_CERT: K8s CA ËØÅ‰π¶Ôºàbase64 ÁºñÁ†ÅÔºâ
#      - K8S_TOKEN: K8s ËÆøÈóÆ‰ª§Áâå
#      - K8S_NAMESPACE: K8s ÂëΩÂêçÁ©∫Èó¥ÔºàÂèØÈÄâÔºåÈªòËÆ§Ôºöbtc-shopflowÔºâ

on:
  repository_dispatch:
    types: [build-deploy-all-k8s]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  detect-image-tag:
    name: Detect Image Tag
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
      repo_owner_lower: ${{ steps.detect.outputs.repo_owner_lower }}
    steps:
      - name: Detect image tag and repository owner
        id: detect
        run: |
          echo "üîç ÂºÄÂßãÊ£ÄÊµãÈïúÂÉèÊ†áÁ≠æÂíå‰ªìÂ∫ì‰ø°ÊÅØ..."
          echo "  - client_payload.github_sha: ${{ github.event.client_payload.github_sha }}"
          echo "  - github.sha: ${{ github.sha }}"
          
          # ËΩ¨Êç¢‰ªìÂ∫ìÊâÄÊúâËÄÖÂêçÁß∞‰∏∫Â∞èÂÜô
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner_lower=$REPO_OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "  ‚úÖ ‰ªìÂ∫ìÊâÄÊúâËÄÖÔºàÂ∞èÂÜôÔºâ: $REPO_OWNER_LOWER"
          
          # ÁîüÊàêÈïúÂÉèÊ†áÁ≠æÔºà‰ΩøÁî® SHA Ââç7‰ΩçÔºâ
          if [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            GIT_SHA="${{ github.event.client_payload.github_sha }}"
            echo "  ‚úÖ ‰ªé client_payload.github_sha Ëé∑Âèñ: $GIT_SHA"
          else
            GIT_SHA="${{ github.sha }}"
            echo "  ‚úÖ ‰ªé github.sha Ëé∑Âèñ: $GIT_SHA"
          fi
          
          if [ ${#GIT_SHA} -gt 7 ]; then
            IMAGE_TAG="${GIT_SHA:0:7}"
          elif [ ${#GIT_SHA} -lt 7 ]; then
            IMAGE_TAG="latest"
            echo "  ‚ö†Ô∏è  SHA Â§™Áü≠Ôºå‰ΩøÁî® latest"
          else
            IMAGE_TAG="$GIT_SHA"
          fi
          
          if [ -z "$IMAGE_TAG" ]; then
            echo "  ‚ö†Ô∏è  Ê†áÁ≠æ‰∏∫Á©∫Ôºå‰ΩøÁî® latest"
            IMAGE_TAG="latest"
          fi
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "‚úÖ ÊúÄÁªàÈïúÂÉèÊ†áÁ≠æ: $IMAGE_TAG"

  build-deploy-all:
    name: Build and Deploy All Apps (Parallel)
    needs: detect-image-tag
    strategy:
      fail-fast: false
      matrix:
        app:
          - system-app
          - admin-app
          - logistics-app
          - quality-app
          - production-app
          - engineering-app
          - finance-app
          - mobile-app
    uses: ./.github/workflows/build-deploy-app-k8s-reusable.yml
    with:
      app_name: ${{ matrix.app }}
      registry: ${{ secrets.PRIVATE_REGISTRY || 'ghcr.io' }}
      github_repository: ${{ github.repository }}
      github_sha: ${{ github.sha }}
      github_repository_owner: ${{ needs.detect-image-tag.outputs.repo_owner_lower }}
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
      k8s_namespace: ${{ secrets.K8S_NAMESPACE || 'btc-shopflow' }}
      skip_build: false
      skip_deploy: false
    secrets:
      gh_token: ${{ secrets.PRIVATE_REGISTRY_PASSWORD || github.token }}
      K8S_SERVER: ${{ secrets.K8S_SERVER }}
      K8S_CA_CERT: ${{ secrets.K8S_CA_CERT }}
      K8S_TOKEN: ${{ secrets.K8S_TOKEN }}
