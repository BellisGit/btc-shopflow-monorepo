name: Deploy All Apps

# ÂÖ®ÈáèÈÉ®ÁΩ≤Â∑•‰ΩúÊµÅÔºö‰ΩøÁî®ÂèØÂ§çÁî®Â∑•‰ΩúÊµÅÂêåÊó∂ÈÉ®ÁΩ≤ÊâÄÊúâ8‰∏™Â∫îÁî®
# - Ëß¶ÂèëÊù°‰ª∂Ôºö
#   1. repository_dispatch ‰∫ã‰ª∂ÔºàÈÄöËøá API Ëß¶ÂèëÔºåevent_type: deploy-all-appsÔºâ
#   2. workflow_dispatchÔºàÊâãÂä®Ëß¶ÂèëÔºâ
# - ‰ΩøÁî® matrix Á≠ñÁï•Âπ∂Ë°åÈÉ®ÁΩ≤ÊâÄÊúâÂ∫îÁî®
# - ‰∏ç‰ºöËß¶Âèë‰ªª‰ΩïÊûÑÂª∫ËøáÁ®ãÔºàÊûÑÂª∫Âú®Êú¨Âú∞ÂÆåÊàêÔºâ
on:
  repository_dispatch:
    types: [deploy-all-apps]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  packages: read

jobs:
  validate:
    name: Validate Deployment
    uses: ./.github/workflows/validate-deployment.yml
    secrets: inherit

  detect-image-tag:
    name: Detect Image Tag
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
    steps:
      - name: Detect image tag
        id: detect
        run: |
          echo "üîç ÂºÄÂßãÊ£ÄÊµãÈïúÂÉèÊ†áÁ≠æ..."
          echo "  - client_payload.image_tag: ${{ github.event.client_payload.image_tag }}"
          echo "  - client_payload.github_sha: ${{ github.event.client_payload.github_sha }}"
          echo "  - github.sha: ${{ github.sha }}"
          
          # ‰ºòÂÖàÁ∫ßÔºöclient_payload.image_tag > client_payload.github_sha > github.sha > latest
          if [ -n "${{ github.event.client_payload.image_tag }}" ]; then
            # ‰ªéÂÆåÊï¥ÈïúÂÉèÊ†áÁ≠æ‰∏≠ÊèêÂèñÊ†áÁ≠æÈÉ®ÂàÜÔºàÂéªÊéâ registry ÂâçÁºÄÔºâ
            FULL_TAG="${{ github.event.client_payload.image_tag }}"
            IMAGE_TAG=$(echo "$FULL_TAG" | sed 's|.*:||' || echo "")
            echo "  ‚úÖ ‰ªé client_payload.image_tag ÊèêÂèñ: $IMAGE_TAG"
          elif [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            # ‰ΩøÁî® client_payload ‰∏≠ÁöÑ github_shaÔºàÁ°Æ‰øùÊòØ 7 ‰ΩçÔºâ
            GIT_SHA="${{ github.event.client_payload.github_sha }}"
            # Â¶ÇÊûúÈïøÂ∫¶‰∏çÊòØ 7 ‰ΩçÔºåÊà™ÂèñÂâç 7 ‰Ωç
            if [ ${#GIT_SHA} -gt 7 ]; then
              IMAGE_TAG="${GIT_SHA:0:7}"
            elif [ ${#GIT_SHA} -lt 7 ]; then
              # Â¶ÇÊûúÂ§™Áü≠Ôºå‰ΩøÁî® github.sha ÁöÑÂâç 7 ‰Ωç
              GITHUB_SHA="${{ github.sha }}"
              IMAGE_TAG="${GITHUB_SHA:0:7}"
            else
              IMAGE_TAG="$GIT_SHA"
            fi
            echo "  ‚úÖ ‰ªé client_payload.github_sha Ëé∑Âèñ: $IMAGE_TAG"
          else
            # ‰ΩøÁî®ÂΩìÂâç commit SHA ÁöÑÂâç7‰Ωç
            GITHUB_SHA="${{ github.sha }}"
            IMAGE_TAG="${GITHUB_SHA:0:7}"
            echo "  ‚úÖ ‰ªé github.sha Ëé∑Âèñ: $IMAGE_TAG"
          fi
          
          # Â¶ÇÊûúÊ†áÁ≠æ‰∏∫Á©∫ÊàñÂ§™Áü≠Ôºå‰ΩøÁî® latest
          if [ -z "$IMAGE_TAG" ] || [ ${#IMAGE_TAG} -lt 7 ]; then
            echo "  ‚ö†Ô∏è  Ê†áÁ≠æ‰∏∫Á©∫ÊàñÂ§™Áü≠Ôºå‰ΩøÁî® latest"
            IMAGE_TAG="latest"
          fi
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "‚úÖ ÊúÄÁªàÈïúÂÉèÊ†áÁ≠æ: $IMAGE_TAG"

  deploy-all:
    name: Deploy All Apps
    needs: [validate, detect-image-tag]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - app_name: system-app
            app_port: "30080"
            container_name: btc-system-app
          - app_name: admin-app
            app_port: "30081"
            container_name: btc-admin-app
          - app_name: logistics-app
            app_port: "30082"
            container_name: btc-logistics-app
          - app_name: quality-app
            app_port: "30083"
            container_name: btc-quality-app
          - app_name: production-app
            app_port: "30084"
            container_name: btc-production-app
          - app_name: engineering-app
            app_port: "30085"
            container_name: btc-engineering-app
          - app_name: finance-app
            app_port: "30086"
            container_name: btc-finance-app
          - app_name: mobile-app
            app_port: "30091"
            container_name: btc-mobile-app
      fail-fast: false
      max-parallel: 8
    steps:
      - name: Deploy ${{ matrix.app_name }}
        uses: ./.github/workflows/deploy-app-reusable.yml
        with:
          app_name: ${{ matrix.app_name }}
          app_port: ${{ matrix.app_port }}
          container_name: ${{ matrix.container_name }}
          image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
        secrets: inherit

