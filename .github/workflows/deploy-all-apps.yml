name: Deploy All Apps

# å…¨é‡éƒ¨ç½²å·¥ä½œæµï¼šä½¿ç”¨å¯å¤ç”¨å·¥ä½œæµåŒæ—¶éƒ¨ç½²æ‰€æœ‰8ä¸ªåº”ç”¨
# - è§¦å‘æ¡ä»¶ï¼š
#   1. repository_dispatch äº‹ä»¶ï¼ˆé€šè¿‡ API è§¦å‘ï¼Œevent_type: deploy-all-appsï¼‰
#   2. workflow_dispatchï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
# - ä½¿ç”¨ matrix ç­–ç•¥å¹¶è¡Œéƒ¨ç½²æ‰€æœ‰åº”ç”¨
# - ä¸ä¼šè§¦å‘ä»»ä½•æ„å»ºè¿‡ç¨‹ï¼ˆæ„å»ºåœ¨æœ¬åœ°å®Œæˆï¼‰
on:
  repository_dispatch:
    types: [deploy-all-apps]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  packages: read

jobs:
  validate:
    name: Validate Deployment
    uses: ./.github/workflows/validate-deployment.yml
    secrets: inherit

  detect-image-tag:
    name: Detect Image Tag
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
    steps:
      - name: Detect image tag
        id: detect
        run: |
          echo "ğŸ” å¼€å§‹æ£€æµ‹é•œåƒæ ‡ç­¾..."
          echo "  - client_payload.image_tag: ${{ github.event.client_payload.image_tag }}"
          echo "  - client_payload.github_sha: ${{ github.event.client_payload.github_sha }}"
          echo "  - github.sha: ${{ github.sha }}"
          
          # ä¼˜å…ˆçº§ï¼šclient_payload.image_tag > client_payload.github_sha > github.sha > latest
          if [ -n "${{ github.event.client_payload.image_tag }}" ]; then
            # ä»å®Œæ•´é•œåƒæ ‡ç­¾ä¸­æå–æ ‡ç­¾éƒ¨åˆ†ï¼ˆå»æ‰ registry å‰ç¼€ï¼‰
            FULL_TAG="${{ github.event.client_payload.image_tag }}"
            IMAGE_TAG=$(echo "$FULL_TAG" | sed 's|.*:||' || echo "")
            echo "  âœ… ä» client_payload.image_tag æå–: $IMAGE_TAG"
          elif [ -n "${{ github.event.client_payload.github_sha }}" ]; then
            # ä½¿ç”¨ client_payload ä¸­çš„ github_shaï¼ˆç¡®ä¿æ˜¯ 7 ä½ï¼‰
            GIT_SHA="${{ github.event.client_payload.github_sha }}"
            # å¦‚æœé•¿åº¦ä¸æ˜¯ 7 ä½ï¼Œæˆªå–å‰ 7 ä½
            if [ ${#GIT_SHA} -gt 7 ]; then
              IMAGE_TAG="${GIT_SHA:0:7}"
            elif [ ${#GIT_SHA} -lt 7 ]; then
              # å¦‚æœå¤ªçŸ­ï¼Œä½¿ç”¨ github.sha çš„å‰ 7 ä½
              GITHUB_SHA="${{ github.sha }}"
              IMAGE_TAG="${GITHUB_SHA:0:7}"
            else
              IMAGE_TAG="$GIT_SHA"
            fi
            echo "  âœ… ä» client_payload.github_sha è·å–: $IMAGE_TAG"
          else
            # ä½¿ç”¨å½“å‰ commit SHA çš„å‰7ä½
            GITHUB_SHA="${{ github.sha }}"
            IMAGE_TAG="${GITHUB_SHA:0:7}"
            echo "  âœ… ä» github.sha è·å–: $IMAGE_TAG"
          fi
          
          # å¦‚æœæ ‡ç­¾ä¸ºç©ºæˆ–å¤ªçŸ­ï¼Œä½¿ç”¨ latest
          if [ -z "$IMAGE_TAG" ] || [ ${#IMAGE_TAG} -lt 7 ]; then
            echo "  âš ï¸  æ ‡ç­¾ä¸ºç©ºæˆ–å¤ªçŸ­ï¼Œä½¿ç”¨ latest"
            IMAGE_TAG="latest"
          fi
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "âœ… æœ€ç»ˆé•œåƒæ ‡ç­¾: $IMAGE_TAG"

  deploy-system-app:
    name: Deploy System App
    needs: [validate, detect-image-tag]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: system-app
      app_port: "30080"
      container_name: btc-system-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-admin-app:
    name: Deploy Admin App
    needs: [validate, detect-image-tag]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: admin-app
      app_port: "30081"
      container_name: btc-admin-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-logistics-app:
    name: Deploy Logistics App
    needs: [validate, detect-image-tag]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: logistics-app
      app_port: "30082"
      container_name: btc-logistics-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-quality-app:
    name: Deploy Quality App
    needs: [validate, detect-image-tag]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: quality-app
      app_port: "30083"
      container_name: btc-quality-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-production-app:
    name: Deploy Production App
    needs: [validate, detect-image-tag]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: production-app
      app_port: "30084"
      container_name: btc-production-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-engineering-app:
    name: Deploy Engineering App
    needs: [validate, detect-image-tag]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: engineering-app
      app_port: "30085"
      container_name: btc-engineering-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

  deploy-finance-app:
    name: Deploy Finance App
    needs: [validate, detect-image-tag]
    uses: ./.github/workflows/deploy-app-reusable.yml
    with:
      app_name: finance-app
      app_port: "30086"
      container_name: btc-finance-app
      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

      image_tag: ${{ needs.detect-image-tag.outputs.image_tag }}
    secrets: inherit

