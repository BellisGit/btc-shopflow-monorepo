name: Repository Dispatch Handler

on:
  repository_dispatch:
    types: [deploy-system-app, deploy-apps]

jobs:
  handle-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: éªŒè¯éƒ¨ç½²è¯·æ±‚å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯éƒ¨ç½²è¯·æ±‚å‚æ•°..."
          
          # æ£€æŸ¥äº‹ä»¶ç±»å‹
          EVENT_TYPE="${{ github.event.action }}"
          echo "ğŸ“‹ äº‹ä»¶ç±»å‹: $EVENT_TYPE"
          
          # è·å–åº”ç”¨åç§°
          if [ "$EVENT_TYPE" = "deploy-system-app" ]; then
            APP_NAME="system-app"
          else
            APP_NAME="${{ github.event.client_payload.app_name }}"
            if [ -z "$APP_NAME" ]; then
              APP_NAME="${{ github.event.client_payload.apps }}"
            fi
          fi
          
          if [ -z "$APP_NAME" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€å‚æ•°: app_name"
            exit 1
          fi
          
          echo "âœ… éƒ¨ç½²è¯·æ±‚å‚æ•°éªŒè¯é€šè¿‡"
          echo "ğŸ“‹ éƒ¨ç½²è¯·æ±‚è¯¦æƒ…:"
          echo "- åº”ç”¨: $APP_NAME"
          echo "- äº‹ä»¶ç±»å‹: $EVENT_TYPE"
          GITHUB_SHA="${{ github.event.client_payload.github_sha }}"
          if [ -z "$GITHUB_SHA" ]; then
            GITHUB_SHA="${{ github.sha }}"
          fi
          echo "- SHA: $GITHUB_SHA"

  trigger-deployment:
    needs: handle-deploy
    runs-on: ubuntu-latest
    steps:
      - name: è§¦å‘éƒ¨ç½²å·¥ä½œæµ
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              console.log('ğŸš€ è§¦å‘éƒ¨ç½²å·¥ä½œæµ...');
              
              // è·å–äº‹ä»¶ç±»å‹å’Œåº”ç”¨åç§°
              const eventType = '${{ github.event.action }}';
              let workflowFile;
              let inputs = {};
              
              if (eventType === 'deploy-system-app') {
                workflowFile = 'deploy-system-app.yml';
                console.log('ğŸ“‹ è§¦å‘ system-app éƒ¨ç½²å·¥ä½œæµ');
              } else {
                workflowFile = 'deploy-only.yml';
                const apps = '${{ github.event.client_payload.apps }}';
                inputs.apps = apps || '${{ github.event.client_payload.app_name }}';
                const environment = '${{ github.event.client_payload.environment }}';
                inputs.environment = environment || 'production';
                const githubSha = '${{ github.event.client_payload.github_sha }}';
                inputs.github_sha = githubSha || '${{ github.sha }}';
                console.log('ğŸ“‹ è§¦å‘ deploy-only å·¥ä½œæµ');
              }
              
              const { data: response } = await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowFile,
                ref: 'master',
                inputs: inputs
              });
              
              console.log('âœ… éƒ¨ç½²å·¥ä½œæµå·²æˆåŠŸè§¦å‘!');
              console.log('ğŸ“‹ è§¦å‘è¯¦æƒ…:');
              console.log('- å·¥ä½œæµ:', workflowFile);
              const appName = '${{ github.event.client_payload.app_name }}';
              const apps = '${{ github.event.client_payload.apps }}';
              console.log('- åº”ç”¨:', appName || apps);
              
            } catch (error) {
              console.error('ğŸš¨ è§¦å‘éƒ¨ç½²å·¥ä½œæµå¤±è´¥:', error.message);
              console.error('é”™è¯¯è¯¦æƒ…:', error);
              throw error;
            }

