// å¸ƒå±€åº”ç”¨ï¼ˆlayout-appï¼‰Docker éƒ¨ç½² Jenkinsfile
// ä½¿ç”¨ Docker æ–¹å¼éƒ¨ç½²ï¼šæ„å»º Docker é•œåƒ â†’ æ¨é€åˆ°æœåŠ¡å™¨ â†’ docker-compose éƒ¨ç½²
// ä½¿ç”¨æ–¹æ³•ï¼š
// 1. åˆ›å»ºä¸€ä¸ª Jobï¼ˆå¦‚ btc-shopflow-deploy-layout-app-dockerï¼‰
// 2. åœ¨ Job é…ç½®ä¸­ï¼ŒPipeline éƒ¨åˆ†é€‰æ‹© "Pipeline script from SCM"
// 3. è®¾ç½® Script Path ä¸º "jenkins/Jenkinsfile.layout-app.docker"

pipeline {
    agent any
    
    environment {
        NODE_VERSION = '20'
        PNPM_VERSION = '8.15.0'
        APP_NAME = 'layout-app'
        DOCKER_REGISTRY = 'btc-shopflow'
        DOCKER_IMAGE = "btc-shopflow/${APP_NAME}"
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }
    
    parameters {
        string(
            name: 'SERVER_HOST',
            defaultValue: '47.112.31.96',
            description: 'æœåŠ¡å™¨åœ°å€'
        )
        string(
            name: 'SERVER_USER',
            defaultValue: 'root',
            description: 'æœåŠ¡å™¨ç”¨æˆ·å'
        )
        string(
            name: 'SERVER_PORT',
            defaultValue: '22',
            description: 'SSH ç«¯å£'
        )
        string(
            name: 'SSH_KEY_PATH',
            defaultValue: '/var/jenkins_home/.ssh/id_rsa',
            description: 'SSH ç§é’¥è·¯å¾„'
        )
        string(
            name: 'REMOTE_PATH',
            defaultValue: '/www/wwwroot/btc-shopflow-monorepo',
            description: 'æœåŠ¡å™¨ä¸Šçš„é¡¹ç›®è·¯å¾„'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: true,
            description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•'
        )
        booleanParam(
            name: 'CLEAN_BUILD',
            defaultValue: true,
            description: 'æ˜¯å¦æ¸…ç†æ„å»ºç¼“å­˜'
        )
        booleanParam(
            name: 'BUILD_SHARED_DEPS',
            defaultValue: false,
            description: 'æ˜¯å¦æ„å»ºå…±äº«ä¾èµ–åŒ…'
        )
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "ğŸ“¦ æ£€å‡ºä»£ç ..."
                    checkout scm
                    if (isUnix()) {
                        sh '''
                            echo "Git ä¿¡æ¯:"
                            echo "  åˆ†æ”¯: $(git branch --show-current)"
                            echo "  æäº¤: $(git rev-parse --short HEAD)"
                        '''
                    }
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                script {
                    echo "ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒ..."
                    
                    // å°è¯•ä½¿ç”¨ NodeJS Pluginï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
                    try {
                        def nodejs = tool name: 'NodeJS', type: 'jenkins.plugins.nodejs.tools.NodeJSInstallation'
                        env.PATH = "${nodejs}/bin:${env.PATH}"
                        echo "âœ… ä½¿ç”¨ NodeJS Plugin å®‰è£…çš„ Node.js: ${nodejs}"
                    } catch (Exception e) {
                        echo "â„¹ï¸ NodeJS Plugin æœªé…ç½®æˆ–æœªæ‰¾åˆ°ï¼Œå°è¯•ä½¿ç”¨ç³»ç»Ÿ Node.js"
                    }
                    
                    if (isUnix()) {
                        sh '''
                            # æ£€æŸ¥ Node.jsï¼ˆä¼˜å…ˆä½¿ç”¨ NodeJS Plugin è®¾ç½®çš„ PATHï¼‰
                            if command -v node >/dev/null 2>&1; then
                                echo "âœ… Node.js å·²å®‰è£…: $(node --version)"
                            else
                                echo "âŒ Node.js æœªæ‰¾åˆ°"
                                echo "ğŸ’¡ è¯·ç¡®ä¿ï¼š"
                                echo "   1. å¦‚æœä½¿ç”¨ NodeJS Pluginï¼šåœ¨ Jenkins å…¨å±€é…ç½®ä¸­é…ç½® Node.js å·¥å…·ï¼Œåç§°ä¸º 'NodeJS'"
                                echo "   2. å¦‚æœä½¿ç”¨ç³»ç»Ÿå®‰è£…ï¼šåœ¨ Jenkins å®¹å™¨ä¸­å®‰è£… Node.js"
                                echo "      å®‰è£…æ–¹æ³•ï¼šdocker exec -u root jenkins bash -c 'curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs'"
                                exit 1
                            fi
                            
                            # æ£€æŸ¥ pnpm
                            if command -v pnpm >/dev/null 2>&1; then
                                echo "âœ… pnpm å·²å®‰è£…: $(pnpm --version)"
                            else
                                echo "ğŸ“¦ å®‰è£… pnpm..."
                                npm install -g pnpm@${PNPM_VERSION}
                                echo "âœ… pnpm å®‰è£…å®Œæˆ: $(pnpm --version)"
                            fi
                            
                            # æ£€æŸ¥ Docker
                            if command -v docker >/dev/null 2>&1; then
                                if docker --version >/dev/null 2>&1; then
                                    echo "âœ… Docker å·²å®‰è£…: $(docker --version)"
                                else
                                    echo "âš ï¸ Docker å‘½ä»¤å­˜åœ¨ä½†æ— æ³•æ‰§è¡Œï¼Œå¯èƒ½æ˜¯æƒé™é—®é¢˜"
                                    echo "ğŸ’¡ è¯·æ£€æŸ¥ï¼š"
                                    echo "   1. Jenkins ç”¨æˆ·æ˜¯å¦åœ¨ docker ç»„ä¸­: groups \$USER"
                                    echo "   2. Docker socket æƒé™: ls -l /var/run/docker.sock"
                                    exit 1
                                fi
                            else
                                # æ£€æŸ¥ Docker socket æ˜¯å¦å­˜åœ¨ï¼ˆå¯èƒ½æŒ‚è½½äº† socket ä½†æ²¡æœ‰ Docker CLIï¼‰
                                if [ -S /var/run/docker.sock ]; then
                                    echo "âŒ Docker socket å·²æŒ‚è½½ï¼Œä½† Docker CLI æœªå®‰è£…"
                                    echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šåœ¨ Jenkins å®¹å™¨ä¸­å®‰è£… Docker CLI"
                                    echo "   æ–¹æ³• 1ï¼ˆæ¨èï¼‰ï¼šä½¿ç”¨åŒ…å« Docker çš„ Jenkins é•œåƒï¼Œæˆ–"
                                    echo "   æ–¹æ³• 2ï¼šåœ¨å®¹å™¨ä¸­å®‰è£… Docker CLIï¼š"
                                    echo "     docker exec -u root jenkins bash -c 'apt-get update && apt-get install -y docker.io'"
                                    exit 1
                                else
                                    echo "âŒ Docker æœªå®‰è£…æˆ–ä¸åœ¨ PATH ä¸­"
                                    echo "ğŸ’¡ è°ƒè¯•ä¿¡æ¯ï¼š"
                                    echo "   PATH: \$PATH"
                                    echo "   which docker: $(which docker 2>&1 || echo 'not found')"
                                    echo "   Docker socket: $([ -S /var/run/docker.sock ] && echo 'å·²æŒ‚è½½' || echo 'æœªæŒ‚è½½')"
                                    echo ""
                                    echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š"
                                    echo "   å¦‚æœåœ¨å®¹å™¨ä¸­è¿è¡Œ Jenkinsï¼š"
                                    echo "     1. æŒ‚è½½ Docker socket: -v /var/run/docker.sock:/var/run/docker.sock"
                                    echo "     2. å®‰è£… Docker CLIï¼ˆå¦‚æœé•œåƒä¸­æ²¡æœ‰ï¼‰"
                                    echo "     3. æˆ–åœ¨å®¹å™¨ä¸­è¿è¡Œ Docker-in-Docker (DinD)"
                                    exit 1
                                fi
                            fi
                            
                            echo "âœ… ç¯å¢ƒæ£€æŸ¥å®Œæˆ"
                        '''
                    }
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                script {
                    echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
                    if (isUnix()) {
                        sh '''
                            if [ "${CLEAN_BUILD}" = "true" ]; then
                                echo "ğŸ§¹ æ¸…ç† node_modules..."
                                rm -rf node_modules
                            fi
                            
                            pnpm install --frozen-lockfile --prefer-offline
                        '''
                    }
                }
            }
        }
        
        stage('Build Shared Dependencies') {
            when {
                expression { params.BUILD_SHARED_DEPS }
            }
            steps {
                script {
                    echo "ğŸ“¦ æ„å»ºå…±äº«ä¾èµ–åŒ…..."
                    if (isUnix()) {
                        sh '''
                            pnpm --filter @btc/vite-plugin run build || true
                            pnpm --filter @btc/shared-utils run build || true
                            pnpm --filter @btc/shared-core run build || true
                            pnpm --filter @btc/shared-components run build || true
                            pnpm --filter @btc/subapp-manifests run build || true
                        '''
                    }
                }
            }
        }
        
        stage('Build Application') {
            steps {
                script {
                    echo "ğŸ”¨ æ„å»ºåº”ç”¨: ${APP_NAME}..."
                    if (isUnix()) {
                        sh '''
                            echo "æ„å»ºåº”ç”¨: ${APP_NAME}..."
                            pnpm --filter ${APP_NAME} build
                        '''
                    }
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    echo "ğŸ³ æ„å»º Docker é•œåƒ..."
                    if (isUnix()) {
                        sh """
                            # æ„å»º Docker é•œåƒï¼ˆä½¿ç”¨é€šç”¨ Dockerfileï¼‰
                            docker build -t ${DOCKER_IMAGE}:latest --build-arg APP_DIR=apps/${APP_NAME} .
                            
                            # æ˜¾ç¤ºé•œåƒä¿¡æ¯
                            docker images ${DOCKER_IMAGE}:latest
                        """
                    }
                }
            }
        }
        
        stage('Save Docker Image') {
            steps {
                script {
                    echo "ğŸ’¾ ä¿å­˜ Docker é•œåƒ..."
                    if (isUnix()) {
                        sh """
                            # åˆ›å»ºä¸´æ—¶ç›®å½•
                            mkdir -p /tmp/docker-images
                            
                            # ä¿å­˜é•œåƒä¸º tar.gz
                            docker save ${DOCKER_IMAGE}:latest | gzip > /tmp/docker-images/${APP_NAME}.tar.gz
                            
                            # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
                            ls -lh /tmp/docker-images/${APP_NAME}.tar.gz
                        """
                    }
                }
            }
        }
        
        stage('Upload to Server') {
            steps {
                script {
                    echo "ğŸ“¤ ä¸Šä¼ é•œåƒåˆ°æœåŠ¡å™¨..."
                    if (isUnix()) {
                        sh """
                            # æ£€æŸ¥ SSH å¯†é’¥
                            if [ ! -f "${params.SSH_KEY_PATH}" ]; then
                                echo "âŒ SSH å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: ${params.SSH_KEY_PATH}"
                                exit 1
                            fi
                            
                            chmod 600 "${params.SSH_KEY_PATH}" || true
                            
                            # æµ‹è¯• SSH è¿æ¥
                            ssh -i "${params.SSH_KEY_PATH}" -p ${params.SERVER_PORT} \
                                -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
                                ${params.SERVER_USER}@${params.SERVER_HOST} \
                                "echo 'SSH connection successful'" || {
                                echo "âŒ SSH è¿æ¥å¤±è´¥"
                                exit 1
                            }
                            
                            # åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸´æ—¶ç›®å½•
                            ssh -i "${params.SSH_KEY_PATH}" -p ${params.SERVER_PORT} \
                                -o StrictHostKeyChecking=no \
                                ${params.SERVER_USER}@${params.SERVER_HOST} \
                                "mkdir -p ${params.REMOTE_PATH}/tmp/docker-images"
                            
                            # ä¸Šä¼ é•œåƒ
                            scp -i "${params.SSH_KEY_PATH}" -P ${params.SERVER_PORT} \
                                -o StrictHostKeyChecking=no \
                                /tmp/docker-images/${APP_NAME}.tar.gz \
                                ${params.SERVER_USER}@${params.SERVER_HOST}:${params.REMOTE_PATH}/tmp/docker-images/
                        """
                    }
                }
            }
        }
        
        stage('Deploy on Server') {
            steps {
                script {
                    echo "ğŸš€ åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²..."
                    if (isUnix()) {
                        sh """
                            # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²è„šæœ¬
                            ssh -i "${params.SSH_KEY_PATH}" -p ${params.SERVER_PORT} \
                                -o StrictHostKeyChecking=no \
                                ${params.SERVER_USER}@${params.SERVER_HOST} << 'REMOTE_SCRIPT'
set -e

REMOTE_PATH="${params.REMOTE_PATH}"
APP_NAME="${APP_NAME}"
DOCKER_IMAGE="${DOCKER_IMAGE}"

cd "\$REMOTE_PATH"

# åŠ è½½ Docker é•œåƒ
echo "[INFO] åŠ è½½ Docker é•œåƒ..."
docker load < "tmp/docker-images/\${APP_NAME}.tar.gz"

# ç¡®ä¿ docker-compose å¯ç”¨
if ! command -v docker-compose &> /dev/null && command -v docker &> /dev/null; then
    # å°è¯•ä½¿ç”¨ docker compose (v2)
    DOCKER_COMPOSE="docker compose"
else
    DOCKER_COMPOSE="docker-compose"
fi

# åˆ›å»ºæˆ–æ›´æ–° docker-compose.yml
echo "[INFO] åˆ›å»º Docker Compose é…ç½®..."
cat > docker-compose.prod.yml << EOF
version: '3.8'

services:
  \${APP_NAME}:
    image: \${DOCKER_IMAGE}:latest
    container_name: btc-\${APP_NAME}
    ports:
      - "30088:80"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
    networks:
      - btc-network

networks:
  btc-network:
    driver: bridge
EOF

# åœæ­¢å¹¶å¯åŠ¨å®¹å™¨
echo "[INFO] å¯åŠ¨å®¹å™¨..."
\$DOCKER_COMPOSE -f docker-compose.prod.yml down 2>/dev/null || true
\$DOCKER_COMPOSE -f docker-compose.prod.yml up -d

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
echo "[INFO] æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
rm -rf tmp/docker-images/\${APP_NAME}.tar.gz

# ç­‰å¾…å®¹å™¨å¯åŠ¨
echo "[INFO] ç­‰å¾…å®¹å™¨å¯åŠ¨..."
sleep 10

# å¥åº·æ£€æŸ¥
if curl -f -s --max-time 10 "http://localhost:30088" > /dev/null 2>&1; then
    echo "[SUCCESS] å®¹å™¨è¿è¡Œæ­£å¸¸"
else
    echo "[WARNING] å®¹å™¨å¯èƒ½ä»åœ¨å¯åŠ¨ä¸­"
fi

echo "[SUCCESS] éƒ¨ç½²å®Œæˆï¼"
REMOTE_SCRIPT
                        """
                    }
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
                    if (isUnix()) {
                        sh '''
                            rm -rf /tmp/docker-images/${APP_NAME}.tar.gz
                        '''
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo """
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Docker éƒ¨ç½²æˆåŠŸï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åº”ç”¨: ${APP_NAME}
é•œåƒ: ${DOCKER_IMAGE}:latest
æœåŠ¡å™¨: ${params.SERVER_HOST}
è®¿é—®åœ°å€: http://${params.SERVER_HOST}:30088
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            }
        }
        failure {
            script {
                echo """
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âŒ Docker éƒ¨ç½²å¤±è´¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥ç¡®å®šå¤±è´¥åŸå› 
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            }
        }
        always {
            script {
                if (isUnix()) {
                    sh '''
                        # æ¸…ç†æœ¬åœ° Docker é•œåƒï¼ˆå¯é€‰ï¼‰
                        # docker rmi ${DOCKER_IMAGE}:latest || true
                    '''
                }
            }
        }
    }
}

