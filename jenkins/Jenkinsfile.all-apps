// å…¨é‡åº”ç”¨éƒ¨ç½² Jenkinsfile æ¨¡æ¿
// ä½¿ç”¨æ–¹æ³•ï¼š
// 1. åˆ›å»ºä¸€ä¸ª Jobï¼ˆå¦‚ btc-shopflow-deploy-allï¼‰
// 2. åœ¨ Job é…ç½®ä¸­ï¼ŒPipeline éƒ¨åˆ†é€‰æ‹© "Pipeline script from SCM"
// 3. è®¾ç½® Script Path ä¸º "jenkins/Jenkinsfile.all-apps"

pipeline {
    agent any
    
    // ç¯å¢ƒå˜é‡é…ç½®
    environment {
        // Node.js ç‰ˆæœ¬
        NODE_VERSION = '20'
        // pnpm ç‰ˆæœ¬
        PNPM_VERSION = '8.15.0'
        // éƒ¨ç½²é…ç½®è·¯å¾„
        DEPLOY_CONFIG = 'deploy.config.json'
    }
    
    options {
        // æ„å»ºè¶…æ—¶æ—¶é—´ï¼ˆ60åˆ†é’Ÿï¼Œå…¨é‡æ„å»ºéœ€è¦æ›´é•¿æ—¶é—´ï¼‰
        timeout(time: 60, unit: 'MINUTES')
        // ä¿ç•™æœ€è¿‘10æ¬¡æ„å»º
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // æ„å»ºæ ‡ç­¾
        timestamps()
    }
    
    parameters {
        // æœåŠ¡å™¨é…ç½®
        string(
            name: 'SERVER_HOST',
            defaultValue: '47.112.31.96',
            description: 'æœåŠ¡å™¨åœ°å€'
        )
        string(
            name: 'SERVER_USER',
            defaultValue: 'root',
            description: 'æœåŠ¡å™¨ç”¨æˆ·å'
        )
        string(
            name: 'SERVER_PORT',
            defaultValue: '22',
            description: 'SSH ç«¯å£'
        )
        string(
            name: 'SSH_KEY_PATH',
            defaultValue: '/var/jenkins_home/.ssh/id_rsa',
            description: 'SSH ç§é’¥è·¯å¾„ï¼ˆåœ¨ Jenkins æœåŠ¡å™¨ä¸Šçš„è·¯å¾„ï¼‰'
        )
        // æ˜¯å¦è·³è¿‡æµ‹è¯•
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: true,
            description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•ï¼ˆåŠ å¿«æ„å»ºé€Ÿåº¦ï¼‰'
        )
        // æ˜¯å¦æ¸…ç†ç¼“å­˜
        booleanParam(
            name: 'CLEAN_BUILD',
            defaultValue: false,
            description: 'æ˜¯å¦æ¸…ç†æ„å»ºç¼“å­˜ï¼ˆå¼ºåˆ¶é‡æ–°æ„å»ºï¼‰'
        )
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "ğŸ“¦ æ£€å‡ºä»£ç ..."
                    checkout scm
                    // æ˜¾ç¤º Git ä¿¡æ¯
                    if (isUnix()) {
                        sh '''
                            echo "Git ä¿¡æ¯:"
                            echo "  åˆ†æ”¯: $(git branch --show-current)"
                            echo "  æäº¤: $(git rev-parse --short HEAD)"
                            echo "  ä½œè€…: $(git log -1 --pretty=format:'%an <%ae>')"
                            echo "  æ¶ˆæ¯: $(git log -1 --pretty=format:'%s')"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo Git ä¿¡æ¯:
                            for /f "delims=" %%i in ('git branch --show-current') do echo   åˆ†æ”¯: %%i
                            for /f "delims=" %%i in ('git rev-parse --short HEAD') do echo   æäº¤: %%i
                            for /f "delims=" %%i in ('git log -1 --pretty=format:"%%an ^<%%ae^>"') do echo   ä½œè€…: %%i
                            for /f "delims=" %%i in ('git log -1 --pretty=format:"%%s"') do echo   æ¶ˆæ¯: %%i
                        '''
                    }
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                script {
                    echo "ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒ..."
                    if (isUnix()) {
                        sh '''
                            if command -v nvm &> /dev/null; then
                                source ~/.nvm/nvm.sh
                                nvm install ${NODE_VERSION}
                                nvm use ${NODE_VERSION}
                            elif command -v node &> /dev/null; then
                                echo "Node.js å·²å®‰è£…: $(node --version)"
                            else
                                echo "é”™è¯¯: æœªæ‰¾åˆ° Node.jsï¼Œè¯·å®‰è£… Node.js ${NODE_VERSION}"
                                exit 1
                            fi
                            
                            # å®‰è£… pnpm
                            if ! command -v pnpm &> /dev/null; then
                                echo "å®‰è£… pnpm ${PNPM_VERSION}..."
                                npm install -g pnpm@${PNPM_VERSION}
                            fi
                            echo "pnpm ç‰ˆæœ¬: $(pnpm --version)"
                        '''
                    } else {
                        bat '''
                            @echo off
                            where node >nul 2>&1
                            if %errorlevel% neq 0 (
                                echo é”™è¯¯: æœªæ‰¾åˆ° Node.jsï¼Œè¯·å®‰è£… Node.js %NODE_VERSION%
                                exit /b 1
                            )
                            echo Node.js å·²å®‰è£…:
                            node --version
                            
                            where pnpm >nul 2>&1
                            if %errorlevel% neq 0 (
                                echo å®‰è£… pnpm %PNPM_VERSION%...
                                call npm install -g pnpm@%PNPM_VERSION%
                            )
                            echo pnpm ç‰ˆæœ¬:
                            pnpm --version
                        '''
                    }
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                script {
                    echo "ğŸ“š å®‰è£…ä¾èµ–..."
                    if (isUnix()) {
                        sh '''
                            # æ¸…ç†å¹¶å®‰è£…ä¾èµ–
                            pnpm install --frozen-lockfile
                            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
                        '''
                    } else {
                        bat '''
                            @echo off
                            call pnpm install --frozen-lockfile
                            echo âœ… ä¾èµ–å®‰è£…å®Œæˆ
                        '''
                    }
                }
            }
        }
        
        stage('Lint & Type Check') {
            when {
                expression { !params.SKIP_TESTS }
            }
            steps {
                script {
                    echo "ğŸ” ä»£ç æ£€æŸ¥..."
                    if (isUnix()) {
                        sh '''
                            echo "è¿è¡Œ ESLint..."
                            pnpm lint || echo "âš ï¸ Lint æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥..."
                            pnpm type-check || echo "âš ï¸ ç±»å‹æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo è¿è¡Œ ESLint...
                            call pnpm lint || echo âš ï¸ Lint æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥...
                            call pnpm type-check || echo âš ï¸ ç±»å‹æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                        '''
                    }
                }
            }
        }
        
        stage('Test') {
            when {
                expression { !params.SKIP_TESTS }
            }
            steps {
                script {
                    echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
                    if (isUnix()) {
                        sh '''
                            echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
                            pnpm test:unit || echo "âš ï¸ å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo è¿è¡Œå•å…ƒæµ‹è¯•...
                            call pnpm test:unit || echo âš ï¸ å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                        '''
                    }
                }
            }
        }
        
        stage('Build All Apps') {
            steps {
                script {
                    echo "ğŸ”¨ æ„å»ºæ‰€æœ‰åº”ç”¨..."
                    if (isUnix()) {
                        sh '''
                            echo "æ„å»ºæ‰€æœ‰åº”ç”¨å¹¶å¤åˆ¶åˆ° dist ç›®å½•..."
                            pnpm build-dist:all
                            echo "âœ… æ‰€æœ‰åº”ç”¨æ„å»ºå®Œæˆï¼Œäº§ç‰©åœ¨ dist ç›®å½•"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo æ„å»ºæ‰€æœ‰åº”ç”¨å¹¶å¤åˆ¶åˆ° dist ç›®å½•...
                            call pnpm build-dist:all
                            echo âœ… æ‰€æœ‰åº”ç”¨æ„å»ºå®Œæˆï¼Œäº§ç‰©åœ¨ dist ç›®å½•
                        '''
                    }
                }
            }
        }
        
        stage('Verify Build Artifacts') {
            steps {
                script {
                    echo "âœ… éªŒè¯æ„å»ºäº§ç‰©..."
                    if (isUnix()) {
                        sh '''
                            echo "éªŒè¯ dist ç›®å½•ä¸‹çš„æ„å»ºäº§ç‰©..."
                            if [ -d "dist" ] && [ -n "$(ls -A dist 2>/dev/null)" ]; then
                                echo "âœ… dist ç›®å½•å­˜åœ¨ä¸”ä¸ä¸ºç©º"
                                echo "åº”ç”¨åˆ—è¡¨:"
                                ls -1 dist/ | while read app; do
                                    if [ -d "dist/$app" ] && [ -n "$(ls -A dist/$app 2>/dev/null)" ]; then
                                        echo "  âœ… $app: $(du -sh dist/$app | awk '{print $1}')"
                                    else
                                        echo "  âŒ $app: ç›®å½•ä¸ºç©º"
                                    fi
                                done
                            else
                                echo "âŒ dist ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
                                exit 1
                            fi
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo éªŒè¯ dist ç›®å½•ä¸‹çš„æ„å»ºäº§ç‰©...
                            if exist "dist" (
                                dir /b "dist" >nul 2>&1
                                if !errorlevel! equ 0 (
                                    echo âœ… dist ç›®å½•å­˜åœ¨ä¸”ä¸ä¸ºç©º
                                    echo åº”ç”¨åˆ—è¡¨:
                                    for /d %%a in (dist\*) do (
                                        if exist "%%a" (
                                            echo   âœ… %%~na: å­˜åœ¨
                                        ) else (
                                            echo   âŒ %%~na: ç›®å½•ä¸ºç©º
                                        )
                                    )
                                ) else (
                                    echo âŒ dist ç›®å½•ä¸ºç©º
                                    exit /b 1
                                )
                            ) else (
                                echo âŒ dist ç›®å½•ä¸å­˜åœ¨
                                exit /b 1
                            )
                        '''
                    }
                }
            }
        }
        
        stage('Deploy All Apps') {
            steps {
                script {
                    echo "ğŸš€ éƒ¨ç½²æ‰€æœ‰åº”ç”¨åˆ°æœåŠ¡å™¨..."
                    def serverHost = params.SERVER_HOST
                    def serverUser = params.SERVER_USER
                    def serverPort = params.SERVER_PORT
                    def sshKeyPath = params.SSH_KEY_PATH
                    
                    if (isUnix()) {
                        sh """
                            echo "ğŸš€ éƒ¨ç½²é…ç½®:"
                            echo "  æœåŠ¡å™¨: ${serverUser}@${serverHost}:${serverPort}"
                            echo "  SSH å¯†é’¥: ${sshKeyPath}"
                            echo "  æ¨¡å¼: å…¨é‡éƒ¨ç½²æ‰€æœ‰åº”ç”¨"
                            
                            # æ£€æŸ¥ SSH å¯†é’¥æ˜¯å¦å­˜åœ¨
                            if [ ! -f "${sshKeyPath}" ]; then
                                echo "âŒ SSH å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: ${sshKeyPath}"
                                echo "ğŸ’¡ è¯·ç¡®ä¿ SSH å¯†é’¥å·²æ”¾ç½®åœ¨ Jenkins æœåŠ¡å™¨ä¸Šï¼Œæˆ–ä¿®æ”¹ SSH_KEY_PATH å‚æ•°"
                                exit 1
                            fi
                            
                            # è®¾ç½®æƒé™
                            chmod 600 "${sshKeyPath}" || true
                            
                            # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›éƒ¨ç½²è„šæœ¬ä½¿ç”¨
                            export SERVER_HOST="${serverHost}"
                            export SERVER_USER="${serverUser}"
                            export SERVER_PORT="${serverPort}"
                            export SSH_KEY="${sshKeyPath}"
                            
                            # æµ‹è¯• SSH è¿æ¥
                            echo "æµ‹è¯• SSH è¿æ¥..."
                            if ssh -i "${sshKeyPath}" -p "${serverPort}" \
                                -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
                                "${serverUser}@${serverHost}" "echo 'SSH connection successful'" 2>&1; then
                                echo "âœ… SSH è¿æ¥æˆåŠŸ"
                            else
                                echo "âŒ SSH è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
                                exit 1
                            fi
                            
                            # æ‰§è¡Œå…¨é‡éƒ¨ç½²
                            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                            echo "éƒ¨ç½²æ‰€æœ‰åº”ç”¨..."
                            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                            
                            bash scripts/deploy-static.sh --all
                        """
                    } else {
                        bat """
                            @echo off
                            echo ğŸš€ éƒ¨ç½²é…ç½®:
                            echo   æœåŠ¡å™¨: ${serverUser}@${serverHost}:${serverPort}
                            echo   SSH å¯†é’¥: ${sshKeyPath}
                            echo   æ¨¡å¼: å…¨é‡éƒ¨ç½²æ‰€æœ‰åº”ç”¨
                            
                            REM æ£€æŸ¥ SSH å¯†é’¥æ˜¯å¦å­˜åœ¨
                            if not exist "${sshKeyPath}" (
                                echo âŒ SSH å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: ${sshKeyPath}
                                echo ğŸ’¡ è¯·ç¡®ä¿ SSH å¯†é’¥å·²æ”¾ç½®åœ¨ Jenkins æœåŠ¡å™¨ä¸Šï¼Œæˆ–ä¿®æ”¹ SSH_KEY_PATH å‚æ•°
                                exit /b 1
                            )
                            
                            REM æ‰§è¡Œå…¨é‡éƒ¨ç½²ï¼ˆä½¿ç”¨ Git Bashï¼‰
                            where bash >nul 2>&1
                            if !errorlevel! equ 0 (
                                echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                                echo éƒ¨ç½²æ‰€æœ‰åº”ç”¨...
                                echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                                bash -c "export SERVER_HOST='${serverHost}' SERVER_USER='${serverUser}' SERVER_PORT='${serverPort}' SSH_KEY='${sshKeyPath}' && bash scripts/deploy-static.sh --all"
                            ) else (
                                echo âŒ æœªæ‰¾åˆ° bashï¼Œæ— æ³•æ‰§è¡Œéƒ¨ç½²è„šæœ¬
                                echo ğŸ’¡ è¯·å®‰è£… Git for Windows æˆ–ä½¿ç”¨ Linux/Unix æœåŠ¡å™¨è¿è¡Œ Jenkins
                                exit /b 1
                            )
                        """
                    }
                }
            }
        }
        
        stage('Post-Deploy Verification') {
            steps {
                script {
                    echo "ğŸ” éƒ¨ç½²åéªŒè¯..."
                    if (isUnix()) {
                        sh '''
                            echo "æ‰€æœ‰åº”ç”¨éƒ¨ç½²å®Œæˆï¼Œå¯ä»¥è¿›è¡Œäººå·¥éªŒè¯"
                            echo "æˆ–æ·»åŠ è‡ªåŠ¨åŒ–å¥åº·æ£€æŸ¥è„šæœ¬"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo æ‰€æœ‰åº”ç”¨éƒ¨ç½²å®Œæˆï¼Œå¯ä»¥è¿›è¡Œäººå·¥éªŒè¯
                            echo æˆ–æ·»åŠ è‡ªåŠ¨åŒ–å¥åº·æ£€æŸ¥è„šæœ¬
                        '''
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo "âœ… æ‰€æœ‰åº”ç”¨æ„å»ºå’Œéƒ¨ç½²æˆåŠŸï¼"
            }
        }
        failure {
            script {
                echo "âŒ æ„å»ºæˆ–éƒ¨ç½²å¤±è´¥"
            }
        }
        always {
            echo "æ„å»ºæµç¨‹å®Œæˆ"
        }
    }
}
