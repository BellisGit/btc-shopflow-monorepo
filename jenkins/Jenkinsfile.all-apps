// å…¨é‡åº”ç”¨éƒ¨ç½² Jenkinsfile æ¨¡æ¿
// ä½¿ç”¨æ–¹æ³•ï¼š
// 1. åˆ›å»ºä¸€ä¸ª Jobï¼ˆå¦‚ btc-shopflow-deploy-allï¼‰
// 2. åœ¨ Job é…ç½®ä¸­ï¼ŒPipeline éƒ¨åˆ†é€‰æ‹© "Pipeline script from SCM"
// 3. è®¾ç½® Script Path ä¸º "jenkins/Jenkinsfile.all-apps"

// å®šä¹‰éœ€è¦éƒ¨ç½²çš„åº”ç”¨åˆ—è¡¨ï¼ˆ10ä¸ªåº”ç”¨ï¼Œæ’é™¤é™æ€éƒ¨ç½²å’Œç§»åŠ¨åº”ç”¨ï¼‰
def APP_LIST = [
    'system-app',
    'admin-app',
    'logistics-app',
    'quality-app',
    'production-app',
    'engineering-app',
    'finance-app',
    'operations-app',
    'dashboard-app',
    'personnel-app'
]

pipeline {
    agent any
    
    // ç¯å¢ƒå˜é‡é…ç½®
    environment {
        // Node.js ç‰ˆæœ¬
        NODE_VERSION = '20'
        // pnpm ç‰ˆæœ¬
        PNPM_VERSION = '8.15.0'
        // éƒ¨ç½²é…ç½®è·¯å¾„
        DEPLOY_CONFIG = 'deploy.config.json'
    }
    
    options {
        // æ„å»ºè¶…æ—¶æ—¶é—´ï¼ˆ60åˆ†é’Ÿï¼Œå…¨é‡æ„å»ºéœ€è¦æ›´é•¿æ—¶é—´ï¼‰
        timeout(time: 60, unit: 'MINUTES')
        // ä¿ç•™æœ€è¿‘10æ¬¡æ„å»º
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // æ„å»ºæ ‡ç­¾
        timestamps()
    }
    
    parameters {
        // æœåŠ¡å™¨é…ç½®
        string(
            name: 'SERVER_HOST',
            defaultValue: '47.112.31.96',
            description: 'æœåŠ¡å™¨åœ°å€'
        )
        string(
            name: 'SERVER_USER',
            defaultValue: 'root',
            description: 'æœåŠ¡å™¨ç”¨æˆ·å'
        )
        string(
            name: 'SERVER_PORT',
            defaultValue: '22',
            description: 'SSH ç«¯å£'
        )
        string(
            name: 'SSH_KEY_PATH',
            defaultValue: '/var/jenkins_home/.ssh/id_rsa',
            description: 'SSH ç§é’¥è·¯å¾„ï¼ˆåœ¨ Jenkins æœåŠ¡å™¨ä¸Šçš„è·¯å¾„ï¼‰'
        )
        // æ˜¯å¦è·³è¿‡æµ‹è¯•
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: true,
            description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•ï¼ˆåŠ å¿«æ„å»ºé€Ÿåº¦ï¼‰'
        )
        // æ˜¯å¦æ¸…ç†ç¼“å­˜
        booleanParam(
            name: 'CLEAN_BUILD',
            defaultValue: false,
            description: 'æ˜¯å¦æ¸…ç†æ„å»ºç¼“å­˜ï¼ˆå¼ºåˆ¶é‡æ–°æ„å»ºï¼‰'
        )
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "ğŸ“¦ æ£€å‡ºä»£ç ..."
                    checkout scm
                    // æ˜¾ç¤º Git ä¿¡æ¯
                    if (isUnix()) {
                        sh '''
                            echo "Git ä¿¡æ¯:"
                            echo "  åˆ†æ”¯: $(git branch --show-current)"
                            echo "  æäº¤: $(git rev-parse --short HEAD)"
                            echo "  ä½œè€…: $(git log -1 --pretty=format:'%an <%ae>')"
                            echo "  æ¶ˆæ¯: $(git log -1 --pretty=format:'%s')"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo Git ä¿¡æ¯:
                            for /f "delims=" %%i in ('git branch --show-current') do echo   åˆ†æ”¯: %%i
                            for /f "delims=" %%i in ('git rev-parse --short HEAD') do echo   æäº¤: %%i
                            for /f "delims=" %%i in ('git log -1 --pretty=format:"%%an ^<%%ae^>"') do echo   ä½œè€…: %%i
                            for /f "delims=" %%i in ('git log -1 --pretty=format:"%%s"') do echo   æ¶ˆæ¯: %%i
                        '''
                    }
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                script {
                    echo "ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒ..."
                    if (isUnix()) {
                        sh '''
                            if command -v nvm &> /dev/null; then
                                source ~/.nvm/nvm.sh
                                nvm install ${NODE_VERSION}
                                nvm use ${NODE_VERSION}
                            elif command -v node &> /dev/null; then
                                echo "Node.js å·²å®‰è£…: $(node --version)"
                            else
                                echo "é”™è¯¯: æœªæ‰¾åˆ° Node.jsï¼Œè¯·å®‰è£… Node.js ${NODE_VERSION}"
                                exit 1
                            fi
                            
                            # å®‰è£… pnpm
                            if ! command -v pnpm &> /dev/null; then
                                echo "å®‰è£… pnpm ${PNPM_VERSION}..."
                                npm install -g pnpm@${PNPM_VERSION}
                            fi
                            echo "pnpm ç‰ˆæœ¬: $(pnpm --version)"
                        '''
                    } else {
                        bat '''
                            @echo off
                            where node >nul 2>&1
                            if %errorlevel% neq 0 (
                                echo é”™è¯¯: æœªæ‰¾åˆ° Node.jsï¼Œè¯·å®‰è£… Node.js %NODE_VERSION%
                                exit /b 1
                            )
                            echo Node.js å·²å®‰è£…:
                            node --version
                            
                            where pnpm >nul 2>&1
                            if %errorlevel% neq 0 (
                                echo å®‰è£… pnpm %PNPM_VERSION%...
                                call npm install -g pnpm@%PNPM_VERSION%
                            )
                            echo pnpm ç‰ˆæœ¬:
                            pnpm --version
                        '''
                    }
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                script {
                    echo "ğŸ“š å®‰è£…ä¾èµ–..."
                    if (isUnix()) {
                        sh '''
                            # æ¸…ç†å¹¶å®‰è£…ä¾èµ–
                            pnpm install --frozen-lockfile
                            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
                        '''
                    } else {
                        bat '''
                            @echo off
                            call pnpm install --frozen-lockfile
                            echo âœ… ä¾èµ–å®‰è£…å®Œæˆ
                        '''
                    }
                }
            }
        }
        
        stage('Build Shared Dependencies') {
            steps {
                script {
                    echo "ğŸ”¨ æ„å»ºå…±äº«ä¾èµ–åŒ…..."
                    echo "è¿™ç¡®ä¿å…±äº«ç»„ä»¶åŒ…ï¼ˆå¦‚ @btc/shared-componentsï¼‰çš„ä¿®æ”¹èƒ½å¤Ÿç”Ÿæ•ˆ"
                    if (isUnix()) {
                        sh '''
                            echo "ğŸ“¦ æ„å»º @btc/vite-plugin..."
                            pnpm --filter @btc/vite-plugin run build --force || pnpm --filter @btc/vite-plugin run build || echo "âš ï¸ vite-plugin æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "ğŸ“¦ æ„å»º @btc/shared-utils..."
                            pnpm --filter @btc/shared-utils run build --force || pnpm --filter @btc/shared-utils run build || echo "âš ï¸ shared-utils æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "ğŸ“¦ æ„å»º @btc/shared-core..."
                            pnpm --filter @btc/shared-core run build --force || pnpm --filter @btc/shared-core run build || echo "âš ï¸ shared-core æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "ğŸ“¦ æ„å»º @btc/shared-components..."
                            pnpm --filter @btc/shared-components run build --force || pnpm --filter @btc/shared-components run build || echo "âš ï¸ shared-components æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "ğŸ“¦ æ„å»º @btc/subapp-manifests..."
                            pnpm --filter @btc/subapp-manifests run build --force || pnpm --filter @btc/subapp-manifests run build || echo "âš ï¸ subapp-manifests æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "âœ… å…±äº«ä¾èµ–åŒ…æ„å»ºå®Œæˆï¼ˆéƒ¨åˆ†å¤±è´¥ä¸å½±å“åº”ç”¨æ„å»ºï¼‰"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo ğŸ“¦ æ„å»º @btc/vite-plugin...
                            call pnpm --filter @btc/vite-plugin run build --force || call pnpm --filter @btc/vite-plugin run build || echo âš ï¸ vite-plugin æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo ğŸ“¦ æ„å»º @btc/shared-utils...
                            call pnpm --filter @btc/shared-utils run build --force || call pnpm --filter @btc/shared-utils run build || echo âš ï¸ shared-utils æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo ğŸ“¦ æ„å»º @btc/shared-core...
                            call pnpm --filter @btc/shared-core run build --force || call pnpm --filter @btc/shared-core run build || echo âš ï¸ shared-core æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo ğŸ“¦ æ„å»º @btc/shared-components...
                            call pnpm --filter @btc/shared-components run build --force || call pnpm --filter @btc/shared-components run build || echo âš ï¸ shared-components æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo ğŸ“¦ æ„å»º @btc/subapp-manifests...
                            call pnpm --filter @btc/subapp-manifests run build --force || call pnpm --filter @btc/subapp-manifests run build || echo âš ï¸ subapp-manifests æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo âœ… å…±äº«ä¾èµ–åŒ…æ„å»ºå®Œæˆï¼ˆéƒ¨åˆ†å¤±è´¥ä¸å½±å“åº”ç”¨æ„å»ºï¼‰
                        '''
                    }
                }
            }
        }
        
        stage('Lint & Type Check') {
            when {
                expression { !params.SKIP_TESTS }
            }
            steps {
                script {
                    echo "ğŸ” ä»£ç æ£€æŸ¥..."
                    if (isUnix()) {
                        sh '''
                            echo "è¿è¡Œ ESLint..."
                            pnpm lint || echo "âš ï¸ Lint æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥..."
                            pnpm type-check || echo "âš ï¸ ç±»å‹æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo è¿è¡Œ ESLint...
                            call pnpm lint || echo âš ï¸ Lint æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥...
                            call pnpm type-check || echo âš ï¸ ç±»å‹æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                        '''
                    }
                }
            }
        }
        
        stage('Test') {
            when {
                expression { !params.SKIP_TESTS }
            }
            steps {
                script {
                    echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
                    if (isUnix()) {
                        sh '''
                            echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
                            pnpm test:unit || echo "âš ï¸ å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo è¿è¡Œå•å…ƒæµ‹è¯•...
                            call pnpm test:unit || echo âš ï¸ å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                        '''
                    }
                }
            }
        }
        
        // ä½¿ç”¨ Matrix Strategy å¹¶è¡Œæ„å»ºå’Œéƒ¨ç½²æ‰€æœ‰åº”ç”¨
        stage('Build and Deploy Apps') {
            matrix {
                agent any
                axes {
                    axis {
                        name 'APP_NAME'
                        values 'system-app', 'admin-app', 'logistics-app', 'quality-app',
                               'production-app', 'engineering-app', 'finance-app',
                               'operations-app', 'dashboard-app', 'personnel-app'
                    }
                }
                stages {
                    stage('Build') {
                        steps {
                            script {
                                def appName = env.APP_NAME
                                echo "ğŸ”¨ æ„å»ºåº”ç”¨: ${appName}..."
                                if (isUnix()) {
                                    sh """
                                        echo "æ„å»ºåº”ç”¨: ${appName}..."
                                        pnpm build-dist:${appName}
                                        echo "âœ… ${appName} æ„å»ºå®Œæˆï¼Œäº§ç‰©åœ¨ dist ç›®å½•"
                                    """
                                } else {
                                    bat """
                                        @echo off
                                        echo æ„å»ºåº”ç”¨: ${appName}...
                                        call pnpm build-dist:${appName}
                                        echo âœ… ${appName} æ„å»ºå®Œæˆï¼Œäº§ç‰©åœ¨ dist ç›®å½•
                                    """
                                }
                            }
                        }
                    }
                    
                    stage('Verify Build Artifacts') {
                        steps {
                            script {
                                def appName = env.APP_NAME
                                echo "âœ… éªŒè¯æ„å»ºäº§ç‰©: ${appName}..."
                                if (isUnix()) {
                                    sh """
                                        # build-to-dist.mjs ä¼šå°†åº”ç”¨å¤åˆ¶åˆ° dist/<domain> ç›®å½•
                                        # åº”ç”¨åç§°åˆ°åŸŸåçš„æ˜ å°„å…³ç³»
                                        declare -A APP_DOMAIN_MAP
                                        APP_DOMAIN_MAP['system-app']='bellis.com.cn'
                                        APP_DOMAIN_MAP['admin-app']='admin.bellis.com.cn'
                                        APP_DOMAIN_MAP['logistics-app']='logistics.bellis.com.cn'
                                        APP_DOMAIN_MAP['quality-app']='quality.bellis.com.cn'
                                        APP_DOMAIN_MAP['production-app']='production.bellis.com.cn'
                                        APP_DOMAIN_MAP['engineering-app']='engineering.bellis.com.cn'
                                        APP_DOMAIN_MAP['finance-app']='finance.bellis.com.cn'
                                        APP_DOMAIN_MAP['operations-app']='operations.bellis.com.cn'
                                        APP_DOMAIN_MAP['dashboard-app']='dashboard.bellis.com.cn'
                                        APP_DOMAIN_MAP['personnel-app']='personnel.bellis.com.cn'
                                        
                                        DOMAIN=\${APP_DOMAIN_MAP['${appName}']}
                                        if [ -z "\$DOMAIN" ]; then
                                            echo "âŒ ${appName}: æœªæ‰¾åˆ°å¯¹åº”çš„åŸŸåæ˜ å°„"
                                            exit 1
                                        fi
                                        
                                        APP_DIR="dist/\$DOMAIN"
                                        if [ -d "\$APP_DIR" ] && [ -n "\$(ls -A \$APP_DIR 2>/dev/null)" ]; then
                                            echo "âœ… ${appName}: æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡ (ç›®å½•: \$APP_DIR)"
                                            du -sh \$APP_DIR | awk '{print "å¤§å°: " \$1}'
                                        else
                                            echo "âŒ ${appName}: æ„å»ºäº§ç‰©ä¸å­˜åœ¨æˆ–ä¸ºç©º (é¢„æœŸç›®å½•: \$APP_DIR)"
                                            exit 1
                                        fi
                                    """
                                } else {
                                    bat """
                                        @echo off
                                        REM åº”ç”¨åç§°åˆ°åŸŸåçš„æ˜ å°„ï¼ˆWindows æ‰¹å¤„ç†ç®€åŒ–å¤„ç†ï¼‰
                                        set APP_DIR=dist\\${appName}
                                        
                                        REM æ³¨æ„ï¼šWindows ç¯å¢ƒä¸‹ï¼Œå¦‚æœ build-to-dist.mjs ä½¿ç”¨åŸŸåç›®å½•ï¼Œ
                                        REM è¿™é‡Œå¯èƒ½éœ€è¦æ ¹æ®åº”ç”¨åç§°æŸ¥æ‰¾å¯¹åº”çš„åŸŸåç›®å½•
                                        REM ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œå…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ£€æŸ¥å¯èƒ½çš„åŸŸåç›®å½•
                                        
                                        if exist "%APP_DIR%" (
                                            dir /b "%APP_DIR%" >nul 2>&1
                                            if !errorlevel! equ 0 (
                                                echo âœ… ${appName}: æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡
                                            ) else (
                                                echo âŒ ${appName}: æ„å»ºäº§ç‰©ä¸ºç©º
                                                exit /b 1
                                            )
                                        ) else (
                                            echo âŒ ${appName}: æ„å»ºäº§ç‰©ä¸å­˜åœ¨ (é¢„æœŸç›®å½•: %APP_DIR%)
                                            echo æ³¨æ„ï¼šWindows ç¯å¢ƒå¯èƒ½éœ€è¦ä½¿ç”¨åŸŸåç›®å½•ï¼Œè¯·æ£€æŸ¥ dist ç›®å½•
                                            exit /b 1
                                        )
                                    """
                                }
                            }
                        }
                    }
                    
                    stage('Deploy') {
                        steps {
                            script {
                                def appName = env.APP_NAME
                                def serverHost = params.SERVER_HOST
                                def serverUser = params.SERVER_USER
                                def serverPort = params.SERVER_PORT
                                def sshKeyPath = params.SSH_KEY_PATH
                                
                                echo "ğŸš€ éƒ¨ç½²åº”ç”¨: ${appName}..."
                                if (isUnix()) {
                                    sh """
                                        echo "ğŸš€ éƒ¨ç½²é…ç½®:"
                                        echo "  æœåŠ¡å™¨: ${serverUser}@${serverHost}:${serverPort}"
                                        echo "  SSH å¯†é’¥: ${sshKeyPath}"
                                        echo "  åº”ç”¨: ${appName}"
                                        
                                        # æ£€æŸ¥ SSH å¯†é’¥æ˜¯å¦å­˜åœ¨
                                        if [ ! -f "${sshKeyPath}" ]; then
                                            echo "âŒ SSH å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: ${sshKeyPath}"
                                            echo "ğŸ’¡ è¯·ç¡®ä¿ SSH å¯†é’¥å·²æ”¾ç½®åœ¨ Jenkins æœåŠ¡å™¨ä¸Šï¼Œæˆ–ä¿®æ”¹ SSH_KEY_PATH å‚æ•°"
                                            exit 1
                                        fi
                                        
                                        # è®¾ç½®æƒé™
                                        chmod 600 "${sshKeyPath}" || true
                                        
                                        # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›éƒ¨ç½²è„šæœ¬ä½¿ç”¨
                                        export SERVER_HOST="${serverHost}"
                                        export SERVER_USER="${serverUser}"
                                        export SERVER_PORT="${serverPort}"
                                        export SSH_KEY="${sshKeyPath}"
                                        
                                        # æµ‹è¯• SSH è¿æ¥
                                        echo "æµ‹è¯• SSH è¿æ¥..."
                                        if ssh -i "${sshKeyPath}" -p "${serverPort}" \
                                            -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
                                            "${serverUser}@${serverHost}" "echo 'SSH connection successful'" 2>&1; then
                                            echo "âœ… SSH è¿æ¥æˆåŠŸ"
                                        else
                                            echo "âŒ SSH è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
                                            exit 1
                                        fi
                                        
                                        # æ‰§è¡Œéƒ¨ç½²
                                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                                        echo "éƒ¨ç½²åº”ç”¨: ${appName}..."
                                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                                        
                                        bash scripts/deploy-static.sh --app ${appName}
                                    """
                                } else {
                                    bat """
                                        @echo off
                                        echo ğŸš€ éƒ¨ç½²é…ç½®:
                                        echo   æœåŠ¡å™¨: ${serverUser}@${serverHost}:${serverPort}
                                        echo   SSH å¯†é’¥: ${sshKeyPath}
                                        echo   åº”ç”¨: ${appName}
                                        
                                        REM æ£€æŸ¥ SSH å¯†é’¥æ˜¯å¦å­˜åœ¨
                                        if not exist "${sshKeyPath}" (
                                            echo âŒ SSH å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: ${sshKeyPath}
                                            echo ğŸ’¡ è¯·ç¡®ä¿ SSH å¯†é’¥å·²æ”¾ç½®åœ¨ Jenkins æœåŠ¡å™¨ä¸Šï¼Œæˆ–ä¿®æ”¹ SSH_KEY_PATH å‚æ•°
                                            exit /b 1
                                        )
                                        
                                        REM æ‰§è¡Œéƒ¨ç½²ï¼ˆä½¿ç”¨ Git Bashï¼‰
                                        where bash >nul 2>&1
                                        if !errorlevel! equ 0 (
                                            echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                                            echo éƒ¨ç½²åº”ç”¨: ${appName}...
                                            echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                                            bash -c "export SERVER_HOST='${serverHost}' SERVER_USER='${serverUser}' SERVER_PORT='${serverPort}' SSH_KEY='${sshKeyPath}' && bash scripts/deploy-static.sh --app ${appName}"
                                        ) else (
                                            echo âŒ æœªæ‰¾åˆ° bashï¼Œæ— æ³•æ‰§è¡Œéƒ¨ç½²è„šæœ¬
                                            echo ğŸ’¡ è¯·å®‰è£… Git for Windows æˆ–ä½¿ç”¨ Linux/Unix æœåŠ¡å™¨è¿è¡Œ Jenkins
                                            exit /b 1
                                        )
                                    """
                                }
                            }
                        }
                    }
                }
            }
        }
        
        stage('Summary') {
            steps {
                script {
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "ğŸ“Š æ„å»ºå’Œéƒ¨ç½²ç»“æœæ±‡æ€»"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "éƒ¨ç½²çš„åº”ç”¨æ•°é‡: ${APP_LIST.size()}"
                    echo "åº”ç”¨åˆ—è¡¨: ${APP_LIST.join(', ')}"
                    echo ""
                    echo "æ‰€æœ‰åº”ç”¨çš„æ„å»ºå’Œéƒ¨ç½²çŠ¶æ€è¯·æŸ¥çœ‹å„ä¸ªçŸ©é˜µæ„å»ºçš„ç»“æœ"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âœ… æ‰€æœ‰åº”ç”¨æ„å»ºå’Œéƒ¨ç½²æˆåŠŸï¼"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "æˆåŠŸéƒ¨ç½²çš„åº”ç”¨æ•°é‡: ${APP_LIST.size()}"
                echo "åº”ç”¨åˆ—è¡¨: ${APP_LIST.join(', ')}"
            }
        }
        failure {
            script {
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âŒ éƒ¨åˆ†åº”ç”¨æ„å»ºæˆ–éƒ¨ç½²å¤±è´¥"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "è¯·æ£€æŸ¥å„ä¸ªçŸ©é˜µæ„å»ºçš„è¯¦ç»†æ—¥å¿—ä»¥ç¡®å®šå¤±è´¥çš„åº”ç”¨"
            }
        }
        always {
            script {
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "æ„å»ºæµç¨‹å®Œæˆ"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "æŸ¥çœ‹å„ä¸ªåº”ç”¨çš„æ„å»ºç»“æœï¼š"
                echo "  - åœ¨ Jenkins æ„å»ºé¡µé¢å¯ä»¥å±•å¼€çŸ©é˜µæ„å»ºæŸ¥çœ‹æ¯ä¸ªåº”ç”¨çš„è¯¦ç»†ç»“æœ"
                echo "  - ç»¿è‰²è¡¨ç¤ºæˆåŠŸï¼Œçº¢è‰²è¡¨ç¤ºå¤±è´¥"
            }
        }
    }
}
