// ä¸»åº”ç”¨ï¼ˆsystem-appï¼‰å•ç‹¬æ„å»ºéƒ¨ç½² Jenkinsfile
// ä½¿ç”¨æ–¹æ³•ï¼š
// 1. åˆ›å»ºä¸€ä¸ª Jobï¼ˆå¦‚ btc-shopflow-deploy-system-appï¼‰
// 2. åœ¨ Job é…ç½®ä¸­ï¼ŒPipeline éƒ¨åˆ†é€‰æ‹© "Pipeline script from SCM"
// 3. è®¾ç½® Script Path ä¸º "jenkins/Jenkinsfile.main-app"
//
// æ³¨æ„ï¼šä¸»åº”ç”¨ï¼ˆsystem-appï¼‰æ˜¯å¾®å‰ç«¯å®¹å™¨ï¼Œå…¶ä»–å­åº”ç”¨å¯èƒ½ä¾èµ–å®ƒï¼Œå»ºè®®ä¼˜å…ˆéƒ¨ç½²

pipeline {
    agent any
    
    // ç¯å¢ƒå˜é‡é…ç½®
    environment {
        // Node.js ç‰ˆæœ¬
        NODE_VERSION = '20'
        // pnpm ç‰ˆæœ¬
        PNPM_VERSION = '8.15.0'
        // ä¸»åº”ç”¨åç§°ï¼ˆå›ºå®šï¼‰
        APP_NAME = 'system-app'
        // éƒ¨ç½²é…ç½®è·¯å¾„
        DEPLOY_CONFIG = 'deploy.config.json'
    }
    
    options {
        // æ„å»ºè¶…æ—¶æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
        timeout(time: 30, unit: 'MINUTES')
        // ä¿ç•™æœ€è¿‘10æ¬¡æ„å»º
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // æ„å»ºæ ‡ç­¾
        timestamps()
    }
    
    parameters {
        // æœåŠ¡å™¨é…ç½®
        string(
            name: 'SERVER_HOST',
            defaultValue: '47.112.31.96',
            description: 'æœåŠ¡å™¨åœ°å€'
        )
        string(
            name: 'SERVER_USER',
            defaultValue: 'root',
            description: 'æœåŠ¡å™¨ç”¨æˆ·å'
        )
        string(
            name: 'SERVER_PORT',
            defaultValue: '22',
            description: 'SSH ç«¯å£'
        )
        string(
            name: 'SSH_KEY_PATH',
            defaultValue: '/var/jenkins_home/.ssh/id_rsa',
            description: 'SSH ç§é’¥è·¯å¾„ï¼ˆåœ¨ Jenkins æœåŠ¡å™¨ä¸Šçš„è·¯å¾„ï¼‰'
        )
        // æ˜¯å¦è·³è¿‡æµ‹è¯•
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: true,
            description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•ï¼ˆåŠ å¿«æ„å»ºé€Ÿåº¦ï¼‰'
        )
        // æ˜¯å¦æ¸…ç†ç¼“å­˜
        booleanParam(
            name: 'CLEAN_BUILD',
            defaultValue: false,
            description: 'æ˜¯å¦æ¸…ç†æ„å»ºç¼“å­˜ï¼ˆå¼ºåˆ¶é‡æ–°æ„å»ºï¼‰'
        )
        // æ˜¯å¦æ„å»ºå…±äº«ä¾èµ–
        booleanParam(
            name: 'BUILD_SHARED_DEPS',
            defaultValue: true,
            description: 'æ˜¯å¦æ„å»ºå…±äº«ä¾èµ–åŒ…ï¼ˆ@btc/* åŒ…ï¼‰ï¼Œç¡®ä¿ä¾èµ–æœ€æ–°ç‰ˆæœ¬'
        )
        // æ˜¯å¦å¯ç”¨ CDN åŠ é€Ÿ
        booleanParam(
            name: 'ENABLE_CDN',
            defaultValue: true,
            description: 'æ˜¯å¦å¯ç”¨ CDN åŠ é€Ÿï¼ˆå°†èµ„æº URL è½¬æ¢ä¸º CDN åœ°å€ï¼‰'
        )
        // æ˜¯å¦å¯ç”¨ CDN ä¸Šä¼ 
        booleanParam(
            name: 'ENABLE_CDN_UPLOAD',
            defaultValue: false,
            description: 'æ˜¯å¦å¯ç”¨ CDN ä¸Šä¼ ï¼ˆå°†æ„å»ºäº§ç‰©ä¸Šä¼ åˆ° CDNï¼Œéœ€è¦é…ç½® CDN å‡­è¯ï¼‰'
        )
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "ğŸ“¦ æ£€å‡ºä»£ç ..."
                    checkout scm
                    // æ˜¾ç¤º Git ä¿¡æ¯
                    if (isUnix()) {
                        sh '''
                            echo "Git ä¿¡æ¯:"
                            echo "  åˆ†æ”¯: $(git branch --show-current)"
                            echo "  æäº¤: $(git rev-parse --short HEAD)"
                            echo "  ä½œè€…: $(git log -1 --pretty=format:'%an <%ae>')"
                            echo "  æ¶ˆæ¯: $(git log -1 --pretty=format:'%s')"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo Git ä¿¡æ¯:
                            for /f "delims=" %%i in ('git branch --show-current') do echo   åˆ†æ”¯: %%i
                            for /f "delims=" %%i in ('git rev-parse --short HEAD') do echo   æäº¤: %%i
                            for /f "delims=" %%i in ('git log -1 --pretty=format:"%%an ^<%%ae^>"') do echo   ä½œè€…: %%i
                            for /f "delims=" %%i in ('git log -1 --pretty=format:"%%s"') do echo   æ¶ˆæ¯: %%i
                        '''
                    }
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                script {
                    echo "ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒ..."
                    if (isUnix()) {
                        sh '''
                            # æ£€æŸ¥ Node.js æ˜¯å¦å·²å®‰è£…ï¼ˆåº”è¯¥å·²ç»åœ¨å®¹å™¨ä¸­å®‰è£…ï¼‰
                            if command -v node >/dev/null 2>&1; then
                                echo "âœ… Node.js å·²å®‰è£…: $(node --version)"
                            else
                                echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° Node.js"
                                echo "ğŸ’¡ æç¤º: è¯·åœ¨ Jenkins å®¹å™¨ä¸­å®‰è£… Node.js"
                                echo "   å®‰è£…æ–¹æ³•: docker exec -u root jenkins bash -c 'curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs'"
                                exit 1
                            fi
                            
                            # æ£€æŸ¥å¹¶å®‰è£… pnpmï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
                            if ! command -v pnpm >/dev/null 2>&1; then
                                echo "ğŸ“¦ å®‰è£… pnpm ${PNPM_VERSION}..."
                                npm install -g pnpm@${PNPM_VERSION} || {
                                    echo "âŒ é”™è¯¯: pnpm å®‰è£…å¤±è´¥"
                                    exit 1
                                }
                            else
                                echo "âœ… pnpm å·²å®‰è£…: $(pnpm --version)"
                            fi
                        '''
                    } else {
                        bat '''
                            @echo off
                            where node >nul 2>&1
                            if %errorlevel% neq 0 (
                                echo é”™è¯¯: æœªæ‰¾åˆ° Node.jsï¼Œè¯·å®‰è£… Node.js %NODE_VERSION%
                                exit /b 1
                            )
                            echo Node.js å·²å®‰è£…:
                            node --version
                            
                            where pnpm >nul 2>&1
                            if %errorlevel% neq 0 (
                                echo å®‰è£… pnpm %PNPM_VERSION%...
                                call npm install -g pnpm@%PNPM_VERSION%
                            )
                            echo pnpm ç‰ˆæœ¬:
                            pnpm --version
                        '''
                    }
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                script {
                    echo "ğŸ“š å®‰è£…ä¾èµ–..."
                    if (isUnix()) {
                        sh '''
                            # è·å– pnpm store è·¯å¾„ï¼ˆç”¨äºç¼“å­˜è¯´æ˜ï¼‰
                            STORE_PATH=$(pnpm store path 2>/dev/null || echo "")
                            if [ -n "$STORE_PATH" ]; then
                                echo "ğŸ“¦ pnpm store è·¯å¾„: $STORE_PATH"
                            fi
                            
                            # ä½¿ç”¨ --prefer-offline ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼ŒåŠ é€Ÿå®‰è£…
                            # Jenkins workspace ä¼šæŒä¹…åŒ–ï¼Œæ‰€ä»¥ node_modules å’Œ pnpm store ä¼šä¿ç•™
                            # åªæœ‰åœ¨ pnpm-lock.yaml å˜æ›´æ—¶æ‰éœ€è¦é‡æ–°å®‰è£…
                            echo "ğŸ”„ æ£€æŸ¥ä¾èµ–ï¼ˆä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼‰..."
                            pnpm install --frozen-lockfile --prefer-offline
                            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo ğŸ”„ æ£€æŸ¥ä¾èµ–ï¼ˆä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼‰...
                            call pnpm install --frozen-lockfile --prefer-offline
                            echo âœ… ä¾èµ–å®‰è£…å®Œæˆ
                        '''
                    }
                }
            }
        }
        
        stage('Build Shared Dependencies') {
            when {
                expression { params.BUILD_SHARED_DEPS }
            }
            steps {
                script {
                    echo "ğŸ”¨ æ„å»ºå…±äº«ä¾èµ–åŒ…..."
                    echo "è¿™ç¡®ä¿å…±äº«ç»„ä»¶åŒ…ï¼ˆå¦‚ @btc/shared-componentsï¼‰çš„ä¿®æ”¹èƒ½å¤Ÿç”Ÿæ•ˆ"
                    if (isUnix()) {
                        sh '''
                            echo "ğŸ“¦ æ„å»º @btc/vite-plugin..."
                            pnpm --filter @btc/vite-plugin run build --force || pnpm --filter @btc/vite-plugin run build || echo "âš ï¸ vite-plugin æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "ğŸ“¦ æ„å»º @btc/shared-utils..."
                            pnpm --filter @btc/shared-utils run build --force || pnpm --filter @btc/shared-utils run build || echo "âš ï¸ shared-utils æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "ğŸ“¦ æ„å»º @btc/shared-core..."
                            pnpm --filter @btc/shared-core run build --force || pnpm --filter @btc/shared-core run build || echo "âš ï¸ shared-core æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "ğŸ“¦ æ„å»º @btc/shared-components..."
                            pnpm --filter @btc/shared-components run build --force || pnpm --filter @btc/shared-components run build || echo "âš ï¸ shared-components æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "ğŸ“¦ æ„å»º @btc/subapp-manifests..."
                            pnpm --filter @btc/subapp-manifests run build --force || pnpm --filter @btc/subapp-manifests run build || echo "âš ï¸ subapp-manifests æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "âœ… å…±äº«ä¾èµ–åŒ…æ„å»ºå®Œæˆï¼ˆéƒ¨åˆ†å¤±è´¥ä¸å½±å“åº”ç”¨æ„å»ºï¼‰"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo ğŸ“¦ æ„å»º @btc/vite-plugin...
                            call pnpm --filter @btc/vite-plugin run build --force || call pnpm --filter @btc/vite-plugin run build || echo âš ï¸ vite-plugin æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo ğŸ“¦ æ„å»º @btc/shared-utils...
                            call pnpm --filter @btc/shared-utils run build --force || call pnpm --filter @btc/shared-utils run build || echo âš ï¸ shared-utils æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo ğŸ“¦ æ„å»º @btc/shared-core...
                            call pnpm --filter @btc/shared-core run build --force || call pnpm --filter @btc/shared-core run build || echo âš ï¸ shared-core æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo ğŸ“¦ æ„å»º @btc/shared-components...
                            call pnpm --filter @btc/shared-components run build --force || call pnpm --filter @btc/shared-components run build || echo âš ï¸ shared-components æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo ğŸ“¦ æ„å»º @btc/subapp-manifests...
                            call pnpm --filter @btc/subapp-manifests run build --force || call pnpm --filter @btc/subapp-manifests run build || echo âš ï¸ subapp-manifests æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo âœ… å…±äº«ä¾èµ–åŒ…æ„å»ºå®Œæˆï¼ˆéƒ¨åˆ†å¤±è´¥ä¸å½±å“åº”ç”¨æ„å»ºï¼‰
                        '''
                    }
                }
            }
        }
        
        stage('Lint & Type Check') {
            when {
                expression { !params.SKIP_TESTS }
            }
            steps {
                script {
                    echo "ğŸ” ä»£ç æ£€æŸ¥..."
                    if (isUnix()) {
                        sh '''
                            echo "è¿è¡Œ ESLint..."
                            pnpm lint || echo "âš ï¸ Lint æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                            
                            echo "è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥..."
                            pnpm type-check || echo "âš ï¸ ç±»å‹æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo è¿è¡Œ ESLint...
                            call pnpm lint || echo âš ï¸ Lint æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                            
                            echo è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥...
                            call pnpm type-check || echo âš ï¸ ç±»å‹æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                        '''
                    }
                }
            }
        }
        
        stage('Test') {
            when {
                expression { !params.SKIP_TESTS }
            }
            steps {
                script {
                    echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
                    if (isUnix()) {
                        sh '''
                            echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
                            pnpm test:unit || echo "âš ï¸ å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo è¿è¡Œå•å…ƒæµ‹è¯•...
                            call pnpm test:unit || echo âš ï¸ å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
                        '''
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                    def appName = env.APP_NAME
                    // å°†åº”ç”¨åç§°è½¬æ¢ä¸º package.json ä¸­çš„è„šæœ¬åç§°ï¼ˆå»æ‰ -app åç¼€ï¼‰
                    def scriptName = appName.replace('-app', '')
                    echo "ğŸ”¨ æ„å»ºä¸»åº”ç”¨: ${appName} (è„šæœ¬: build-dist:${scriptName})..."
                    def enableCdn = params.ENABLE_CDN ? 'true' : 'false'
                    def enableCdnUpload = params.ENABLE_CDN_UPLOAD ? 'true' : 'false'
                    if (isUnix()) {
                        sh """
                            # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä¸ä½¿ç”¨ cross-envï¼Œç›´æ¥åœ¨ shell ä¸­è®¾ç½®ï¼‰
                            export ENABLE_CDN_ACCELERATION=${enableCdn}
                            export ENABLE_CDN_UPLOAD=${enableCdnUpload}
                            
                            echo "æ„å»ºä¸»åº”ç”¨: ${appName}..."
                            echo "CDN åŠ é€Ÿ: ${enableCdn}"
                            echo "CDN ä¸Šä¼ : ${enableCdnUpload}"
                            # ç›´æ¥æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ package.json ä¸­çš„è„šæœ¬ï¼ˆå› ä¸ºè„šæœ¬ä½¿ç”¨äº† cross-envï¼‰
                            pnpm build:${scriptName} && node scripts/build-to-dist.mjs --app ${appName}
                            echo "âœ… ${appName} æ„å»ºå®Œæˆï¼Œäº§ç‰©åœ¨ dist ç›®å½•"
                        """
                    } else {
                        bat """
                            @echo off
                            REM è®¾ç½®ç¯å¢ƒå˜é‡
                            set ENABLE_CDN_ACCELERATION=${enableCdn}
                            set ENABLE_CDN_UPLOAD=${enableCdnUpload}
                            
                            echo æ„å»ºä¸»åº”ç”¨: ${appName}...
                            echo CDN åŠ é€Ÿ: ${enableCdn}
                            echo CDN ä¸Šä¼ : ${enableCdnUpload}
                            call pnpm build:${scriptName} && node scripts/build-to-dist.mjs --app ${appName}
                            echo âœ… ${appName} æ„å»ºå®Œæˆï¼Œäº§ç‰©åœ¨ dist ç›®å½•
                        """
                    }
                }
            }
        }
        
        stage('Verify Build Artifacts') {
            steps {
                script {
                    def appName = env.APP_NAME
                    echo "âœ… éªŒè¯æ„å»ºäº§ç‰©: ${appName}..."
                    if (isUnix()) {
                        sh """
                            # build-to-dist.mjs ä¼šå°†åº”ç”¨å¤åˆ¶åˆ° dist/<domain> ç›®å½•
                            # system-app å¯¹åº”çš„åŸŸåæ˜¯ bellis.com.cn
                            DOMAIN="bellis.com.cn"
                            APP_DIR="dist/\$DOMAIN"
                            
                            if [ -d "\$APP_DIR" ] && [ -n "\$(ls -A \$APP_DIR 2>/dev/null)" ]; then
                                echo "âœ… ${appName}: æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡ (ç›®å½•: \$APP_DIR)"
                                du -sh \$APP_DIR | awk '{print "å¤§å°: " \$1}'
                                
                                # æ£€æŸ¥å…³é”®æ–‡ä»¶
                                if [ -f "\$APP_DIR/index.html" ]; then
                                    echo "âœ… index.html å­˜åœ¨"
                                else
                                    echo "âš ï¸ è­¦å‘Š: index.html ä¸å­˜åœ¨"
                                fi
                                
                                if [ -d "\$APP_DIR/assets" ]; then
                                    echo "âœ… assets ç›®å½•å­˜åœ¨"
                                    echo "   JS æ–‡ä»¶æ•°é‡: \$(find \$APP_DIR/assets -name '*.js' | wc -l)"
                                    echo "   CSS æ–‡ä»¶æ•°é‡: \$(find \$APP_DIR/assets -name '*.css' | wc -l)"
                                else
                                    echo "âš ï¸ è­¦å‘Š: assets ç›®å½•ä¸å­˜åœ¨"
                                fi
                            else
                                echo "âŒ ${appName}: æ„å»ºäº§ç‰©ä¸å­˜åœ¨æˆ–ä¸ºç©º (é¢„æœŸç›®å½•: \$APP_DIR)"
                                exit 1
                            fi
                        """
                    } else {
                        bat """
                            @echo off
                            REM system-app å¯¹åº”çš„åŸŸåæ˜¯ bellis.com.cn
                            set DOMAIN=bellis.com.cn
                            set APP_DIR=dist\\%DOMAIN%
                            
                            if exist "%APP_DIR%" (
                                dir /b "%APP_DIR%" >nul 2>&1
                                if !errorlevel! equ 0 (
                                    echo âœ… ${appName}: æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡
                                    echo ç›®å½•: %APP_DIR%
                                ) else (
                                    echo âŒ ${appName}: æ„å»ºäº§ç‰©ä¸ºç©º
                                    exit /b 1
                                )
                            ) else (
                                echo âŒ ${appName}: æ„å»ºäº§ç‰©ä¸å­˜åœ¨ (é¢„æœŸç›®å½•: %APP_DIR%)
                                echo æ³¨æ„ï¼šWindows ç¯å¢ƒå¯èƒ½éœ€è¦ä½¿ç”¨åŸŸåç›®å½•ï¼Œè¯·æ£€æŸ¥ dist ç›®å½•
                                exit /b 1
                            )
                        """
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    def appName = env.APP_NAME
                    def serverHost = params.SERVER_HOST
                    def serverUser = params.SERVER_USER
                    def serverPort = params.SERVER_PORT
                    def sshKeyPath = params.SSH_KEY_PATH
                    
                    echo "ğŸš€ éƒ¨ç½²ä¸»åº”ç”¨: ${appName}..."
                    if (isUnix()) {
                        sh """
                            echo "ğŸš€ éƒ¨ç½²é…ç½®:"
                            echo "  æœåŠ¡å™¨: ${serverUser}@${serverHost}:${serverPort}"
                            echo "  SSH å¯†é’¥: ${sshKeyPath}"
                            echo "  åº”ç”¨: ${appName} (ä¸»åº”ç”¨)"
                            
                            # æ£€æŸ¥ SSH å¯†é’¥æ˜¯å¦å­˜åœ¨
                            if [ ! -f "${sshKeyPath}" ]; then
                                echo "âŒ SSH å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: ${sshKeyPath}"
                                echo "ğŸ’¡ è¯·ç¡®ä¿ SSH å¯†é’¥å·²æ”¾ç½®åœ¨ Jenkins æœåŠ¡å™¨ä¸Šï¼Œæˆ–ä¿®æ”¹ SSH_KEY_PATH å‚æ•°"
                                exit 1
                            fi
                            
                            # è®¾ç½®æƒé™
                            chmod 600 "${sshKeyPath}" || true
                            
                            # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›éƒ¨ç½²è„šæœ¬ä½¿ç”¨
                            export SERVER_HOST="${serverHost}"
                            export SERVER_USER="${serverUser}"
                            export SERVER_PORT="${serverPort}"
                            export SSH_KEY="${sshKeyPath}"
                            
                            # æµ‹è¯• SSH è¿æ¥
                            echo "æµ‹è¯• SSH è¿æ¥..."
                            if ssh -i "${sshKeyPath}" -p "${serverPort}" \
                                -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
                                "${serverUser}@${serverHost}" "echo 'SSH connection successful'" 2>&1; then
                                echo "âœ… SSH è¿æ¥æˆåŠŸ"
                            else
                                echo "âŒ SSH è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
                                exit 1
                            fi
                            
                            # æ‰§è¡Œéƒ¨ç½²
                            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                            echo "éƒ¨ç½²ä¸»åº”ç”¨: ${appName}..."
                            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                            
                            bash scripts/deploy-static.sh --app ${appName}
                        """
                    } else {
                        bat """
                            @echo off
                            echo ğŸš€ éƒ¨ç½²é…ç½®:
                            echo   æœåŠ¡å™¨: ${serverUser}@${serverHost}:${serverPort}
                            echo   SSH å¯†é’¥: ${sshKeyPath}
                            echo   åº”ç”¨: ${appName} (ä¸»åº”ç”¨)
                            
                            REM æ£€æŸ¥ SSH å¯†é’¥æ˜¯å¦å­˜åœ¨
                            if not exist "${sshKeyPath}" (
                                echo âŒ SSH å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: ${sshKeyPath}
                                echo ğŸ’¡ è¯·ç¡®ä¿ SSH å¯†é’¥å·²æ”¾ç½®åœ¨ Jenkins æœåŠ¡å™¨ä¸Šï¼Œæˆ–ä¿®æ”¹ SSH_KEY_PATH å‚æ•°
                                exit /b 1
                            )
                            
                            REM æ‰§è¡Œéƒ¨ç½²ï¼ˆä½¿ç”¨ Git Bashï¼‰
                            where bash >nul 2>&1
                            if !errorlevel! equ 0 (
                                echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                                echo éƒ¨ç½²ä¸»åº”ç”¨: ${appName}...
                                echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                                bash -c "export SERVER_HOST='${serverHost}' SERVER_USER='${serverUser}' SERVER_PORT='${serverPort}' SSH_KEY='${sshKeyPath}' && bash scripts/deploy-static.sh --app ${appName}"
                            ) else (
                                echo âŒ æœªæ‰¾åˆ° bashï¼Œæ— æ³•æ‰§è¡Œéƒ¨ç½²è„šæœ¬
                                echo ğŸ’¡ è¯·å®‰è£… Git for Windows æˆ–ä½¿ç”¨ Linux/Unix æœåŠ¡å™¨è¿è¡Œ Jenkins
                                exit /b 1
                            )
                        """
                    }
                }
            }
        }
        
        stage('Post-Deploy Verification') {
            steps {
                script {
                    echo "ğŸ” éƒ¨ç½²åéªŒè¯..."
                    if (isUnix()) {
                        sh '''
                            echo "âœ… ä¸»åº”ç”¨éƒ¨ç½²å®Œæˆ"
                            echo "ğŸ’¡ æç¤º: ä¸»åº”ç”¨ï¼ˆsystem-appï¼‰æ˜¯å¾®å‰ç«¯å®¹å™¨ï¼Œå…¶ä»–å­åº”ç”¨å¯èƒ½ä¾èµ–å®ƒ"
                            echo "   å»ºè®®åœ¨éƒ¨ç½²ä¸»åº”ç”¨åï¼ŒéªŒè¯ä»¥ä¸‹å†…å®¹ï¼š"
                            echo "   1. ä¸»åº”ç”¨é¡µé¢æ˜¯å¦æ­£å¸¸åŠ è½½"
                            echo "   2. å­åº”ç”¨æ˜¯å¦èƒ½æ­£å¸¸åŠ è½½"
                            echo "   3. å¾®å‰ç«¯è·¯ç”±æ˜¯å¦æ­£å¸¸å·¥ä½œ"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo âœ… ä¸»åº”ç”¨éƒ¨ç½²å®Œæˆ
                            echo ğŸ’¡ æç¤º: ä¸»åº”ç”¨ï¼ˆsystem-appï¼‰æ˜¯å¾®å‰ç«¯å®¹å™¨ï¼Œå…¶ä»–å­åº”ç”¨å¯èƒ½ä¾èµ–å®ƒ
                            echo    å»ºè®®åœ¨éƒ¨ç½²ä¸»åº”ç”¨åï¼ŒéªŒè¯ä»¥ä¸‹å†…å®¹ï¼š
                            echo    1. ä¸»åº”ç”¨é¡µé¢æ˜¯å¦æ­£å¸¸åŠ è½½
                            echo    2. å­åº”ç”¨æ˜¯å¦èƒ½æ­£å¸¸åŠ è½½
                            echo    3. å¾®å‰ç«¯è·¯ç”±æ˜¯å¦æ­£å¸¸å·¥ä½œ
                        '''
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âœ… ä¸»åº”ç”¨æ„å»ºå’Œéƒ¨ç½²æˆåŠŸï¼"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "åº”ç”¨: ${env.APP_NAME}"
                echo "åŸŸå: bellis.com.cn"
                echo ""
                echo "ğŸ’¡ æç¤º: ä¸»åº”ç”¨æ˜¯å¾®å‰ç«¯å®¹å™¨ï¼Œå»ºè®®ä¼˜å…ˆéƒ¨ç½²"
            }
        }
        failure {
            script {
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âŒ ä¸»åº”ç”¨æ„å»ºæˆ–éƒ¨ç½²å¤±è´¥"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥ç¡®å®šå¤±è´¥åŸå› "
            }
        }
        always {
            script {
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "æ„å»ºæµç¨‹å®Œæˆ"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            }
        }
    }
}

