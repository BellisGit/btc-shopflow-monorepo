// ä»ªè¡¨æ¿åº”ç”¨ï¼ˆdashboard-appï¼‰å•ç‹¬æ„å»ºéƒ¨ç½² Jenkinsfile
// ä½¿ç”¨æ–¹æ³•ï¼š
// 1. åˆ›å»ºä¸€ä¸ª Jobï¼ˆå¦‚ btc-shopflow-deploy-dashboard-appï¼‰
// 2. åœ¨ Job é…ç½®ä¸­ï¼ŒPipeline éƒ¨åˆ†é€‰æ‹© "Pipeline script from SCM"
// 3. è®¾ç½® Script Path ä¸º "jenkins/Jenkinsfile.dashboard-app"

pipeline {
    agent any
    
    environment {
        NODE_VERSION = '20'
        PNPM_VERSION = '8.15.0'
        APP_NAME = 'dashboard-app'
        DEPLOY_CONFIG = 'deploy.config.json'
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }
    
    // é…ç½®æ„å»ºè§¦å‘å™¨
    // ä½¿ç”¨ Poll SCM è‡ªåŠ¨è½®è¯¢ï¼ˆæ¯ 2 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä»£ç å˜æ›´ï¼‰
    // ä¼˜ç‚¹ï¼šæ— éœ€é…ç½® Webhookï¼Œé€‚åˆæœ¬åœ° Jenkinsï¼Œè‡ªåŠ¨è§¦å‘æ„å»º
    // æµç¨‹ï¼šä¿®æ”¹ä»£ç  â†’ æäº¤æ¨é€ â†’ è‡ªåŠ¨æ„å»ºï¼ˆ2åˆ†é’Ÿå†…ï¼‰ â†’ æŸ¥çœ‹ç»“æœ
    triggers {
        pollSCM('H/2 * * * *')  // æ¯ 2 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä»£ç å˜æ›´
    }
    
    parameters {
        string(name: 'SERVER_HOST', defaultValue: '47.112.31.96', description: 'æœåŠ¡å™¨åœ°å€')
        string(name: 'SERVER_USER', defaultValue: 'root', description: 'æœåŠ¡å™¨ç”¨æˆ·å')
        string(name: 'SERVER_PORT', defaultValue: '22', description: 'SSH ç«¯å£')
        string(name: 'SSH_KEY_PATH', defaultValue: '/var/jenkins_home/.ssh/id_rsa', description: 'SSH ç§é’¥è·¯å¾„')
        booleanParam(name: 'SKIP_TESTS', defaultValue: true, description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•')
        booleanParam(name: 'CLEAN_BUILD', defaultValue: true, description: 'æ˜¯å¦æ¸…ç†æ„å»ºç¼“å­˜')
        booleanParam(name: 'BUILD_SHARED_DEPS', defaultValue: false, description: 'æ˜¯å¦æ„å»ºå…±äº«ä¾èµ–åŒ…')
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "ğŸ“¦ æ£€å‡ºä»£ç ..."
                    checkout scm
                    if (isUnix()) {
                        sh '''
                            echo "Git ä¿¡æ¯:"
                            echo "  åˆ†æ”¯: $(git branch --show-current)"
                            echo "  æäº¤: $(git rev-parse --short HEAD)"
                            echo "  ä½œè€…: $(git log -1 --pretty=format:'%an <%ae>')"
                            echo "  æ¶ˆæ¯: $(git log -1 --pretty=format:'%s')"
                        '''
                    } else {
                        bat '''
                            @echo off
                            echo Git ä¿¡æ¯:
                            for /f "delims=" %%i in ('git branch --show-current') do echo   åˆ†æ”¯: %%i
                            for /f "delims=" %%i in ('git rev-parse --short HEAD') do echo   æäº¤: %%i
                            for /f "delims=" %%i in ('git log -1 --pretty=format:"%%an ^<%%ae^>"') do echo   ä½œè€…: %%i
                            for /f "delims=" %%i in ('git log -1 --pretty=format:"%%s"') do echo   æ¶ˆæ¯: %%i
                        '''
                    }
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                script {
                    echo "ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒ..."
                    
                    // å°è¯•ä½¿ç”¨ NodeJS Pluginï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
                    try {
                        def nodejs = tool name: 'NodeJS', type: 'jenkins.plugins.nodejs.tools.NodeJSInstallation'
                        env.PATH = "${nodejs}/bin:${env.PATH}"
                        echo "âœ… ä½¿ç”¨ NodeJS Plugin å®‰è£…çš„ Node.js: ${nodejs}"
                    } catch (Exception e) {
                        echo "â„¹ï¸ NodeJS Plugin æœªé…ç½®æˆ–æœªæ‰¾åˆ°ï¼Œå°è¯•ä½¿ç”¨ç³»ç»Ÿ Node.js"
                    }
                    
                    if (isUnix()) {
                        sh '''
                            # æ£€æŸ¥ Node.jsï¼ˆä¼˜å…ˆä½¿ç”¨ NodeJS Plugin è®¾ç½®çš„ PATHï¼‰
                            if command -v node >/dev/null 2>&1; then
                                # éªŒè¯ Node.js æ˜¯å¦èƒ½æ­£å¸¸è¿è¡Œ
                                if node --version >/dev/null 2>&1; then
                                    echo "âœ… Node.js å·²å®‰è£…: $(node --version)"
                                else
                                    echo "âŒ Node.js å‘½ä»¤å­˜åœ¨ä½†æ— æ³•è¿è¡Œ"
                                    echo "é”™è¯¯ä¿¡æ¯: $(node --version 2>&1 || true)"
                                    echo ""
                                    echo "ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š"
                                    echo "   1. ç¼ºå°‘ç³»ç»Ÿåº“ï¼ˆå¦‚ libatomic.so.1ï¼‰"
                                    echo "   2. Node.js äºŒè¿›åˆ¶æ–‡ä»¶æŸåæˆ–ä¸å…¼å®¹"
                                    echo ""
                                    echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š"
                                    echo "   å¦‚æœä½¿ç”¨ NodeJS Pluginï¼Œå¯èƒ½éœ€è¦åœ¨ Jenkins å®¹å™¨ä¸­å®‰è£…ç¼ºå¤±çš„åº“ï¼š"
                                    echo "   docker exec -u root jenkins bash -c 'apt-get update && apt-get install -y libatomic1'"
                                    echo ""
                                    echo "   æˆ–è€…ä½¿ç”¨ç³»ç»Ÿå®‰è£…çš„ Node.jsï¼ˆå¦‚æœå®¹å™¨ä¸­å·²å®‰è£…ï¼‰"
                                    exit 1
                                fi
                            else
                                echo "âŒ Node.js æœªæ‰¾åˆ°"
                                echo "ğŸ’¡ è¯·ç¡®ä¿ï¼š"
                                echo "   1. å¦‚æœä½¿ç”¨ NodeJS Pluginï¼šåœ¨ Jenkins å…¨å±€é…ç½®ä¸­é…ç½® Node.js å·¥å…·ï¼Œåç§°ä¸º 'NodeJS'"
                                echo "   2. å¦‚æœä½¿ç”¨ç³»ç»Ÿå®‰è£…ï¼šç¡®ä¿ Node.js å·²å®‰è£…åœ¨ç³»ç»Ÿ PATH ä¸­"
                                exit 1
                            fi
                            
                            if ! command -v pnpm >/dev/null 2>&1; then
                                echo "ğŸ“¦ å®‰è£… pnpm ${PNPM_VERSION}..."
                                npm install -g pnpm@${PNPM_VERSION} || exit 1
                            else
                                echo "âœ… pnpm å·²å®‰è£…: $(pnpm --version)"
                            fi
                        '''
                    } else {
                        bat '''
                            @echo off
                            where node >nul 2>&1
                            if %errorlevel% neq 0 (exit /b 1)
                            node --version
                            where pnpm >nul 2>&1
                            if %errorlevel% neq 0 (call npm install -g pnpm@%PNPM_VERSION%)
                            pnpm --version
                        '''
                    }
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                script {
                    echo "ğŸ“š å®‰è£…ä¾èµ–..."
                    if (isUnix()) {
                        sh '''
                            pnpm install --frozen-lockfile --prefer-offline
                            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
                        '''
                    } else {
                        bat '''call pnpm install --frozen-lockfile --prefer-offline'''
                    }
                }
            }
        }
        
        stage('Build Shared Dependencies') {
            when { expression { params.BUILD_SHARED_DEPS } }
            steps {
                script {
                    echo "ğŸ”¨ æ„å»ºå…±äº«ä¾èµ–åŒ…..."
                    if (isUnix()) {
                        sh '''
                            pnpm --filter @btc/vite-plugin run build --force || true
                            pnpm --filter @btc/shared-utils run build --force || true
                            pnpm --filter @btc/shared-core run build --force || true
                            pnpm --filter @btc/shared-components run build --force || true
                            pnpm --filter @btc/subapp-manifests run build --force || true
                            echo "âœ… å…±äº«ä¾èµ–åŒ…æ„å»ºå®Œæˆ"
                        '''
                    } else {
                        bat '''
                            call pnpm --filter @btc/vite-plugin run build --force || echo.
                            call pnpm --filter @btc/shared-utils run build --force || echo.
                            call pnpm --filter @btc/shared-core run build --force || echo.
                            call pnpm --filter @btc/shared-components run build --force || echo.
                            call pnpm --filter @btc/subapp-manifests run build --force || echo.
                        '''
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                    def appName = env.APP_NAME
                    def scriptName = appName.replace('-app', '')
                    echo "ğŸ”¨ æ„å»ºåº”ç”¨: ${appName}..."
                    def enableCdn = 'true'
                    def enableCdnUpload = 'true'
                    if (isUnix()) {
                        sh """
                            export ENABLE_CDN_ACCELERATION=${enableCdn}
                            export ENABLE_CDN_UPLOAD=${enableCdnUpload}
                            echo "æ„å»ºåº”ç”¨: ${appName}..."
                            echo "CDN åŠ é€Ÿ: ${enableCdn}"
                            echo "CDN ä¸Šä¼ : ${enableCdnUpload}"
                            pnpm build:${scriptName} && node scripts/build-to-dist.mjs --app ${appName}
                            echo "âœ… ${appName} æ„å»ºå®Œæˆï¼Œäº§ç‰©åœ¨ dist ç›®å½•"
                        """
                    } else {
                        bat """
                            @echo off
                            set ENABLE_CDN_ACCELERATION=${enableCdn}
                            set ENABLE_CDN_UPLOAD=${enableCdnUpload}
                            echo æ„å»ºåº”ç”¨: ${appName}...
                            echo CDN åŠ é€Ÿ: ${enableCdn}
                            echo CDN ä¸Šä¼ : ${enableCdnUpload}
                            call pnpm build:${scriptName} && node scripts/build-to-dist.mjs --app ${appName}
                            echo âœ… ${appName} æ„å»ºå®Œæˆ
                        """
                    }
                }
            }
        }
        
        stage('Verify Build Artifacts') {
            steps {
                script {
                    def appName = env.APP_NAME
                    echo "âœ… éªŒè¯æ„å»ºäº§ç‰©: ${appName}..."
                    if (isUnix()) {
                        sh """
                            DOMAIN="dashboard.bellis.com.cn"
                            APP_DIR="dist/\$DOMAIN"
                            
                            if [ -d "\$APP_DIR" ] && [ -n "\$(ls -A \$APP_DIR 2>/dev/null)" ]; then
                                echo "âœ… ${appName}: æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡ (ç›®å½•: \$APP_DIR)"
                                du -sh \$APP_DIR | awk '{print "å¤§å°: " \$1}'
                                if [ -f "\$APP_DIR/index.html" ]; then
                                    echo "âœ… index.html å­˜åœ¨"
                                fi
                                if [ -d "\$APP_DIR/assets" ]; then
                                    echo "âœ… assets ç›®å½•å­˜åœ¨"
                                    echo "   JS æ–‡ä»¶æ•°é‡: \$(find \$APP_DIR/assets -name '*.js' | wc -l)"
                                    echo "   CSS æ–‡ä»¶æ•°é‡: \$(find \$APP_DIR/assets -name '*.css' | wc -l)"
                                fi
                            else
                                echo "âŒ ${appName}: æ„å»ºäº§ç‰©ä¸å­˜åœ¨æˆ–ä¸ºç©º (é¢„æœŸç›®å½•: \$APP_DIR)"
                                exit 1
                            fi
                        """
                    } else {
                        bat """
                            @echo off
                            set DOMAIN=dashboard.bellis.com.cn
                            set APP_DIR=dist\\%DOMAIN%
                            if exist "%APP_DIR%" (
                                echo âœ… ${appName}: æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡
                            ) else (
                                echo âŒ ${appName}: æ„å»ºäº§ç‰©ä¸å­˜åœ¨
                                exit /b 1
                            )
                        """
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    def appName = env.APP_NAME
                    def serverHost = params.SERVER_HOST
                    def serverUser = params.SERVER_USER
                    def serverPort = params.SERVER_PORT
                    def sshKeyPath = params.SSH_KEY_PATH
                    
                    echo "ğŸš€ éƒ¨ç½²åº”ç”¨: ${appName}..."
                    if (isUnix()) {
                        sh """
                            echo "ğŸš€ éƒ¨ç½²é…ç½®:"
                            echo "  æœåŠ¡å™¨: ${serverUser}@${serverHost}:${serverPort}"
                            echo "  SSH å¯†é’¥: ${sshKeyPath}"
                            echo "  åº”ç”¨: ${appName}"
                            
                            if [ ! -f "${sshKeyPath}" ]; then
                                echo "âŒ SSH å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: ${sshKeyPath}"
                                exit 1
                            fi
                            
                            chmod 600 "${sshKeyPath}" || true
                            export SERVER_HOST="${serverHost}"
                            export SERVER_USER="${serverUser}"
                            export SERVER_PORT="${serverPort}"
                            export SSH_KEY="${sshKeyPath}"
                            
                            echo "æµ‹è¯• SSH è¿æ¥..."
                            if ssh -i "${sshKeyPath}" -p "${serverPort}" \
                                -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
                                "${serverUser}@${serverHost}" "echo 'SSH connection successful'" 2>&1; then
                                echo "âœ… SSH è¿æ¥æˆåŠŸ"
                            else
                                echo "âŒ SSH è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
                                exit 1
                            fi
                            
                            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                            echo "éƒ¨ç½²åº”ç”¨: ${appName}..."
                            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                            
                            bash scripts/deploy-static.sh --app ${appName}
                        """
                    } else {
                        bat """
                            @echo off
                            echo ğŸš€ éƒ¨ç½²é…ç½®:
                            echo   æœåŠ¡å™¨: ${serverUser}@${serverHost}:${serverPort}
                            echo   SSH å¯†é’¥: ${sshKeyPath}
                            echo   åº”ç”¨: ${appName}
                            if not exist "${sshKeyPath}" (
                                echo âŒ SSH å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: ${sshKeyPath}
                                exit /b 1
                            )
                            where bash >nul 2>&1
                            if !errorlevel! equ 0 (
                                bash -c "export SERVER_HOST='${serverHost}' SERVER_USER='${serverUser}' SERVER_PORT='${serverPort}' SSH_KEY='${sshKeyPath}' && bash scripts/deploy-static.sh --app ${appName}"
                            ) else (
                                echo âŒ æœªæ‰¾åˆ° bash
                                exit /b 1
                            )
                        """
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo """
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… åº”ç”¨æ„å»ºå’Œéƒ¨ç½²æˆåŠŸï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åº”ç”¨: ${env.APP_NAME}
åŸŸå: dashboard.bellis.com.cn
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            }
        }
        failure {
            script {
                echo """
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âŒ åº”ç”¨æ„å»ºæˆ–éƒ¨ç½²å¤±è´¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥ç¡®å®šå¤±è´¥åŸå› 
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            }
        }
    }
}
