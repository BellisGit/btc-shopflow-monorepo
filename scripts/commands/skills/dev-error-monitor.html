<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç›‘æ§ä¸­å¿ƒ - BTC ShopFlow</title>
  <link rel="icon" type="image/png" href="/logo.png" />
  <link rel="shortcut icon" type="image/png" href="/logo.png" />
  <link rel="apple-touch-icon" href="/logo.png" />
  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css?v=2.4.4" crossorigin="anonymous">
  <!-- Element Plus Dark Theme -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/theme-chalk/dark/css-vars.css?v=2.4.4" crossorigin="anonymous">
  <script>
    // ç¡®ä¿ CSS åŠ è½½å®Œæˆåæ˜¾ç¤ºé¡µé¢
    (function() {
      function checkAllLoaded() {
        if (document.body) {
          document.body.classList.add('loaded');
        }
      }
      
      // ç­‰å¾… DOM åŠ è½½å®Œæˆ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          initCSSLoader();
        });
      } else {
        // DOM å·²ç»åŠ è½½å®Œæˆ
        initCSSLoader();
      }
      
      function initCSSLoader() {
        const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
        let loadedCount = 0;
        const totalCount = stylesheets.length;
        
        if (totalCount === 0) {
          // æ²¡æœ‰æ ·å¼è¡¨ï¼Œç›´æ¥æ˜¾ç¤º
          checkAllLoaded();
          return;
        }
        
        function onStylesheetLoaded() {
          loadedCount++;
          if (loadedCount >= totalCount) {
            checkAllLoaded();
          }
        }
        
        stylesheets.forEach(link => {
          if (link.sheet) {
            // å·²ç»åŠ è½½å®Œæˆ
            onStylesheetLoaded();
          } else {
            link.onload = onStylesheetLoaded;
            link.onerror = onStylesheetLoaded; // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­æ˜¾ç¤º
          }
        });
        
        // è¶…æ—¶ä¿æŠ¤ï¼š3ç§’åå¼ºåˆ¶æ˜¾ç¤º
        setTimeout(() => {
          checkAllLoaded();
        }, 3000);
      }
    })();
  </script>
  <style>
    /* é˜²æ­¢ CSS åŠ è½½å¤±è´¥æ—¶çš„æ ·å¼é—ªçƒ */
    body:not(.loaded) {
      visibility: hidden;
    }
    body.loaded {
      visibility: visible;
    }
  </style>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
    }

    body {
      margin: 0;
      padding: 0;
    }

    #app {
      height: 100%;
    }

    .common-layout {
      height: 100%;
    }

    .layout-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background-color: var(--el-bg-color, #fff);
      border-bottom: 1px solid var(--el-border-color-lighter, #ebeef5);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .layout-aside {
      background-color: var(--el-bg-color, #fff);
      border-right: 1px solid var(--el-border-color-lighter, #ebeef5);
      overflow: hidden;
    }

    .layout-aside :deep(.el-menu) {
      border-right: none;
    }

    .layout-aside :deep(.el-menu-item) {
      height: 56px;
      line-height: 56px;
      font-size: 14px;
    }

    .layout-aside :deep(.el-menu-item.is-active) {
      background-color: var(--el-color-primary-light-9, #ecf5ff);
      color: var(--el-color-primary, #409eff);
    }

    .layout-main {
      background-color: var(--el-bg-color-page, #f5f7fa);
      padding: 20px;
      overflow: hidden;
    }

    .layout-main :deep(.el-card) {
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
    }

    .layout-main :deep(.el-card__header) {
      padding: 18px 20px;
      border-bottom: 1px solid var(--el-border-color-lighter, #ebeef5);
    }

    .layout-main :deep(.el-card__body) {
      padding: 20px;
    }

    .aside-content {
      padding: 20px;
    }

    .aside-section {
      margin-bottom: 24px;
    }

    .aside-section-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--el-text-color-regular, #606266);
      margin-bottom: 12px;
    }

    .monitor-row {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      row-gap: 10px;
      column-gap: 10px;
      flex-shrink: 0;
    }

    .monitor-row + .monitor-row {
      margin-top: 10px;
    }

    .monitor-flex1 {
      flex: 1;
      font-size: 12px;
    }

    /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
    .stats-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .stat-item {
      flex: 1;
      min-width: 120px;
      text-align: center;
      padding: 16px;
      background: var(--el-bg-color, #fff);
      border-radius: var(--el-border-radius-base, 4px);
      border: 1px solid var(--el-border-color-lighter, #ebeef5);
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 8px;
      line-height: 1;
    }

    .stat-label {
      font-size: 14px;
      color: var(--el-text-color-secondary, #909399);
    }

    /* è¡¨æ ¼å®¹å™¨ */
    .table-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .table-container .el-table {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--el-border-color, #dcdfe6);
    }

    .table-container .el-table__inner {
      flex: 1;
      min-height: 0;
    }

    /* è¡¨æ ¼è¾¹æ¡†æ ·å¼ */
    .layout-main :deep(.el-table) {
      border: 1px solid var(--el-border-color, #dcdfe6);
    }

    .layout-main :deep(.el-table__header-wrapper) {
      border-bottom: 1px solid var(--el-border-color, #dcdfe6);
    }

    .layout-main :deep(.el-table__body-wrapper) {
      border-top: 1px solid var(--el-border-color, #dcdfe6);
    }

    .layout-main :deep(.el-table th),
    .layout-main :deep(.el-table td) {
      border-right: 1px solid var(--el-border-color, #dcdfe6);
    }

    .layout-main :deep(.el-table th:last-child),
    .layout-main :deep(.el-table td:last-child) {
      border-right: none;
    }

    /* é”™è¯¯ä¿¡æ¯å•å…ƒæ ¼ */
    .error-message-cell {
      max-width: 500px;
      cursor: pointer;
      line-height: 1.5;
    }

    .error-message-cell.expanded {
      white-space: normal;
      word-break: break-all;
    }

    .error-message-cell:not(.expanded) {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-path-cell {
      max-width: 300px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--el-text-color-regular, #606266);
    }

    .suggestion-text {
      color: var(--el-color-warning, #e6a23c);
      font-size: 12px;
      margin-top: 4px;
      display: block;
      padding: 4px 8px;
      background: var(--el-color-warning-light-9, #fdf6ec);
      border-radius: 4px;
    }

    .new-error-row {
      animation: highlight 2s ease-out;
    }

    @keyframes highlight {
      0% { background: var(--el-color-warning-light-9, #fdf6ec); }
      100% { background: transparent; }
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* è¿æ¥çŠ¶æ€ */
    .connection-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    /* è¯¦æƒ…å¯¹è¯æ¡† */
    .error-detail-pre {
      background: var(--el-bg-color-page, #f5f7fa);
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
      max-height: 300px;
      overflow-y: auto;
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .stats-row {
        flex-direction: column;
      }

      .stat-item {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="common-layout">
      <el-container style="height: 100%;">
        <!-- é¡¶æ  -->
        <el-header class="layout-header" height="60px">
          <div style="display: flex; align-items: center; gap: 16px;">
            <h2 style="margin: 0; font-size: 20px; font-weight: 600; color: var(--el-text-color-primary, #303133);">
              ç›‘æ§ä¸­å¿ƒ
            </h2>
            <el-tag :type="connectionStatus === 'connected' ? 'success' : connectionStatus === 'connecting' ? 'warning' : 'danger'" size="large">
              {{ connectionStatus === 'connected' ? 'å·²è¿æ¥' : connectionStatus === 'connecting' ? 'è¿æ¥ä¸­...' : 'æœªè¿æ¥' }}
            </el-tag>
          </div>
        </el-header>

        <el-container>
          <!-- å·¦ä¾§èœå• -->
          <el-aside width="220px" class="layout-aside">
            <el-menu
              :default-active="$route.path || '/dev'"
              @select="handleMenuSelect"
              style="height: 100%;"
              :collapse="false"
              :router="true"
            >
              <el-menu-item index="/dev">
                <span style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                  <span>æœåŠ¡ç›‘æ§</span>
                  <el-badge v-if="devCount > 0" :value="devCount" :max="99" />
                </span>
              </el-menu-item>
              <el-menu-item index="/errors">
                <span style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                  <span>é”™è¯¯ç›‘æ§</span>
                  <el-badge v-if="errors.length > 0" :value="errors.length" :max="99" />
                </span>
              </el-menu-item>
            </el-menu>
          </el-aside>

          <!-- å³ä¾§å†…å®¹ -->
          <el-main class="layout-main">
            <router-view v-slot="{ Component }">
              <component :is="Component" />
            </router-view>
          </el-main>
              <!-- ç­›é€‰å’Œæ“ä½œæ  -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; background: var(--el-bg-color, #fff); border-radius: 4px; border: 1px solid var(--el-border-color-lighter, #ebeef5);">
                <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                  <span style="color: var(--el-text-color-regular, #606266); font-size: 14px; font-weight: 500;">ä¸¥é‡ç¨‹åº¦:</span>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <el-checkbox v-model="filters.critical" id="filter-critical" name="filter-critical" />
                    <el-tag type="danger" size="small" effect="dark">ä¸¥é‡</el-tag>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <el-checkbox v-model="filters.error" id="filter-error" name="filter-error" />
                    <el-tag type="danger" size="small" effect="plain">é”™è¯¯</el-tag>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <el-checkbox v-model="filters.warning" id="filter-warning" name="filter-warning" />
                    <el-tag type="warning" size="small" effect="plain">è­¦å‘Š</el-tag>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <el-checkbox v-model="filters.info" id="filter-info" name="filter-info" />
                    <el-tag type="info" size="small" effect="plain">ä¿¡æ¯</el-tag>
                  </div>
                  <el-select
                    v-model="filterPackageName"
                    id="filter-package-name"
                    name="filter-package-name"
                    placeholder="å·¥ä½œç©ºé—´"
                    clearable
                    style="width: 200px;"
                  >
                    <el-option
                      v-for="pkg in packageNames"
                      :key="pkg"
                      :label="pkg"
                      :value="pkg"
                    />
                  </el-select>
                  <el-select
                    v-model="filterErrorType"
                    id="filter-error-type"
                    name="filter-error-type"
                    placeholder="é”™è¯¯ç±»å‹"
                    clearable
                    style="width: 200px;"
                  >
                    <el-option
                      v-for="type in errorTypes"
                      :key="type"
                      :label="type"
                      :value="type"
                    />
                  </el-select>
                </div>
                <div style="display: flex; gap: 10px;">
                  <el-button type="danger" @click="clearAllErrors" :disabled="errors.length === 0">
                    æ¸…ç©ºåˆ—è¡¨
                  </el-button>
                  <el-button type="primary" @click="exportErrors" :disabled="errors.length === 0">
                    å¯¼å‡ºé”™è¯¯
                  </el-button>
                </div>
              </div>

              <!-- è¡¨æ ¼å®¹å™¨ -->
              <div class="table-container">
                <el-table
                  :data="filteredErrors"
                  stripe
                  border
                  style="width: 100%"
                  v-loading="loading"
                  @row-click="handleRowClick"
                  row-class-name="error-row"
                  height="100%"
                >
          <template #empty>
            <el-empty :description="emptyText" />
          </template>
          <el-table-column prop="severity" label="ä¸¥é‡ç¨‹åº¦" width="120" align="center" fixed="left">
            <template #default="{ row }">
              <el-tag
                :type="getSeverityType(row.severity)"
                size="small"
                effect="dark"
              >
                {{ getSeverityLabel(row.severity) }}
              </el-tag>
            </template>
          </el-table-column>
          
          <el-table-column prop="errorType" label="ç±»å‹" width="140" align="center">
            <template #default="{ row }">
              <el-tag type="info" size="small" effect="plain">
                {{ row.errorType || 'unknown' }}
              </el-tag>
              <el-tag v-if="row.fixable" type="success" size="small" effect="plain" style="margin-left: 4px;">
                å¯ä¿®å¤
              </el-tag>
            </template>
          </el-table-column>
          
          <el-table-column prop="packageName" label="å·¥ä½œç©ºé—´" width="180" align="center">
            <template #default="{ row }">
              <el-tag type="warning" size="small" effect="plain">
                {{ row.packageName || 'æœªçŸ¥' }}
              </el-tag>
            </template>
          </el-table-column>
          
          <el-table-column prop="filePath" label="æ–‡ä»¶" width="250" align="center" show-overflow-tooltip>
            <template #default="{ row }">
              <code class="file-path-cell">{{ row.filePath || '-' }}</code>
            </template>
          </el-table-column>
          
          <el-table-column prop="errorMessage" label="é”™è¯¯ä¿¡æ¯" min-width="400" align="center">
            <template #default="{ row }">
              <div
                class="error-message-cell"
                :class="{ expanded: expandedMessages.has(row.errorHash) }"
                @click.stop="toggleMessage(row.errorHash)"
              >
                <div>{{ row.errorMessage || '' }}</div>
                <span v-if="row.suggestion" class="suggestion-text">
                  {{ row.suggestion }}
                </span>
                <el-button
                  v-if="hasMoreInfo(row)"
                  link
                  type="primary"
                  size="small"
                  @click.stop="showDetailDialog(row)"
                  style="margin-top: 4px;"
                >
                  æŸ¥çœ‹è¯¦æƒ…
                </el-button>
              </div>
            </template>
          </el-table-column>
          
          <el-table-column prop="occurrence_count" label="æ¬¡æ•°" width="80" align="center">
            <template #default="{ row }">
              <el-badge :value="row.occurrence_count || 1" :max="99" />
            </template>
          </el-table-column>
          
          <el-table-column prop="timestamp" label="æ—¶é—´" width="150" align="center">
            <template #default="{ row }">
              <span style="color: var(--el-text-color-secondary, #909399); font-size: 12px;">
                {{ formatTime(row.timestamp) }}
              </span>
            </template>
          </el-table-column>
                </el-table>
              </div>
            </div>
          </el-main>
        </el-container>
      </el-container>
    </div>

  </div>

  <!-- Vue 3 Production Build -->
  <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>
  <!-- Vue Router -->
  <script src="https://unpkg.com/vue-router@4.2.5/dist/vue-router.global.prod.js"></script>
  <!-- Element Plus JS -->
  <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
  <!-- Element Plus Icons -->
  <script src="https://unpkg.com/@element-plus/icons-vue@2.3.1/dist/index.iife.js"></script>

  <script>
    const { createApp, ref, computed, onMounted, onUnmounted, provide, inject, watch } = Vue;
    const { createRouter, createWebHashHistory } = VueRouter;
    const { ElMessage, ElNotification } = ElementPlus;

    // æœåŠ¡ç›‘æ§ç»„ä»¶
    const DevServiceMonitor = {
      template: `
        <div style="height: 100%;">
          <el-card shadow="hover" style="height: 100%; display: flex; flex-direction: column;">
            <template #header>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>è¿è¡Œä¸­çš„å¼€å‘æœåŠ¡å™¨ ({{ devCount }})</span>
                <el-button size="small" @click="refreshCommands">åˆ·æ–°</el-button>
              </div>
            </template>
            <div style="flex: 1; overflow-y: auto;">
              <template v-if="devCommands.length === 0">
                <el-empty description="æš‚æ— è¿è¡Œä¸­çš„å¼€å‘æœåŠ¡å™¨" />
              </template>
              <div v-else style="display: flex; flex-direction: column; gap: 12px;">
                <el-card v-for="cmd in devCommands" :key="cmd.id" shadow="hover" style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <el-tag type="success" size="small">è¿è¡Œä¸­</el-tag>
                        <code style="font-size: 13px; color: var(--el-text-color-primary, #303133);">{{ cmd.command }} {{ (cmd.args || []).join(' ') }}</code>
                      </div>
                      <div style="color: var(--el-text-color-secondary, #909399); font-size: 12px;">
                        å¯åŠ¨æ—¶é—´: {{ formatTime(cmd.startTime) }}
                      </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                      <el-button type="primary" size="small" @click="viewErrorsForCommand(cmd.id)">
                        æŸ¥çœ‹é”™è¯¯
                      </el-button>
                      <el-button type="danger" size="small" @click="stopCommand(cmd.id)">
                        åœæ­¢
                      </el-button>
                    </div>
                  </div>
                </el-card>
              </div>
            </div>
          </el-card>
        </div>
      `,
      setup() {
        const context = inject('monitorContext', {});
        const { runningCommands = ref([]), refreshCommands = () => {}, stopCommand = async () => {}, formatTime = () => '-', router = null } = context;
        const { ElMessage } = ElementPlus;

        const devCommands = computed(() => {
          return runningCommands.value.filter(cmd => 
            (cmd.command === 'dev:all' || cmd.command === 'dev' || 
            (cmd.command && cmd.command.includes('dev'))) && cmd.status === 'running'
          );
        });

        const devCount = computed(() => devCommands.value.length);

        const viewErrorsForCommand = (commandId) => {
          const context = inject('monitorContext', {});
          const routerInstance = context.router;
          if (routerInstance) {
            routerInstance.push('/errors');
          }
        };

        const handleStopCommand = async (commandId) => {
          await stopCommand(commandId);
        };

        return {
          devCommands,
          devCount,
          refreshCommands,
          stopCommand: handleStopCommand,
          formatTime,
          viewErrorsForCommand
        };
      }
    };

    // é”™è¯¯ç›‘æ§ç»„ä»¶
    const ErrorMonitor = {
      template: `
        <div style="height: 100%; display: flex; flex-direction: column;">
          <!-- ç­›é€‰å’Œæ“ä½œæ  -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; background: var(--el-bg-color, #fff); border-radius: 4px; border: 1px solid var(--el-border-color-lighter, #ebeef5);">
            <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
              <span style="color: var(--el-text-color-regular, #606266); font-size: 14px; font-weight: 500;">ä¸¥é‡ç¨‹åº¦:</span>
              <div style="display: flex; align-items: center; gap: 8px;">
                <el-checkbox v-model="filters.critical" id="filter-critical" name="filter-critical" />
                <el-tag type="danger" size="small" effect="dark">ä¸¥é‡</el-tag>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <el-checkbox v-model="filters.error" id="filter-error" name="filter-error" />
                <el-tag type="danger" size="small" effect="plain">é”™è¯¯</el-tag>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <el-checkbox v-model="filters.warning" id="filter-warning" name="filter-warning" />
                <el-tag type="warning" size="small" effect="plain">è­¦å‘Š</el-tag>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <el-checkbox v-model="filters.info" id="filter-info" name="filter-info" />
                <el-tag type="info" size="small" effect="plain">ä¿¡æ¯</el-tag>
              </div>
              <el-select
                v-model="filterPackageName"
                id="filter-package-name"
                name="filter-package-name"
                placeholder="å·¥ä½œç©ºé—´"
                clearable
                style="width: 200px;"
              >
                <el-option
                  v-for="pkg in packageNames"
                  :key="pkg"
                  :label="pkg"
                  :value="pkg"
                />
              </el-select>
              <el-select
                v-model="filterErrorType"
                id="filter-error-type"
                name="filter-error-type"
                placeholder="é”™è¯¯ç±»å‹"
                clearable
                style="width: 200px;"
              >
                <el-option
                  v-for="type in errorTypes"
                  :key="type"
                  :label="type"
                  :value="type"
                />
              </el-select>
            </div>
            <div style="display: flex; gap: 10px;">
              <el-button type="danger" @click="clearAllErrors" :disabled="errors.length === 0">
                æ¸…ç©ºåˆ—è¡¨
              </el-button>
              <el-button type="primary" @click="exportErrors" :disabled="errors.length === 0">
                å¯¼å‡ºé”™è¯¯
              </el-button>
            </div>
          </div>

          <!-- è¡¨æ ¼å®¹å™¨ -->
          <div class="table-container">
            <el-table
              :data="filteredErrors"
              stripe
              border
              style="width: 100%"
              v-loading="loading"
              @row-click="handleRowClick"
              row-class-name="error-row"
              height="100%"
            >
              <template #empty>
                <el-empty :description="emptyText" />
              </template>
              <el-table-column prop="severity" label="ä¸¥é‡ç¨‹åº¦" width="120" align="center" fixed="left">
                <template #default="{ row }">
                  <el-tag
                    :type="getSeverityType(row.severity)"
                    size="small"
                    effect="dark"
                  >
                    {{ getSeverityLabel(row.severity) }}
                  </el-tag>
                </template>
              </el-table-column>
              
              <el-table-column prop="errorType" label="ç±»å‹" width="140" align="center">
                <template #default="{ row }">
                  <el-tag type="info" size="small" effect="plain">
                    {{ row.errorType || 'unknown' }}
                  </el-tag>
                  <el-tag v-if="row.fixable" type="success" size="small" effect="plain" style="margin-left: 4px;">
                    å¯ä¿®å¤
                  </el-tag>
                </template>
              </el-table-column>
              
              <el-table-column prop="packageName" label="å·¥ä½œç©ºé—´" width="180" align="center">
                <template #default="{ row }">
                  <el-tag type="warning" size="small" effect="plain">
                    {{ row.packageName || 'æœªçŸ¥' }}
                  </el-tag>
                </template>
              </el-table-column>
              
              <el-table-column prop="filePath" label="æ–‡ä»¶" width="250" align="center" show-overflow-tooltip>
                <template #default="{ row }">
                  <code class="file-path-cell">{{ row.filePath || '-' }}</code>
                </template>
              </el-table-column>
              
              <el-table-column prop="errorMessage" label="é”™è¯¯ä¿¡æ¯" min-width="400" align="center">
                <template #default="{ row }">
                  <div
                    class="error-message-cell"
                    :class="{ expanded: expandedMessages.has(row.errorHash) }"
                    @click.stop="toggleMessage(row.errorHash)"
                  >
                    <div>{{ row.errorMessage || '' }}</div>
                    <span v-if="row.suggestion" class="suggestion-text">
                      {{ row.suggestion }}
                    </span>
                    <el-button
                      v-if="hasMoreInfo(row)"
                      link
                      type="primary"
                      size="small"
                      @click.stop="showDetailDialog(row)"
                      style="margin-top: 4px;"
                    >
                      æŸ¥çœ‹è¯¦æƒ…
                    </el-button>
                  </div>
                </template>
              </el-table-column>
              
              <el-table-column prop="occurrence_count" label="æ¬¡æ•°" width="80" align="center">
                <template #default="{ row }">
                  <el-badge :value="row.occurrence_count || 1" :max="99" />
                </template>
              </el-table-column>
              
              <el-table-column prop="timestamp" label="æ—¶é—´" width="150" align="center">
                <template #default="{ row }">
                  <span style="color: var(--el-text-color-secondary, #909399); font-size: 12px;">
                    {{ formatTime(row.timestamp) }}
                  </span>
                </template>
              </el-table-column>
            </el-table>
          </div>

          <!-- é”™è¯¯è¯¦æƒ…å¯¹è¯æ¡† -->
          <el-dialog
            v-model="detailDialogVisible"
            title="é”™è¯¯è¯¦æƒ…"
            width="70%"
            :before-close="handleCloseDetail"
          >
            <el-descriptions :column="2" border v-if="selectedError">
              <el-descriptions-item label="ä¸¥é‡ç¨‹åº¦">
                <el-tag :type="getSeverityType(selectedError.severity)" effect="dark">
                  {{ getSeverityLabel(selectedError.severity) }}
                </el-tag>
              </el-descriptions-item>
              <el-descriptions-item label="é”™è¯¯ç±»å‹">
                <el-tag type="info">{{ selectedError.errorType || 'unknown' }}</el-tag>
              </el-descriptions-item>
              <el-descriptions-item label="å·¥ä½œç©ºé—´">
                {{ selectedError.packageName || 'æœªçŸ¥' }}
              </el-descriptions-item>
              <el-descriptions-item label="å‡ºç°æ¬¡æ•°">
                <el-badge :value="selectedError.occurrence_count || 1" />
              </el-descriptions-item>
              <el-descriptions-item label="æ–‡ä»¶è·¯å¾„" :span="2">
                <code>{{ selectedError.filePath || '-' }}</code>
              </el-descriptions-item>
              <el-descriptions-item label="é”™è¯¯ä¿¡æ¯" :span="2">
                <pre class="error-detail-pre">{{ selectedError.errorMessage || '' }}</pre>
              </el-descriptions-item>
              <el-descriptions-item label="åŸå§‹è¾“å‡º" :span="2" v-if="selectedError.rawOutput && selectedError.rawOutput !== selectedError.errorMessage">
                <pre class="error-detail-pre">{{ selectedError.rawOutput }}</pre>
              </el-descriptions-item>
              <el-descriptions-item label="è§£å†³å»ºè®®" :span="2" v-if="selectedError.suggestion">
                <el-alert type="warning" :closable="false">
                  {{ selectedError.suggestion }}
                </el-alert>
              </el-descriptions-item>
            </el-descriptions>
          </el-dialog>
        </div>
      `,
      setup() {
        const context = inject('monitorContext', {});
        const { errors = ref([]), filters = ref({ critical: true, error: true, warning: true, info: true }), connectionStatus = ref('disconnected'), loading = ref(false) } = context;
        const filterPackageName = ref('');
        const filterErrorType = ref('');
        const expandedMessages = ref(new Set());
        const detailDialogVisible = ref(false);
        const selectedError = ref(null);
        const { ElMessage } = ElementPlus;

        const packageNames = computed(() => {
          const names = new Set();
          errors.value.forEach(err => {
            if (err.packageName) {
              names.add(err.packageName);
            }
          });
          return Array.from(names).sort();
        });

        const errorTypes = computed(() => {
          const types = new Set();
          errors.value.forEach(err => {
            if (err.errorType) {
              types.add(err.errorType);
            }
          });
          return Array.from(types).sort();
        });

        const filteredErrors = computed(() => {
          let result = errors.value.filter(err => {
            const severity = err.severity || 'info';
            return filters.value[severity] !== false;
          });

          if (filterPackageName.value) {
            result = result.filter(err => err.packageName === filterPackageName.value);
          }

          if (filterErrorType.value) {
            result = result.filter(err => err.errorType === filterErrorType.value);
          }

          return result.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        });

        const emptyText = computed(() => {
          if (connectionStatus.value === 'disconnected') {
            return 'ç­‰å¾…è¿æ¥...';
          }
          if (errors.value.length === 0) {
            return 'æš‚æ— é”™è¯¯';
          }
          return 'æ²¡æœ‰åŒ¹é…çš„é”™è¯¯';
        });

        const getSeverityType = (severity) => {
          const typeMap = {
            'critical': 'danger',
            'error': 'danger',
            'warning': 'warning',
            'info': 'info'
          };
          return typeMap[severity] || 'info';
        };

        const getSeverityLabel = (severity) => {
          const labelMap = {
            'critical': 'ä¸¥é‡',
            'error': 'é”™è¯¯',
            'warning': 'è­¦å‘Š',
            'info': 'ä¿¡æ¯'
          };
          return labelMap[severity] || severity;
        };

        const formatTime = (timestamp) => {
          if (!timestamp) return '-';
          const date = new Date(timestamp);
          return date.toLocaleTimeString('zh-CN');
        };

        const hasMoreInfo = (error) => {
          return error.rawOutput && error.rawOutput !== error.errorMessage && error.rawOutput.length > error.errorMessage.length;
        };

        const toggleMessage = (errorHash) => {
          if (expandedMessages.value.has(errorHash)) {
            expandedMessages.value.delete(errorHash);
          } else {
            expandedMessages.value.add(errorHash);
          }
        };

        const showDetailDialog = (error) => {
          selectedError.value = error;
          detailDialogVisible.value = true;
        };

        const handleCloseDetail = () => {
          detailDialogVisible.value = false;
          selectedError.value = null;
        };

        const handleRowClick = (row) => {
          showDetailDialog(row);
        };

        const clearAllErrors = () => {
          errors.value = [];
          ElMessage.success('å·²æ¸…ç©ºé”™è¯¯åˆ—è¡¨');
        };

        const exportErrors = () => {
          const dataStr = JSON.stringify(errors.value, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `dev-errors-${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          URL.revokeObjectURL(url);
          ElMessage.success('é”™è¯¯æ•°æ®å·²å¯¼å‡º');
        };

        return {
          errors,
          filters,
          filterPackageName,
          filterErrorType,
          packageNames,
          errorTypes,
          filteredErrors,
          emptyText,
          loading,
          expandedMessages,
          detailDialogVisible,
          selectedError,
          getSeverityType,
          getSeverityLabel,
          formatTime,
          hasMoreInfo,
          toggleMessage,
          showDetailDialog,
          handleCloseDetail,
          handleRowClick,
          clearAllErrors,
          exportErrors
        };
      }
    };

    // è·¯ç”±é…ç½®
    const routes = [
      {
        path: '/',
        redirect: '/dev'
      },
      {
        path: '/dev',
        component: DevServiceMonitor
      },
      {
        path: '/errors',
        component: ErrorMonitor
      }
    ];

    const router = createRouter({
      history: createWebHashHistory(),
      routes
    });

    // ä¸»åº”ç”¨ç»„ä»¶
    createApp({
      setup() {
        const stats = ref({
          critical: 0,
          error: 0,
          warning: 0,
          info: 0
        });

        const errors = ref([]);
        const filters = ref({
          critical: true,
          error: true,
          warning: true,
          info: true
        });

        const connectionStatus = ref('disconnected'); // disconnected, connecting, connected
        const loading = ref(false);
        const runningCommands = ref([]);
        let eventSource = null;
        let commandsRefreshTimer = null;

        // è®¡ç®—å¯ç”¨çš„å·¥ä½œç©ºé—´åˆ—è¡¨
        const packageNames = computed(() => {
          const names = new Set();
          errors.value.forEach(err => {
            if (err.packageName) {
              names.add(err.packageName);
            }
          });
          return Array.from(names).sort();
        });

        // è®¡ç®—å¯ç”¨çš„é”™è¯¯ç±»å‹åˆ—è¡¨
        const errorTypes = computed(() => {
          const types = new Set();
          errors.value.forEach(err => {
            if (err.errorType) {
              types.add(err.errorType);
            }
          });
          return Array.from(types).sort();
        });

        // è®¡ç®—è¿è¡Œä¸­çš„è¿›ç¨‹ç»Ÿè®¡
        const devCommands = computed(() => {
          return runningCommands.value.filter(cmd => 
            (cmd.command === 'dev:all' || cmd.command === 'dev' || 
            (cmd.command && cmd.command.includes('dev'))) && cmd.status === 'running'
          );
        });

        const devCount = computed(() => devCommands.value.length);

        // åˆ·æ–°è¿è¡Œä¸­çš„å‘½ä»¤åˆ—è¡¨
        const refreshCommands = async () => {
          try {
            const response = await fetch('/api/commands');
            const result = await response.json();
            if (response.ok) {
              runningCommands.value = result.commands || [];
            }
          } catch (error) {
            console.error('åˆ·æ–°å‘½ä»¤åˆ—è¡¨å¤±è´¥:', error);
          }
        };

        // åœæ­¢å‘½ä»¤
        const stopCommand = async (commandId) => {
          try {
            const response = await fetch(`/api/commands/${commandId}`, {
              method: 'DELETE'
            });
            const result = await response.json();
            if (response.ok) {
              ElMessage.success(result.message || 'å‘½ä»¤å·²åœæ­¢');
              await refreshCommands();
            } else {
              ElMessage.error(result.error || 'åœæ­¢å‘½ä»¤å¤±è´¥');
            }
          } catch (error) {
            ElMessage.error('åœæ­¢å‘½ä»¤å¤±è´¥: ' + error.message);
          }
        };

        // æ ¼å¼åŒ–æ—¶é—´
        const formatTime = (timestamp) => {
          if (!timestamp) return '-';
          const date = new Date(timestamp);
          return date.toLocaleTimeString('zh-CN');
        };

        // è·å–ä¸¥é‡ç¨‹åº¦ç±»å‹
        const getSeverityType = (severity) => {
          const typeMap = {
            'critical': 'danger',
            'error': 'danger',
            'warning': 'warning',
            'info': 'info'
          };
          return typeMap[severity] || 'info';
        };

        // æ›´æ–°ç»Ÿè®¡
        const updateStats = () => {
          try {
            // ç¡®ä¿ stats å·²ç»åˆå§‹åŒ–
            if (!stats) {
              console.warn('stats is not defined');
              return;
            }
            // ç¡®ä¿ stats.value å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆå§‹åŒ–
            if (!stats.value) {
              stats.value = {
                critical: 0,
                error: 0,
                warning: 0,
                info: 0
              };
            }
            // æ›´æ–°ç»Ÿè®¡å€¼
            const errorsList = errors.value || [];
            stats.value = {
              critical: errorsList.filter(e => e.severity === 'critical').length,
              error: errorsList.filter(e => e.severity === 'error').length,
              warning: errorsList.filter(e => e.severity === 'warning').length,
              info: errorsList.filter(e => e.severity === 'info').length
            };
          } catch (error) {
            console.error('updateStats error:', error);
            // å¦‚æœå‡ºé”™ï¼Œç¡®ä¿ stats.value è‡³å°‘æœ‰ä¸€ä¸ªé»˜è®¤å€¼
            if (stats && !stats.value) {
              stats.value = {
                critical: 0,
                error: 0,
                warning: 0,
                info: 0
              };
            }
          }
        };

        // èœå•é€‰æ‹©å¤„ç†
        const handleMenuSelect = (path) => {
          router.push(path);
        };

        // æ·»åŠ é”™è¯¯
        const addError = (errorData) => {
          const error = {
            ...errorData.data,
            id: errors.value.length + 1
          };

          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆåŸºäº errorHashï¼‰
          const existingIndex = errors.value.findIndex(e => e.errorHash === error.errorHash);
          if (existingIndex >= 0) {
            // æ›´æ–°ç°æœ‰é”™è¯¯
            errors.value[existingIndex] = error;
          } else {
            // æ·»åŠ æ–°é”™è¯¯
            errors.value.push(error);
            
            // æ˜¾ç¤ºé€šçŸ¥
            const severity = error.severity || 'info';
            if (severity === 'critical' || severity === 'error') {
              ElNotification({
                title: 'æ–°é”™è¯¯æ£€æµ‹åˆ°',
                message: error.errorMessage || 'æœªçŸ¥é”™è¯¯',
                type: getSeverityType(severity),
                duration: 5000,
                position: 'top-right'
              });
            }
          }

          // æ›´æ–°ç»Ÿè®¡
          updateStats();
        };

        // è¿æ¥ SSE
        const connect = () => {
          connectionStatus.value = 'connecting';
          
          if (eventSource) {
            eventSource.close();
          }

          eventSource = new EventSource('/events');

          eventSource.onopen = () => {
            connectionStatus.value = 'connected';
            ElMessage.success('å·²è¿æ¥åˆ°é”™è¯¯ç›‘æ§æœåŠ¡å™¨');
          };

          eventSource.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              console.log('[SSE] æ”¶åˆ°æ¶ˆæ¯:', data.type, data);
              if (data.type === 'connected') {
                console.log('âœ… å·²è¿æ¥åˆ°é”™è¯¯ç›‘æ§æœåŠ¡å™¨');
              } else if (data.type === 'error') {
                console.log('[SSE] âœ… æ”¶åˆ°é”™è¯¯:', data.data);
                addError(data);
              } else if (data.type === 'close') {
                eventSource.close();
                connectionStatus.value = 'disconnected';
                ElMessage.warning('æœåŠ¡å™¨è¿æ¥å·²å…³é—­');
              } else {
                console.log('[SSE] âš ï¸  æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
              }
            } catch (error) {
              console.error('âŒ è§£æ SSE æ¶ˆæ¯å¤±è´¥:', error, event.data);
            }
          };

          eventSource.onerror = (error) => {
            console.error('[SSE] âŒ è¿æ¥é”™è¯¯:', error);
            console.error('[SSE] readyState:', eventSource?.readyState);
            // readyState: 0=CONNECTING, 1=OPEN, 2=CLOSED
            if (eventSource?.readyState === EventSource.CLOSED) {
              connectionStatus.value = 'disconnected';
              ElMessage.error('è¿æ¥å·²å…³é—­ï¼Œ5ç§’åé‡è¯•...');
              // 5ç§’åé‡è¿
              setTimeout(() => {
                if (eventSource) {
                  eventSource.close();
                }
                console.log('[SSE] ğŸ”„ å°è¯•é‡æ–°è¿æ¥...');
                connect();
              }, 5000);
            } else if (eventSource?.readyState === EventSource.CONNECTING) {
              console.log('[SSE] â³ æ­£åœ¨è¿æ¥...');
            } else {
              // OPEN çŠ¶æ€ä½†è§¦å‘é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜
              console.warn('[SSE] âš ï¸  è¿æ¥çŠ¶æ€å¼‚å¸¸ï¼Œå‡†å¤‡é‡è¿...');
              connectionStatus.value = 'disconnected';
              setTimeout(() => {
                if (eventSource) {
                  eventSource.close();
                }
                connect();
              }, 5000);
            }
          };
        };

        // ç¡®ä¿ stats å·²ç»æ­£ç¡®åˆå§‹åŒ–
        if (!stats.value || typeof stats.value !== 'object') {
          stats.value = {
            critical: 0,
            error: 0,
            warning: 0,
            info: 0
          };
        }

        // åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡ updateStatsï¼ˆåœ¨ provide ä¹‹å‰ï¼‰
        updateStats();

        // æä¾›å…±äº«çŠ¶æ€ç»™å­ç»„ä»¶ï¼ˆç¡®ä¿æ‰€æœ‰å€¼éƒ½å·²åˆå§‹åŒ–ï¼‰
        provide('monitorContext', {
          errors,
          filters,
          stats,
          runningCommands,
          connectionStatus,
          loading,
          refreshCommands,
          stopCommand,
          formatTime,
          router
        });

        // ç»„ä»¶æŒ‚è½½æ—¶è¿æ¥
        onMounted(() => {
          connect();
          refreshCommands();
          // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡å‘½ä»¤åˆ—è¡¨
          commandsRefreshTimer = setInterval(refreshCommands, 5000);
          
          // é»˜è®¤è·³è½¬åˆ° /devï¼ˆå¦‚æœå½“å‰è·¯å¾„æ˜¯æ ¹è·¯å¾„ï¼‰
          if (router.currentRoute.value.path === '/' || !router.currentRoute.value.path || router.currentRoute.value.path === '/#/') {
            router.push('/dev');
          }
        });

        // ç»„ä»¶å¸è½½æ—¶å…³é—­è¿æ¥
        onUnmounted(() => {
          if (eventSource) {
            eventSource.close();
          }
          if (commandsRefreshTimer) {
            clearInterval(commandsRefreshTimer);
          }
        });

        const currentRoute = computed(() => router.currentRoute.value);

        return {
          errors,
          devCount,
          connectionStatus,
          handleMenuSelect,
          $route: currentRoute
        };
      }
    })
    .use(ElementPlus)
    .use(router)
    .mount('#app');
  </script>
</body>
</html>
