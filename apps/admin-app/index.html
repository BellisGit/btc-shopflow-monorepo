<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/png" href="/logo.png" />
		<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png" />
		<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png" />
		<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="theme-color" content="#404040" />
		<title>__PAGE_TITLE__</title>
		<style>
			/* 统一的首屏 Loading 样式 */
			html,
			body,
			#app,
			#layout-container {
				height: 100%;
				overflow: hidden;
			}

			/* 关键：在 HTML 解析时立即设置 body 背景色，避免白屏 */
			body {
				margin: 0 !important;
				padding: 0 !important;
				background-color: #ffffff; /* 默认白色背景 */
			}

			@media (prefers-color-scheme: dark) {
				body {
					background-color: #000000; /* 暗色模式黑色背景 */
				}
			}

			* {
				-webkit-font-smoothing: antialiased;
				font-family:
					'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB',
					'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
			}

			#Loading {
				display: flex;
				flex-direction: column;
				letter-spacing: 1px;
				background-color: #ffffff;
				position: fixed;
				left: 0;
				top: 0;
				height: 100%;
				width: 100%;
				z-index: 9999;
				transition: all 0.3s ease-in;
				opacity: 1;
				pointer-events: none;
			}

			@media (prefers-color-scheme: dark) {
				#Loading {
					background-color: #000000;
				}
			}

			#Loading.is-hide {
				opacity: 0;
			}

			.preload__container {
				display: flex;
				justify-content: center;
				align-items: center;
				flex-direction: column;
				width: 100%;
				user-select: none;
				-webkit-user-select: none;
				flex-grow: 1;
			}

			.preload__name {
				font-size: 30px;
				color: #303133;
				letter-spacing: 5px;
				font-weight: bold;
				margin-bottom: 30px;
				min-height: 50px;
			}

			@media (prefers-color-scheme: dark) {
				.preload__name {
					color: #ffffff;
				}
			}

			.preload__title {
				color: #606266;
				font-size: 14px;
				margin: 30px 0 20px 0;
				min-height: 20px;
			}

			@media (prefers-color-scheme: dark) {
				.preload__title {
					color: #ffffff;
				}
			}

			.preload__sub-title {
				color: #909399;
				font-size: 12px;
				min-height: 20px;
			}

			@media (prefers-color-scheme: dark) {
				.preload__sub-title {
					color: #ababab;
				}
			}

			.preload__name,
			.preload__title,
			.preload__sub-title {
				animation: s 0.5s ease-in;
			}

			@keyframes s {
				from {
					opacity: 0;
				}
				to {
					opacity: 1;
				}
			}

			.preload__loading {
				height: 44px;
				width: 44px;
				border-radius: 30px;
				border: 7px solid currentColor;
				border-bottom-color: #ffffff;
				position: relative;
				animation:
					r 1s infinite cubic-bezier(0.17, 0.67, 0.83, 0.67),
					bc 2s infinite ease-in;
				transform: rotate(0deg);
				box-sizing: border-box;
				color: #409eff;
			}

			@media (prefers-color-scheme: dark) {
				.preload__loading {
					border-bottom-color: #000000;
					color: #409eff;
				}
			}

			@keyframes r {
				from {
					transform: rotate(0deg);
				}
				to {
					transform: rotate(360deg);
				}
			}

			.preload__loading::after,
			.preload__loading::before {
				content: '';
				display: inline-block;
				position: absolute;
				bottom: -2px;
				height: 7px;
				width: 7px;
				border-radius: 10px;
				background-color: currentColor;
			}

			.preload__loading::after {
				left: -1px;
			}

			.preload__loading::before {
				right: -1px;
			}

			@keyframes bc {
				0% {
					color: #409eff;
				}
				25% {
					color: #67c23a;
				}
				50% {
					color: #e6a23c;
				}
				75% {
					color: #f56c6c;
				}
				100% {
					color: #409eff;
				}
			}
		</style>
		<script>
			// 关键：在页面加载时立即检查导航标记，立即显示 Loading，避免白屏
			(function() {
				try {
					// 关键：在qiankun环境下，应用级别loading由qiankun统一管理，不应该显示index.html中的#Loading
					// 检查是否为qiankun环境（包括__POWERED_BY_QIANKUN__和__USE_LAYOUT_APP__两种情况）
					const isQiankun = typeof window !== 'undefined' && (
						window['__POWERED_BY_QIANKUN__'] || 
						window['__USE_LAYOUT_APP__']
					);
          if (isQiankun) {
            // qiankun环境下，立即隐藏#Loading元素，避免与应用级别loading冲突
            var loadingEl = document.getElementById('Loading');
            if (loadingEl) {
              loadingEl.style.setProperty('display', 'none', 'important');
              loadingEl.style.setProperty('visibility', 'hidden', 'important');
              loadingEl.style.setProperty('opacity', '0', 'important');
              loadingEl.style.setProperty('pointer-events', 'none', 'important');
              loadingEl.classList.add('is-hide');
            }
            // 如果DOM还没加载完成，也监听DOMContentLoaded确保隐藏
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', function() {
                var loadingEl = document.getElementById('Loading');
                if (loadingEl) {
                  loadingEl.style.setProperty('display', 'none', 'important');
                  loadingEl.style.setProperty('visibility', 'hidden', 'important');
                  loadingEl.style.setProperty('opacity', '0', 'important');
                  loadingEl.style.setProperty('pointer-events', 'none', 'important');
                  loadingEl.classList.add('is-hide');
                }
              });
            }
            return; // qiankun环境下不显示index.html中的loading
          }
					
					const shouldShowLoading = sessionStorage.getItem('__BTC_NAV_LOADING__') === '1';
					if (shouldShowLoading) {
						// 使用内联样式立即显示 Loading，不等待 DOMContentLoaded
						// 在 head 中直接写入样式，确保在 body 解析前就设置好
						var style = document.createElement('style');
						style.textContent = '#Loading { display: flex !important; visibility: visible !important; opacity: 1 !important; }';
						document.head.appendChild(style);

						// 同时监听 DOMContentLoaded，确保 Loading 元素存在后立即显示
						if (document.readyState === 'loading') {
							document.addEventListener('DOMContentLoaded', function() {
								var loadingEl = document.getElementById('Loading');
								if (loadingEl) {
									loadingEl.style.display = 'flex';
									loadingEl.style.visibility = 'visible';
									loadingEl.style.opacity = '1';
									loadingEl.classList.remove('is-hide');
								}
							});
						} else {
							// 如果 DOM 已经加载完成，立即显示
							var loadingEl = document.getElementById('Loading');
							if (loadingEl) {
								loadingEl.style.display = 'flex';
								loadingEl.style.visibility = 'visible';
								loadingEl.style.opacity = '1';
								loadingEl.classList.remove('is-hide');
							}
						}
					}
				} catch (e) {
					// 静默失败
				}
			})();
		</script>
		<script>
			// 立即读取loading样式并写入内联样式，避免闪烁
			(function() {
				try {
					function getCookie(name) {
						const nameEQ = name + '=';
						const ca = document.cookie.split(';');
						for (let i = 0; i < ca.length; i++) {
							let c = ca[i];
							while (c.charAt(0) === ' ') c = c.substring(1, c.length);
							if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
						}
						return null;
					}

					function getLoadingStyle() {
						try {
							if (typeof localStorage !== 'undefined') {
								const settingsStr = localStorage.getItem('settings');
								if (settingsStr) {
									const settings = JSON.parse(settingsStr);
									if (settings.loadingStyle === 'dots' || settings.loadingStyle === 'circle') {
										return settings.loadingStyle;
									}
								}
							}
							const settingsCookie = getCookie('btc_settings');
							if (settingsCookie) {
								const settings = JSON.parse(decodeURIComponent(settingsCookie));
								if (settings.loadingStyle === 'dots' || settings.loadingStyle === 'circle') {
									return settings.loadingStyle;
								}
							}
						} catch (e) {}
						return 'circle';
					}

					const loadingStyle = getLoadingStyle();
					if (loadingStyle === 'dots') {
						// 使用document.write在解析阶段写入样式和script，完全避免闪烁
						// 注意：只在解析阶段有效，如果DOM已加载完成则无效
						if (document.readyState === 'loading') {
							// 写入样式，隐藏圆圈
							document.write('<style id="preload-loading-dots-hide">.preload__loading { border: none !important; border-radius: 0 !important; background: none !important; animation: none !important; } .preload__loading::before, .preload__loading::after { display: none !important; }</style>');
							// 写入dots样式和动画
							document.write('<style id="preload-dots-style">.preload__loading .preload-dots-svg { width: 44px; height: 44px; } .preload__loading .preload-dots-spinner { transform-origin: 22px 22px; animation: preload-dots-rotate 1.6s linear infinite; } .preload__loading .preload-dot { animation: preload-dots-fade 1.6s infinite, preload-dots-color-change 3.2s infinite ease-in-out; } .preload__loading .preload-dot-1 { fill: #409eff; animation-delay: 0s, 0s; } .preload__loading .preload-dot-2 { fill: #67c23a; animation-delay: 0.4s, 0.8s; } .preload__loading .preload-dot-3 { fill: #e6a23c; animation-delay: 0.8s, 1.6s; } .preload__loading .preload-dot-4 { fill: #f56c6c; animation-delay: 1.2s, 2.4s; } @keyframes preload-dots-rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } @keyframes preload-dots-fade { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } } @keyframes preload-dots-color-change { 0% { fill: #409eff; } 25% { fill: #67c23a; } 50% { fill: #e6a23c; } 75% { fill: #f56c6c; } 100% { fill: #409eff; } }</style>');
							// 写入一个script到body开始处，在元素解析时立即设置内容
							document.write('<script>(function(){var el=document.currentScript;if(el&&el.previousElementSibling&&el.previousElementSibling.classList.contains("preload__loading")){var loadingEl=el.previousElementSibling;loadingEl.style.border="none";loadingEl.style.borderRadius="0";loadingEl.style.background="none";loadingEl.style.width="44px";loadingEl.style.height="44px";loadingEl.innerHTML=\'<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 44 44" class="preload-dots-svg"><g class="preload-dots-spinner"><circle class="preload-dot preload-dot-1" cx="22" cy="8" r="5" fill="#409eff"/><circle class="preload-dot preload-dot-2" cx="36" cy="22" r="5" fill="#67c23a"/><circle class="preload-dot preload-dot-3" cx="22" cy="36" r="5" fill="#e6a23c"/><circle class="preload-dot preload-dot-4" cx="8" cy="22" r="5" fill="#f56c6c"/></g></svg>\';}else{setTimeout(function(){var loadingEl=document.querySelector(".preload__loading");if(loadingEl&&!loadingEl.querySelector(".preload-dots-svg")){loadingEl.style.border="none";loadingEl.style.borderRadius="0";loadingEl.style.background="none";loadingEl.style.width="44px";loadingEl.style.height="44px";loadingEl.innerHTML=\'<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 44 44" class="preload-dots-svg"><g class="preload-dots-spinner"><circle class="preload-dot preload-dot-1" cx="22" cy="8" r="5" fill="#409eff"/><circle class="preload-dot preload-dot-2" cx="36" cy="22" r="5" fill="#67c23a"/><circle class="preload-dot preload-dot-3" cx="22" cy="36" r="5" fill="#e6a23c"/><circle class="preload-dot preload-dot-4" cx="8" cy="22" r="5" fill="#f56c6c"/></g></svg>\';}},0);}})();<\/script>');
							// 设置一个标记，让后续脚本知道要使用dots
							window.__PRELOD_LOADING_STYLE__ = 'dots';
						} else {
							// DOM已加载，使用createElement
							const style = document.createElement('style');
							style.id = 'preload-loading-dots-hide';
							style.textContent = '.preload__loading { border: none !important; border-radius: 0 !important; background: none !important; animation: none !important; } .preload__loading::before, .preload__loading::after { display: none !important; }';
							document.head.appendChild(style);
						}
					} else {
						window.__PRELOD_LOADING_STYLE__ = 'circle';
					}
				} catch (e) {}
			})();
		</script>
		<script>
			// 关键：在页面加载时立即应用主题类，避免水合不匹配
			// 必须在 JavaScript 执行前就应用，确保 Vue 组件渲染时主题类已存在
			(function() {
				try {
					// 读取 Cookie 中的设置
					function getCookie(name) {
						const nameEQ = name + '=';
						const ca = document.cookie.split(';');
						for (let i = 0; i < ca.length; i++) {
							let c = ca[i];
							while (c.charAt(0) === ' ') c = c.substring(1, c.length);
							if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
						}
						return null;
					}

					const settingsCookie = getCookie('btc_settings');
					if (settingsCookie) {
						try {
							const settings = JSON.parse(decodeURIComponent(settingsCookie));
							const systemThemeType = settings?.systemThemeType;
							const htmlEl = document.documentElement;

							if (systemThemeType === 'dark') {
								htmlEl.classList.add('dark');
							} else if (systemThemeType === 'light') {
								htmlEl.classList.remove('dark');
							} else if (systemThemeType === 'auto' || !systemThemeType) {
								// AUTO 模式或未设置：跟随系统偏好
								const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
								if (prefersDark) {
									htmlEl.classList.add('dark');
								} else {
									htmlEl.classList.remove('dark');
								}
							}
						} catch (e) {
							// 如果解析失败，使用系统偏好
							const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
							if (prefersDark) {
								document.documentElement.classList.add('dark');
							}
						}
					} else {
						// 如果没有 Cookie，使用系统偏好
						const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
						if (prefersDark) {
							document.documentElement.classList.add('dark');
						}
					}
				} catch (e) {
					// 静默失败，使用系统偏好作为兜底
					try {
						const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
						if (prefersDark) {
							document.documentElement.classList.add('dark');
						}
					} catch (e2) {
						// 完全失败，不做任何操作
					}
				}
			})();
		</script>
		<script>
			// 根据用户偏好设置更新loading样式（dots 或 circle）
			(function() {
				try {
					function getCookie(name) {
						const nameEQ = name + '=';
						const ca = document.cookie.split(';');
						for (let i = 0; i < ca.length; i++) {
							let c = ca[i];
							while (c.charAt(0) === ' ') c = c.substring(1, c.length);
							if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
						}
						return null;
					}

					function getLoadingStyle() {
						try {
							// 先尝试从localStorage读取
							const settingsStr = localStorage.getItem('settings');
							if (settingsStr) {
								const settings = JSON.parse(settingsStr);
								if (settings.loadingStyle === 'dots' || settings.loadingStyle === 'circle') {
									return settings.loadingStyle;
								}
							}

							// 如果localStorage中没有，尝试从Cookie读取
							const settingsCookie = getCookie('btc_settings');
							if (settingsCookie) {
								const settings = JSON.parse(decodeURIComponent(settingsCookie));
								if (settings.loadingStyle === 'dots' || settings.loadingStyle === 'circle') {
									return settings.loadingStyle;
								}
							}
						} catch (e) {
							// 忽略错误
						}
						return 'circle'; // 默认使用circle
					}

					function updateLoadingStyle() {
						const loadingEl = document.querySelector('.preload__loading');
						if (!loadingEl) return;

						// 优先使用全局标记（在解析阶段设置的）
						const loadingStyle = window.__PRELOD_LOADING_STYLE__ || getLoadingStyle();
						
						// 如果已经有SVG内容，说明已经在解析阶段写入，不需要再次设置
						if (loadingStyle === 'dots' && loadingEl.querySelector('.preload-dots-svg')) {
							return;
						}
						
						if (loadingStyle === 'dots') {
							// 确保data属性已设置
							loadingEl.setAttribute('data-loading-style', 'dots');
							
							// 移除圆圈样式，替换为dots SVG
							loadingEl.style.border = 'none';
							loadingEl.style.borderRadius = '0';
							loadingEl.style.background = 'none';
							loadingEl.style.width = '44px';
							loadingEl.style.height = '44px';
							loadingEl.className = 'preload__loading preload__loading-dots';
							
							loadingEl.innerHTML = `
								<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 44 44" class="preload-dots-svg">
									<g class="preload-dots-spinner">
										<circle class="preload-dot preload-dot-1" cx="22" cy="8" r="5" fill="#409eff"/>
										<circle class="preload-dot preload-dot-2" cx="36" cy="22" r="5" fill="#67c23a"/>
										<circle class="preload-dot preload-dot-3" cx="22" cy="36" r="5" fill="#e6a23c"/>
										<circle class="preload-dot preload-dot-4" cx="8" cy="22" r="5" fill="#f56c6c"/>
									</g>
								</svg>
							`;
							
							// 添加dots样式和动画（如果不存在）
							if (!document.getElementById('preload-dots-style')) {
								const style = document.createElement('style');
								style.id = 'preload-dots-style';
								style.textContent = `
									.preload__loading-dots {
										border: none !important;
										border-radius: 0 !important;
										background: none !important;
										animation: none !important;
									}
									.preload__loading-dots::before,
									.preload__loading-dots::after {
										display: none !important;
									}
									.preload__loading .preload-dots-svg {
										width: 44px;
										height: 44px;
									}
									.preload__loading .preload-dots-spinner {
										transform-origin: 22px 22px;
										animation: preload-dots-rotate 1.6s linear infinite;
									}
									.preload__loading .preload-dot {
										animation: preload-dots-fade 1.6s infinite, preload-dots-color-change 3.2s infinite ease-in-out;
									}
									.preload__loading .preload-dot-1 {
										fill: #409eff;
										animation-delay: 0s, 0s;
									}
									.preload__loading .preload-dot-2 {
										fill: #67c23a;
										animation-delay: 0.4s, 0.8s;
									}
									.preload__loading .preload-dot-3 {
										fill: #e6a23c;
										animation-delay: 0.8s, 1.6s;
									}
									.preload__loading .preload-dot-4 {
										fill: #f56c6c;
										animation-delay: 1.2s, 2.4s;
									}
									@keyframes preload-dots-rotate {
										0% { transform: rotate(0deg); }
										100% { transform: rotate(360deg); }
									}
									@keyframes preload-dots-fade {
										0%, 100% { opacity: 1; }
										50% { opacity: 0.5; }
									}
									@keyframes preload-dots-color-change {
										0% { fill: #409eff; }
										25% { fill: #67c23a; }
										50% { fill: #e6a23c; }
										75% { fill: #f56c6c; }
										100% { fill: #409eff; }
									}
								`;
								document.head.appendChild(style);
							}
						} else {
							// circle样式：恢复原有样式
							loadingEl.removeAttribute('data-loading-style');
							loadingEl.innerHTML = '';
							loadingEl.className = 'preload__loading';
							loadingEl.style.border = '';
							loadingEl.style.borderRadius = '';
							loadingEl.style.background = '';
							loadingEl.style.width = '';
							loadingEl.style.height = '';
						}
					}

					// 立即执行，不等待任何事件
					updateLoadingStyle();

					// 监听DOMContentLoaded，确保在DOM加载完成后再次更新（如果之前没有成功）
					if (document.readyState === 'loading') {
						document.addEventListener('DOMContentLoaded', updateLoadingStyle);
					}

					// 监听storage事件，当设置变化时更新样式
					window.addEventListener('storage', function(e) {
						if (e.key === 'settings') {
							updateLoadingStyle();
						}
					});

					// 监听自定义事件，当设置变化时更新样式（用于同标签页内的设置变化）
					window.addEventListener('settings-change', function() {
						updateLoadingStyle();
					});
				} catch (e) {
					// 静默失败
				}
			})();
		</script>
	</head>

	<body>
		<!-- 跨子域通信桥 iframe（用于跨标签页登出同步） -->
		<!-- src 将在 useCrossDomainBridge 中动态设置，这里先留空避免加载错误的 URL -->
		<iframe 
			id="btc-auth-bridge" 
			src="about:blank" 
			style="display: none; width: 0; height: 0; border: none;"
			title="Auth Bridge"
			aria-hidden="true"
		></iframe>
		<div id="Loading">
			<div class="preload__container">
				<div class="preload__name">拜里斯科技</div>
				<div class="preload__loading"></div>
				<div class="preload__title">正在加载资源</div>
				<div class="preload__sub-title">部分资源可能加载时间较长，请耐心等待</div>
			</div>
		</div>
		<div id="app"></div>
		<script type="module" src="/src/main.ts"></script>
	</body>
</html>

