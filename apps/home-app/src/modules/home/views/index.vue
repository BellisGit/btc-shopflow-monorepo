<template>
  <div class="home-page">
    <!-- é¦–å±è§†é¢‘/è½®æ’­å›¾ -->
    <section class="hero-section">
      <!-- è§†é¢‘æ’­æ”¾å™¨ -->
      <div class="hero-video">
        <VideoPlayer
          :src="videoSrcRef"
          :poster="videoPoster"
          :autoplay="false"
          :loop="true"
          :muted="true"
        />
      </div>
      <!-- è½®æ’­å›¾ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦å¯ä»¥åˆ‡æ¢æ˜¾ç¤ºï¼‰ -->
      <!-- <Carousel :slides="carouselSlides" :autoplay="true" :interval="3000" /> -->
    </section>

    <!-- å“ç‰Œç†å¿µæ ‡è¯­åŒº -->
    <section class="brand-slogan">
      <div class="container">
        <div class="slogan-content">
          <span class="slogan-chinese">æ‹œé‡Œæ–¯</span>
          <span class="slogan-red">å› ä¸ºæœ‰ä½  æ‰€ä»¥ç²¾å½©</span>
        </div>
        <p class="slogan-english">Because you are so wonderful</p>
      </div>
    </section>

    <!-- æ ¸å¿ƒç†å¿µç½‘æ ¼åŒº -->
    <section class="core-values">
      <div class="container">
        <div class="values-grid">
          <!-- å·¦åˆ—ï¼šè´¨é‡ç®¡ç†æ¿å— -->
          <div class="values-column quality-management">
            <div class="section-block">
              <div class="red-title-bar">è´¨é‡æ–¹é’ˆ / Quality Policy</div>
              <div class="red-outline-text policy-chinese">
                ä»¥æœ€é«˜æ€§ä»·æ¯”ç”Ÿäº§æ»¡è¶³é¡¾å®¢æœŸæœ›çš„å¯é äº§å“ã€‚
              </div>
              <div class="red-outline-text policy-english">
                Assembly functional and reliable products that satisfy and anticipate the customer request with the best ratio quality/price.
        </div>
        </div>
            <div class="section-block">
              <div class="red-title-bar">è´¨é‡ç›®æ ‡ / Quality Objective</div>
              <ul class="quality-goals">
                <li>
                  <span class="goal-text">æˆå“åˆæ ¼ç‡â‰¥98%</span>
                  <span class="goal-english">Finish goods pass yieldâ‰¥98%</span>
                </li>
                <li>
                  <span class="goal-text">äº¤è´§å‡†æ—¶ç‡â‰¥98%</span>
                  <span class="goal-english">Delivery on time rateâ‰¥98%</span>
                </li>
                <li>
                  <span class="goal-text">é¡¾å®¢æ»¡æ„åº¦â‰¥118åˆ†</span>
                  <span class="goal-english">Customer satisfactionâ‰¥118 points</span>
                </li>
              </ul>
        </div>
      </div>

          <!-- å³åˆ—ï¼šå›¢é˜Ÿæ–‡åŒ–æ¿å— -->
          <div class="values-column team-culture">
            <div class="section-block culture-section">
              <div class="red-title-bar">å›¢é˜Ÿç†å¿µ</div>
              <div class="culture-cards-grid">
                <div class="culture-card">
                  <h3 class="card-title">å›¢ç»“</h3>
                  <p class="card-english">Teamwork</p>
                </div>
                <div class="culture-card">
                  <h3 class="card-title">æˆé•¿</h3>
                  <p class="card-english">Grow Up</p>
          </div>
                <div class="culture-card">
                  <h3 class="card-title">åˆ›æ–°</h3>
                  <p class="card-english">Innovative</p>
          </div>
                <div class="culture-card">
                  <h3 class="card-title">We're Established</h3>
                  <p class="card-english"></p>
          </div>
                <div class="culture-card">
                  <h3 class="card-title">We're Trusted</h3>
                  <p class="card-english"></p>
          </div>
                <div class="culture-card">
                  <h3 class="card-title">We're Innovative</h3>
                  <p class="card-english"></p>
          </div>
          </div>
          </div>
          </div>
        </div>
      </div>
    </section>

    <!-- äº§å“å±•ç¤ºåŒºï¼ˆæ»šåŠ¨å±‚å æ ·å¼ï¼‰ -->
    <section id="products-showcase" class="products-showcase" ref="productsSectionRef">
      <div class="container">
        <h2 class="products-title">äº§å“ä¸­å¿ƒ</h2>
        <p class="products-subtitle">Product Center</p>
        <div class="products-scene" ref="productsSceneRef">
          <div
            class="sub-scene"
            v-for="(product, index) in products"
            :key="index"
            :data-index="index"
            :style="{ animationDelay: `${-Math.random() * 1}s` }"
          >
            <div class="product-card">
              <div class="product-image">
                <picture>
                  <!-- WebP æ ¼å¼ï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰ -->
                  <source
                    v-if="product.image.endsWith('.webp')"
                    :srcset="product.image"
                    type="image/webp"
                  />
                  <!-- PNG é™çº§æ–¹æ¡ˆ -->
                  <img
                    :src="product.fallback || product.image"
                    :alt="product.name"
                    loading="lazy"
                    decoding="async"
                    @error="(e) => handleProductImageError(e, product.fallback || product.image)"
                  />
                </picture>
              </div>
              <div class="product-info">
                <h3 class="product-name">{{ product.name }}</h3>
                <p class="product-desc">{{ product.desc }}</p>
          </div>
          </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, nextTick } from 'vue';
import VideoPlayer from '@/components/VideoPlayer.vue';
import { checkWebPSupport, getCdnFallbackUrl } from '@/utils/image-optimizer';

defineOptions({
  name: 'HomePage',
});

// å¯¼å…¥å°é¢å›¾ï¼ˆä¼˜å…ˆä½¿ç”¨ WebPï¼Œé™çº§åˆ° PNGï¼‰
import videoPosterWebP from '@/assets/webp/22.webp';
import videoPosterPng from '@/assets/images/22.png';

// è§†é¢‘å§‹ç»ˆä½¿ç”¨ CDN ç‰ˆæœ¬ï¼ˆä¸å‚ä¸æ„å»ºï¼‰
const videoSrc = 'https://all.bellis.com.cn/automation_area_web.mp4';

// WebP æ”¯æŒæ£€æµ‹ï¼ˆç¼“å­˜ç»“æœï¼‰
const supportsWebP = ref(false);
onMounted(() => {
  supportsWebP.value = checkWebPSupport();
  // æ ¹æ® WebP æ”¯æŒæƒ…å†µè®¾ç½®å°é¢å›¾
  videoPoster.value = supportsWebP.value ? videoPosterWebP : videoPosterPng;
});

// å°é¢å›¾ï¼ˆä½¿ç”¨ refï¼Œæ”¯æŒåŠ¨æ€åˆ‡æ¢ï¼‰
const videoPoster = ref(videoPosterPng); // é»˜è®¤ä½¿ç”¨ PNGï¼Œmounted åæ ¹æ®æ”¯æŒæƒ…å†µåˆ‡æ¢

// äº§å“å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†ï¼ˆå¤šçº§é™çº§ï¼šWebP -> PNG -> CDNï¼‰
const handleProductImageError = (event: Event, currentSrc: string) => {
  const img = event.target as HTMLImageElement;
  if (!img) return;

  // è·å–å½“å‰äº§å“
  const product = products.value.find(p => p.fallback === currentSrc || p.image === currentSrc);

  // ç¬¬ä¸€çº§é™çº§ï¼šå¦‚æœ WebP å¤±è´¥ï¼Œå°è¯• PNG
  if (product?.fallback && img.src === product.image) {
    img.src = product.fallback;
    return;
  }

  // ç¬¬äºŒçº§é™çº§ï¼šå¦‚æœæœ¬åœ°å›¾ç‰‡éƒ½å¤±è´¥ï¼Œå°è¯• CDN
  const cdnUrl = getCdnFallbackUrl(currentSrc);
  if (img.src !== cdnUrl) {
    img.src = cdnUrl;
    // æ¸…é™¤é”™è¯¯å¤„ç†ï¼Œé¿å…æ— é™å¾ªç¯
    img.onerror = null;
  }
};

// è§†é¢‘æºï¼ˆä½¿ç”¨ refï¼Œæ”¯æŒåŠ¨æ€åˆ‡æ¢ï¼‰
const videoSrcRef = ref(videoSrc);

// é¢„åŠ è½½é¦–å±å°é¢å›¾ï¼ˆå…³é”®èµ„æºï¼Œä¼˜å…ˆåŠ è½½ï¼‰
const preloadHeroPoster = () => {
  if (typeof window === 'undefined') return;

  // ä¼˜å…ˆåŠ è½½ WebP æ ¼å¼
  const posterUrl = supportsWebP.value ? videoPosterWebP : videoPosterPng;

  // æ–¹æ³•1: ä½¿ç”¨ link preloadï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œæµè§ˆå™¨ä¼šä¼˜å…ˆä¸‹è½½ï¼‰
  const existingLink = document.querySelector(`link[href="${posterUrl}"]`);
  if (!existingLink) {
    const link = document.createElement('link');
    link.rel = 'preload';
    link.as = 'image';
    link.href = posterUrl;
    link.setAttribute('fetchpriority', 'high');
    document.head.appendChild(link);
  }

  // æ–¹æ³•2: ä½¿ç”¨ Image å¯¹è±¡é¢„åŠ è½½ï¼ˆç¡®ä¿å›¾ç‰‡ç¼“å­˜åˆ°å†…å­˜ï¼‰
  const img = new Image();
  img.src = posterUrl;
  img.loading = 'eager';
  img.decoding = 'sync';

  // å¦‚æœ WebP åŠ è½½å¤±è´¥ï¼Œé™çº§åˆ° PNG
  if (supportsWebP.value && posterUrl === videoPosterWebP) {
    img.onerror = () => {
      const fallbackImg = new Image();
      fallbackImg.src = videoPosterPng;
      fallbackImg.loading = 'eager';
      fallbackImg.decoding = 'sync';

      // å¦‚æœ PNG ä¹Ÿå¤±è´¥ï¼Œé™çº§åˆ° CDN
      fallbackImg.onerror = () => {
        const cdnImg = new Image();
        cdnImg.src = 'https://all.bellis.com.cn/22.png';
        cdnImg.loading = 'eager';
        cdnImg.decoding = 'sync';
      };
    };
  }
};

// å¯¼å…¥äº§å“å›¾ç‰‡ WebP ç‰ˆæœ¬ï¼ˆä¼˜å…ˆä½¿ç”¨ï¼Œä½“ç§¯æ›´å°ï¼‰
import BNF_WebP from '@/assets/bellis_model/BNF.webp';
import NV11_SPECTRAL_WebP from '@/assets/bellis_model/NV11_SPECTRAL.webp';
import NV200_SPECTRAL_WebP from '@/assets/bellis_model/NV200_SPECTRAL.webp';
import NV22_SPECTRAL_WebP from '@/assets/bellis_model/NV22_SPECTRAL.webp';
import NV4000_WebP from '@/assets/bellis_model/NV4000.webp';
import NV9_SPECTRAL_WebP from '@/assets/bellis_model/NV9_SPECTRAL.webp';
import SAFE_INTERFACE_WebP from '@/assets/bellis_model/SAFE_INTERFACE.webp';
import SMART_COIN_SYSTEM_WebP from '@/assets/bellis_model/SMART_COIN_SYSTEM.webp';
import SMART_HOPPER_WebP from '@/assets/bellis_model/SMART_HOPPER.webp';
import SPECTRAL_PAYOUT_WebP from '@/assets/bellis_model/SPECTRAL_PAYOUT.webp';
import TWIN_SMART_COIN_SYSTEM_WebP from '@/assets/bellis_model/TWIN_SMART_COIN_SYSTEM.webp';

// å¯¼å…¥äº§å“å›¾ç‰‡ PNG ç‰ˆæœ¬ï¼ˆä½œä¸ºé™çº§æ–¹æ¡ˆï¼‰
import BNF_Png from '@/assets/bellis_model/BNF.png';
import NV11_SPECTRAL_Png from '@/assets/bellis_model/NV11_SPECTRAL.png';
import NV200_SPECTRAL_Png from '@/assets/bellis_model/NV200_SPECTRAL.png';
import NV22_SPECTRAL_Png from '@/assets/bellis_model/NV22_SPECTRAL.png';
import NV4000_Png from '@/assets/bellis_model/NV4000.png';
import NV9_SPECTRAL_Png from '@/assets/bellis_model/NV9_SPECTRAL.png';
import SAFE_INTERFACE_Png from '@/assets/bellis_model/SAFE_INTERFACE.png';
import SMART_COIN_SYSTEM_Png from '@/assets/bellis_model/SMART_COIN_SYSTEM.png';
import SMART_HOPPER_Png from '@/assets/bellis_model/SMART_HOPPER.png';
import SPECTRAL_PAYOUT_Png from '@/assets/bellis_model/SPECTRAL_PAYOUT.png';
import TWIN_SMART_COIN_SYSTEM_Png from '@/assets/bellis_model/TWIN_SMART_COIN_SYSTEM.png';

// äº§å“æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨ WebPï¼Œé™çº§åˆ° PNGï¼Œæœ€åé™çº§åˆ° CDNï¼‰
const products = ref([
  {
    name: 'BNF',
    desc: 'BNF äº§å“ç³»åˆ—',
    image: BNF_WebP,
    fallback: BNF_Png,
  },
  {
    name: 'NV11 SPECTRAL',
    desc: 'NV11 å…‰è°±ç³»åˆ—',
    image: NV11_SPECTRAL_WebP,
    fallback: NV11_SPECTRAL_Png,
  },
  {
    name: 'NV200 SPECTRAL',
    desc: 'NV200 å…‰è°±ç³»åˆ—',
    image: NV200_SPECTRAL_WebP,
    fallback: NV200_SPECTRAL_Png,
  },
  {
    name: 'NV22 SPECTRAL',
    desc: 'NV22 å…‰è°±ç³»åˆ—',
    image: NV22_SPECTRAL_WebP,
    fallback: NV22_SPECTRAL_Png,
  },
  {
    name: 'NV4000',
    desc: 'NV4000 äº§å“ç³»åˆ—',
    image: NV4000_WebP,
    fallback: NV4000_Png,
  },
  {
    name: 'NV9 SPECTRAL',
    desc: 'NV9 å…‰è°±ç³»åˆ—',
    image: NV9_SPECTRAL_WebP,
    fallback: NV9_SPECTRAL_Png,
  },
  {
    name: 'SAFE INTERFACE',
    desc: 'å®‰å…¨æ¥å£ç³»ç»Ÿ',
    image: SAFE_INTERFACE_WebP,
    fallback: SAFE_INTERFACE_Png,
  },
  {
    name: 'SMART COIN SYSTEM',
    desc: 'æ™ºèƒ½ç¡¬å¸ç³»ç»Ÿ',
    image: SMART_COIN_SYSTEM_WebP,
    fallback: SMART_COIN_SYSTEM_Png,
  },
  {
    name: 'SMART HOPPER',
    desc: 'æ™ºèƒ½å‚¨å¸å™¨',
    image: SMART_HOPPER_WebP,
    fallback: SMART_HOPPER_Png,
  },
  {
    name: 'SPECTRAL PAYOUT',
    desc: 'å…‰è°±æ”¯ä»˜ç³»ç»Ÿ',
    image: SPECTRAL_PAYOUT_WebP,
    fallback: SPECTRAL_PAYOUT_Png,
  },
  {
    name: 'TWIN SMART COIN SYSTEM',
    desc: 'åŒæ™ºèƒ½ç¡¬å¸ç³»ç»Ÿ',
    image: TWIN_SMART_COIN_SYSTEM_WebP,
    fallback: TWIN_SMART_COIN_SYSTEM_Png,
  },
]);

// æ»šåŠ¨èšæ‹¢/å‘æ•£æ•ˆæœï¼ˆå‚è€ƒQQé¦–é¡µå®ç°ï¼‰
const productsSectionRef = ref<HTMLElement | null>(null);
const productsSceneRef = ref<HTMLElement | null>(null);

// å­˜å‚¨æ¯ä¸ªå¡ç‰‡çš„åˆå§‹ä½ç½®ï¼ˆç”¨äºä½ç½®è®¡ç®—ï¼‰
const cardInitialPositions = ref<Array<{ top: number; left: number }>>([]);

const handleScroll = () => {
  // è°ƒè¯•ï¼šè¾“å‡ºæ»šåŠ¨ä½ç½®ï¼ˆä»…åœ¨éœ€è¦æ—¶å¯ç”¨ï¼‰
  // const mainContainerEl = document.querySelector('.main') as HTMLElement;
  // const scrollTopValue = mainContainerEl ? mainContainerEl.scrollTop : (window.scrollY || document.documentElement.scrollTop);
  // console.log('ğŸ”µ handleScroll è¢«è°ƒç”¨ - scrollTop:', scrollTopValue);

  // ä¼˜å…ˆä½¿ç”¨refï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨IDé€‰æ‹©å™¨ä½œä¸ºåå¤‡
  const sectionElement = productsSectionRef.value || document.getElementById('products-showcase');
  const sceneElement = productsSceneRef.value || document.querySelector('#products-showcase .products-scene') as HTMLElement;

  if (!sectionElement || !sceneElement) {
    // å¦‚æœrefæœªåˆå§‹åŒ–ï¼Œé™é»˜è¿”å›ï¼Œé¿å…æ§åˆ¶å°è­¦å‘Š
    return;
  }

  // 1. è·å– products-section ç›¸å¯¹äºè§†å£çš„ä½ç½®
  const sectionRect = sectionElement.getBoundingClientRect();

  // 2. è®¡ç®—æ»šåŠ¨æ¯”ä¾‹ï¼šåŸºäºè§†å£åº•éƒ¨ä¸sectionçš„ä½ç½®å…³ç³»
  // å½“æ»šåŠ¨æ¡å‘ä¸‹æ»šåŠ¨ï¼Œè§†å£åº•éƒ¨è¿›å…¥sectionæ—¶ï¼Œratioä»0å¢åŠ åˆ°1ï¼ˆç¦»æ•£åˆ°èšæ‹¢ï¼‰
  // å½“æ»šåŠ¨æ¡å‘ä¸Šæ»šåŠ¨ï¼Œè§†å£åº•éƒ¨ç¦»å¼€sectionæ—¶ï¼Œratioä»1å›åˆ°0ï¼ˆèšæ‹¢åˆ°ç¦»æ•£ï¼‰
  const windowHeight = window.innerHeight;
  const viewportBottom = windowHeight; // è§†å£åº•éƒ¨ä½ç½®ï¼ˆç›¸å¯¹äºè§†å£é¡¶éƒ¨ï¼‰

  // sectionçš„é¡¶éƒ¨å’Œåº•éƒ¨ä½ç½®ï¼ˆç›¸å¯¹äºè§†å£ï¼‰
  const sectionTop = sectionRect.top;
  const sectionBottom = sectionRect.top + sectionRect.height;

  // è®¡ç®—ratioï¼š
  // - å½“è§†å£åº•éƒ¨ < sectioné¡¶éƒ¨æ—¶ï¼Œratio = 0ï¼ˆå®Œå…¨ç¦»æ•£ï¼‰
  // - å½“è§†å£åº•éƒ¨åœ¨sectionå†…éƒ¨æ—¶ï¼Œratio = (è§†å£åº•éƒ¨ - sectioné¡¶éƒ¨) / sectioné«˜åº¦ï¼ˆ0åˆ°1ï¼‰
  // - å½“è§†å£åº•éƒ¨ > sectionåº•éƒ¨æ—¶ï¼Œratio = 1ï¼ˆå®Œå…¨èšæ‹¢ï¼‰
  let ratio = 0;

  if (viewportBottom < sectionTop) {
    // è§†å£åº•éƒ¨è¿˜æœªè¿›å…¥sectionï¼Œå®Œå…¨ç¦»æ•£
    ratio = 0;
  } else if (viewportBottom >= sectionTop && viewportBottom <= sectionBottom) {
    // è§†å£åº•éƒ¨åœ¨sectionå†…éƒ¨ï¼Œæ ¹æ®è¿›åº¦è®¡ç®—ratio
    ratio = (viewportBottom - sectionTop) / sectionRect.height;
  } else {
    // è§†å£åº•éƒ¨å·²å®Œå…¨ç¦»å¼€sectionï¼Œå®Œå…¨èšæ‹¢
    ratio = 1;
  }

  // ç¡®ä¿ratioåœ¨0-1èŒƒå›´å†…
  ratio = Math.max(0, Math.min(1, ratio));

  // è°ƒè¯•ï¼šè¾“å‡º ratio å€¼ï¼ˆä»…åœ¨éœ€è¦æ—¶å¯ç”¨ï¼‰
  // console.log('æ»šåŠ¨æ¯”ä¾‹ ratio:', ratio.toFixed(3), 'viewportBottom:', viewportBottom.toFixed(0), 'sectionTop:', sectionTop.toFixed(0), 'sectionBottom:', sectionBottom.toFixed(0));

  // 3. è·å–æ‰€æœ‰å¡ç‰‡
  const cards = sceneElement.querySelectorAll('.sub-scene');

  if (cards.length === 0 || cardInitialPositions.value.length === 0) {
    return;
  }

  // 4. éå†æ¯ä¸ªå¡ç‰‡ï¼Œæ ¹æ® ratio è°ƒæ•´æ ·å¼
  cards.forEach((card, index) => {
    const cardElement = card as HTMLElement;

    // è·å–å¡ç‰‡çš„åˆå§‹ä½ç½®
    const initialPos = cardInitialPositions.value[index];
    if (!initialPos) return;

    // è·å– animation-delayï¼Œè½¬æˆæ•°å­—ï¼ˆç”¨äºé”™è½æ•ˆæœï¼‰
    const delayStr = cardElement.style.animationDelay || getComputedStyle(cardElement).animationDelay;
    const delay = parseFloat(delayStr) || 0;

    // å»¶è¿Ÿç³»æ•°ï¼šè®©ä¸åŒå¡ç‰‡çš„èšæ‹¢é€Ÿåº¦ç•¥æœ‰å·®å¼‚
    const delayFactor = 1 + delay * 0.1;

    // 5. æ ¹æ® ratio è®¡ç®—æ•ˆæœå‚æ•°ï¼ˆåè½¬é€»è¾‘ï¼šåˆå§‹ç´§å¯†ï¼Œæ»šåŠ¨ååˆ†æ•£ï¼‰
    // ç¼©æ”¾ï¼šä» 1.0ï¼ˆåˆå§‹ç´§å¯†ï¼‰åˆ° 1.2ï¼ˆæ»šåŠ¨åæ”¾å¤§ï¼‰
    const scale = 1.0 + ratio * 0.2 * delayFactor;

    // é€æ˜åº¦ï¼šä» 1.0ï¼ˆåˆå§‹æ¸…æ™°ï¼‰åˆ° 1.0ï¼ˆä¿æŒæ¸…æ™°ï¼‰
    const opacity = 1.0; // ä¿æŒå®Œå…¨ä¸é€æ˜

    // ä½ç½®æ‰©å±•ï¼šä»åˆå§‹ç´§å¯†ä½ç½®å‘å››å‘¨æ‰©å±•ï¼ˆratioè¶Šå¤§ï¼Œæ‰©å±•è¶Šå¤šï¼‰
    // ä½†éœ€è¦ç¡®ä¿ä¸è¶…å‡ºå®¹å™¨è¾¹ç•Œ
    if (!sceneElement) return;

    const sceneWidth = sceneElement.offsetWidth;
    const sceneHeight = sceneElement.offsetHeight;

    // æ ¹æ®å±å¹•å®½åº¦åŠ¨æ€è°ƒæ•´å¡ç‰‡å¤§å°å’Œåˆ—æ•°
    const isMobile = window.innerWidth <= 480;
    const isTablet = window.innerWidth > 480 && window.innerWidth <= 768;
    const cardWidth = isMobile ? 140 : isTablet ? 160 : 200; // å¡ç‰‡å®½åº¦
    const cardHeight = isMobile ? 200 : isTablet ? 240 : 280; // å¡ç‰‡é«˜åº¦
    const totalCols = isMobile ? 2 : isTablet ? 3 : 5;

    // æœ€ç»ˆé—´è·ï¼š30pxï¼ˆåˆ†æ•£çŠ¶æ€ï¼‰
    const finalGap = 30;

    // è®¡ç®—æœ€ç»ˆçŠ¶æ€ä¸‹çš„æ€»å®½åº¦ï¼ˆé—´è·10pxï¼‰
    const finalTotalWidth = totalCols * cardWidth + (totalCols - 1) * finalGap;

    // è®¡ç®—æœ€ç»ˆçŠ¶æ€ä¸‹çš„èµ·å§‹ä½ç½®ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰
    const finalStartLeft = (sceneWidth - finalTotalWidth) / 2;

    // è·å–å½“å‰å¡ç‰‡çš„åˆ—å·
    const cardCol = index % totalCols;

    // è®¡ç®—åˆå§‹å’Œæœ€ç»ˆä½ç½®
    const initialLeft = initialPos.left; // åˆå§‹ä½ç½®ï¼ˆå æ®å®Œæ•´å®½åº¦ï¼‰
    const finalLeft = (finalStartLeft + cardCol * (cardWidth + finalGap) + cardWidth / 2) / sceneWidth * 100;

    // æ ¹æ®ratioæ’å€¼è®¡ç®—å½“å‰ä½ç½®
    let newLeft = initialLeft + ratio * (finalLeft - initialLeft);

    // å‚ç›´æ–¹å‘ä¿æŒåˆå§‹ä½ç½®ï¼ˆä¸æ‰©å±•ï¼‰
    let newTop = initialPos.top;

    // è¾¹ç•Œæ£€æŸ¥ï¼šç¡®ä¿å¡ç‰‡ä¸è¶…å‡ºå®¹å™¨ï¼ˆè€ƒè™‘å¡ç‰‡å®½åº¦ï¼‰
    const cardWidthPercent = (cardWidth / sceneWidth) * 100;
    const cardHeightPercent = (cardHeight / sceneHeight) * 100;
    const halfCardWidthPercent = cardWidthPercent / 2;
    const halfCardHeightPercent = cardHeightPercent / 2;

    // æœ€å°è¾¹è·ï¼ˆç¡®ä¿å¡ç‰‡ä¸å®Œå…¨è´´è¾¹ï¼‰
    const minMargin = 10;

    // é™åˆ¶åœ¨å®¹å™¨å†…ï¼ˆç•™å‡ºè¾¹è·ï¼Œç¡®ä¿å¡ç‰‡ä¸å®Œå…¨è´´è¾¹ï¼‰
    newLeft = Math.max(minMargin / sceneWidth * 100 + halfCardWidthPercent,
                      Math.min(100 - minMargin / sceneWidth * 100 - halfCardWidthPercent, newLeft));
    newTop = Math.max(minMargin / sceneHeight * 100 + halfCardHeightPercent,
                     Math.min(100 - minMargin / sceneHeight * 100 - halfCardHeightPercent, newTop));

    // 6. åº”ç”¨æ ·å¼ï¼ˆä½¿ç”¨ transform å’Œ opacityï¼Œè§¦å‘ç¡¬ä»¶åŠ é€Ÿï¼‰
    // ä½¿ç”¨ setProperty ç¡®ä¿æ ·å¼è¢«æ­£ç¡®åº”ç”¨
    // æ³¨æ„ï¼šinitialPos å­˜å‚¨çš„æ˜¯å¡ç‰‡ä¸­å¿ƒç‚¹çš„ç™¾åˆ†æ¯”ä½ç½®
    cardElement.style.setProperty('top', `${initialPos.top}%`);
    cardElement.style.setProperty('left', `${initialPos.left}%`);
    // ä½¿ç”¨ translate æ¥è°ƒæ•´ä½ç½®ï¼Œç¡®ä¿å¡ç‰‡ä¸­å¿ƒç‚¹å¯¹é½ï¼Œé¿å…é‡å 
    const translateX = (newLeft - initialPos.left) * sceneWidth / 100;
    const translateY = (newTop - initialPos.top) * sceneHeight / 100;
    cardElement.style.setProperty('transform', `translate(-50%, -50%) translate(${translateX}px, ${translateY}px) scale(${scale})`);
    cardElement.style.setProperty('opacity', opacity.toString());

    // è°ƒè¯•ï¼šè¾“å‡ºç¬¬ä¸€ä¸ªå¡ç‰‡çš„å˜åŒ–ï¼ˆä»…åœ¨éœ€è¦æ—¶å¯ç”¨ï¼‰
    // if (index === 0) {
    //   console.log(`å¡ç‰‡0: ratio=${ratio.toFixed(3)}, scale=${scale.toFixed(2)}, opacity=${opacity.toFixed(2)}, top=${newTop.toFixed(1)}%, left=${newLeft.toFixed(1)}%`);
    // }
  });
};

// èŠ‚æµå‡½æ•°ï¼šé™åˆ¶æ‰§è¡Œé¢‘ç‡
function throttle(fn: () => void, delay: number = 16) {
  let lastTime = 0;
  return function () {
    const currentTime = Date.now();
    if (currentTime - lastTime >= delay) {
      fn();
      lastTime = currentTime;
    }
  };
}

let scrollHandlerRef: (() => void) | null = null;
let resizeHandlerRef: (() => void) | null = null;

onMounted(async () => {
  // é¢„åŠ è½½é¦–å±å°é¢å›¾ï¼ˆå…³é”®èµ„æºï¼Œä¼˜å…ˆåŠ è½½ï¼‰
  preloadHeroPoster();

  // ç­‰å¾… DOM æ¸²æŸ“å®Œæˆ
  await nextTick();

  // ä½¿ç”¨åå¤‡é€‰æ‹©å™¨ï¼Œç¡®ä¿å³ä½¿refæœªåˆå§‹åŒ–ä¹Ÿèƒ½æ‰¾åˆ°å…ƒç´ 
  const sectionEl = productsSectionRef.value || document.getElementById('products-showcase');
  const sceneEl = productsSceneRef.value || document.querySelector('#products-showcase .products-scene') as HTMLElement;

  if (!sectionEl || !sceneEl) {
    // å¦‚æœå…ƒç´ æœªæ‰¾åˆ°ï¼Œé™é»˜è¿”å›
    return;
  }

  // åˆå§‹åŒ–ï¼šå­˜å‚¨æ¯ä¸ªå¡ç‰‡çš„åˆå§‹ä½ç½®ï¼ˆä» DOM ä¸­è¯»å–å®é™…æ¸²æŸ“çš„ä½ç½®ï¼‰
  const cards = sceneEl.querySelectorAll('.sub-scene');
  if (cards.length === 0) {
    // å¦‚æœå¡ç‰‡æœªæ‰¾åˆ°ï¼Œé™é»˜è¿”å›
    return;
  }

  const sceneWidth = sceneEl.offsetWidth || 1200; // å®¹å™¨å®½åº¦
  const sceneHeight = sceneEl.offsetHeight || 800; // å®¹å™¨é«˜åº¦

  // æ ¹æ®å±å¹•å®½åº¦åŠ¨æ€è°ƒæ•´åˆ—æ•°å’Œå¡ç‰‡å¤§å°
  const isMobile = window.innerWidth <= 480;
  const isTablet = window.innerWidth > 480 && window.innerWidth <= 768;
  const totalCols = isMobile ? 2 : isTablet ? 3 : 5;
  const cardWidth = isMobile ? 140 : isTablet ? 160 : 200; // å¡ç‰‡å®½åº¦
  const cardHeight = isMobile ? 200 : isTablet ? 240 : 280; // å¡ç‰‡é«˜åº¦

  // åˆå§‹çŠ¶æ€ï¼šå¡ç‰‡å æ®å®Œæ•´å®½åº¦ï¼Œè®¡ç®—æœ€å°é—´è·
  const initialGap = Math.max(0, (sceneWidth - totalCols * cardWidth) / (totalCols - 1));

  // è®¡ç®—èµ·å§‹ä½ç½®ï¼šä»å·¦è¾¹å¼€å§‹ï¼Œå æ®å®Œæ•´å®½åº¦
  const startLeft = 0;

  // è®¡ç®—å‚ç›´èµ·å§‹ä½ç½®ï¼ˆè€ƒè™‘æ ‡é¢˜å’Œå‰¯æ ‡é¢˜çš„é«˜åº¦ï¼Œé¿å…é®æŒ¡ï¼‰
  // æ ‡é¢˜é«˜åº¦çº¦60pxï¼Œå‰¯æ ‡é¢˜é«˜åº¦çº¦40pxï¼ŒåŠ ä¸Šé—´è·çº¦100px
  const titleHeight = 100; // æ ‡é¢˜å’Œå‰¯æ ‡é¢˜çš„æ€»é«˜åº¦ï¼ˆåŒ…æ‹¬é—´è·ï¼‰

  // ä½¿ç”¨å›ºå®šçš„å‚ç›´é—´è·ï¼ˆå› ä¸ºæ»šåŠ¨åªæ¶‰åŠæ°´å¹³åŠ¨æ•ˆï¼Œå‚ç›´ä½ç½®ä¸å˜ï¼‰
  const fixedVerticalGap = 30; // å›ºå®šå‚ç›´é—´è·ï¼ˆåƒç´ ï¼‰

  // è®¡ç®—ç¬¬ä¸€è¡Œçš„èµ·å§‹ä½ç½®ï¼ˆä»æ ‡é¢˜ä¸‹æ–¹å¼€å§‹ï¼‰
  // æ³¨æ„ï¼šç”±äºå¡ç‰‡ä½¿ç”¨ä¸­å¿ƒç‚¹å®šä½ï¼ˆtranslate(-50%, -50%)ï¼‰ï¼ŒstartTop åº”è¯¥æ˜¯ç¬¬ä¸€å¼ å¡ç‰‡é¡¶éƒ¨çš„ä½ç½®
  // ç¬¬ä¸€å¼ å¡ç‰‡çš„ä¸­å¿ƒç‚¹ = startTop + cardHeight / 2
  const startTop = titleHeight + cardHeight / 2; // ç¬¬ä¸€è¡Œå¡ç‰‡çš„é¡¶éƒ¨ä½ç½®

  cardInitialPositions.value = Array.from(cards).map((_, index) => {
    // è®¡ç®—åˆå§‹ä½ç½®ï¼šå¤šæ’ç´§å¯†æ’åˆ—ï¼ˆæ ¹æ®å±å¹•å®½åº¦åŠ¨æ€è°ƒæ•´åˆ—æ•°ï¼‰ï¼Œå æ®å®Œæ•´å®½åº¦
    const row = Math.floor(index / totalCols); // è¡Œå·
    const col = index % totalCols; // åˆ—å·

    // è®¡ç®—æ¯ä¸ªå¡ç‰‡çš„ä½ç½®ï¼ˆç›¸å¯¹äºå®¹å™¨ï¼Œåˆå§‹çŠ¶æ€å æ®å®Œæ•´å®½åº¦ï¼‰
    // ä½¿ç”¨å¡ç‰‡ä¸­å¿ƒç‚¹ä½œä¸ºå®šä½åŸºå‡†
    const left = startLeft + col * (cardWidth + initialGap) + cardWidth / 2;
    const leftPercent = (left / sceneWidth) * 100;

    // è®¡ç®—å‚ç›´ä½ç½®ï¼šç¬¬ä¸€æ’ä» startTop å¼€å§‹ï¼Œæ¯æ’ä¹‹é—´ä½¿ç”¨å›ºå®šé—´è·
    // æ³¨æ„ï¼šç”±äºä½¿ç”¨ä¸­å¿ƒç‚¹å®šä½ï¼Œæ¯æ’çš„é¡¶éƒ¨ä½ç½® = startTop + row * (cardHeight + fixedVerticalGap)
    // ä¸­å¿ƒç‚¹ä½ç½® = é¡¶éƒ¨ä½ç½® + cardHeight / 2
    const top = startTop + row * (cardHeight + fixedVerticalGap) + cardHeight / 2;
    const topPercent = (top / sceneHeight) * 100;

    return { top: topPercent, left: leftPercent };
  });

  // æ£€æŸ¥å¹¶è°ƒæ•´å·¦å³é—´è·ï¼Œç¡®ä¿å¹³è¡¡
  if (cardInitialPositions.value.length > 0) {
    const firstCardLeft = cardInitialPositions.value[0]?.left || 0;
    // æ‰¾åˆ°ç¬¬ä¸€è¡Œæœ€åä¸€åˆ—å¡ç‰‡ï¼ˆç¬¬5ä¸ªï¼Œç´¢å¼•4ï¼‰
    const firstRowLastIndex = Math.min(totalCols - 1, cardInitialPositions.value.length - 1);
    const lastCardLeft = cardInitialPositions.value[firstRowLastIndex]?.left || 0;

    if (firstCardLeft && lastCardLeft) {
      const leftMargin = firstCardLeft - (cardWidth / 2 / sceneWidth * 100);
      const rightMargin = 100 - (lastCardLeft + (cardWidth / 2 / sceneWidth * 100));

      // å¦‚æœå³ä¾§è¾¹è·æ˜æ˜¾å¤§äºå·¦ä¾§è¾¹è·ï¼Œå‘å³è°ƒæ•´ä½ç½®ï¼Œè®©å¡ç‰‡æ›´ç´§å‡‘
      if (rightMargin > leftMargin + 2) {
        // è®¡ç®—éœ€è¦å‘å³ç§»åŠ¨çš„è·ç¦»ï¼Œä½¿å·¦å³é—´è·æ›´å¹³è¡¡
        const adjustPercent = (rightMargin - leftMargin) / 2;
        if (adjustPercent > 0) {
          cardInitialPositions.value = cardInitialPositions.value.map(pos => ({
            ...pos,
            left: pos.left + adjustPercent
          }));
        }
      }
    }
  }

  // ç«‹å³åº”ç”¨åˆå§‹ä½ç½®ï¼Œç¡®ä¿å¡ç‰‡å±…ä¸­æ˜¾ç¤º
  cards.forEach((card, index) => {
    const cardElement = card as HTMLElement;
    const initialPos = cardInitialPositions.value[index];
    if (initialPos) {
      cardElement.style.setProperty('top', `${initialPos.top}%`);
      cardElement.style.setProperty('left', `${initialPos.left}%`);
    }
  });

  // è°ƒè¯•ï¼šè¾“å‡ºåˆå§‹ä½ç½®ï¼ˆä»…åœ¨éœ€è¦æ—¶å¯ç”¨ï¼‰
  // console.log('å¡ç‰‡æ•°é‡:', cards.length, 'åˆå§‹ä½ç½®ï¼ˆç™¾åˆ†æ¯”ï¼‰:', cardInitialPositions.value);
  // console.log('å®¹å™¨å®½åº¦:', sceneWidth, 'èµ·å§‹ä½ç½®:', startLeft);

  // åˆ›å»ºæ»šåŠ¨å¤„ç†å‡½æ•°ï¼ˆä½¿ç”¨èŠ‚æµä¼˜åŒ–æ€§èƒ½ï¼‰
  const scrollHandler = throttle(() => {
    requestAnimationFrame(() => {
      handleScroll();
    });
  }, 16); // çº¦60fps

  // ç»‘å®šæ»šåŠ¨äº‹ä»¶ï¼ˆå…³é”®ï¼šæ»šåŠ¨å‘ç”Ÿåœ¨.mainå®¹å™¨å†…ï¼Œä¸æ˜¯windowï¼‰
  const mainContainer = document.querySelector('.main') as HTMLElement;
  if (mainContainer) {
    // ç»‘å®šåˆ°.mainå®¹å™¨ï¼ˆå®é™…æ»šåŠ¨çš„å®¹å™¨ï¼‰
    mainContainer.addEventListener('scroll', scrollHandler, { passive: true });
    scrollHandlerRef = scrollHandler;
  } else {
    // å¦‚æœæ‰¾ä¸åˆ°.mainï¼Œå›é€€åˆ°window
    window.addEventListener('scroll', scrollHandler, { passive: true });
    scrollHandlerRef = scrollHandler;
  }

  // åˆå§‹è®¡ç®—ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿ DOM å®Œå…¨æ¸²æŸ“å’Œåˆå§‹ä½ç½®å·²å­˜å‚¨ï¼‰
  setTimeout(() => {
    handleScroll();
  }, 100);

  // ç›‘å¬resizeäº‹ä»¶ï¼Œç¡®ä¿çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—
  const handleResize = () => {
    // çª—å£å¤§å°å˜åŒ–æ—¶ï¼Œé‡æ–°åˆå§‹åŒ–ä½ç½®
    setTimeout(() => {
      const sectionEl = productsSectionRef.value || document.getElementById('products-showcase');
      const sceneEl = productsSectionRef.value || document.querySelector('#products-showcase .products-scene') as HTMLElement;

      if (sectionEl && sceneEl) {
        const cards = sceneEl.querySelectorAll('.sub-scene');
        if (cards.length > 0) {
          const sceneWidth = sceneEl.offsetWidth || 1200;
          const sceneHeight = sceneEl.offsetHeight || 800;

          const isMobile = window.innerWidth <= 480;
          const isTablet = window.innerWidth > 480 && window.innerWidth <= 768;
          const totalCols = isMobile ? 2 : isTablet ? 3 : 5;
          const cardWidth = isMobile ? 140 : isTablet ? 160 : 200;
          const cardHeight = isMobile ? 200 : isTablet ? 240 : 280;

          const initialGap = Math.max(0, (sceneWidth - totalCols * cardWidth) / (totalCols - 1));
          const startLeft = 0;
          const titleHeight = 100;
          const fixedVerticalGap = 30;
          const startTop = titleHeight + cardHeight / 2;

          cardInitialPositions.value = Array.from(cards).map((_, index) => {
            const row = Math.floor(index / totalCols);
            const col = index % totalCols;
            const left = startLeft + col * (cardWidth + initialGap) + cardWidth / 2;
            const leftPercent = (left / sceneWidth) * 100;
            const top = startTop + row * (cardHeight + fixedVerticalGap) + cardHeight / 2;
            const topPercent = (top / sceneHeight) * 100;
            return { top: topPercent, left: leftPercent };
          });

          // é‡æ–°åº”ç”¨ä½ç½®
          cards.forEach((card, index) => {
            const cardElement = card as HTMLElement;
            const initialPos = cardInitialPositions.value[index];
            if (initialPos) {
              cardElement.style.setProperty('top', `${initialPos.top}%`);
              cardElement.style.setProperty('left', `${initialPos.left}%`);
            }
          });
        }
      }
      handleScroll();
    }, 100);
  };

  resizeHandlerRef = handleResize;
  window.addEventListener('resize', handleResize, { passive: true });
});

onUnmounted(() => {
  // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
  if (scrollHandlerRef) {
    const mainContainer = document.querySelector('.main') as HTMLElement;
    if (mainContainer) {
      mainContainer.removeEventListener('scroll', scrollHandlerRef);
    }
    window.removeEventListener('scroll', scrollHandlerRef);
  }
  if (resizeHandlerRef) {
    window.removeEventListener('resize', resizeHandlerRef);
  }
});
</script>

<style scoped lang="scss">
@use '../styles/index.scss' as *;
</style>

