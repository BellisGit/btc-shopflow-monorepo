<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>物流应用 - BTC ShopFlow</title>
  </head>
  <body>
    <!-- 布局微应用的挂载点 -->
    <div id="layout-container"></div>
    <!-- 子应用独立运行容器（仅本地调试使用） -->
    <div id="app"></div>
    <script>
      (function () {
        // 关键：如果已经在 qiankun 环境中（由主应用加载），不执行任何独立运行逻辑
        // 生产环境：主应用通过 /micro-apps/logistics/ 路径加载，此时不应该加载 layout-app
        if (window.__POWERED_BY_QIANKUN__ || window.location.pathname.startsWith('/micro-apps/')) {
          return;
        }

        // 仅本地开发环境或独立访问子域名时，才加载 layout-app
        // 生产环境：子域名应该代理到主应用，不应该直接访问子应用的 index.html
        var shouldLoadLayout = /\.bellis\.com\.cn$/i.test(window.location.hostname);
        if (!shouldLoadLayout) {
          return;
        }

        var LOADER_FLAG = '__layout_app_loader__';
        if (window[LOADER_FLAG]) {
          return;
        }
        window[LOADER_FLAG] = true;
        window.__USE_LAYOUT_APP__ = true;

        // 加载 qiankun（使用多个 CDN 源作为备用）
        const qiankunCDNs = [
          'https://unpkg.com/qiankun@2.10.16/dist/umd/qiankun.min.js',
          'https://cdn.jsdelivr.net/npm/qiankun@2.10.16/dist/umd/qiankun.min.js',
          'https://cdn.bootcdn.net/ajax/libs/qiankun/2.10.16/umd/qiankun.min.js'
        ];

        let currentCDNIndex = 0;

        function loadQiankun() {
          if (currentCDNIndex >= qiankunCDNs.length) {
            console.error('[logistics-app] 所有 CDN 源都加载失败，无法加载 qiankun');
            return;
          }

          const script = document.createElement('script');
          script.src = qiankunCDNs[currentCDNIndex];
          script.crossOrigin = 'anonymous';

          script.onload = function() {
          // 获取当前环境
          const isProd = window.location.hostname.includes('bellis.com.cn');
          const protocol = window.location.protocol;

          // 布局微应用入口
          const layoutEntry = isProd
            ? `${protocol}//layout.bellis.com.cn/`
            : 'http://localhost:4188/';

          console.log('[logistics-app] 准备加载 layout-app，入口地址:', layoutEntry);

          // 注册并启动 qiankun，仅挂载布局微应用
          qiankun.registerMicroApps([
            {
              name: 'layout-app',
              entry: layoutEntry,
              container: '#layout-container',
              activeRule: () => true,
              // 添加 scriptType 和 getTemplate 配置，确保资源正确加载
              scriptType: 'module',
              getTemplate: function(tpl) {
                // 确保所有 script 标签都有 type="module"
                return tpl.replace(
                  /<script(\s+[^>]*)?>/gi,
                  function(match, attrs) {
                    if (!attrs) attrs = '';
                    // 如果已经有 type 属性，替换为 module
                    if (attrs.includes('type=')) {
                      return match.replace(/type=["']?[^"'\s>]+["']?/i, 'type="module"');
                    }
                    // 如果没有 type 属性，添加 type="module"
                    return '<script type="module"' + attrs + '>';
                  }
                );
              },
            }
          ], {
            beforeLoad: [
              (app) => {
                console.log('[logistics-app] 准备加载 layout-app:', app.name, app.entry);
              }
            ],
            beforeMount: [
              (app) => {
                console.log('[logistics-app] 准备挂载 layout-app:', app.name);
              }
            ],
            afterMount: [
              (app) => {
                console.log('[logistics-app] layout-app 挂载完成:', app.name);
              }
            ],
            beforeUnmount: [
              (app) => {
                console.log('[logistics-app] 准备卸载 layout-app:', app.name);
              }
            ],
            afterUnmount: [
              (app) => {
                console.log('[logistics-app] layout-app 卸载完成:', app.name);
              }
            ],
          });

          qiankun.start({
            sandbox: {
              strictStyleIsolation: false,
              experimentalStyleIsolation: true,
            },
            singular: false,
            // 添加错误处理
            errorHandler: function(error) {
              console.error('[logistics-app] qiankun 错误:', error);
            },
            // 添加自定义 fetch 和 getTemplate 配置，确保跨域资源可以加载
            importEntryOpts: {
              fetch: function(url, options) {
                console.log('[logistics-app] 加载资源:', url);
                return fetch(url, {
                  ...options,
                  mode: 'cors',
                  credentials: 'include',
                });
              },
              getTemplate: function(tpl) {
                // 确保所有 script 标签都有 type="module"
                return tpl.replace(
                  /<script(\s+[^>]*)?>/gi,
                  function(match, attrs) {
                    if (!attrs) attrs = '';
                    // 如果已经有 type 属性，替换为 module
                    if (attrs.includes('type=')) {
                      return match.replace(/type=["']?[^"'\s>]+["']?/i, 'type="module"');
                    }
                    // 如果没有 type 属性，添加 type="module"
                    return '<script type="module"' + attrs + '>';
                  }
                );
              },
            },
          });

          console.log('[logistics-app] qiankun 已启动');
        };

        script.onerror = function(error) {
          console.warn('[logistics-app] CDN 源加载失败:', qiankunCDNs[currentCDNIndex], error);
          currentCDNIndex++;
          // 尝试下一个 CDN 源
          loadQiankun();
        };

        document.head.appendChild(script);
        }

        // 开始加载
        loadQiankun();
      })();
    </script>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>

