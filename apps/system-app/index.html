<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>系统应用 - BTC ShopFlow</title>
  </head>
  <body>
    <div id="app"></div>
    <!-- HTTPS 页面强制拦截 HTTP 请求脚本（必须在所有脚本之前执行） -->
    <script>
      (function() {
        'use strict';
        // 仅在 HTTPS 页面下执行
        if (typeof window === 'undefined' || window.location.protocol !== 'https:') {
          return;
        }

        // 1. 立即清理 localStorage 中的 HTTP URL
        try {
          const stored = localStorage.getItem('dev_api_base_url');
          if (stored && (stored.startsWith('http://') || stored !== '/api')) {
            console.warn('[HTTPS Guard] 清理 localStorage 中的非 /api baseURL:', stored);
            localStorage.removeItem('dev_api_base_url');
          }
        } catch (e) {
          console.warn('[HTTPS Guard] 清理 localStorage 失败:', e);
        }

        // 2. 拦截 XMLHttpRequest
        const originalXHROpen = XMLHttpRequest.prototype.open;
        const originalXHRSend = XMLHttpRequest.prototype.send;

        XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
          // 强制验证：在 HTTPS 页面下，绝对不允许 HTTP URL
          if (typeof url === 'string' && url.startsWith('http://')) {
            console.error('[HTTPS Guard] XMLHttpRequest.open 拦截：检测到 HTTP 请求，强制转换为相对路径:', url);
            try {
              const urlObj = new URL(url);
              url = urlObj.pathname + urlObj.search;
              console.log('[HTTPS Guard] 转换后的 URL:', url);
            } catch (e) {
              url = url.replace(/^https?:\/\/[^/]+/, '');
              console.log('[HTTPS Guard] 转换后的 URL (fallback):', url);
            }
          } else if (url instanceof URL && url.protocol === 'http:') {
            console.error('[HTTPS Guard] XMLHttpRequest.open 拦截：检测到 HTTP URL 对象，强制转换为相对路径:', url.href);
            url = new URL(url.pathname + url.search, window.location.origin);
            console.log('[HTTPS Guard] 转换后的 URL:', url.href);
          }
          
          // 保存 URL 用于 send 方法检查
          this._method = method;
          this._url = url;
          
          return originalXHROpen.call(this, method, url, async !== undefined ? async : true, user, password);
        };

        XMLHttpRequest.prototype.send = function(data) {
          // 在发送前再次检查 URL
          const url = this._url || '';
          const urlStr = typeof url === 'string' ? url : url instanceof URL ? url.href : '';
          
          if (urlStr && urlStr.startsWith('http://')) {
            console.error('[HTTPS Guard] XMLHttpRequest.send 拦截：检测到 HTTP 请求，阻止发送:', urlStr);
            // 阻止发送 HTTP 请求
            return;
          }
          
          return originalXHRSend.call(this, data);
        };

        // 3. 拦截 fetch
        const originalFetch = window.fetch;
        window.fetch = function(input, init) {
          // 强制验证：在 HTTPS 页面下，绝对不允许 HTTP URL
          let url = typeof input === 'string' ? input : input instanceof URL ? input.href : input.url;
          
          if (typeof url === 'string' && url.startsWith('http://')) {
            console.error('[HTTPS Guard] fetch 拦截：检测到 HTTP 请求，强制转换为相对路径:', url);
            try {
              const urlObj = new URL(url);
              url = urlObj.pathname + urlObj.search;
              if (typeof input === 'string') {
                input = url;
              } else if (input instanceof URL) {
                input = new URL(url, window.location.origin);
              } else {
                input = Object.assign({}, input, { url: url });
              }
              console.log('[HTTPS Guard] 转换后的 URL:', url);
            } catch (e) {
              url = url.replace(/^https?:\/\/[^/]+/, '');
              if (typeof input === 'string') {
                input = url;
              } else if (input instanceof URL) {
                input = new URL(url, window.location.origin);
              } else {
                input = Object.assign({}, input, { url: url });
              }
              console.log('[HTTPS Guard] 转换后的 URL (fallback):', url);
            }
          } else if (input instanceof URL && input.protocol === 'http:') {
            console.error('[HTTPS Guard] fetch 拦截：检测到 HTTP URL 对象，强制转换为相对路径:', input.href);
            input = new URL(input.pathname + input.search, window.location.origin);
            console.log('[HTTPS Guard] 转换后的 URL:', input.href);
          }
          
          return originalFetch.call(this, input, init);
        };

        console.log('[HTTPS Guard] 已启用：所有 HTTP 请求将被强制转换为相对路径 /api');
      })();
    </script>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>

