# 版本发布指南

本文档说明如何使用自动化脚本进行版本发布，遵循标准的 Git Flow 流程。

## 快速开始

### 使用 npm/pnpm 脚本（推荐）

```bash
# 发布新版本（例如 1.0.0）
pnpm release 1.0.0

# 或者使用 npm
npm run release 1.0.0
```

### 直接使用脚本

```bash
# 发布新版本
node scripts/release-version.mjs 1.0.0
```

## 发布流程说明

脚本会自动执行以下 Git Flow 标准流程：

### 1. 从 develop 创建 release 分支
- 检查当前分支（应在 develop）
- 拉取最新代码
- 创建 `release/v1.0.0` 分支

### 2. 发布准备阶段
- 在 release 分支上进行小修复
- 更新版本号（package.json）
- 完善发布文档

**✨ 自动更新**：创建标签后，CHANGELOG.md 会自动更新，无需手动编辑。

**⚠️ 注意**：只做小修复，不要新增大功能！

### 3. 合并到 main 分支
- 切换到 main 分支
- 合并 release 分支到 main（使用 `--no-ff` 保留合并记录）
- 创建版本标签（v1.0.0）

### 4. 合并回 develop 分支
- 切换到 develop 分支
- 合并 release 分支回 develop
- 确保 develop 包含所有发布修复

### 5. 清理临时分支
- 删除本地 release 分支
- 删除远程 release 分支

### 6. 推送所有更改
- 推送 main 分支
- 推送 develop 分支
- 推送版本标签

## 完整示例

```bash
# 1. 确保在 develop 分支
git checkout develop
git pull origin develop

# 2. 运行发布脚本
pnpm release 1.0.0

# 3. 按照脚本提示操作
# - 确认版本号
# - 进行发布准备（修复bug、更新版本号等）
# - 确认继续发布流程
# - 输入标签附注信息
# - 确认推送更改
```

## 交互式流程

脚本是交互式的，会在关键步骤询问确认：

1. **检查工作区**：确保没有未提交的更改
2. **检查分支**：确认在 develop 分支
3. **拉取代码**：是否拉取最新代码
4. **创建分支**：如果分支已存在，是否删除重建
5. **更新版本号**：是否自动更新 package.json
6. **发布准备**：完成后是否继续
7. **创建标签**：输入标签附注信息
8. **自动更新 CHANGELOG**：创建标签后自动更新 CHANGELOG.md（新增）
9. **删除分支**：是否删除临时 release 分支
10. **推送更改**：是否推送到远程

## 版本号格式

版本号必须遵循语义化版本规范：`x.y.z`

- **主版本号（x）**：不兼容的 API 修改
- **次版本号（y）**：向下兼容的功能性新增
- **修订号（z）**：向下兼容的问题修正

示例：
- `1.0.0` - 第一个正式版本
- `1.1.0` - 新增功能
- `1.1.1` - 修复 bug
- `2.0.0` - 重大更新（可能不兼容）

## 发布准备清单

在 release 分支上，建议完成以下工作：

- [ ] 修复所有已知的 bug
- [ ] 更新 `package.json` 中的版本号
- [ ] 更新 `CHANGELOG.md`（如存在）
- [ ] 更新 README.md 中的版本信息
- [ ] 检查所有测试是否通过
- [ ] 更新依赖版本（如需要）
- [ ] 完善文档

## 发布后操作

脚本完成后，建议：

1. **在 GitHub 上创建 Releases**
   - 访问仓库的 Releases 页面
   - 点击 "Draft a new release"
   - 选择刚创建的标签（v1.0.0）
   - 填写更新日志和发布说明
   - 上传构建产物（如需要）

2. **通知团队**
   - 发送发布通知
   - 说明新功能和修复
   - 提供升级指南（如需要）

3. **监控部署**
   - 检查生产环境部署
   - 监控错误日志
   - 收集用户反馈

## 常见问题

### Q: 如果发布流程中断了怎么办？

A: 脚本会在每个步骤检查状态，如果中断：
1. 检查当前分支状态：`git status`
2. 根据错误信息修复问题
3. 重新运行脚本或手动执行剩余步骤

### Q: 可以跳过某些步骤吗？

A: 脚本是交互式的，可以在关键步骤选择跳过或暂停。但建议按照标准流程执行，确保代码一致性。

### Q: 如果 release 分支已存在怎么办？

A: 脚本会检测到已存在的分支，并询问是否删除重建。如果分支中有重要更改，建议先手动处理。

### Q: 如何回滚发布？

A: 如果需要回滚：
1. 在 main 分支上回退到上一个标签
2. 强制推送（谨慎操作）
3. 删除错误的标签
4. 通知团队

## 最佳实践

1. **定期发布**：不要积累太多更改，定期发布小版本
2. **测试充分**：在 release 分支上充分测试
3. **文档完善**：每次发布都更新 CHANGELOG
4. **沟通及时**：发布后及时通知团队和用户
5. **监控反馈**：关注发布后的用户反馈和错误报告

## 相关文档

- [Git Flow 工作流](https://nvie.com/posts/a-successful-git-branching-model/)
- [语义化版本规范](https://semver.org/lang/zh-CN/)
- [GitHub Releases 指南](https://docs.github.com/en/repositories/releasing-projects-on-github)
