<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWA è¯Šæ–­å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin-bottom: 30px;
      color: #333;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .section h2 {
      margin-bottom: 15px;
      color: #1976d2;
      font-size: 18px;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status.success {
      background: #4caf50;
      color: white;
    }
    .status.error {
      background: #f44336;
      color: white;
    }
    .status.warning {
      background: #ff9800;
      color: white;
    }
    .icon-preview {
      display: inline-block;
      width: 64px;
      height: 64px;
      margin: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      background: repeating-linear-gradient(45deg, #f0f0f0 0, #f0f0f0 10px, #fff 10px, #fff 20px);
      vertical-align: top;
    }
    .icon-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .icon-info {
      display: inline-block;
      vertical-align: top;
      margin-left: 10px;
      font-size: 12px;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      margin-top: 10px;
    }
    .error {
      color: #f44336;
      margin-top: 10px;
    }
    .success {
      color: #4caf50;
      margin-top: 10px;
    }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #1565c0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PWA è¯Šæ–­å·¥å…·</h1>
    
    <div class="section">
      <h2>Manifest æ£€æŸ¥ <span id="manifest-status" class="status">æ£€æŸ¥ä¸­...</span></h2>
      <div id="manifest-content"></div>
    </div>

    <div class="section">
      <h2>å›¾æ ‡æ£€æŸ¥ <span id="icons-status" class="status">æ£€æŸ¥ä¸­...</span></h2>
      <div id="icons-content"></div>
    </div>

    <div class="section">
      <h2>Service Worker çŠ¶æ€</h2>
      <div id="sw-content"></div>
    </div>

    <div class="section">
      <h2>æ“ä½œå»ºè®®</h2>
      <div id="suggestions"></div>
    </div>
  </div>

  <script>
    async function checkManifest() {
      try {
        const response = await fetch('/manifest.webmanifest');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const manifest = await response.json();
        
        document.getElementById('manifest-status').textContent = 'âœ“ æ­£å¸¸';
        document.getElementById('manifest-status').className = 'status success';
        
        document.getElementById('manifest-content').innerHTML = `
          <div class="success">âœ“ Manifest æ–‡ä»¶å¯è®¿é—®</div>
          <pre>${JSON.stringify(manifest, null, 2)}</pre>
        `;
        
        return manifest;
      } catch (error) {
        document.getElementById('manifest-status').textContent = 'âœ— é”™è¯¯';
        document.getElementById('manifest-status').className = 'status error';
        document.getElementById('manifest-content').innerHTML = `
          <div class="error">âœ— æ— æ³•åŠ è½½ manifest: ${error.message}</div>
        `;
        return null;
      }
    }

    async function checkIcons(manifest) {
      if (!manifest || !manifest.icons) {
        document.getElementById('icons-status').textContent = 'âœ— æ— å›¾æ ‡';
        document.getElementById('icons-status').className = 'status error';
        document.getElementById('icons-content').innerHTML = '<div class="error">Manifest ä¸­æ²¡æœ‰å›¾æ ‡é…ç½®</div>';
        return;
      }

      let successCount = 0;
      let failCount = 0;
      const iconsHtml = [];

      for (const icon of manifest.icons) {
        try {
          const response = await fetch(icon.src);
          if (response.ok) {
            successCount++;
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            iconsHtml.push(`
              <div class="icon-preview">
                <img src="${url}" alt="${icon.sizes}" onerror="this.parentElement.innerHTML='åŠ è½½å¤±è´¥'">
              </div>
              <div class="icon-info">
                <strong>${icon.sizes}</strong><br>
                è·¯å¾„: ${icon.src}<br>
                ç±»å‹: ${icon.type || 'image/png'}<br>
                ç”¨é€”: ${icon.purpose || 'any'}<br>
                <span class="success">âœ“ å¯è®¿é—®</span>
              </div>
              <br style="clear: both;">
            `);
          } else {
            failCount++;
            iconsHtml.push(`
              <div class="icon-info">
                <strong>${icon.sizes}</strong><br>
                è·¯å¾„: ${icon.src}<br>
                <span class="error">âœ— æ— æ³•è®¿é—® (HTTP ${response.status})</span>
              </div>
              <br style="clear: both;">
            `);
          }
        } catch (error) {
          failCount++;
          iconsHtml.push(`
            <div class="icon-info">
              <strong>${icon.sizes}</strong><br>
              è·¯å¾„: ${icon.src}<br>
              <span class="error">âœ— é”™è¯¯: ${error.message}</span>
            </div>
            <br style="clear: both;">
          `);
        }
      }

      if (failCount === 0) {
        document.getElementById('icons-status').textContent = `âœ“ å…¨éƒ¨æ­£å¸¸ (${successCount})`;
        document.getElementById('icons-status').className = 'status success';
      } else if (successCount > 0) {
        document.getElementById('icons-status').textContent = `âš  éƒ¨åˆ†å¤±è´¥ (${successCount}/${successCount + failCount})`;
        document.getElementById('icons-status').className = 'status warning';
      } else {
        document.getElementById('icons-status').textContent = 'âœ— å…¨éƒ¨å¤±è´¥';
        document.getElementById('icons-status').className = 'status error';
      }

      document.getElementById('icons-content').innerHTML = iconsHtml.join('');
    }

    function checkServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          if (registrations.length > 0) {
            document.getElementById('sw-content').innerHTML = `
              <div class="success">âœ“ å·²æ³¨å†Œ ${registrations.length} ä¸ª Service Worker</div>
              <button onclick="unregisterSW()">æ³¨é”€æ‰€æœ‰ Service Worker</button>
            `;
          } else {
            document.getElementById('sw-content').innerHTML = `
              <div>â„¹ æœªæ³¨å†Œ Service Workerï¼ˆå¼€å‘ç¯å¢ƒä¸­æ­£å¸¸ï¼‰</div>
            `;
          }
        });
      } else {
        document.getElementById('sw-content').innerHTML = `
          <div class="error">âœ— æµè§ˆå™¨ä¸æ”¯æŒ Service Worker</div>
        `;
      }
    }

    window.unregisterSW = async function() {
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (const registration of registrations) {
          await registration.unregister();
        }
        alert('å·²æ³¨é”€æ‰€æœ‰ Service Workerï¼Œè¯·åˆ·æ–°é¡µé¢');
        location.reload();
      }
    };

    function generateSuggestions(manifest) {
      const suggestions = [];
      
      if (!manifest) {
        suggestions.push('âŒ Manifest æ–‡ä»¶æ— æ³•åŠ è½½ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®');
        document.getElementById('suggestions').innerHTML = suggestions.join('<br>');
        return;
      }

      if (!manifest.icons || manifest.icons.length === 0) {
        suggestions.push('âŒ Manifest ä¸­æ²¡æœ‰é…ç½®å›¾æ ‡');
      } else {
        suggestions.push(`âœ“ Manifest ä¸­é…ç½®äº† ${manifest.icons.length} ä¸ªå›¾æ ‡`);
      }

      suggestions.push('ğŸ“‹ å¦‚æœå›¾æ ‡ä»ç„¶æ˜¾ç¤ºä¸ºé»˜è®¤å›¾æ ‡ï¼Œè¯·å°è¯•ï¼š');
      suggestions.push('1. å®Œå…¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆåŒ…æ‹¬ Service Workerï¼‰');
      suggestions.push('2. å¸è½½ç°æœ‰çš„ PWAï¼ˆé•¿æŒ‰æ¡Œé¢å›¾æ ‡ > å¸è½½ï¼‰');
      suggestions.push('3. åœ¨æµè§ˆå™¨ä¸­è®¿é—®åº”ç”¨ï¼Œæ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰');
      suggestions.push('4. Application > Storage > Clear site dataï¼ˆæ¸…é™¤ç«™ç‚¹æ•°æ®ï¼‰');
      suggestions.push('5. é‡æ–°è®¿é—®åº”ç”¨å¹¶å®‰è£…åˆ°æ¡Œé¢');
      suggestions.push('6. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯');

      document.getElementById('suggestions').innerHTML = suggestions.join('<br>');
    }

    // æ‰§è¡Œæ£€æŸ¥
    (async () => {
      const manifest = await checkManifest();
      await checkIcons(manifest);
      checkServiceWorker();
      generateSuggestions(manifest);
    })();
  </script>
</body>
</html>

