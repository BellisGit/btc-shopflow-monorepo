# ğŸš€ BTC ShopFlow Kubernetes éƒ¨ç½²å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

BTC ShopFlow æ˜¯ä¸€ä¸ªåŸºäºå¾®å‰ç«¯æ¶æ„çš„ä¼ä¸šçº§ä¾›åº”é“¾ç®¡ç†ç³»ç»Ÿï¼Œç°å·²å®Œæˆ Kubernetes éƒ¨ç½²æ–¹æ¡ˆè®¾è®¡ã€‚æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„éƒ¨ç½²æŒ‡å—å’Œæœ€ä½³å®è·µã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### å¾®å‰ç«¯åº”ç”¨æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kubernetes é›†ç¾¤                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Ingress Controller (Nginx)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ system-app  â”‚ â”‚ admin-app   â”‚ â”‚logistics-appâ”‚   ...    â”‚
â”‚  â”‚ (ä¸»åº”ç”¨)     â”‚ â”‚ (ç®¡ç†åº”ç”¨)   â”‚ â”‚ (ç‰©æµåº”ç”¨)   â”‚          â”‚
â”‚  â”‚ Port: 8080  â”‚ â”‚ Port: 8081  â”‚ â”‚ Port: 8082  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åº”ç”¨æ¸…å•
| åº”ç”¨ | ç«¯å£ | åŸŸå | å‰¯æœ¬æ•° | è‡ªåŠ¨æ‰©å±• |
|------|------|------|--------|----------|
| system-app | 8080 | bellis.com.cn | 2 | 2-10 |
| admin-app | 8081 | admin.bellis.com.cn | 2 | 2-8 |
| logistics-app | 8082 | logistics.bellis.com.cn | 2 | 2-6 |
| quality-app | 8083 | quality.bellis.com.cn | 1 | å¦ |
| production-app | 8084 | production.bellis.com.cn | 1 | å¦ |
| engineering-app | 8085 | engineering.bellis.com.cn | 1 | å¦ |
| finance-app | 8086 | finance.bellis.com.cn | 1 | å¦ |
| docs-site-app | 8087 | docs.bellis.com.cn | 1 | å¦ |
| mobile-app | 8091 | mobile.bellis.com.cn | 1 | å¦ |

## ğŸ“ éƒ¨ç½²æ–‡ä»¶ç»“æ„

```
k8s/
â”œâ”€â”€ README.md                    # è¯¦ç»†éƒ¨ç½²æŒ‡å—
â”œâ”€â”€ deploy.sh                    # ä¸€é”®éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ namespace.yaml               # å‘½åç©ºé—´é…ç½®
â”œâ”€â”€ configmap.yaml              # åº”ç”¨é…ç½®
â”œâ”€â”€ ingress.yaml                # è·¯ç”±é…ç½®
â”œâ”€â”€ hpa.yaml                    # è‡ªåŠ¨æ‰©å±•é…ç½®
â”œâ”€â”€ deployments/                # åº”ç”¨éƒ¨ç½²é…ç½®
â”‚   â”œâ”€â”€ system-app.yaml         # ç³»ç»Ÿåº”ç”¨
â”‚   â”œâ”€â”€ admin-app.yaml          # ç®¡ç†åº”ç”¨
â”‚   â”œâ”€â”€ logistics-app.yaml      # ç‰©æµåº”ç”¨
â”‚   â””â”€â”€ all-apps.yaml           # å…¶ä»–åº”ç”¨
â”œâ”€â”€ helm/                       # Helm Chart
â”‚   â”œâ”€â”€ Chart.yaml
â”‚   â””â”€â”€ values.yaml
â”œâ”€â”€ ci-cd/                      # CI/CD é…ç½®
â”‚   â””â”€â”€ github-actions.yml
â””â”€â”€ monitoring/                 # ç›‘æ§é…ç½®
    â””â”€â”€ prometheus.yaml
```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### æ–¹å¼ä¸€ï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è¿›å…¥ K8s ç›®å½•
cd btc-shopflow-monorepo/k8s

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
./deploy.sh prod deploy

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
./deploy.sh prod status

# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
./deploy.sh dev deploy
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ Helmï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# å®‰è£… Helm Chart
helm install btc-shopflow ./helm -n btc-shopflow --create-namespace

# å‡çº§éƒ¨ç½²
helm upgrade btc-shopflow ./helm -n btc-shopflow

# å¸è½½
helm uninstall btc-shopflow -n btc-shopflow
```

### æ–¹å¼ä¸‰ï¼šæ‰‹åŠ¨éƒ¨ç½²

```bash
# åº”ç”¨æ‰€æœ‰é…ç½®
kubectl apply -f namespace.yaml
kubectl apply -f configmap.yaml -n btc-shopflow
kubectl apply -f deployments/ -n btc-shopflow
kubectl apply -f ingress.yaml -n btc-shopflow
kubectl apply -f hpa.yaml -n btc-shopflow
```

## ğŸ”§ é…ç½®è¯¦è§£

### 1. èµ„æºé…ç½®

#### æ ¸å¿ƒåº”ç”¨ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- **CPU**: è¯·æ±‚ 50mï¼Œé™åˆ¶ 200m
- **å†…å­˜**: è¯·æ±‚ 64Miï¼Œé™åˆ¶ 256Mi
- **å‰¯æœ¬æ•°**: 2ï¼ˆæ”¯æŒè‡ªåŠ¨æ‰©å±•åˆ° 10ï¼‰

#### è¾…åŠ©åº”ç”¨ï¼ˆæ ‡å‡†é…ç½®ï¼‰
- **CPU**: è¯·æ±‚ 25mï¼Œé™åˆ¶ 100m
- **å†…å­˜**: è¯·æ±‚ 32Miï¼Œé™åˆ¶ 128Mi
- **å‰¯æœ¬æ•°**: 1

### 2. ç½‘ç»œé…ç½®

#### Ingress è·¯ç”±ç­–ç•¥
```yaml
# å­åŸŸåè·¯ç”±ï¼ˆæ¨èï¼‰
bellis.com.cn â†’ system-app
admin.bellis.com.cn â†’ admin-app
logistics.bellis.com.cn â†’ logistics-app

# è·¯å¾„è·¯ç”±ï¼ˆå¤‡é€‰ï¼‰
bellis.com.cn/ â†’ system-app
bellis.com.cn/admin â†’ admin-app
bellis.com.cn/logistics â†’ logistics-app
```

#### å®‰å…¨é…ç½®
- **TLS åŠ å¯†**: æ”¯æŒ Let's Encrypt è‡ªåŠ¨è¯ä¹¦
- **CORS é…ç½®**: å…è®¸è·¨åŸŸè®¿é—®
- **å®‰å…¨å¤´**: åŒ…å« XSSã€CSRF é˜²æŠ¤

### 3. è‡ªåŠ¨æ‰©å±•é…ç½®

```yaml
# HPA é…ç½®
CPU é˜ˆå€¼: 70%
å†…å­˜é˜ˆå€¼: 80%
æ‰©å±•ç­–ç•¥: æ¸è¿›å¼æ‰©å±•
æœ€å°å‰¯æœ¬: 2
æœ€å¤§å‰¯æœ¬: 2-10ï¼ˆæ ¹æ®åº”ç”¨é‡è¦æ€§ï¼‰
```

## ğŸ“Š ç›‘æ§å’Œå‘Šè­¦

### Prometheus ç›‘æ§æŒ‡æ ‡
- **åº”ç”¨çŠ¶æ€**: Pod å¥åº·çŠ¶æ€
- **èµ„æºä½¿ç”¨**: CPUã€å†…å­˜ã€ç½‘ç»œ
- **æ€§èƒ½æŒ‡æ ‡**: å“åº”æ—¶é—´ã€é”™è¯¯ç‡
- **ä¸šåŠ¡æŒ‡æ ‡**: ç”¨æˆ·è®¿é—®é‡ã€åŠŸèƒ½ä½¿ç”¨æƒ…å†µ

### Grafana ä»ªè¡¨æ¿
- **ç³»ç»Ÿæ¦‚è§ˆ**: é›†ç¾¤æ•´ä½“çŠ¶æ€
- **åº”ç”¨è¯¦æƒ…**: å•ä¸ªåº”ç”¨æ€§èƒ½
- **èµ„æºè¶‹åŠ¿**: å†å²ä½¿ç”¨æƒ…å†µ
- **å‘Šè­¦é¢æ¿**: å®æ—¶å‘Šè­¦ä¿¡æ¯

### å‘Šè­¦è§„åˆ™
- **åº”ç”¨ä¸‹çº¿**: 1åˆ†é’Ÿå†…å“åº”
- **é«˜CPUä½¿ç”¨**: 80% æŒç»­ 5åˆ†é’Ÿ
- **é«˜å†…å­˜ä½¿ç”¨**: 90% æŒç»­ 5åˆ†é’Ÿ
- **Podé‡å¯**: é¢‘ç¹é‡å¯å‘Šè­¦

## ğŸ”„ CI/CD é›†æˆ

### GitHub Actions å·¥ä½œæµ

```yaml
è§¦å‘æ¡ä»¶:
- Push to main/master: è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- Pull Request: éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒè¿›è¡Œæµ‹è¯•

éƒ¨ç½²æµç¨‹:
1. ä»£ç æ£€å‡º
2. æ„å»º Docker é•œåƒ
3. æ¨é€åˆ°é•œåƒä»“åº“
4. æ›´æ–° K8s éƒ¨ç½²
5. éªŒè¯éƒ¨ç½²ç»“æœ
```

### éƒ¨ç½²ç­–ç•¥
- **æ»šåŠ¨æ›´æ–°**: é›¶åœæœºéƒ¨ç½²
- **è“ç»¿éƒ¨ç½²**: å¿«é€Ÿå›æ»šèƒ½åŠ›
- **é‡‘ä¸é›€å‘å¸ƒ**: æ¸è¿›å¼å‘å¸ƒ

## ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ

### 1. é•œåƒå®‰å…¨
```bash
# ä½¿ç”¨é root ç”¨æˆ·
USER 101

# æœ€å°åŒ–é•œåƒ
FROM nginx:alpine

# å®‰å…¨æ‰«æ
docker scan btc-shopflow/system-app:latest
```

### 2. ç½‘ç»œå®‰å…¨
```yaml
# ç½‘ç»œç­–ç•¥
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: btc-shopflow-netpol
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

### 3. è®¿é—®æ§åˆ¶
```yaml
# RBAC é…ç½®
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: btc-shopflow-role
rules:
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "list", "watch"]
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. Pod å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹ Pod çŠ¶æ€
kubectl describe pod <pod-name> -n btc-shopflow

# æŸ¥çœ‹æ—¥å¿—
kubectl logs <pod-name> -n btc-shopflow

# å¸¸è§åŸå› ï¼š
- é•œåƒæ‹‰å–å¤±è´¥
- èµ„æºä¸è¶³
- é…ç½®é”™è¯¯
```

#### 2. æœåŠ¡æ— æ³•è®¿é—®
```bash
# æ£€æŸ¥æœåŠ¡
kubectl get svc -n btc-shopflow

# æ£€æŸ¥ç«¯ç‚¹
kubectl get endpoints -n btc-shopflow

# æ£€æŸ¥ Ingress
kubectl describe ingress btc-shopflow-ingress -n btc-shopflow
```

#### 3. æ€§èƒ½é—®é¢˜
```bash
# æŸ¥çœ‹èµ„æºä½¿ç”¨
kubectl top pods -n btc-shopflow
kubectl top nodes

# è°ƒæ•´èµ„æºé™åˆ¶
kubectl edit deployment btc-system-app -n btc-shopflow
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. èµ„æºä¼˜åŒ–
- **CPU é™åˆ¶**: æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´
- **å†…å­˜é™åˆ¶**: é¿å… OOM æ€æ­»
- **å­˜å‚¨ä¼˜åŒ–**: ä½¿ç”¨ SSD å­˜å‚¨ç±»

### 2. ç½‘ç»œä¼˜åŒ–
- **CDN é›†æˆ**: é™æ€èµ„æºåŠ é€Ÿ
- **è´Ÿè½½å‡è¡¡**: å¤šå‰¯æœ¬åˆ†å¸ƒ
- **ç¼“å­˜ç­–ç•¥**: Redis é›†ç¾¤

### 3. æ‰©å±•ç­–ç•¥
- **æ°´å¹³æ‰©å±•**: å¢åŠ å‰¯æœ¬æ•°
- **å‚ç›´æ‰©å±•**: å¢åŠ èµ„æºé…ç½®
- **é›†ç¾¤æ‰©å±•**: å¢åŠ èŠ‚ç‚¹æ•°é‡

## ğŸ¯ ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. é«˜å¯ç”¨é…ç½®
```yaml
# Pod åäº²å’Œæ€§
podAntiAffinity:
  requiredDuringSchedulingIgnoredDuringExecution:
  - labelSelector:
      matchLabels:
        app: btc-system-app
    topologyKey: kubernetes.io/hostname
```

### 2. å¤‡ä»½ç­–ç•¥
```bash
# å®šæœŸå¤‡ä»½é…ç½®
kubectl get all -n btc-shopflow -o yaml > backup-$(date +%Y%m%d).yaml

# å¤‡ä»½æŒä¹…åŒ–æ•°æ®
velero backup create btc-shopflow-backup --include-namespaces btc-shopflow
```

### 3. ç¾éš¾æ¢å¤
- **å¤šåŒºåŸŸéƒ¨ç½²**: è·¨å¯ç”¨åŒºåˆ†å¸ƒ
- **æ•°æ®å¤‡ä»½**: å®šæœŸå¤‡ä»½å…³é”®æ•°æ®
- **æ¢å¤æ¼”ç»ƒ**: å®šæœŸè¿›è¡Œæ¢å¤æµ‹è¯•

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### è”ç³»æ–¹å¼
- **é¡¹ç›®ç»´æŠ¤è€…**: BTC IT Team
- **é‚®ç®±**: mlu@bellis-technology.cn
- **é¡¹ç›®åœ°å€**: https://github.com/BellisGit/btc-shopflow-monorepo

### æ–‡æ¡£èµ„æº
- **K8s å®˜æ–¹æ–‡æ¡£**: https://kubernetes.io/docs/
- **Helm æ–‡æ¡£**: https://helm.sh/docs/
- **Nginx Ingress**: https://kubernetes.github.io/ingress-nginx/

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] Kubernetes é›†ç¾¤å¯ç”¨
- [ ] kubectl é…ç½®æ­£ç¡®
- [ ] Docker é•œåƒå·²æ„å»ºå¹¶æ¨é€
- [ ] åŸŸå DNS é…ç½®å®Œæˆ
- [ ] TLS è¯ä¹¦å‡†å¤‡å°±ç»ª

### éƒ¨ç½²åéªŒè¯
- [ ] æ‰€æœ‰ Pod è¿è¡Œæ­£å¸¸
- [ ] æœåŠ¡å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] Ingress è·¯ç”±å·¥ä½œæ­£å¸¸
- [ ] è‡ªåŠ¨æ‰©å±•é…ç½®ç”Ÿæ•ˆ
- [ ] ç›‘æ§å‘Šè­¦æ­£å¸¸å·¥ä½œ

### ç”Ÿäº§ç¯å¢ƒé¢å¤–æ£€æŸ¥
- [ ] å¤‡ä»½ç­–ç•¥å·²é…ç½®
- [ ] å®‰å…¨ç­–ç•¥å·²åº”ç”¨
- [ ] æ€§èƒ½ç›‘æ§å·²å¯ç”¨
- [ ] æ—¥å¿—æ”¶é›†å·²é…ç½®
- [ ] ç¾éš¾æ¢å¤è®¡åˆ’å·²åˆ¶å®š

---

ğŸ‰ **æ­å–œï¼æ‚¨çš„ BTC ShopFlow é¡¹ç›®ç°å·²å®Œå…¨æ”¯æŒ Kubernetes éƒ¨ç½²ï¼**

è¿™å¥—å®Œæ•´çš„ K8s éƒ¨ç½²æ–¹æ¡ˆåŒ…å«äº†ä»åŸºç¡€éƒ¨ç½²åˆ°ç”Ÿäº§çº§ä¼˜åŒ–çš„æ‰€æœ‰é…ç½®ï¼Œæ”¯æŒè‡ªåŠ¨æ‰©å±•ã€ç›‘æ§å‘Šè­¦ã€CI/CD é›†æˆç­‰ä¼ä¸šçº§åŠŸèƒ½ã€‚
