# ============================================
# BTC ShopFlow - Nginx子域名反向代理配置
# ============================================
# 
# 使用说明：
# 1. 将此文件复制到服务器: /etc/nginx/conf.d/btc-shopflow.conf
# 2. 修改 server_name 为你的实际域名
# 3. 配置SSL证书路径
# 4. 测试配置: nginx -t
# 5. 重新加载: nginx -s reload
#
# ============================================

# 域名到端口的映射（可选，用于动态配置）
map $host $backend_port {
    bellis.com.cn              30080;
    www.bellis.com.cn          30080;
    admin.bellis.com.cn        30081;
    logistics.bellis.com.cn    30082;
    quality.bellis.com.cn      30083;
    production.bellis.com.cn   30084;
    engineering.bellis.com.cn  30085;
    finance.bellis.com.cn      30086;
    mobile.bellis.com.cn       30091;
    default                    30080;
}

# ============================================
# 主应用 - bellis.com.cn
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name bellis.com.cn www.bellis.com.cn;

    # HTTP重定向到HTTPS
    return 301 https://bellis.com.cn$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name bellis.com.cn www.bellis.com.cn;

    # SSL证书配置（请修改为实际路径）
    ssl_certificate /etc/nginx/ssl/bellis.com.cn/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/bellis.com.cn/privkey.pem;
    
    # SSL优化配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 日志配置
    access_log /var/log/nginx/btc-system-app.access.log;
    error_log /var/log/nginx/btc-system-app.error.log;

    # 代理到system-app容器
    location / {
        proxy_pass http://127.0.0.1:30080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 缓冲设置
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # 健康检查
    location /health {
        proxy_pass http://127.0.0.1:30080/health;
        access_log off;
    }
}

# ============================================
# 管理应用 - admin.bellis.com.cn
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name admin.bellis.com.cn;
    return 301 https://admin.bellis.com.cn$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name admin.bellis.com.cn;

    ssl_certificate /etc/nginx/ssl/bellis.com.cn/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/bellis.com.cn/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    access_log /var/log/nginx/btc-admin-app.access.log;
    error_log /var/log/nginx/btc-admin-app.error.log;

    location / {
        proxy_pass http://127.0.0.1:30081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }
}

# ============================================
# 物流应用 - logistics.bellis.com.cn
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name logistics.bellis.com.cn;
    return 301 https://logistics.bellis.com.cn$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name logistics.bellis.com.cn;

    ssl_certificate /etc/nginx/ssl/bellis.com.cn/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/bellis.com.cn/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    access_log /var/log/nginx/btc-logistics-app.access.log;
    error_log /var/log/nginx/btc-logistics-app.error.log;

    location / {
        proxy_pass http://127.0.0.1:30082;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }
}

# ============================================
# 质量应用 - quality.bellis.com.cn
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name quality.bellis.com.cn;
    return 301 https://quality.bellis.com.cn$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name quality.bellis.com.cn;

    ssl_certificate /etc/nginx/ssl/bellis.com.cn/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/bellis.com.cn/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    access_log /var/log/nginx/btc-quality-app.access.log;
    error_log /var/log/nginx/btc-quality-app.error.log;

    location / {
        proxy_pass http://127.0.0.1:30083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }
}

# ============================================
# 生产应用 - production.bellis.com.cn
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name production.bellis.com.cn;
    return 301 https://production.bellis.com.cn$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name production.bellis.com.cn;

    ssl_certificate /etc/nginx/ssl/bellis.com.cn/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/bellis.com.cn/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    access_log /var/log/nginx/btc-production-app.access.log;
    error_log /var/log/nginx/btc-production-app.error.log;

    location / {
        proxy_pass http://127.0.0.1:30084;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }
}

# ============================================
# 工程应用 - engineering.bellis.com.cn
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name engineering.bellis.com.cn;
    return 301 https://engineering.bellis.com.cn$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name engineering.bellis.com.cn;

    ssl_certificate /etc/nginx/ssl/bellis.com.cn/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/bellis.com.cn/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    access_log /var/log/nginx/btc-engineering-app.access.log;
    error_log /var/log/nginx/btc-engineering-app.error.log;

    location / {
        proxy_pass http://127.0.0.1:30085;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }
}

# ============================================
# 财务应用 - finance.bellis.com.cn
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name finance.bellis.com.cn;
    return 301 https://finance.bellis.com.cn$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name finance.bellis.com.cn;

    ssl_certificate /etc/nginx/ssl/bellis.com.cn/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/bellis.com.cn/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    access_log /var/log/nginx/btc-finance-app.access.log;
    error_log /var/log/nginx/btc-finance-app.error.log;

    location / {
        proxy_pass http://127.0.0.1:30086;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }
}

# ============================================
# 移动应用 - mobile.bellis.com.cn
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name mobile.bellis.com.cn;
    return 301 https://mobile.bellis.com.cn$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name mobile.bellis.com.cn;

    ssl_certificate /etc/nginx/ssl/bellis.com.cn/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/bellis.com.cn/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    access_log /var/log/nginx/btc-mobile-app.access.log;
    error_log /var/log/nginx/btc-mobile-app.error.log;

    location / {
        proxy_pass http://127.0.0.1:30091;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }
}

