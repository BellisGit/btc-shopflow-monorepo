# 80端口：HTTP 强制重定向到 HTTPS（保持不变）
server {
    listen       80;
    server_name  mobile.bellis.com.cn;
    return 301 https://$server_name$request_uri;
}

# 443端口：HTTPS 主配置（核心适配内网后端 API）
server {
    listen       443 ssl;
    server_name  mobile.bellis.com.cn;

    # SSL 证书配置（保持不变）
    ssl_certificate      /home/ssl/bellis.com.cn_nginx/bellis.com.cn_bundle.pem;
    ssl_certificate_key  /home/ssl/bellis.com.cn_nginx/bellis.com.cn.key;

    # 允许请求大小（保持不变）
    client_max_body_size 10M;

    # SSL 会话配置（保持不变）
    ssl_session_cache    shared:SSL:10m;
    ssl_session_timeout  10m;
    ssl_session_tickets  off;

    # TLS 协议与加密套件（保持不变）
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;

    # 代理到内网后端 API（核心修正：目标IP+头信息适配内网服务）
    location /api/ {
        # 修正1：代理目标改回内网后端真实地址（必须带端口8091，末尾/确保路径正确）
        proxy_pass http://10.0.0.168:8091/api/;

        # 核心修复1：Host头传递内网后端IP（而非前端域名）
        # 原因：内网服务可能基于Host头匹配路由，前端域名会被后端拒绝（直接访问内网IP时Host是10.0.0.168）
        proxy_set_header Host 10.0.0.168;

        # 核心修复2：保留必要的转发头，帮助后端识别真实请求来源
        proxy_set_header X-Real-IP $remote_addr;  # 真实客户端IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 转发链IP
        proxy_set_header X-Forwarded-Proto $scheme;  # 告知后端请求是HTTPS（避免后端重定向HTTP）
        proxy_set_header X-Forwarded-Port $server_port;  # 前端访问端口（443）

        # 移除冗余头：内网后端通常不识别X-Original-*、X-Forwarded-Prefix，避免触发异常拦截
        # proxy_set_header X-Original-URI $request_uri; （已移除）
        # proxy_set_header X-Original-Method $request_method; （已移除）
        # proxy_set_header X-Forwarded-Prefix /api; （已移除）

        proxy_http_version 1.1;

        # 超时设置（内网网络稳定，可适当缩短，避免无效等待）
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 60s;

        # 缓冲设置（保持不变）
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        proxy_cookie_path / /;

        # 关键修复3：强化CORS配置（内网后端大概率未配置跨域，需明确允许前端域名）
        # 因为域名访问时，前端Origin是https://mobile.bellis.com.cn，后端需明确允许
        add_header Access-Control-Allow-Origin "https://mobile.bellis.com.cn" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, Accept, Token" always;  # 补充常见Token头
        add_header Access-Control-Allow-Credentials true always;

        # 处理OPTIONS预检请求（内网后端常忽略OPTIONS请求，导致跨域失败）
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://mobile.bellis.com.cn";
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH";
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, Accept, Token";
            add_header Access-Control-Max-Age 1728000;  # 预检缓存1天，减少请求次数
            add_header Content-Type 'text/plain charset=UTF-8';
            add_header Content-Length 0;
            return 204;  # 无内容响应，符合OPTIONS规范
        }
    }

    # 移动端前端代理（保持之前的WebSocket修复，无改动）
    location / {
        proxy_pass http://10.0.0.53:30091;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Forwarded-Prefix /;
        proxy_http_version 1.1;

        # WebSocket支持（硬编码Connection头，无语法错误）
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    }
}
